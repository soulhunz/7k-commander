<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7K Commander (Master Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES --- */
        body { font-family: 'Kanit', sans-serif; background-color: #0b0e14; color: #e2e8f0; height: 100vh; overflow: hidden; }
        .no-scroll::-webkit-scrollbar { width: 6px; }
        .no-scroll::-webkit-scrollbar-track { background: #111827; }
        .no-scroll::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }

        /* Sidebar */
        .sidebar { background: #111827; border-right: 1px solid #1f2937; }
        .menu-item { cursor: pointer; padding: 10px 14px; border-radius: 8px; font-size: 0.9rem; color: #9ca3af; transition: 0.2s; margin-bottom: 2px; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover { background: #1f2937; color: white; }
        .menu-item.active { background: #1d4ed8; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3); }
        .menu-section-title { font-size: 0.7rem; font-weight: bold; color: #6b7280; text-transform: uppercase; margin: 16px 0 6px 12px; letter-spacing: 0.05em; }
        
        /* Castle & Buttons */
        .castle-btn { padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; background: #1f2937; color: #9ca3af; border: 1px solid #374151; transition: 0.2s; white-space: nowrap; }
        .castle-btn:hover { background: #374151; color: white; border-color: #4b5563; }
        .castle-btn.active { background: rgba(37, 99, 235, 0.2); color: #60a5fa; border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); }
        .castle-group-label { font-size: 0.7rem; color: #6b7280; font-weight: bold; text-transform: uppercase; margin-right: 10px; min-width: 60px; display: inline-block; }

        /* Skill Box Styling */
        .skill-display { font-size: 14px; line-height: 1.6; color: #e2e8f0; white-space: pre-wrap; }
        .sb-green { margin-top: 8px; border-radius: 6px; overflow: hidden; background: #d1fae5; border: 1px solid #059669; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .sb-green .sb-head { background: #10b981; padding: 4px 10px; font-size: 11px; font-weight: bold; color: #fff; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .sb-green .sb-content { padding: 8px 10px; font-size: 13px; color: #064e3b; font-weight: 600; }
        .sb-purple { margin-top: 8px; border-radius: 6px; overflow: hidden; background: #f3e8ff; border: 1px solid #7c3aed; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .sb-purple .sb-head { background: #8b5cf6; padding: 4px 10px; font-size: 11px; font-weight: bold; color: #fff; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .sb-purple .sb-content { padding: 8px 10px; font-size: 13px; color: #4c1d95; font-weight: 600; }

        /* General UI Elements */
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; flex-direction: column; gap: 20px; backdrop-filter: blur(5px); }
        .loading-overlay.active { display: flex; }
        .spinner { width: 60px; height: 60px; border: 6px solid #1f2937; border-top: 6px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* War Room & My Team Styles */
        .team-row { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; align-items: stretch; justify-content: space-between; gap: 16px; min-height: 160px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.2s; }
        .team-row.cleared { opacity: 0.5; filter: grayscale(1); pointer-events: none; border-color: #ef4444; position: relative; }
        .team-row.cleared::after { content: 'DEFEATED'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); font-size: 3rem; color: #ef4444; font-weight: 900; border: 4px solid #ef4444; padding: 10px 40px; border-radius: 10px; opacity: 0.8; z-index: 50; }
        
        .slot { width: 90px; height: 90px; background: #0d1117; border: 2px dashed #4b5563; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: 0.2s; user-select: none; }
        .slot.filled { border: 2px solid #fbbf24; background: #000; border-style: solid; }
        .slot img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; pointer-events: none; }
        .ring-trigger { position: absolute; top: -10px; left: -10px; width: 28px; height: 28px; border-radius: 50%; border: 2px dashed #4b5563; background: #111827; z-index: 20; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; color: #4b5563; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .ring-trigger:hover { border-color: #fbbf24; color: #fbbf24; transform: scale(1.1); }
        .ring-trigger.equipped { border-style: solid; background: #000; color: transparent; overflow: hidden; }
        .ring-trigger.equipped img { width: 100%; height: 100%; object-fit: cover; }
        .grade-4 { border-color: #facc15 !important; } .grade-5 { border-color: #f97316 !important; } .grade-6 { border-color: #ef4444 !important; }
        .star-row-slot { position: absolute; bottom: 3px; width: 100%; display: flex; justify-content: center; gap: 1px; z-index: 6; pointer-events: none; padding: 2px 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); border-radius: 0 0 10px 10px; }
        .star-row-detail { display: flex; gap: 2px; margin-top: 4px; }
        .star { width: 8px; height: 8px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.6); }
        .star.yellow { background: #facc15; } .star.blue { background: #38bdf8; } .star.red { background: #ef4444; }
        
        .skill-bar { display: flex; gap: 2px; position: absolute; bottom: -20px; width: 100%; justify-content: center; z-index: 7; }
        .skill-btn { 
            /* width: 32px;  <-- ‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô */
            width: 36px; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
            height: 18px; 
            background: #1f2937; 
            border: 1px solid #4b5563; 
            border-radius: 3px; 
            font-size: 10px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå */
            font-weight: 800; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #9ca3af; 
        }
        .skill-btn.active { background: #fbbf24; color: black; border-color: #fbbf24; }
        
        .pet-slot { width: 60px; height: 60px; border-radius: 50%; border: 2px dashed #a78bfa; margin-top: auto; margin-bottom: auto; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #a78bfa; position: relative; background: #0d1117; cursor: pointer; transition: 0.2s; }
        .pet-slot:hover { border-color: #c4b5fd; color: white; }
        .pet-slot.filled { border: 2px solid #8b5cf6; }
        .pet-slot img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; pointer-events: none; }
        
        .form-btn { font-size: 10px; padding: 4px; border: 1px solid #4b5563; border-radius: 4px; color: #9ca3af; cursor: pointer; background: #0d1117; text-align: center; width: 100%; }
        .form-btn.active { background: #1d4ed8; color: white; border-color: #3b82f6; font-weight: bold; }

        /* Manager & Inputs */
        .manager-list-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; gap: 10px; }
        .manager-list-item:hover { background: #1f2937; }
        .manager-list-item.active { background: #1d4ed8; border-color: #3b82f6; }
        .input-group label { display: block; font-size: 11px; color: #9ca3af; margin-bottom: 4px; font-weight: bold; text-transform: uppercase; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; background: #0d1117; border: 1px solid #374151; padding: 8px; border-radius: 6px; color: white; font-size: 13px; outline: none; }
        .input-group textarea { font-family: monospace; line-height: 1.4; resize: vertical; }
        .skill-input-container { border: 1px solid #374151; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .si-header { background: #1f2937; padding: 8px 12px; font-size: 12px; font-weight: bold; color: #d1d5db; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #374151; }
        .si-section { padding: 10px; border-top: 1px solid #374151; }
        .si-green-bg { background: rgba(6, 78, 59, 0.3); border-color: #064e3b; }
        .si-purple-bg { background: rgba(88, 28, 135, 0.3); border-color: #581c87; }
        .builder-textarea { width: 100%; background: #0d1117; border: 1px solid #374151; border-radius: 6px; padding: 8px; color: #e2e8f0; font-family: monospace; font-size: 12px; min-height: 60px; outline: none; }
        .builder-textarea:focus { border-color: #3b82f6; }

        /* Gallery Grid */
        #gallery-container { display: flex; flex-wrap: wrap; gap: 12px; align-content: flex-start; }
        .hero-card { width: 100px; height: 100px; background: #161b22; border: 1px solid #30363d; border-radius: 12px; overflow: hidden; transition: 0.2s; cursor: pointer; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .hero-card:hover { transform: scale(1.05); border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); z-index: 10; }
        .hc-img { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .hc-name-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0)); padding: 15px 4px 4px 4px; text-align: center; }
        .hc-name-text { color: white; font-size: 10px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 1px 2px black; }

        /* Filter Styles */
        .filter-btn { padding: 4px 10px; font-size: 11px; border-radius: 20px; border: 1px solid #374151; color: #9ca3af; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .filter-btn:hover { background: #1f2937; color: white; }
        .filter-btn.active { background: #3b82f6; color: white; border-color: #2563eb; font-weight: bold; }
        .tab-btn { padding: 8px 16px; font-weight: bold; color: #6b7280; border-bottom: 2px solid transparent; cursor: pointer; transition: 0.2s; }
        .tab-btn:hover { color: #d1d5db; }
        .tab-btn.active { color: #3b82f6; border-color: #3b82f6; }

        /* TIER LIST STYLES */
        .tier-row { display: flex; border: 1px solid #30363d; border-radius: 8px; overflow: hidden; min-height: 80px; background: #0d1117; margin-bottom: 12px; }
        .tier-header { width: 80px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; color: rgba(0,0,0,0.5); text-shadow: 0 1px 0 rgba(255,255,255,0.2); flex-shrink: 0; }
        .tier-content { flex: 1; padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start; min-height: 80px; transition: 0.2s; }
        .tier-content.drag-over { background: rgba(59, 130, 246, 0.1); box-shadow: inset 0 0 20px rgba(59, 130, 246, 0.2); }
        .tier-s { background: #ef4444; color: #7f1d1d; }
        .tier-a { background: #f97316; color: #7c2d12; }
        .tier-b { background: #eab308; color: #713f12; }
        .tier-c { background: #84cc16; color: #365314; }
        .tier-d { background: #64748b; color: #1e293b; }
        .tier-item { width: 50px; height: 50px; border-radius: 8px; overflow: hidden; cursor: grab; position: relative; border: 2px solid transparent; transition: 0.1s; background: #1f2937; }
        .tier-item:hover { transform: scale(1.1); border-color: #3b82f6; z-index: 10; }
        .tier-item:active { cursor: grabbing; }
        .tier-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .view-mode .tier-item { cursor: pointer; width: 60px; height: 60px; }
        .view-mode .tier-row { min-height: 100px; }
        .mode-btn { font-size: 12px; padding: 4px 12px; border-radius: 6px; font-weight: bold; color: #6b7280; transition: 0.2s; }
        .mode-btn:hover { color: white; background: rgba(255,255,255,0.1); }
        .mode-btn.active { background: #2563eb; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Other Styles */
        .log-table { width: 100%; text-align: left; border-collapse: separate; border-spacing: 0 4px; }
        .log-table th { font-size: 12px; color: #6b7280; padding: 10px; text-transform: uppercase; }
        .log-row { background: #161b22; transition: 0.2s; }
        .log-row:hover { background: #1f2937; }
        .log-cell { padding: 12px 10px; font-size: 13px; border-top: 1px solid #374151; border-bottom: 1px solid #374151; }
        .log-cell:first-child { border-left: 1px solid #374151; border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .log-cell:last-child { border-right: 1px solid #374151; border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        .status-pill { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; }
        .status-pill.defeat { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #ef4444; }
        .status-pill.reset { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid #3b82f6; }
        .sync-badge { font-size: 12px; padding: 6px 12px; border-radius: 20px; font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; border: 1px solid; }
        .sync-cloud { background: rgba(16, 185, 129, 0.1); color: #34d399; border-color: #059669; }
        .sync-cloud.offline { background: rgba(239, 68, 68, 0.1); color: #f87171; border-color: #b91c1c; }
        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Class ‡∏ô‡∏µ‡πâ */
        .sync-cloud.loading { 
            animation: pulse 1s infinite; 
            background: rgba(245, 158, 11, 0.2); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡πâ‡∏° */
            border-color: #f59e0b; /* ‡∏Ç‡∏≠‡∏ö‡∏™‡πâ‡∏° */
            color: #fbbf24; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á */
            font-weight: 900;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); /* ‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á */
        }
        
        #view-war-room, #view-manager, #view-logs, #view-settings, #view-gallery, #view-tier-viewer, #view-tier-manager, #view-my-teams { display: none; height: 100%; }
        .tab-active { display: flex !important; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 60; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: #161b22; padding: 0; border-radius: 16px; border: 1px solid #30363d; width: 1000px; max-width: 95%; box-shadow: 0 20px 50px rgba(0,0,0,0.7); max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 16px 24px; background: #111827; border-bottom: 1px solid #374151; display: flex; flex-direction: column; gap: 12px; }
        .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
        
        .selector-card { position: relative; border: 1px solid #374151; background: #0d1117; border-radius: 12px; overflow: hidden; cursor: pointer; aspect-ratio: 1/1; }
        .selector-card:hover { border-color: #3b82f6; z-index: 10; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .selector-card img { width: 100%; height: 100%; object-fit: cover; }
        .selector-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.75); padding: 4px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .selector-text { font-size: 10px; font-weight: bold; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; }
        .selector-badge { position: absolute; top: 4px; right: 4px; z-index: 5; transform: scale(0.85); transform-origin: top right; }
        .selector-category-title { font-size: 12px; font-weight: bold; text-transform: uppercase; color: #9ca3af; padding: 8px 4px; margin-top: 10px; border-bottom: 1px solid #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .selector-grid-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-bottom: 16px; }
        
        .detail-row { display: flex; border-bottom: 1px solid #374151; padding: 12px 0; }
        .detail-label { width: 100px; font-size: 12px; color: #9ca3af; font-weight: bold; flex-shrink: 0; }
        .detail-val { flex: 1; }

        #contextMenu { display: none; position: absolute; z-index: 100; background: #161b22; border: 1px solid #30363d; padding: 10px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); min-width: 200px; }
        #textEditorMenu { display: none; position: absolute; z-index: 200; background: #1f2937; border: 1px solid #4b5563; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); min-width: 150px; overflow: hidden; }
        .ctx-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-bottom: 8px; }
        .ctx-btn { height: 28px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; border: 1px solid; display: flex; align-items: center; justify-content: center; }
        .ctx-btn.red { background: rgba(239,68,68,0.1); border-color: #7f1d1d; color: #fca5a5; }
        .ctx-btn.blue { background: rgba(56,189,248,0.1); border-color: #0c4a6e; color: #7dd3fc; }
        .ctx-btn.yellow { background: rgba(250,204,21,0.1); border-color: #713f12; color: #fde047; width: 100%; }
        .ring-option { padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; border: 1px solid transparent; transition: 0.2s; }
        .ring-option:hover { background: #21262d; border-color: #30363d; }
        .ring-option img { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #333; }
        .editor-menu-item { padding: 8px 12px; cursor: pointer; font-size: 12px; font-weight: bold; color: #e5e7eb; display: flex; align-items: center; gap: 8px; transition: 0.1s; }
        .editor-menu-item:hover { background: #374151; }
        .color-dot { width: 10px; height: 10px; border-radius: 50%; }

        /* --- CUSTOM TEXT COLORS (‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô <style>) --- */
        .text-orange { color: #f97316 !important; font-weight: bold; }
        .text-blue { color: #3b82f6 !important; font-weight: bold; }
        .text-red { color: #ef4444 !important; font-weight: bold; }
        .dmg-fire { color: #fca5a5; font-weight: bold; text-shadow: 0 0 5px rgba(252, 165, 165, 0.5); }
        .dmg-ice { color: #7dd3fc; font-weight: bold; text-shadow: 0 0 5px rgba(125, 211, 252, 0.5); }

        /* --- BATTLE RECORDER STYLES --- */
        .recorder-table th { font-size: 10px; color: #6b7280; text-transform: uppercase; padding: 4px; }
        .recorder-input { 
            width: 100%; background: #0d1117; border: 1px solid #374151; 
            border-radius: 4px; padding: 4px 8px; color: #fff; font-size: 11px; outline: none;
        }
        .recorder-input:focus { border-color: #3b82f6; background: #1f2937; }
        .autocomplete-list {
            position: absolute; top: 100%; left: 0; width: 100%; 
            background: #1f2937; border: 1px solid #374151; border-radius: 4px; 
            max-height: 150px; overflow-y: auto; z-index: 50; display: none;
        }
        .autocomplete-item {
            padding: 6px 8px; font-size: 11px; cursor: pointer; color: #d1d5db; display: flex; align-items: center; gap: 8px;
        }
        .autocomplete-item:hover, .autocomplete-item.selected { background: #3b82f6; color: white; }
        .autocomplete-item img { width: 20px; height: 20px; border-radius: 4px; background: black; }

        /* ‡πÉ‡∏™‡πà‡πÉ‡∏ô <style> */
        .item-level-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: #000;
            color: #4ade80; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
            border: 1px solid #22c55e;
            font-size: 9px;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 4px;
            z-index: 20;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏î‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏°‡∏î‡∏∏‡∏• */
        /* --- FINAL STAR ICON STYLES --- */
        .star-icon {
            font-size: 20px;
            line-height: 1;
            display: inline-block;
            filter: drop-shadow(0 0 2px rgba(0,0,0,1));
            /* ‡∏Ç‡∏¢‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô 1px ‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å -3.5px ‡πÄ‡∏õ‡πá‡∏ô -2.5px (‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á 1px) */
            margin: 0 -2.5px; 
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏î‡∏≤‡∏ß‡πÅ‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏™‡πâ‡∏°‡∏≠‡∏°‡πÅ‡∏î‡∏á (Red-Orange) */
        .star-red { color: #ff4500; text-shadow: 0 0 8px rgba(255, 69, 0, 0.6); }

        /* ‡∏™‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° */
        .star-yellow { color: #facc15; text-shadow: 0 0 3px #854d0e; }
        .star-blue { color: #38bdf8; text-shadow: 0 0 5px #0369a1; }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏î‡∏≤‡∏ß‡πÉ‡∏ô Slot */
        .star-row-slot {
            position: absolute;
            /* ‡∏Ç‡∏¢‡∏±‡∏ö‡∏•‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å 2px (‡∏à‡∏≤‡∏Å -1px ‡πÄ‡∏õ‡πá‡∏ô -3px) */
            bottom: -3px; 
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 15;
            pointer-events: none;
            background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
            padding-bottom: 4px;
            border-radius: 0 0 12px 12px;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Container ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ */
        .star-row-detail {
            display: flex;
            gap: -3px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Detail */
            margin-top: 8px;
        }
        /* --- CONTEXT MENU (‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤) --- */
        #sim-context-menu {
            position: absolute;
            z-index: 100;
            width: 150px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
            overflow: hidden;
        }

        .ctx-item {
            padding: 10px 15px;
            font-size: 12px;
            color: #c9d1d9;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .ctx-item:hover { background: #1f6feb; color: white; }
        .ctx-item.delete:hover { background: #da3633; }

        /* --- SKILL QUEUE BAR (‡πÅ‡∏ñ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß) --- */
        .skill-timeline {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            min-height: 40px;
        }
        .skill-node {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 2px 6px 2px 2px;
            border-radius: 20px;
            font-size: 10px;
            color: #8b949e;
        }
        .skill-node img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #30363d;
        }
        .skill-arrow { color: #58a6ff; font-size: 10px; }

        /* --- BUTTON CLEANUP --- */
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏•‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
        .btn-skill-ghost {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.4);
        }
        .btn-skill-ghost:hover { border-color: rgba(255,255,255,0.6); color: white; }
        .btn-skill-active {
            background: transparent;
            border: 1px solid #eab308;
            color: #eab308;
            text-shadow: 0 0 5px rgba(234,179,8,0.5);
            box-shadow: 0 0 5px rgba(234,179,8,0.2) inset;
        }
        /* --- MODERN TIER LIST STYLES --- */
        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏Å (Glassmorphism) */
        .glass-panel {
            background: rgba(17, 24, 39, 0.7); /* ‡∏™‡∏µ‡∏î‡∏≥‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á */
            backdrop-filter: blur(12px); /* ‡πÄ‡∏ö‡∏•‡∏≠‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); /* ‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß‡∏à‡∏≤‡∏á‡πÜ */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Rank Header Gradients (‡∏™‡∏µ‡πÑ‡∏•‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏π‡πÅ‡∏û‡∏á‡∏Ç‡∏∂‡πâ‡∏ô) */
        .rank-header {
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: 900; font-style: italic;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            width: 100px; flex-shrink: 0;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .rank-s { background: linear-gradient(135deg, #ef4444 0%, #7f1d1d 100%); color: #fee2e2; }
        .rank-a { background: linear-gradient(135deg, #f97316 0%, #c2410c 100%); color: #ffedd5; }
        .rank-b { background: linear-gradient(135deg, #eab308 0%, #a16207 100%); color: #fffbeb; text-shadow: 1px 1px 0 rgba(0,0,0,0.8); }
        .rank-c { background: linear-gradient(135deg, #22c55e 0%, #14532d 100%); color: #dcfce7; }
        .rank-d { background: linear-gradient(135deg, #64748b 0%, #334155 100%); color: #f1f5f9; }

        /* Item ‡πÉ‡∏ô Tier List */
        .tier-card {
            width: 64px; height: 64px;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
            border: 2px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }
        .tier-card:hover {
            transform: scale(1.15) translateY(-5px);
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
            z-index: 10;
        }
        
        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô <style> */
        #tier-bg-overlay {
            position: absolute; inset: 0; z-index: 1;
            
            /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô transparent (‡πÉ‡∏™ 100%) */
            background: transparent !important; 
            
            /* ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏•‡∏≠ */
            backdrop-filter: none !important; 
            -webkit-backdrop-filter: none !important;
            
            pointer-events: none;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */
        #tier-bg-container {
            position: absolute; inset: 0; z-index: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            
            /* ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏Ñ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ö‡∏≤‡∏á Browser */
            image-rendering: -webkit-optimize-contrast;
        }

        /* --- TIER LIST STYLES (UPDATED) --- */
        
        /* 1. ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ñ‡∏ß Ranking ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á (Compact) */
        /* Z-Index Handling for Row Backgrounds */
        .tier-row-modern {
            position: relative;
            display: flex;
            min-height: 80px; 
            margin-bottom: 6px;
            /* [‡πÅ‡∏Å‡πâ] ‡πÉ‡∏ä‡πâ background-color ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Default ‡πÅ‡∏ó‡∏ô none !important */
            background-color: rgba(17, 24, 39, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transition: 0.2s;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏° properties ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .tier-header-modern {
            width: 100px;
            display: flex;
            align-items: center;     
            justify-content: center; 
            flex-shrink: 0;
            padding: 4px;
            cursor: context-menu; 
            border-right: 1px solid rgba(255,255,255,0.1);
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏° transition ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• */
            transition: background 0.3s; 
        }

        /* [UPDATED] Rank Name Input */
        .rank-name-input {
            background: transparent;
            border: none;
            /* ‡∏•‡∏ö color: white; ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ style="color:..." ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
            font-weight: 900;
            font-size: 20px;
            text-align: center;
            width: 100%;
            outline: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡∏™‡∏µ */
            font-style: italic;
            cursor: text;
        }

        /* 3. Rank Context Menu (‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏ó‡∏µ‡πà Rank) */
        .custom-ctx-menu {
            position: fixed;
            z-index: 9999;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            padding: 4px;
            min-width: 150px;
            display: none;
        }
        .ctx-option {
            padding: 8px 12px;
            color: #c9d1d9;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ctx-option:hover { background: #1f6feb; color: white; }
        .ctx-option.delete:hover { background: #da3633; }

        /* 1. Sticker Layer (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö Event ‡πÑ‡∏î‡πâ) */
        #tier-sticker-layer {
            position: absolute; 
            inset: 0; 
            z-index: 50; /* ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Content (10-30) */
            pointer-events: none; /* ‡∏ï‡∏±‡∏ß Layer ‡πÑ‡∏°‡πà‡∏Ç‡∏ß‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏î */
            overflow: hidden;
        }
        /* 2. ‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (‡πÄ‡∏û‡∏¥‡πà‡∏° cursor ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ resize ‡πÑ‡∏î‡πâ) */
        .sticker-item {
            position: absolute;
            cursor: move; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô move */
            z-index: 50; 
            transition: transform 0.05s; /* ‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏¢‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏•‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
            user-select: none;
        }
        .sticker-item:hover {
            outline: 2px dashed rgba(255,255,255,0.6);
            cursor: grab;
        }
        .sticker-item:active {
            cursor: grabbing;
        }

        body.preview-mode #view-tier-viewer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999;
            background: #000;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
        /* 2. ‡∏õ‡∏∏‡πà‡∏° Exit Auto-hide */
        #exit-preview-btn {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ */
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 9999;
            background: rgba(220, 38, 38, 0.9); /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
            color: white; 
            padding: 10px 20px; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            
            /* Animation Transition */
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
            opacity: 1;
        }

        /* --- CSS FIX FOR POOL FOOTER --- */
        #tier-pool-footer {
            height: 350px;
            pointer-events: auto !important; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏∏‡πà‡∏°‡πÜ */
            background: rgba(11, 14, 20, 0.95);
            border-top: 1px solid #374151;
            backdrop-filter: blur(10px);
            z-index: 60; /* ‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Sticker (50) */
        }

        #pool-toggle-btn {
            pointer-events: auto !important;
            cursor: pointer;
        }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Hover Effect ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á */
        #pool-toggle-btn:hover {
            background-color: #374151; /* gray-700 */
            color: #ffffff;
        }

        /* Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° (JS ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° class ‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ idle) */
        body.preview-mode.ui-idle #exit-preview-btn {
            transform: translateX(150%); /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
            opacity: 0;
        }

        /* 3. Padding ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Full Screen */
        body.preview-mode #view-tier-viewer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999;
            background: #000;
        }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Padding ‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏Ç‡∏≠‡∏ö */
        body.preview-mode #tier-rows-container {
            padding: 60px !important; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö 60px */
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Full Screen */
        body.preview-mode .sidebar,
        body.preview-mode header, 
        body.preview-mode #tier-pool-footer,
        body.preview-mode #tier-settings-menu { /* ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢ */
            display: none !important;
        }
        
        /* ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Exit ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î Full Screen */
        body.preview-mode #exit-preview-btn {
            display: block;
        }

        /* --- SIDEBAR TRANSITION --- */
        .sidebar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡∏≠‡∏ô‡∏´‡∏∏‡∏ö */
        }

        /* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π */
        .sidebar.collapsed {
            width: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            opacity: 0;
            overflow: hidden;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π (‡πÅ‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢ ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á) */
        #sidebar-floating-btn {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏î‡πâ‡∏ß‡∏¢ JS) */
            position: absolute;
            
            /* --- ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á --- */
            left: 0;
            top: 50%;
            transform: translateY(-50%); /* ‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ 50% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏õ‡πä‡∏∞ */
            z-index: 60;

            /* --- ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏õ‡∏∏‡πà‡∏° --- */
            background: #1f2937;
            border: 1px solid #374151;
            border-left: none; /* ‡πÄ‡∏≠‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô */
            
            /* ‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ (‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤, ‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤) */
            border-radius: 0 12px 12px 0; 
            
            /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
            padding: 24px 6px; /* ‡∏™‡∏π‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÅ‡∏Ñ‡∏ö‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
            color: #60a5fa;    /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
            
            cursor: pointer;
            box-shadow: 4px 0 15px rgba(0,0,0,0.5); /* ‡πÄ‡∏á‡∏≤‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* ‡∏à‡∏±‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ */
        #sidebar-floating-btn:hover {
            background: #374151;
            color: white;
            padding-left: 10px; /* ‡∏¢‡∏∑‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á */
            box-shadow: 6px 0 20px rgba(59, 130, 246, 0.4); /* ‡πÄ‡∏á‡∏≤‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á */
        }

        /* --- ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô Panel ‡∏®‡∏±‡∏ï‡∏£‡∏π (‡∏Ç‡πâ‡∏≠ 4) --- */
        .enemy-panel-hidden {
            display: none !important;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Transition ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡∏î‡∏π‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏• */
        .enemy-panel-transition {
            transition: all 0.3s ease-in-out;
            max-height: 500px;
            opacity: 1;
            overflow: hidden;
        }
        .enemy-panel-hidden {
            max-height: 0 !important;
            padding: 0 !important;
            opacity: 0 !important;
            border: none !important;
        }

        /* ‡∏õ‡∏£‡∏±‡∏ö Scrollbar ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
        .battle-scroll::-webkit-scrollbar { width: 6px; }
        .battle-scroll::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }


        /* --- BATTLE RECORDER: BIG & CENTERED --- */
        .rec-slot-container {
            width: 80px;  /* üü¢ ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î */
            height: 80px; /* üü¢ ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î */
            position: relative;
            background-color: #0d1117;
            border: 1px solid #374151;
            border-radius: 12px 12px 0 0; /* ‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .rec-slot-container:hover { border-color: #3b82f6; transform: translateY(-2px); }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏Å‡∏¥‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        .skill-btn-group {
            width: 80px; /* üü¢ ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á */
            display: flex;
            border: 1px solid #374151;
            border-top: none;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            height: 24px; /* üü¢ ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢ */
        }

        .rec-slot-img {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; border-radius: 10px 10px 0 0; opacity: 0.8; pointer-events: none;
        }

        .rec-slot-input {
            position: absolute; inset: 0; width: 100%; height: 100%;
            background: transparent; border: none; outline: none;
            text-align: center; color: white; font-weight: bold; font-size: 12px; /* üü¢ ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
            z-index: 10; text-shadow: 0 1px 3px black;
        }
        .rec-slot-input:focus { background: rgba(0, 0, 0, 0.85); color: #fbbf24; border-radius: 10px 10px 0 0;}
        .rec-slot-input::placeholder { color: #6b7280; font-weight: normal; font-size: 11px; }

        /* List ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
        .autocomplete-list {
            top: 85px !important;
            width: 160px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
        }

        /* Floating Text Style (‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô Tier List) */
        .floating-label {
            position: absolute;
            cursor: move;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fbbf24;
            padding: 4px 12px;
            border: 1px dashed #fbbf24;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1.2rem;
            z-index: 1000;
            min-width: 50px;
            text-align: center;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);

            /* Properties ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
        }

        .floating-label:focus {
            background-color: rgba(0, 0, 0, 0.9);
            border: 1px solid #fff;
            color: #fff;
            cursor: text;
            outline: none;
        }

        #tier-canvas {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ Scroll ‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô auto */
            background-size: cover;
            background-position: center;
            cursor: grab; /* ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ (‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï) */
        }

        /* ‡πÅ‡∏ñ‡∏ß Tier (‡πÅ‡∏õ‡∏•‡∏á‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô Object ‡∏•‡∏≠‡∏¢‡πÑ‡∏î‡πâ) */
        .tier-row-modern {
            position: absolute !important; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏≠‡∏¢‡∏ï‡∏±‡∏ß */
            display: flex;
            min-height: 80px;
            width: auto;
            min-width: 300px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î */
            
            /* Design ‡πÄ‡∏î‡∏¥‡∏° */
            background-color: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô */
            
            /* ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° */
            transform-origin: top left; /* ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô */
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            user-select: none;
            transition: box-shadow 0.2s, border-color 0.2s; /* ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà transition transform ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å */
        }

        /* ‡∏ï‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß */
        .tier-row-modern.dragging {
            z-index: 1000 !important; /* ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
            border-color: #3b82f6;
            cursor: grabbing;
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏ö‡∏•‡∏≤‡∏Å) */
        .tier-header-modern {
            width: 80px;
            flex-shrink: 0;
            cursor: move; /* ‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏¢‡πâ‡∏≤‡∏¢ */
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        /* ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£) */
        .tier-content {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-content: flex-start;
            min-height: 80px;
            min-width: 200px;
        }

        /* ‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏Å‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏∞‡∏à‡∏≠‡∏¢‡∏Å‡∏±‡∏ô (Snapping Line) - Optional */
        .snap-guide {
            position: absolute;
            height: 2px;
            background-color: #3b82f6;
            width: 100%;
            z-index: 900;
            display: none;
            pointer-events: none;
        }
    </style>
</head>
<body class="flex" onclick="closeContextMenu(); closeTextContextMenu();">

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <div id="update-notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[300] hidden">
        <div class="bg-blue-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-4 border border-blue-400 animate-bounce">
            <span class="text-xl">üîî</span>
            <div class="flex flex-col">
                <span class="text-xs font-bold text-blue-200 uppercase">New Data Available</span>
                <span class="text-sm font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</span>
            </div>
            <button onclick="applyPendingUpdate()" class="bg-white text-blue-700 px-4 py-1 rounded-full font-bold text-xs hover:bg-blue-50 transition shadow-md border border-blue-200">
                ‚Üª Refresh Data
            </button>
            <button onclick="dismissUpdate()" class="text-blue-300 hover:text-white text-lg font-bold ml-2">‚úï</button>
        </div>
    </div>

    <div id="login-screen" class="fixed inset-0 z-[200] bg-[#0b0e14] flex flex-col items-center justify-center font-['Kanit']">
        <div class="bg-[#161b22] p-8 rounded-2xl border border-gray-700 shadow-[0_0_50px_rgba(59,130,246,0.2)] w-full max-w-sm text-center relative overflow-hidden">
            
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 via-purple-600 to-blue-600"></div>

            <div class="text-4xl mb-2">üõ°Ô∏è</div>
            <h1 class="text-2xl font-bold text-white tracking-wider mb-1">7K Seven Deadly Sins</h1>
            <p class="text-xs text-gray-500 mb-8">Guild Management System</p>

            <form onsubmit="event.preventDefault(); doLogin();" class="space-y-4">
                <div class="text-left">
                    <label class="text-[10px] text-gray-400 font-bold uppercase ml-1">Username</label>
                    <input type="text" id="login-user" class="w-full bg-[#0d1117] border border-gray-600 text-white p-3 rounded-lg outline-none focus:border-blue-500 transition" required placeholder="Enter username">
                </div>
                
                <div class="text-left">
                    <label class="text-[10px] text-gray-400 font-bold uppercase ml-1">Password</label>
                    <input type="password" id="login-pass" class="w-full bg-[#0d1117] border border-gray-600 text-white p-3 rounded-lg outline-none focus:border-blue-500 transition" required placeholder="Enter password">
                </div>

                <button type="submit" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2">
                    <span>üîì</span> Login
                </button>
            </form>

            <div id="login-msg" class="text-red-400 text-xs mt-4 min-h-[20px]"></div>
        </div>
        <div class="text-gray-600 text-[10px] mt-4">Authorized Access Only</div>
    </div>

    <aside class="sidebar w-72 flex-col h-full flex overflow-y-auto no-scroll flex-shrink-0" id="main-sidebar">
        <div class="p-6 border-b border-gray-800 flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-yellow-500 italic tracking-wider">7K COMMANDER</h1>
                <p class="text-xs text-gray-500 mt-1">Seven Deadly Sins</p>
                <div class="py-2 mb-2 text-xs text-gray-500">
                    User: <span id="display-username" class="text-blue-400 font-bold">...</span>
                </div>
            </div>
            <button onclick="toggleSidebar()" class="text-gray-500 hover:text-white p-1 px-2 rounded hover:bg-gray-800 transition" title="‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π">
                ‚óÄ
            </button>
        </div>
        <div class="p-4 flex-1 flex flex-col">
            <div class="menu-section-title">Main</div>
            <div onclick="switchView('preparation')" class="menu-item text-green-400" id="nav-preparation">üß† PREPARATION (AI)</div>
            <div onclick="switchView('simulator')" class="menu-item" id="nav-simulator">üéÆ Battle Simulator</div>
            <div onclick="switchView('hero-lists')" class="menu-item">üìã Hero Lists & Usage</div>
            <div onclick="switchView('gallery')" class="menu-item" id="nav-gallery">üñºÔ∏è Gallery</div>
            <div onclick="switchView('tier-viewer')" class="menu-item" id="nav-tier-viewer">üèÜ Tier Lists</div>

            <div class="my-4 pt-4 border-t border-gray-800">
                <div class="menu-section-title">Database Manager</div>
                <div onclick="switchView('hero-manager')" class="menu-item" id="nav-hero-manager">ü¶∏ Heroes</div>
                <div onclick="switchView('pet-manager')" class="menu-item" id="nav-pet-manager">üêæ Pets</div>
                <!-- <div onclick="switchView('item-manager')" class="menu-item" id="nav-item-manager">‚öîÔ∏è Items</div> -->
                <div onclick="switchView('ring-manager')" class="menu-item" id="nav-ring-manager">üíç Rings</div>
                <!-- <div onclick="switchView('set-manager')" class="menu-item" id="nav-set-manager">‚öîÔ∏è Team Sets</div> -->
            </div>

            <!-- <div class="my-4 pt-4 border-t border-gray-800">
                <div class="menu-section-title">War Manager</div>
                <div onclick="switchView('battle-war')" class="menu-item" id="nav-battle-war">‚öîÔ∏è Battle War</div>
                <div onclick="openRecorder()" class="menu-item text-indigo-400" id="nav-battle-record">üìù Battle Record (Multi)</div>
                <div onclick="switchView('battle-history')" class="menu-item" id="nav-battle-history">üìú Battle History</div>
            </div> -->

            <div id="admin-menu-group" class="mt-4 pt-4 border-t border-gray-800" style="display: none;">
                <div class="menu-section-title text-red-400">Admin Zone</div>
                <div onclick="switchView('user-manager')" class="menu-item" id="nav-user-manager">üë• User Management</div>
                <div onclick="switchView('audit-logs')" class="menu-item" id="nav-audit-logs">üïµÔ∏è System Audit Logs</div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-800">
                <!-- <div class="mt-auto pt-4 border-t border-gray-800"> -->
                <div onclick="logout()" class="menu-item text-red-400 hover:text-red-300">üö™ Logout</div>
                <div onclick="switchView('settings')" class="menu-item text-gray-400 hover:text-white" id="nav-settings">‚öôÔ∏è Setting</div>
            </div>
        </div>
    </aside>

    <main class="flex-1 bg-[#0d1117] h-full overflow-hidden relative">
        <div id="sidebar-floating-btn" onclick="toggleSidebar()" title="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π" style="display: none;">
            ‚ùØ
        </div>

        <div id="view-home" class="flex-col h-full items-center justify-center bg-[#0b0e14] hidden">
            <div class="text-center opacity-40 select-none">
                <div class="text-8xl mb-6 filter drop-shadow-[0_0_20px_rgba(59,130,246,0.3)]">üõ°Ô∏è</div>
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2 tracking-widest">7K Seven Deadly Sins</h1>
                <p class="text-gray-500 text-sm font-mono">System Ready. Select a menu to start.</p>
            </div>
        </div>

        <div id="view-war-room" class="tab-active flex-col relative h-full">
            <div id="war-room-empty" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-[#0b0e14]">
                <div class="text-6xl mb-4 animate-bounce">üè∞</div>
                <h2 class="text-3xl font-bold text-white mb-2">Guild War Room</h2>
                <p class="text-gray-500 mb-8 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°‡∏Å‡∏¥‡∏•‡∏î‡πå</p>
                
                <div class="bg-[#161b22] p-8 rounded-2xl border border-gray-700 shadow-2xl text-center max-w-md w-full">
                    <div class="text-purple-400 font-bold text-xl mb-6">PREPARATION PHASE</div>
                    <div class="text-gray-400 text-sm mb-6">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ<br>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° Season ‡πÉ‡∏´‡∏°‡πà
                    </div>
                    <button onclick="startNewSeasonInput()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-blue-900/50 transition transform hover:scale-105 flex items-center justify-center gap-3">
                        <span>‚öîÔ∏è</span> ‡πÄ‡∏£‡∏¥‡πà‡∏° Season ‡πÉ‡∏´‡∏°‡πà (Start)
                    </button>
                </div>
            </div>

            <div id="war-room-interface" class="flex flex-col h-full hidden">
                <header class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center flex-shrink-0 shadow-lg z-20">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-4">
                            <h2 id="castle-title" class="text-3xl font-bold text-white">‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡∏ô‡∏≠‡∏Å 4</h2>
                            <div id="sync-status" class="sync-badge sync-cloud"><div class="w-2 h-2 rounded-full bg-current"></div><span id="status-text">OFFLINE</span></div>
                        </div>
                        <div class="flex items-center gap-2 mt-1 text-xs text-gray-400">
                            <span class="bg-purple-900 text-purple-200 px-2 py-0.5 rounded border border-purple-700 font-bold" id="gw-season-badge">Season -</span>
                            <span>VS</span>
                            <span class="text-red-400 font-bold text-sm" id="gw-opponent-name">Waiting...</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button id="btn-end-season" onclick="endGuildWarRound()" class="bg-red-900/80 hover:bg-red-800 text-red-200 px-4 py-2 rounded-lg text-xs font-bold border border-red-700 flex items-center gap-2 transition">
                            <span>üèÅ</span> ‡∏à‡∏ö Season (End)
                        </button>
                        <div class="w-px h-8 bg-gray-700 mx-2"></div>
                        <button onclick="triggerAutoSave(true)" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg text-sm font-bold border border-blue-400 shadow-lg transition transform hover:scale-105">üíæ Save Now</button>
                        <button id="btn-clear-room" onclick="clearCastle()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-2 rounded-lg text-sm font-bold border border-gray-600 transition">üßπ Clear Room</button>
                    </div>
                </header>
                
                <div id="castle-selector-bar" class="p-3 bg-[#111827] border-b border-gray-800 flex flex-col gap-2 shadow-inner z-10 flex-shrink-0"></div>
                <div id="dashboard-container" class="p-8 overflow-y-auto no-scroll h-full pb-40"></div>
            </div>
        </div>

        <div id="view-preparation" class="flex-col hidden h-full relative bg-[#0b0e14]">
            <header class="p-4 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg z-20 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">
                        ü§ñ AI BATTLE ANALYZER
                    </h2>
                    <div class="text-xs text-gray-500">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ä‡∏ô‡∏∞</div>
                </div>
                <button onclick="resetPreparation()" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded text-xs font-bold border border-gray-600">Reset Board</button>
            </header>

            <div class="flex-1 flex overflow-hidden">
                
                <div class="flex-1 overflow-y-auto custom-scroll p-4 relative bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
                    <div class="flex flex-col items-center gap-6 pb-24 w-full max-w-3xl mx-auto mt-4">
                        
                        <div class="w-full relative group">
                            <div class="absolute -top-3 left-4 z-20 bg-red-900 text-red-100 text-xs font-bold px-3 py-1 rounded border border-red-500 shadow-md">
                                üëπ ENEMY (Target)
                            </div>
                            <div id="prep-enemy-area"></div>
                        </div>

                        <div class="flex items-center justify-center relative -my-2 z-10">
                            <div class="bg-gradient-to-r from-transparent via-gray-700 to-transparent h-px w-full absolute"></div>
                            <div class="bg-[#0b0e14] border-2 border-yellow-500 rounded-full w-10 h-10 flex items-center justify-center text-yellow-500 font-black text-sm shadow-[0_0_15px_rgba(234,179,8,0.5)] relative z-10">VS</div>
                        </div>

                        <div class="w-full relative">
                            <div class="absolute -top-3 left-4 z-20 bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded border border-blue-400 shadow-md">
                                üõ°Ô∏è MY SQUAD
                            </div>
                            <div id="prep-my-area"></div>
                        </div>

                    </div>
                </div>

                <div class="w-80 xl:w-96 bg-[#111827] border-l border-gray-800 flex flex-col flex-shrink-0 z-20 shadow-2xl">
                    <div class="p-4 border-b border-gray-800 font-bold text-gray-400 text-xs uppercase tracking-wider bg-[#1f2937]">
                        üìä Tactical Analysis
                    </div>
                    <div id="prep-ai-panel" class="p-4 overflow-y-auto flex-1 custom-scroll">
                        <div class="flex items-center justify-center h-full text-gray-500 animate-pulse">
                            Loading AI...
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="view-my-teams" class="flex-col hidden h-full">
            <header class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg z-10 flex-shrink-0">
                <div>
                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                        <span>üìä</span> Guild War Results
                    </h2>
                    <div class="text-xs text-gray-500 mt-1">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <select id="season-selector" onchange="switchSeasonData(this.value)" class="bg-[#0d1117] border border-gray-600 text-white text-xs px-3 py-2 rounded-lg outline-none font-bold uppercase tracking-wider hover:border-blue-500 transition">
                            <option value="current">‚ö° Current Season</option>
                            </select>
                    </div>

                    <div class="h-8 w-px bg-gray-700 mx-2"></div>

                    <button onclick="triggerAutoSave(true)" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2">
                        <span>üíæ</span> Save
                    </button>
                </div>
            </header>
            
            <div class="flex h-full overflow-hidden bg-[#0d1117]">
                
                <div class="w-80 border-r border-gray-800 bg-[#111827] flex flex-col flex-shrink-0">
                    <div class="p-3 bg-[#1f2937] border-b border-gray-700 flex flex-col gap-2">
                        <div class="flex justify-between items-center text-xs font-bold text-gray-400 uppercase">
                            <span>Members</span>
                            <span id="total-gw-stat" class="text-blue-400">Loading...</span>
                        </div>
                        <input type="text" onkeyup="filterGuildMemberUI(this.value)" placeholder="Find member..." class="w-full bg-[#0d1117] border border-gray-600 rounded px-3 py-1.5 text-xs text-white outline-none focus:border-blue-500">
                    </div>
                    
                    <div id="guild-member-list" class="overflow-y-auto flex-1 p-2 space-y-1 custom-scroll">
                        </div>
                </div>

                <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
                    
                    <div id="member-history-header" class="p-4 border-b border-gray-800 bg-[#161b22]/90 backdrop-blur flex justify-between items-center flex-shrink-0 hidden">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-blue-900 flex items-center justify-center text-xl font-bold text-white border-2 border-blue-500" id="hist-mem-icon">1</div>
                            <div>
                                <h3 class="text-xl font-bold text-white" id="hist-mem-name">Member Name</h3>
                                <div class="text-xs text-gray-400" id="hist-mem-summary">Stats...</div>
                            </div>
                        </div>
                    </div>

                    <div id="member-history-content" class="p-6 overflow-y-auto flex-1 pb-20 custom-scroll">
                        <div class="flex flex-col items-center justify-center h-full text-gray-500 opacity-50">
                            <div class="text-6xl mb-4">üëà</div>
                            <div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="view-gallery" class="flex-col">
            <header class="p-6 border-b border-gray-800 bg-[#161b22] flex-col gap-4 shadow-lg z-10">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">Gallery</h2>
                    <div class="relative"><span class="absolute left-3 top-2.5 text-gray-500">üîç</span><input type="text" id="gallery-search" onkeyup="renderGallery()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠..." class="bg-[#0d1117] border border-gray-600 text-white pl-10 pr-4 py-2 rounded-lg outline-none w-64 focus:border-blue-500"></div>
                </div>
                <div class="flex border-b border-gray-700 mb-4">
                    <div onclick="switchGalleryTab('hero')" class="tab-btn active" id="tab-gallery-hero">HEROES</div>
                    <div onclick="switchGalleryTab('pet')" class="tab-btn" id="tab-gallery-pet">PETS</div>
                </div>
                <div id="gallery-filters" class="flex flex-col gap-3"></div>
            </header>
            <div class="p-8 overflow-y-auto bg-[#0d1117] h-full"><div id="gallery-container"></div></div>
        </div>

        <div id="view-tier-viewer" class="flex-col relative h-full overflow-hidden">
            <div id="tier-bg-container" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-500" style="background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2072');"></div>
            <div id="tier-bg-overlay" class="absolute inset-0 z-0 bg-transparent pointer-events-none"></div>
            
            <div id="tier-sticker-layer"></div>

            <div class="relative z-10 flex flex-col h-full pointer-events-none">
                <header class="p-4 flex justify-between items-center pointer-events-auto relative z-50">
                    <div class="flex items-center gap-4">
                        <div id="tv-mode-selector" class="flex bg-black/60 backdrop-blur rounded-lg p-1 border border-white/10"></div>
                    </div>
                    
                    <div class="flex gap-2 relative">
                        <button onclick="togglePreviewMode()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-lg flex items-center gap-2 border border-indigo-400"><span>üëÅÔ∏è</span> Full Screen</button>
                        
                        <div class="relative">
                            <button onclick="toggleTierSettings()" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-lg flex items-center gap-2 border border-gray-600"><span>üé®</span> Customize</button>
                            <div id="tier-settings-menu" class="hidden absolute right-0 top-12 w-72 bg-[#161b22] border border-gray-600 rounded-xl shadow-2xl p-4 animate-fade-in z-[100]">
                                <div class="text-[10px] text-blue-400 font-bold uppercase mb-2">Change Background</div>
                                <input type="text" placeholder="BG Image URL..." class="w-full bg-black/50 border border-gray-600 rounded px-2 py-1.5 text-xs text-white outline-none mb-3" onchange="setTierBg(this.value)">
                                </div>
                        </div>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto px-8 pb-40 custom-scroll pointer-events-auto relative" id="tier-canvas" oncontextmenu="openTierContextMenu(event)">
                    <div id="snap-line-top" class="snap-guide"></div>
                    <div id="snap-line-bottom" class="snap-guide"></div>
                </div>
            </div>

            <div id="tier-pool-footer" class="absolute bottom-0 left-0 right-0 h-64 z-[60] flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transition-transform duration-300 translate-y-full">
                <div id="pool-toggle-btn" onclick="toggleTierPool()" class="absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-1.5 rounded-t-xl hover:bg-gray-700 font-bold text-xs border-t border-x border-gray-600 flex items-center gap-2 shadow-lg cursor-pointer h-8">
                    <span id="pool-toggle-icon">‚ñ≤</span> UNRANKED POOL (<span id="pool-count">0</span>)
                </div>

                <div class="bg-gray-900 border-b border-gray-700 px-4 py-2 flex justify-center items-center gap-2 shadow-md shrink-0">
                    <button onclick="switchTierTab('hero')" id="pool-tab-hero" class="px-6 py-1 rounded text-xs font-bold transition border border-transparent hover:border-blue-500 bg-blue-600 text-white shadow-lg">
                        ü¶∏ HEROES
                    </button>
                    <button onclick="switchTierTab('pet')" id="pool-tab-pet" class="px-6 py-1 rounded text-xs font-bold transition border border-gray-600 text-gray-400 hover:text-white hover:bg-gray-700">
                        üêæ PETS
                    </button>
                </div>

                <div class="flex-1 p-4 overflow-y-auto flex flex-wrap gap-2 content-start bg-[#0b0e14]/95 backdrop-blur-md" id="tier-pool-content" ondragover="tierAllowDrop(event)" ondrop="tierDrop(event, 'pool')"></div>
            </div>

            <div id="exit-preview-btn" onclick="togglePreviewMode()">‚ùå EXIT</div>

            <div id="rank-context-menu" class="custom-ctx-menu w-64 fixed hidden z-[2000]">
                <div class="p-3 border-b border-gray-700 bg-gray-800/90 rounded-t-lg backdrop-blur relative">
                    <button onclick="closeCtxMenus()" class="absolute top-2 right-2 text-gray-400 hover:text-white font-bold text-xs">‚úï</button>
                    <div class="text-[10px] text-gray-400 font-bold uppercase mb-2">üé® Style & Appearance</div>
                    
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-gray-300">‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (Text)</span>
                        <input type="color" id="ctx-rank-color" class="w-6 h-6 rounded cursor-pointer bg-transparent border-none p-0" oninput="updateRankStyle('color', this.value)">
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-300">‡∏™‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Header BG)</span>
                        <div class="flex gap-2">
                            <button onclick="updateRankStyle('headerBg', '')" class="text-[10px] bg-gray-600 px-1 rounded text-white" title="‡πÉ‡∏ä‡πâ‡∏™‡∏µ Default">Auto</button>
                            <input type="color" id="ctx-header-bg" class="w-6 h-6 rounded cursor-pointer bg-transparent border-none p-0" oninput="updateRankStyle('headerBg', this.value)">
                        </div>
                    </div>

                    <div class="mb-2">
                        <div class="flex justify-between text-xs text-gray-300 mb-1">
                            <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö‡πÅ‡∏™‡∏á‡πÅ‡∏ñ‡∏ß (Opacity)</span>
                            <span id="ctx-opacity-val">60%</span>
                        </div>
                        <input type="range" id="ctx-rank-opacity" min="0" max="100" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer" oninput="updateRankStyle('opacity', this.value)">
                    </div>

                    <div class="mb-1">
                        <span class="text-xs text-gray-300 block mb-1">‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ñ‡∏ß (URL)</span>
                        <input type="text" id="ctx-rank-bg" placeholder="Paste Image URL..." class="w-full bg-black/50 border border-gray-600 rounded px-2 py-1 text-xs text-white outline-none" onchange="updateRankStyle('bg', this.value)">
                    </div>
                </div>
                
                <div class="p-1 bg-gray-800 rounded-b-lg border border-t-0 border-gray-600">
                    <div onclick="addNewRank()" class="ctx-option text-green-400 hover:bg-gray-700 p-2 rounded cursor-pointer flex gap-2 text-xs">‚ûï ‡πÅ‡∏ó‡∏£‡∏Å Rank ‡πÉ‡∏´‡∏°‡πà</div>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <div onclick="moveRank(-1)" class="ctx-option hover:bg-gray-700 p-2 rounded cursor-pointer flex gap-2 text-xs text-gray-300">‚¨ÜÔ∏è ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô</div>
                    <div onclick="moveRank(1)" class="ctx-option hover:bg-gray-700 p-2 rounded cursor-pointer flex gap-2 text-xs text-gray-300">‚¨áÔ∏è ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á</div>
                    <div class="h-px bg-gray-700 my-1"></div>
                    <div onclick="deleteRank()" class="ctx-option delete hover:bg-red-900/50 text-red-400 p-2 rounded cursor-pointer flex gap-2 text-xs">üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ</div>
                </div>
            </div>
            
            <div id="item-context-menu" class="custom-ctx-menu fixed hidden bg-gray-800 border border-gray-600 rounded p-1 z-[2000]">
                <div onclick="convertItemToSticker()" class="ctx-option hover:bg-gray-700 p-2 rounded cursor-pointer text-gray-300 text-xs">üéà ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (Float)</div>
                <div onclick="removeItemFromTier()" class="ctx-option delete hover:bg-red-900/50 text-red-400 p-2 rounded cursor-pointer text-xs">‚¨áÔ∏è ‡πÄ‡∏≠‡∏≤‡∏•‡∏á Pool</div>
            </div>

            <div id="sticker-context-menu" class="custom-ctx-menu fixed hidden bg-gray-800 border border-gray-600 rounded p-1 z-[2000]">
                <div onclick="resetSticker()" class="ctx-option text-yellow-400 hover:bg-gray-700 p-2 rounded cursor-pointer text-xs">‚Ü∫ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡∏ô‡∏≤‡∏î (Reset)</div>
                <div class="h-px bg-gray-700 my-1"></div>
                <div onclick="deleteSticker()" class="ctx-option delete hover:bg-red-900/50 text-red-400 p-2 rounded cursor-pointer text-xs">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ (Delete)</div>
            </div>

            <div id="tier-context-menu" class="fixed hidden bg-gray-800 border border-gray-600 shadow-xl rounded-lg py-1 z-[2000] w-40 font-['Kanit']">
                <div onclick="addTextAtContextLocation()" class="px-4 py-2 hover:bg-gray-700 cursor-pointer text-white text-sm flex items-center gap-2 transition">
                    <span>‚úé</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                </div>
                <div onclick="resetTierList()" class="px-4 py-2 hover:bg-red-900/50 hover:text-red-200 cursor-pointer text-gray-300 text-sm flex items-center gap-2 border-t border-gray-700 mt-1 transition">
                    <span>üóëÔ∏è</span> Reset ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </div>
            </div>

            <div id="tier-text-menu" class="fixed hidden bg-gray-800 border border-gray-600 shadow-xl rounded-lg py-1 z-[2000] w-48 font-['Kanit']">
                <div onclick="setTextBackground()" class="px-4 py-2 hover:bg-gray-700 cursor-pointer text-white text-sm flex items-center gap-2 transition">
                    <span>üåÑ</span> ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (Set BG)
                </div>
                <div onclick="clearTextBackground()" class="px-4 py-2 hover:bg-gray-700 cursor-pointer text-gray-300 text-sm flex items-center gap-2 transition">
                    <span>üé®</span> ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (Clear BG)
                </div>
                <div onclick="deleteFloatingText()" class="px-4 py-2 hover:bg-red-900/50 hover:text-red-200 cursor-pointer text-red-400 text-sm flex items-center gap-2 border-t border-gray-700 transition mt-1">
                    <span>üóëÔ∏è</span> ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Delete)
                </div>
            </div>

        </div>

        <div id="view-set-manager" class="flex-col hidden h-full"> 
            <header class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg z-10 flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">Manage Hero Sets (‡∏ó‡∏µ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ)</h2>
                <button onclick="addNewHeroSet()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg transition transform hover:scale-105">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á Set ‡πÉ‡∏´‡∏°‡πà</button>
            </header>
    
            <div class="flex h-full overflow-hidden">
        
                <div class="w-96 border-r border-gray-800 bg-[#111827] overflow-y-auto no-scroll p-4 space-y-1" id="set-manager-list">
                </div>
        
                <div class="flex-1 p-8 overflow-y-auto bg-[#0d1117] flex flex-col items-center">
                    <div id="set-manager-empty" class="flex flex-col items-center justify-center mt-20 text-gray-500">
                        <div class="text-6xl mb-4 opacity-20">‚öîÔ∏è</div>
                        <div class="text-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Set ‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
                    </div>
            
            <div id="set-manager-editor" class="hidden w-full max-w-4xl bg-[#161b22] border border-gray-700 rounded-2xl p-6 shadow-xl relative animate-fade-in">
                </div>
            
                    <button id="btn-save-set" onclick="saveHeroSets()" class="hidden mt-6 bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                        <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Save All)
                    </button>
                </div>
            </div>
        </div>

        <div id="view-battle-war" class="flex-col hidden h-full bg-[#0b0e14]">
            <header class="p-4 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg flex-shrink-0 z-20">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class="text-gray-500">‚öîÔ∏è</span> Battle War Recorder
                    </h2>
                    <div class="text-xs text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Formation ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <span class="text-yellow-500">WINNER</span> ‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö</div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto custom-scroll p-6 relative bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
                
                <div class="max-w-4xl mx-auto flex flex-col gap-8 pb-40">
                    
                    <div class="relative w-full transition-all duration-300">
                        <div class="flex justify-between items-end mb-1 px-1">
                            <div class="text-xs font-bold text-blue-400 uppercase tracking-widest">üõ°Ô∏è My Team</div>
                            <button onclick="clearSimTeam('BW-MY')" class="text-[9px] text-gray-600 hover:text-red-400 transition">Clear</button>
                        </div>
                        <div id="bw-my-area"></div>
                    </div>

                    <div class="flex items-center justify-center relative -my-4 z-10 opacity-20">
                        <div class="bg-gray-800 h-px w-full absolute"></div>
                        <div class="bg-[#0b0e14] border border-gray-700 rounded-full w-8 h-8 flex items-center justify-center text-gray-600 font-bold text-[10px] relative z-10 select-none">VS</div>
                    </div>

                    <div class="relative w-full transition-all duration-300">
                        <div class="flex justify-between items-end mb-1 px-1">
                            <div class="text-xs font-bold text-red-400 uppercase tracking-widest">üëπ Enemy Team</div>
                            <button onclick="clearSimTeam('BW-ENEMY')" class="text-[9px] text-gray-600 hover:text-red-400 transition">Clear</button>
                        </div>
                        <div id="bw-enemy-area"></div>
                    </div>

                </div>
            </div>
        </div>

        <div id="view-logs" class="flex-col">
            <header class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center flex-shrink-0 shadow-lg">
                <h2 class="text-2xl font-bold text-white">Battle Logs</h2>
                <div class="flex gap-2">
                    <button onclick="viewArchives()" class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded border border-gray-500">üìÇ ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡πà‡∏≤</button>
                    <button onclick="clearHistoryDB()" class="text-xs text-red-500 hover:text-white border border-red-900 px-3 py-1 rounded">Clear Logs</button>
                </div>
            </header>
            <div class="p-8 overflow-y-auto bg-[#0d1117] h-full"><table class="log-table"><thead><tr><th>Time</th><th>Castle</th><th>Slot</th><th>Player</th><th>Status</th></tr></thead><tbody id="log-list-body"></tbody></table></div>
        </div>

        <div id="archiveModal" class="modal-overlay" style="z-index: 90;">
            <div class="modal-content">
                <div class="p-4 border-b border-gray-700 bg-[#1f2937] flex justify-between items-center">
                    <h3 class="text-white font-bold">üóÑÔ∏è Season Archives</h3>
                    <button onclick="document.getElementById('archiveModal').style.display='none'" class="text-gray-400 font-bold">‚úï</button>
                </div>
                <div class="p-4 bg-[#0d1117] h-[600px] overflow-hidden flex">
                    <div id="arc-season-list" class="w-1/3 border-r border-gray-700 pr-2 overflow-y-auto space-y-2"></div>
                    <div id="arc-log-detail" class="w-2/3 pl-4 overflow-y-auto">
                        <div class="text-gray-500 text-center mt-20">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Season ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-settings" class="flex-col">
            <header class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg">
                <h2 class="text-2xl font-bold text-white">System Settings</h2>
            </header>
            <div class="p-8 flex justify-center">
                <div class="bg-[#161b22] p-8 rounded-2xl border border-gray-700 w-full max-w-2xl shadow-xl">
                    <h3 class="text-xl font-bold text-yellow-500 mb-6 flex items-center gap-2"><span>‚òÅÔ∏è</span> Google Sheets / Cloud Sync</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-bold text-gray-400 mb-2">Web App URL</label><input type="text" id="setting-url-input" class="w-full bg-[#0d1117] border border-gray-600 p-3 rounded-lg text-white outline-none" placeholder="https://script.google.com/macros/s/..."></div>
                        <div class="flex items-center justify-between pt-4 border-t border-gray-700 mt-6"><div id="setting-status-display" class="flex items-center gap-2 text-sm font-bold text-gray-500"><div class="w-3 h-3 rounded-full bg-gray-500"></div> Checking...</div><button onclick="saveCloudSettings()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button></div>
                    </div>
                </div>
            </div>
            <div class="p-8 flex justify-center"> 
                <div class="bg-[#161b22] p-8 rounded-2xl border border-gray-700 w-full max-w-2xl shadow-xl mt-6">
                    <h3 class="text-xl font-bold text-blue-400 mb-6 flex items-center gap-2"><span>üíæ</span> Backup & Restore</h3>
                    <div class="space-y-4">
                        <p class="text-sm text-gray-400">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                        <div class="flex gap-4">
                            <button onclick="downloadBackup()" class="flex-1 bg-green-900/50 hover:bg-green-800 text-green-200 border border-green-700 py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                                <span>‚¨áÔ∏è</span> Download JSON (Backup)
                            </button>
                            <label class="flex-1 bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 py-3 rounded-lg font-bold flex items-center justify-center gap-2 cursor-pointer">
                                <span>‚¨ÜÔ∏è</span> Restore from File
                                <input type="file" id="restore-file" onchange="restoreBackup(this)" class="hidden" accept=".json">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-manager" class="flex-col">
            <header class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center flex-shrink-0 shadow-lg">
                <h2 id="manager-title" class="text-2xl font-bold text-white">Manager</h2>
                <button onclick="addNewItemInit()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
            </header>
            <div class="flex h-full overflow-hidden">
                <div class="w-96 border-r border-gray-800 bg-[#111827] overflow-y-auto no-scroll p-4" id="manager-list"></div>
                <div class="flex-1 p-8 overflow-y-auto bg-[#0d1117]">
                    <div id="manager-empty" class="text-center text-gray-500 mt-20 text-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
                    <div id="manager-form" class="hidden max-w-3xl mx-auto bg-[#161b22] p-8 rounded-2xl border border-gray-700"></div>
                </div>
            </div>
        </div>

        <div id="view-analytics" class="flex-col hidden h-full overflow-hidden">
            <header class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg flex-shrink-0">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2"><span>üìä</span> Guild Statistics & Meta Analysis</h2>
                <button onclick="renderAnalytics()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition">üîÑ Refresh Stats</button>
            </header>
            
            <div class="p-8 overflow-y-auto no-scroll h-full space-y-8 pb-20">
                <div id="analytics-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-[#161b22] border border-gray-700 rounded-2xl p-6 shadow-xl">
                        <h3 class="text-green-400 font-bold mb-4 flex items-center gap-2">üî• Top Used Heroes (Most Picked)</h3>
                        <div id="analytics-top-heroes" class="space-y-3"></div>
                    </div>
                    
                    <div class="bg-[#161b22] border border-gray-700 rounded-2xl p-6 shadow-xl">
                        <h3 class="text-red-400 font-bold mb-4 flex items-center gap-2">‚ùÑÔ∏è Unused Heroes (No Pick)</h3>
                        <div id="analytics-unused-heroes" class="grid grid-cols-4 md:grid-cols-6 gap-2"></div>
                    </div>
                </div>

                <div class="bg-[#161b22] border border-gray-700 rounded-2xl p-6 shadow-xl">
                    <h3 class="text-yellow-500 font-bold mb-4 flex items-center gap-2">ü§ù Best Synergies (‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô)</h3>
                    <div id="analytics-synergy" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>
        </div>

        <div id="view-simulator" class="flex-col hidden h-full bg-[#0b0e14]">
            <header class="p-4 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg flex-shrink-0">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><span>üè∞</span> Castle Assault Simulator</h2>
                <button onclick="resetSimulator()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded text-xs font-bold transition">Reset Board</button>
            </header>

            <div class="flex-1 overflow-y-auto no-scroll p-6 flex flex-col gap-8 pb-40">
                <div class="flex flex-col items-center justify-center py-6 bg-gradient-to-b from-red-900/20 to-transparent rounded-3xl border border-red-900/30 mb-8">
                    <div class="text-4xl mb-2">üèØ</div>
                    <div class="text-red-500 font-black tracking-widest text-sm uppercase mb-4">Enemy Defenders</div>
                    <div class="w-full max-w-2xl px-4" id="sim-enemy-slots"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="sim-teams-container">
                    <div id="sim-team-0" class="h-full"></div>
                    <div id="sim-team-1" class="h-full"></div>
                </div>

                <div class="bg-[#111827] border border-gray-800 rounded-2xl p-5 shadow-inner" style="min-height: fit-content;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Hero Pool (Drag to Team)</h3>
                        <div class="relative w-48">
                            <input type="text" id="sim-hero-search" onkeyup="renderSimulatorPool()" placeholder="Search..." class="w-full bg-[#0d1117] border border-gray-700 text-white text-xs px-3 py-1.5 rounded-full outline-none focus:border-blue-500">
                        </div>
                    </div>
                    <div id="sim-hero-pool" class="flex flex-wrap gap-2 max-h-48 overflow-y-auto custom-scroll content-start" style="min-height: fit-content;"></div>
                </div>
            </div>
        </div>

        <div id="view-hero-lists" class="hidden h-full flex flex-col p-6 space-y-6 overflow-hidden">
            <div class="flex justify-between items-center pb-4 border-b border-gray-800">
                <div>
                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                        <span class="text-purple-400">üìã</span> Hero Checklist
                        <span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded ml-2">Temporary Mode</span>
                    </h2>
                    <p class="text-gray-400 text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Hero (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="resetAllHeroLists()" class="border border-red-500/50 text-red-400 hover:bg-red-500/10 px-4 py-2 rounded-lg flex items-center gap-2 transition">
                        <span>üóëÔ∏è Reset All</span>
                    </button>
                    <button onclick="createNewHeroList()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg transition">
                        <span>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    </button>
                </div>
            </div>

            <div class="flex-1 grid grid-cols-12 gap-6 overflow-hidden">
                
                <div class="col-span-8 flex flex-col bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                    <div class="p-3 bg-gray-800 border-b border-gray-700 font-bold text-gray-300">My Lists</div>
                    <div id="hero-lists-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                        </div>
                </div>

                <div class="col-span-4 flex flex-col bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                    <div class="p-3 bg-gray-800 border-b border-gray-700 font-bold text-yellow-400 flex justify-between">
                        <span>üìä Hero Usage Count</span>
                        <span class="text-xs font-normal text-gray-400 self-center">Session Only</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-0">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-800 text-xs text-gray-400 uppercase sticky top-0">
                                <tr>
                                    <th class="p-3">Hero</th>
                                    <th class="p-3 text-center">Count</th>
                                </tr>
                            </thead>
                            <tbody id="hero-usage-table-body" class="divide-y divide-gray-800 text-sm">
                                </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <div id="view-user-manager" class="flex-col hidden h-full">
            <header class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">üë• User Management</h2>
                <button onclick="openAddUserModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Add User)</button>
            </header>
            <div class="p-8 overflow-y-auto bg-[#0d1117] h-full custom-scroll">
                <div class="bg-[#161b22] border border-gray-700 rounded-xl overflow-hidden shadow-xl max-w-5xl mx-auto">
                    <table class="w-full text-left">
                        <thead class="bg-[#1f2937] text-gray-400 text-xs uppercase font-bold border-b border-gray-700">
                            <tr>
                                <th class="p-4 w-1/4">Username</th>
                                <th class="p-4 w-1/4">Name</th>
                                <th class="p-4 w-1/6">Role</th>
                                <th class="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-body" class="text-sm text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-audit-logs" class="flex-col hidden h-full">
            <header class="p-6 border-b border-gray-800 bg-[#161b22] shadow-lg flex-shrink-0">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    üïµÔ∏è System Audit Logs <span class="text-xs font-normal text-gray-500 ml-2">(‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</span>
                </h2>
            </header>
            <div class="p-8 overflow-y-auto bg-[#0d1117] h-full custom-scroll">
                <div class="bg-[#161b22] border border-gray-700 rounded-xl overflow-hidden shadow-xl max-w-5xl mx-auto">
                    <table class="w-full text-left">
                        <thead class="bg-[#1f2937] text-gray-400 text-xs uppercase font-bold border-b border-gray-700">
                            <tr><th class="p-4 w-48">Time</th><th class="p-4 w-32">User</th><th class="p-4 w-24">Action</th><th class="p-4">Details</th></tr>
                        </thead>
                        <tbody id="audit-log-body" class="text-sm text-gray-300 divide-y divide-gray-800 font-mono"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="userModal" class="modal-overlay" style="z-index: 100;">
            <div class="modal-content !w-[500px]">
                <div class="p-4 border-b border-gray-700 bg-[#1f2937] flex justify-between items-center">
                    <h3 class="text-white font-bold text-lg" id="user-modal-title">Add / Edit User</h3>
                    <button onclick="document.getElementById('userModal').style.display='none'" class="text-gray-400 hover:text-white font-bold">‚úï</button>
                </div>
                <div class="p-6 bg-[#0d1117] flex flex-col gap-4">
                    <input type="hidden" id="form-user-mode" value="add">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="text-blue-400 text-xs font-bold uppercase">Username</label>
                            <input type="text" id="form-user-id" class="w-full bg-[#161b22] border border-gray-600 rounded p-2 text-white outline-none">
                        </div>
                        <div class="input-group">
                            <label class="text-gray-400 text-xs font-bold uppercase">Password</label>
                            <input type="text" id="form-user-pass" class="w-full bg-[#161b22] border border-gray-600 rounded p-2 text-white outline-none">
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="text-gray-400 text-xs font-bold uppercase">Display Name</label>
                        <input type="text" id="form-user-name" class="w-full bg-[#161b22] border border-gray-600 rounded p-2 text-white outline-none">
                    </div>

                    <div class="border-t border-gray-700 pt-4 mt-2">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-green-400 text-xs font-bold uppercase">Access Permissions (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ)</label>
                            <div class="space-x-2 text-[10px]">
                                <span class="cursor-pointer text-blue-400 hover:underline" onclick="toggleAllPermissions(true)">Select All</span>
                                <span class="cursor-pointer text-red-400 hover:underline" onclick="toggleAllPermissions(false)">Clear</span>
                            </div>
                        </div>
                        <div id="permission-container" class="grid grid-cols-2 gap-2 bg-[#161b22] border border-gray-600 rounded p-3 max-h-60 overflow-y-auto custom-scroll"></div>
                    </div>
                    
                    <button onclick="saveUserData()" class="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold mt-2 shadow-lg">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)</button>
                </div>
            </div>
        </div>

        <div id="view-battle-history" class="flex-col hidden h-full bg-[#0b0e14]">
            <header class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg flex-shrink-0 z-20">
                <div>
                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                        <span>üìú</span> Battle History
                    </h2>
                    <div class="text-xs text-gray-500 mt-1">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="history-total-count" class="text-blue-400 font-bold ml-1">(0)</span></div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="downloadBackup()" class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded border border-gray-600 flex items-center gap-2">
                        <span>‚¨áÔ∏è</span> Backup Data
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto custom-scroll p-6 bg-[#0d1117]">
                <div class="max-w-5xl mx-auto">
                    <div id="full-history-list" class="space-y-2">
                        <div class="text-center text-gray-600 py-20 animate-pulse">Loading logs...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="recorderModal" class="fixed inset-0 bg-[#0b0e14] z-[100] hidden flex flex-col">
            <div class="px-4 py-3 border-b border-gray-800 bg-[#161b22] flex justify-between items-center shadow-lg shrink-0">
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class="text-indigo-400">üìù</span> Battle Multi-Recorder
                    </h2>
                    <button onclick="addNewRow()" class="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-3 py-1.5 rounded flex items-center gap-1">
                        <span>+</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß (Add Row)
                    </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="saveAllMatches()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-1.5 rounded text-sm font-bold shadow-lg flex items-center gap-2">
                        <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="rowCountBadge">0</span>)
                    </button>
                    <button onclick="closeRecorder()" class="text-gray-400 hover:text-white font-bold px-4">‚úï</button>
                </div>
            </div>

            <div class="flex-1 overflow-auto p-4 custom-scroll">
                <table class="w-full border-collapse">
                    <thead class="sticky top-0 bg-[#0b0e14] z-10 shadow-sm">
                        <tr>
                            <th class="w-8">#</th>
                            <th class="w-20">Format</th>
                            <th class="bg-blue-900/10 border-b-2 border-blue-600/50" colspan="6">üõ°Ô∏è My Team (Heroes & Pet)</th>
                            <th class="w-4"></th>
                        </tr>
                    </thead>
                    <tbody id="recorderRows" class="space-y-2"></tbody>
                </table>
                
                <div id="emptyState" class="text-center py-20 text-gray-600 hidden">
                    ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß" ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </div>
            </div>
        </div>
        
    </main>
    
    <div id="contextMenu" onclick="event.stopPropagation()">
        <div class="p-2 border-b border-gray-700">
            <button onclick="removeItemFromContext()" class="w-full bg-red-900/30 hover:bg-red-800 border border-red-800 text-red-300 py-1.5 rounded text-xs font-bold flex items-center justify-center gap-2 transition"><span>üóëÔ∏è</span> ‡∏•‡∏ö (Remove)</button>
        </div>
        <div class="ctx-header text-blue-400 p-2 font-bold text-xs uppercase">Actions</div>
        <div class="ctx-body border-b border-gray-800 p-2"><button onclick="openDetailFromContext()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-1.5 rounded text-xs font-bold flex items-center justify-center gap-2"><span>üîç</span> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></div>
        
        <div id="ctx-stars-section">
            <div class="ctx-header p-2 font-bold text-xs uppercase text-gray-500">Adjust Stars</div>
            <div class="ctx-body border-b border-gray-800 p-2"><div class="ctx-grid" id="star-grid-red"></div><div class="ctx-grid" id="star-grid-blue"></div><button onclick="setStar(0)" class="ctx-btn yellow w-full mb-2">Reset Stars</button></div>
        </div>
        
        <div id="ctx-rings-section">
            <div class="ctx-header p-2 font-bold text-xs uppercase text-gray-500">Equip Ring</div>
            <div class="ctx-body max-h-32 overflow-y-auto no-scroll p-1" id="ring-options"></div>
        </div>
    </div>

    <div id="textEditorMenu" onclick="event.stopPropagation()">
        <div class="p-2 border-b border-gray-600 text-xs font-bold text-gray-400 uppercase">üé® Text Color</div>
        <div onclick="applyTextColor('text-orange')" class="editor-menu-item"><div class="color-dot bg-orange-500"></div> Orange Text</div>
        <div onclick="applyTextColor('text-blue')" class="editor-menu-item"><div class="color-dot bg-blue-500"></div> Blue Text</div>
        <div onclick="applyTextColor('text-red')" class="editor-menu-item"><div class="color-dot bg-red-500"></div> Red Text</div>
        <div onclick="applyTextColor('text-green-400')" class="editor-menu-item"><div class="color-dot bg-green-400"></div> Green Text</div>
        
        <div class="p-2 border-b border-gray-600 border-t mt-1 text-xs font-bold text-gray-400 uppercase">‚öîÔ∏è Damage Type</div>
        <div onclick="applyTextColor('dmg-fire')" class="editor-menu-item"><div class="color-dot bg-red-400"></div> Fire Damage</div>
        <div onclick="applyTextColor('dmg-ice')" class="editor-menu-item"><div class="color-dot bg-blue-300"></div> Ice Damage</div>

        <div class="p-2 border-b border-gray-600 border-t mt-1 text-xs font-bold text-gray-400 uppercase">üéØ Icons / Targets</div>
        
        <div onclick="insertKeyword('ally')" class="editor-menu-item hover:bg-blue-900/30">
            <span class="mr-2 text-lg">üõ°Ô∏è</span> ‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£ (Ally)
        </div>
        
        <div onclick="insertKeyword('enemy')" class="editor-menu-item hover:bg-red-900/30">
            <span class="mr-2 text-lg">‚öîÔ∏è</span> ‡∏®‡∏±‡∏ï‡∏£‡∏π (Enemy)
        </div>

        <div onclick="insertKeyword('self')" class="editor-menu-item hover:bg-yellow-900/30">
            <span class="mr-2 text-lg">üë§</span> ‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (Self)
        </div>
    </div>

    <div id="selectorModal" class="modal-overlay" style="z-index: 200;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="flex justify-between items-center w-full">
                    <h3 id="selector-title" class="text-xl font-bold text-white w-20">Select</h3>
                    <div class="relative flex-1 mx-4">
                        <span class="absolute left-3 top-2 text-gray-500">üîç</span>
                        <input type="text" id="selector-search" onkeyup="filterSelector(this.value)" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="w-full bg-[#0d1117] border border-gray-600 text-white pl-10 pr-4 py-1.5 rounded-lg outline-none text-sm focus:border-blue-500">
                    </div>
                    <button onclick="closeSelector()" class="text-gray-500 hover:text-white text-xl font-bold w-8 text-right">‚úï</button>
                </div>
                <div id="selector-tabs" class="flex gap-2 flex-wrap w-full"></div>
            </div>
            <div id="selector-body" class="modal-body custom-scroll">
                <div id="selector-grid" class="grid grid-cols-[repeat(auto-fill,minmax(100px,1fr))] gap-3 pb-4"></div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay" style="z-index: 70;">
        <div class="modal-content">
            <div class="flex justify-between items-start p-6 pb-4 border-b border-gray-700 bg-[#161b22] sticky top-0 z-10">
                <div class="flex gap-4 items-start">
                    <img id="dt-img" class="w-24 h-24 rounded-lg bg-black border border-gray-600 object-cover flex-shrink-0">
                    <div>
                        <h3 id="dt-name" class="text-2xl font-bold text-white leading-tight">Hero Name</h3>
                        <div id="dt-stars" class="mt-2"></div>
                    </div>
                </div>
                <button onclick="closeDetail()" class="text-gray-500 hover:text-white text-2xl font-bold">‚úï</button>
            </div>
            
            <div class="p-6 pt-4 overflow-y-auto flex-1 custom-scroll">
                
                <div id="dt-tabs" class="flex border-b border-gray-700 mb-4 hidden">
                    <button onclick="switchDetailTab('skills')" id="dt-tab-skills" class="flex-1 py-2 text-sm font-bold text-blue-400 border-b-2 border-blue-500 transition">Skills</button>
                    <button onclick="switchDetailTab('stats')" id="dt-tab-stats" class="flex-1 py-2 text-sm font-bold text-gray-500 hover:text-white transition">Stats</button>
                </div>

                <div id="dt-view-skills">
                    <div id="dt-content-hero" class="space-y-4 mb-4">
                        <div id="dt-ring-section" class="bg-[#111827] p-3 rounded-lg border border-gray-700 flex items-center gap-4"></div>
                        <div>
                            <h4 class="text-yellow-500 font-bold text-sm uppercase mb-2 border-b border-gray-800 pb-1">Basic Skills</h4>
                            <div class="detail-row"><div class="detail-label">Normal</div><div class="detail-val skill-display" id="dt-n"></div></div>
                            <div class="detail-row"><div class="detail-label">Passive</div><div class="detail-val skill-display" id="dt-p"></div></div>
                            <div class="detail-row"><div class="detail-label">Skill 1</div><div class="detail-val skill-display" id="dt-s1"></div></div>
                            <div class="detail-row"><div class="detail-label">Skill 2</div><div class="detail-val skill-display" id="dt-s2"></div></div>
                        </div>
                    </div>
                </div>

                <div id="dt-view-stats" class="hidden">
                    <div class="bg-[#111827] rounded-lg border border-gray-700 p-4 mt-2">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                            <span class="text-xs font-bold text-blue-400 uppercase tracking-wider">üìä Current Battle Stats</span>
                            <span id="dt-stat-desc" class="text-[10px] text-gray-500">Calculating...</span>
                        </div>

                        <div class="grid grid-cols-2 gap-y-3 gap-x-6" id="dt-stat-grid">
                            <div class="text-gray-500 text-sm col-span-2 text-center">No base stats configured.</div>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-gray-700 flex justify-between items-end">
                            <span class="text-xs text-gray-400">Combat Power (Est.)</span>
                            <span id="dt-stat-cp" class="text-xl font-bold text-yellow-500">0</span>
                        </div>
                    </div>
                </div>

                <div id="dt-content-pet" class="hidden text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</div>
                
                <button id="btn-remove-hero" onclick="removeHeroFromDetail()" class="w-full bg-red-900/50 hover:bg-red-600 text-red-400 hover:text-white font-bold py-3 rounded-lg border border-red-900 transition flex items-center justify-center gap-2 mt-4"><span>üóëÔ∏è</span> ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏° (Remove)</button>
            </div>
        </div>
    </div>
    
    <div id="battleModal" class="modal-overlay" style="z-index: 65;">
        <div class="modal-content flex flex-col bg-[#0b0e14] !w-full !h-full !max-w-none !rounded-none !m-0 !border-0">
            
            <div class="p-3 border-b border-gray-800 bg-[#161b22] flex justify-between items-center flex-shrink-0 shadow-md z-50 relative">
                <div class="flex items-center gap-4">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class="text-red-500 text-2xl">‚öîÔ∏è</span> PREPARATION
                    </h3>
                    <div class="h-6 w-px bg-gray-700"></div>
                    <div id="battle-header-info" class="text-xs"></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="closeBattleModal()" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-1.5 rounded text-xs font-bold border border-gray-600 cursor-pointer z-50">Close ‚úï</button>
                </div>
            </div>

            <div class="flex-1 flex overflow-hidden bg-[#0d1117]">
                
                <div class="w-72 border-r border-gray-800 flex flex-col bg-[#111827] flex-shrink-0 z-20 shadow-xl">
                    <div class="p-3 bg-[#1f2937] border-b border-gray-700 font-bold text-gray-300 text-xs uppercase sticky top-0 flex justify-between items-center shadow-md">
                        <span>üë• Active Members</span>
                        <input type="text" placeholder="Filter..." class="bg-[#0d1117] border border-gray-700 text-[10px] px-2 py-1 rounded text-white outline-none w-20" onkeyup="filterBattleGuildList(this.value)">
                    </div>
                    <div class="overflow-y-auto flex-1 p-2 space-y-1 custom-scroll" id="battle-guild-list"></div>
                </div>

                <div class="flex-1 flex relative bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] h-full overflow-hidden">
                    
                    <div class="flex-1 overflow-y-auto p-4 flex flex-col items-center battle-scroll">
                        <div id="battle-builder-area" class="w-full max-w-[750px] flex-col items-center border-2 border-dashed border-gray-800/50 rounded-2xl p-4 transition-all bg-[#0d1117]/80 backdrop-blur-md min-h-fit mx-auto">
                            </div>
                        <div class="h-24 flex-shrink-0"></div> 
                    </div>

                    <div class="w-65 border-l border-gray-800 bg-[#111827]/90 backdrop-blur p-4 overflow-y-auto hidden lg:block z-30 shadow-xl">
                        <div id="battle-ai-panel" class="sticky top-0">
                            <div class="text-center text-xs text-gray-500 mt-10">Select member to see details</div>
                        </div>
                    </div>

                    <div id="battle-actions" class="p-3 border-t border-gray-800 bg-[#161b22] flex justify-between items-center hidden shadow-[0_-5px_30px_rgba(0,0,0,0.8)] z-40 absolute bottom-0 left-0 right-0 lg:right-64"> <div class="text-xs text-gray-400">
                            <div id="battle-footer-info" class="font-bold text-white mb-1">...</div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="confirmBattleResult('Lose')" class="bg-red-900/30 hover:bg-red-800 text-red-200 border border-red-800 px-6 py-2 rounded-lg font-bold shadow-lg transition flex items-center gap-2 backdrop-blur-md">
                                <span>üíÄ</span> ‡πÅ‡∏û‡πâ (LOSE)
                            </button>
                            <button onclick="confirmBattleResult('Win')" class="bg-green-600 hover:bg-green-500 text-white px-10 py-2 rounded-lg font-bold shadow-lg transition flex items-center gap-2 transform hover:scale-105 border border-green-400">
                                <span>üèÜ</span> ‡∏ä‡∏ô‡∏∞ (WIN)
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <div id="historyModal" class="modal-overlay" style="z-index: 65;">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-800 bg-[#161b22] flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center gap-2"><span>üìú</span> Battle History</h3>
                <button onclick="closeHistoryModal()" class="text-gray-500 hover:text-white font-bold text-xl">‚úï</button>
            </div>
            <div class="p-6 bg-[#0d1117] h-96 overflow-y-auto">
                <div class="mb-4 bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                   <div class="text-xs text-gray-400 uppercase font-bold mb-2">Enemy Composition</div>
                   <div id="history-enemy-comp" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="text-xs text-blue-400 uppercase font-bold mb-2">Past Records Against This Comp</div>
                <div id="history-results" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <div id="loadSetModal" class="modal-overlay" style="z-index: 80;">
        <div class="modal-content !w-[600px]">
            <div class="p-4 border-b border-gray-700 bg-[#1f2937] flex justify-between items-center">
                <h3 class="text-white font-bold">üìÇ Load Hero Set</h3>
                <button onclick="closeLoadSetModal()" class="text-gray-400 font-bold">‚úï</button>
            </div>
            <div id="load-set-list" class="p-4 bg-[#0d1117] max-h-[500px] overflow-y-auto grid grid-cols-1 gap-2">
                </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & STATE ---
        const SYSTEM_CONFIG = {
            // ‚úÖ 1. ‡πÉ‡∏™‡πà URL ‡∏ñ‡∏≤‡∏ß‡∏£‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Setting ‡∏≠‡∏µ‡∏Å)
            WEB_APP_URL: "https://script.google.com/macros/s/AKfycbzrXxLPs0Gi4wtzNwvhzxbZX74yOnMpovM2IfUKEzl-mgPgjVmfjlen8Tg6K3jGQkQlbw/exec", 
            
            // ‚úÖ 2. ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå HTML ‡∏ô‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Code.gs)
            VERSION: "1.0.1" 
        };
        // --- Logic ‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á URL (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Config ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏≤‡∏à‡∏≤‡∏Å localStorage) ---
        let SCRIPT_URL = SYSTEM_CONFIG.WEB_APP_URL || localStorage.getItem('7k_script_url') || '';
        let USE_CLOUD = !!SCRIPT_URL;

        // --- [1] GLOBAL VARIABLES UPDATES ---
        let auditLogsDB = []; // ‡πÄ‡∏Å‡πá‡∏ö Log ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        let systemUsersDB = [];
        let tempHeroLists = [];

        var contextMenuPos = { x: 0, y: 0 }; 
        var activeFloatingText = null;

        let manualUsageOffsets = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏î +/- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á { "heroID": 5 }
        let currentTargetListId = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Hero ‡πÉ‡∏´‡πâ List ‡πÑ‡∏´‡∏ô

        let isRowDragging = false;
        let isRowResizing = false;
        let currentRowId = null;
        let dragOffset = { x: 0, y: 0 };
        let startResize = { x: 0, y: 0, w: 0 };
        let activeDragGroupId = null; // ID ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Å‡∏î
        let activeDragGroup = [];     // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô [ {id, startX, startY} ]
        let dragStartMouse = { x: 0, y: 0 };

        const formations = [
            { id: "basic", name: "Basic (B3/F2)" },
            { id: "balanced", name: "Balance (B2/F3)" },
            { id: "attack", name: "Attack (B4/F1)" },
            { id: "defense", name: "Defense (B1/F4)" }
        ];
        let pendingMatches = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å
        let formationOptionsHTML = formations.map(f => `<option value="${f.id}">${f.name}</option>`).join('');

        let viewingSeasonMode = 'current'; // 'current' ‡∏´‡∏£‡∏∑‡∏≠ index ‡∏Ç‡∏≠‡∏á archive
        let activeHistoryData = [];

        let prepData = {
            enemy: { id: 'PREP-ENEMY', name: 'Simulated Enemy', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
            my: { id: 'PREP-MY', name: 'My Draft Team', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] }
        };

        // --- LOGIN SYSTEM ---
        let CURRENT_USER = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const ALL_MENUS = [
            { id: 'nav-simulator',    label: 'üéÆ Simulator',        default: true },
            { id: 'nav-tier-viewer',  label: 'üèÜ Tier List (View)', default: true },
            { id: 'nav-gallery',      label: 'üñºÔ∏è Gallery',          default: true },
            { id: 'nav-settings',     label: '‚öôÔ∏è Settings',         default: true },
            
            // Database Manager
            { id: 'nav-hero-manager', label: 'ü¶∏ Manage Heroes',    default: false },
            { id: 'nav-pet-manager',  label: 'üêæ Manage Pets',      default: false },
            { id: 'nav-item-manager', label: '‚öîÔ∏è Manage Items',     default: false },
            { id: 'nav-ring-manager', label: 'üíç Manage Rings',     default: false },
            
            // War Manager
            { id:'battle-war',      label:'‚öîÔ∏è Battle War',        default:false},
            { id:'nav-set-manager',  label: 'üì¶ Manage Sets',      default: false },

            // Admin Zone
            { id: 'nav-user-manager', label: 'üë• User Manager',     default: false },
            { id: 'nav-audit-logs',   label: 'üïµÔ∏è Audit Logs',       default: false }
        ];

        // --- AUTO-SAVE SYSTEM ---
        let autoSaveTimer = null;

        let battleActiveMemberIdx = null; // ‡πÄ‡∏Å‡πá‡∏ö Index ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        let battleTempTeam = null;

        // --- BATTLE WAR DATA (Manual Log) ---
        let battleWarData = {
            enemy: { id: 'BW-ENEMY', name: 'Enemy Team', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
            my: { id: 'BW-MY', name: 'My Team', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] }
        };

        // --- REAL-TIME VARIABLES ---
        let lastServerTimestamp = 0; // ‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà Server ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
        let isUserInteracting = false; // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ user ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
        let realTimeInterval = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Loop
        let pendingUpdateData = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏û‡∏±‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        let updateCheckInterval = null;

        // ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        let isSaving = false;
        let isPendingSave = false;

        // --- ‡∏™‡∏ñ‡∏≤‡∏õ‡∏∞‡∏ô‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ---
        let simEnemyTeam = [null, null, null];
        let simAttackTeams = [[null,null,null], [null,null,null], [null,null,null]];
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á String ["slot-skill"] ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ó‡∏µ‡∏° (‡πÄ‡∏ä‡πà‡∏ô ["0-1", "1-2"])
        let simSkillQueues = [[], [], []]; 
        let simDragData = null;
        let simData = {
            enemy: { id: 'SIM-ENEMY', name: 'Enemy Team', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
            attack: [
                { id: 'SIM-ATK-0', name: 'Attack Team 1', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
                { id: 'SIM-ATK-1', name: 'Attack Team 2', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
            ]
        };

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö Lethal ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà Weakness ‡πÅ‡∏ó‡∏ô ---
        const STAT_KEYS = ['hp', 'atk', 'def', 'spd', 'critRate', 'critDmg', 'block', 'dmgRed', 'acc', 'resist', 'weakness'];

        const STAT_LABELS = {
            hp: 'HP', 
            atk: 'Attack', 
            def: 'Defense', 
            spd: 'Speed',
            critRate: 'Crit Rate', 
            critDmg: 'Crit Dmg',
            // lethal: 'Lethal',  <-- ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            block: 'Block Rate', 
            dmgRed: 'Dmg Reduce', 
            acc: 'Accuracy', 
            resist: 'Resist',
            weakness: 'Weakness Point' // ‡πÉ‡∏™‡πà‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà
        };
        let currentDetailRedStars = 0; 
        let currentDetailBlueStars = 0; // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß‡∏ü‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á
        
        let heroesDB=[], petsDB=[], ringsDB=[], teamsDB={}, logsDB=[], affiliationsDB = ['‡∏™‡∏µ‡πà‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥', '‡πÄ‡∏à‡πá‡∏î‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô', '‡∏î‡∏≤‡∏£‡πå‡∏Ñ‡πÑ‡∏ô‡∏ó‡πå'];
        let tierListsDB = { hero: {}, pet: {} }; 
        let myTeamsDB = []; 
        let battleHistoryDB = []; // New DB for History
        
        let currentView='war-room', currentCastle='‡∏ô‡∏≠‡∏Å 1', currentCap=10;
        let editContext=null, dragSrc=null, contextTarget=null, detailTarget=null, editingItemId=null;
        let syncInterval=null, activeTextarea=null;
        let activeBattleSlot = null; // Track which slot is fighting

        let selectorCurrentData = [];
        let selectorActiveCategory = 'All';
        let selectorExcludedIds = [];

        let galleryTab = 'hero'; 
        let galleryFilter = { rarity: null, type: null, aff: null };

        let tierViewTab = 'hero';
        let currentTierType = 'hero';
        let currentTierMode = 'pvp'; 
        let tierDragSrc = null;

        // --- GUILD WAR VARIABLES ---
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° status: 'waiting' ‡∏´‡∏£‡∏∑‡∏≠ 'active'
        let currentSeason = { id: 1, name: 'Season 1', opponent: '-', status: 'waiting', startDate: '' };
        let archivedSeasons = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Log ‡πÄ‡∏Å‡πà‡∏≤‡πÜ

        // --- GUILD DATA VARIABLES ---
        let guildMembersDB = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å 30 ‡∏Ñ‡∏ô (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)
        let currentMemberIdx = 0; // ‡∏à‡∏≥‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡∏Ñ‡∏ô‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà (0-29)

        let isStatsOpen = false; // ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Stats ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°

        // --- GLOBAL ---
        let heroSetsDB = []; // [‡πÄ‡∏û‡∏¥‡πà‡∏°]
        let currentSetIdx = -1; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Manager

        let targetLoadContext = null;

        // --- ITEM SYSTEM CONFIG ---
        let itemsDB = []; // ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°

        // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Front/Back)
        const ITEM_TYPES = {
            'front': '‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (Front)',
            'back': '‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á (Back)'
        };

        // ‡∏Ñ‡πà‡∏≤ Stat ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sub Stats)
        const ALL_STATS = ['atk', 'atk%', 'hp', 'hp%', 'def', 'def%', 'critRate', 'critDmg', 'weakness', 'acc', 'dmgRed', 'block', 'resist', 'spd'];

        // ‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏ü‡∏´‡∏•‡∏±‡∏Å (Main Option Rules)
        const MAIN_STAT_RULES = {
            'front': ['atk%', 'atk', 'hp%', 'hp', 'def%', 'def', 'critRate', 'critDmg', 'weakness', 'acc'],
            'back':  ['atk%', 'atk', 'hp%', 'hp', 'def%', 'def', 'dmgRed', 'block', 'resist']
        };

        // Helper ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ Stat ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏™‡∏ß‡∏¢‡πÜ
        const STAT_DISPLAY = {
            'atk': 'ATK (Flat)', 'atk%': 'ATK %',
            'hp': 'HP (Flat)', 'hp%': 'HP %',
            'def': 'DEF (Flat)', 'def%': 'DEF %',
            'critRate': 'Crit Rate', 'critDmg': 'Crit Dmg',
            'weakness': 'Weakness', 'acc': 'Accuracy',
            'dmgRed': 'Dmg Reduce', 'block': 'Block', 'resist': 'Resist',
            'spd': 'Speed'
        };

        const RARITY_OPTS = ['‡πÇ‡∏ö‡∏£‡∏≤‡∏ì', '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô SP', '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', '‡∏´‡∏≤‡∏¢‡∏≤‡∏Å', '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á', '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'];
        const TYPE_OPTS = ['‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û', '‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå', '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô', '‡∏™‡∏°‡∏î‡∏∏‡∏•', '‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô'];
        const PET_RARITY_OPTS = ['‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', '‡∏´‡∏≤‡∏¢‡∏≤‡∏Å'];
        const PET_TYPE_OPTS = ['‡∏ö‡∏±‡∏û‡πÇ‡∏à‡∏°‡∏ï‡∏µ', '‡∏ö‡∏±‡∏û‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô', '‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô'];
        const TIERS = ['S', 'A', 'B', 'C', 'D'];
        const TIER_MODES = ['pvp', 'pve', 'farming'];
        const TIER_MODE_LABELS = { pvp: '‚öîÔ∏è PVP', pve: 'üêâ PVE', farming: 'üåæ Farming' };
        
        const BASE_BADGE_STYLE = "inline-flex items-center justify-center h-5 px-2 text-[10px] font-bold rounded border shadow-sm uppercase tracking-wide whitespace-nowrap mr-1 mb-1";

        // --- TIER LIST SYSTEM CONFIG ---
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Rank ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏á { S: "GOD", A: "GOOD" }
        let isPoolOpen = false;

        let contextStickerTarget = null;

        // --- 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global (‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏ñ‡∏ß‡πÜ heroesDB) ---
        let knownEnemies = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

        // 1. Data Structure ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Ranks (Dynamic)
        // ‡πÄ‡∏Å‡πá‡∏ö Array ‡∏Ç‡∏≠‡∏á Rank ID ‡πÄ‡∏ä‡πà‡∏ô ['S', 'A', 'B', 'C', 'D', 'RANK_1701...']
        let activeTiers = ['S', 'A', 'B', 'C', 'D']; 
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏á { S: "GOD", A: "GOOD" }
        let tierRankNames = { S:'S', A:'A', B:'B', C:'C', D:'D' }; 

        // [UPDATED] Config Object: ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠ + ‡∏™‡πÑ‡∏ï‡∏•‡πå { S: { name:'S', color:'#fff', opacity:0.6, bg:'' } }
        let tierRankConfigs = {
            S: { name: 'S', color: '#ffffff', opacity: 60, bg: '' },
            A: { name: 'A', color: '#ffffff', opacity: 60, bg: '' },
            B: { name: 'B', color: '#ffffff', opacity: 60, bg: '' },
            C: { name: 'C', color: '#ffffff', opacity: 60, bg: '' },
            D: { name: 'D', color: '#ffffff', opacity: 60, bg: '' }
        };

       // --- BATTLE STATE ---
        let selectedAttacker = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ { memIdx, teamIdx } ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

        // Load Configs (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Save ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠)
        if(localStorage.getItem('7k_tier_ranks_config')) {
            tierRankConfigs = JSON.parse(localStorage.getItem('7k_tier_ranks_config'));
        } else if(localStorage.getItem('7k_tier_ranks')) {
            // Convert Old Save to New Format
            const oldNames = JSON.parse(localStorage.getItem('7k_tier_ranks'));
            for(let key in oldNames) {
                if(!tierRankConfigs[key]) tierRankConfigs[key] = { name: oldNames[key], color: '#ffffff', opacity: 60, bg: '' };
                else tierRankConfigs[key].name = oldNames[key];
            }
        }

        // Load Save
        if(localStorage.getItem('7k_active_tiers')) activeTiers = JSON.parse(localStorage.getItem('7k_active_tiers'));

        let contextRankTarget = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏ó‡∏µ‡πà Rank ‡πÑ‡∏´‡∏ô
        let contextItemTarget = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏ó‡∏µ‡πà Hero ‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô

        if(localStorage.getItem('7k_tier_bg')) setTimeout(() => setTierBg(localStorage.getItem('7k_tier_bg')), 100);

        function initLogin() {
            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢ Login ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏´‡∏° (Session Storage)
            const savedUser = sessionStorage.getItem('7k_user_session');
            
            if (savedUser) {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ -> ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤ Login ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
                CURRENT_USER = JSON.parse(savedUser);
                document.getElementById('login-screen').style.display = 'none';
                initApp(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ -> ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤ Login (‡∏°‡∏±‡∏ô‡πÇ‡∏ä‡∏ß‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢ default css)
                // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡∏£‡∏≠ user ‡∏Å‡∏£‡∏≠‡∏Å
            }
        }

        async function doLogin() {
            const userIn = document.getElementById('login-user').value.trim(); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏ö‡∏™‡∏ô
            const passIn = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('btn-login');
            const msg = document.getElementById('login-msg');

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL
            if (!SCRIPT_URL) {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ URL ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πà‡∏≤ Local Admin (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Login ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)
                if (userIn === 'admin' && passIn === '1234') {
                    // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ
                } else {
                    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL! ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏´‡∏±‡∏™ Admin ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô");
                    return;
                }
            }

            // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏° UI Loading
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Checking...`;
            msg.innerText = "";

            try {
                // 3. [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ systemUsersDB ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß Default) ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Server ‡∏Å‡πà‡∏≠‡∏ô
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° User ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô Sheet ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å User ‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if (USE_CLOUD && (systemUsersDB.length <= 1)) {
                    console.log("Downloading latest user data...");
                    const res = await fetch(SCRIPT_URL); // ‡πÉ‡∏ä‡πâ GET ‡∏õ‡∏Å‡∏ï‡∏¥
                    const data = await res.json();
                    
                    if (data.users && Array.isArray(data.users)) {
                        systemUsersDB = data.users; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà
                        if(data.heroes) heroesDB = data.heroes;
                        if(data.teams) teamsDB = data.teams;
                        // ... (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
                    }
                }

                // 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö User/Pass ‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ (Local Check)
                const foundUser = systemUsersDB.find(u => u.id === userIn && u.pass === passIn);

                if (foundUser) {
                    // ‚úÖ LOGIN SUCCESS
                    msg.innerText = "Login Success! Redirecting...";
                    msg.className = "text-green-400 text-xs mt-4";

                    // 4.1 ‡∏™‡∏£‡πâ‡∏≤‡∏á Session
                    const userData = { 
                        username: foundUser.id, 
                        name: foundUser.name, 
                        role: foundUser.role,
                        permissions: foundUser.permissions
                    };
                    sessionStorage.setItem('7k_user_session', JSON.stringify(userData));
                    CURRENT_USER = userData;

                    // 4.2 ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏≤‡∏° Role
                    if (typeof applyUserRole === "function") {
                        applyUserRole();
                    }

                    // 4.3 ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏û
                    setTimeout(() => {
                        document.getElementById('login-screen').style.display = 'none';
                        initApp();
                        
                        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Logout ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤)
                        btn.disabled = false;
                        btn.innerHTML = `<span>üîì</span> Login`;
                        msg.innerText = "";
                    }, 800);

                } else {
                    // ‚ùå LOGIN FAILED
                    throw new Error("Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }

            } catch (err) {
                console.error("Login Error:", err);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error
                msg.innerText = err.message || "Connection Failed";
                msg.className = "text-red-400 text-xs mt-4";
                
                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
                btn.disabled = false;
                btn.innerHTML = `<span>üîì</span> Login`;
            }
        }

        function logout() {
            sessionStorage.removeItem('7k_user_session');
            location.reload(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
        }

        function getRarityBadgeHTML(rarity) {
            if (!rarity) return '';
            let cls = 'bg-gray-800 text-gray-400 border-gray-600';
            if (rarity === '‡πÇ‡∏ö‡∏£‡∏≤‡∏ì') cls = 'bg-[#450a0a] text-[#fca5a5] border-[#b91c1c]';
            else if (rarity === '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô SP') cls = 'bg-[#431407] text-[#fdba74] border-[#c2410c]';
            else if (rarity === '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô') cls = 'bg-[#422006] text-[#fde047] border-[#ca8a04]';
            else if (rarity === '‡∏´‡∏≤‡∏¢‡∏≤‡∏Å') cls = 'bg-[#172554] text-[#93c5fd] border-[#2563eb]';
            else if (rarity === '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á') cls = 'bg-[#052e16] text-[#86efac] border-[#16a34a]';
            return `<span class="${BASE_BADGE_STYLE} ${cls}">${rarity}</span>`;
        }

        function showLoading(text) { document.getElementById('loading-text').innerText = text; document.getElementById('loading-overlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.remove('active'); }

        if(USE_CLOUD) startCloudSync(true); 
        else {
            // Mock Data
            heroesDB = [{id:'h1',name:'Example Hero',img:'https://api.dicebear.com/7.x/avataaars/svg?seed=Rudy', rarity:'‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', type:'‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô', affiliation:'‡πÄ‡∏à‡πá‡∏î‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô', skills:{n:'Normal',p:'Passive',s1:'<span class="text-orange">Fire Attack</span>',s2:'Ice Attack'}}];
            petsDB = [{id:'p1',name:'Pookie',img:'https://api.dicebear.com/7.x/bottts/svg?seed=Pookie', rarity:'‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', type:['‡∏ö‡∏±‡∏û‡πÇ‡∏à‡∏°‡∏ï‡∏µ'], skill:'Increases ATK by 20%'}];
            ringsDB = [{id:'r1',name:'Revive',img:'',desc:'Revive',grade:6}];
            tierListsDB = { hero: { pvp: { 'S': ['h1'] }, pve: {}, farming: {} }, pet: { pvp: {}, pve: {}, farming: {} } };
            updateSyncStatus();
        }
        
        initLogin();

        function initApp() {

            if (CURRENT_USER) {
                const nameEl = document.getElementById('display-username');
                if (nameEl) {
                    nameEl.innerText = `${CURRENT_USER.name} (${CURRENT_USER.role})`;
                }

                // --- üõ°Ô∏è ROLE BASED ACCESS CONTROL (RBAC) ---
                // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ID ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà User ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ "‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô"
                const restrictedIds = [
                    'nav-hero-manager', 
                    'nav-pet-manager', 
                    'nav-item-manager', 
                    'nav-ring-manager', 
                    'nav-set-manager',
                    'menu-title-db-manager' // (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏° id="menu-title-db-manager" ‡πÉ‡∏™‡πà‡πÉ‡∏ô <div class="menu-section-title">Database Manager</div>
                ];

                // Default: ‡∏ã‡πà‡∏≠‡∏ô Admin Group ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                document.getElementById('admin-menu-group').style.display = 'none';

                if (CURRENT_USER.role !== 'admin') {
                    // CASE: User ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ -> ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π Database Manager
                    restrictedIds.forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.style.display = 'none';
                    });
                } else {
                    // CASE: Admin -> ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á + ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ã‡∏ô Admin
                    restrictedIds.forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.style.display = 'flex'; // ‡∏´‡∏£‡∏∑‡∏≠ block ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
                    });
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π Admin
                    document.getElementById('admin-menu-group').style.display = 'block';
                }
            }

            loadLocalTierData();
            renderCastleMenu(); 
            changeCastle('‡∏ô‡∏≠‡∏Å 1', 10); 
            updateSyncStatus();
            loadTierListFull();
            
            initInteractionDetectors(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
            if(USE_CLOUD) {
                startCloudSync(true); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
                // startRealTimeSync();  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏ô‡∏•‡∏π‡∏õ Real-time
                // startUpdateChecker();
            }

            switchView('home');
        }

        // --- [3] AUDIT LOG SYSTEM ---
        function logAudit(action, target, details) {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ User (Dev mode) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ System
            const user = CURRENT_USER ? `${CURRENT_USER.name} (${CURRENT_USER.username})` : 'System';
            
            const newLog = {
                timestamp: new Date().toLocaleString('th-TH'),
                user: user,
                action: action, // e.g. 'ADD', 'EDIT', 'DELETE'
                target: target, // e.g. 'Hero: Rudy'
                details: details
            };
            
            auditLogsDB.unshift(newLog);
            if(auditLogsDB.length > 200) auditLogsDB.pop(); // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            
            // Auto save log to cloud (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
            triggerAutoSave();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Render ‡∏´‡∏ô‡πâ‡∏≤ Log
        function renderAuditLogs() {
            const tbody = document.getElementById('audit-log-body');
            if(!tbody) return;
            tbody.innerHTML = auditLogsDB.map(l => {
                let color = 'text-gray-300';
                if(l.action === 'DELETE') color = 'text-red-400 font-bold';
                if(l.action === 'ADD') color = 'text-green-400 font-bold';
                if(l.action === 'EDIT') color = 'text-yellow-400 font-bold';
                
                return `
                    <tr class="hover:bg-white/5 border-b border-gray-700/50">
                        <td class="p-3 text-gray-500 text-xs">${l.timestamp}</td>
                        <td class="p-3 text-blue-300 font-bold">${l.user}</td>
                        <td class="p-3 ${color}">${l.action}</td>
                        <td class="p-3 text-gray-300">${l.target} <span class="text-gray-500 text-xs ml-2">${l.details || ''}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // --- 1. RENDER ‡∏ï‡∏≤‡∏£‡∏≤‡∏á User ---
        function renderUserManager() {
            const tbody = document.getElementById('user-list-body');
            if (!tbody) return;
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ß‡πà‡∏≤‡∏á
            if (!systemUsersDB || systemUsersDB.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-500">No Data</td></tr>`;
                return;
            }

            tbody.innerHTML = systemUsersDB.map(u => {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤ User Manager)
                const isAdmin = u.permissions && u.permissions.includes('nav-user-manager');
                const roleBadge = isAdmin 
                    ? '<span class="bg-red-900/50 text-red-200 border border-red-700 px-2 py-1 rounded text-[10px] font-bold uppercase">üëë ADMIN</span>'
                    : '<span class="bg-blue-900/50 text-blue-200 border border-blue-700 px-2 py-1 rounded text-[10px] font-bold uppercase">üë§ USER</span>';
                
                // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö admin ‡∏´‡∏•‡∏±‡∏Å)
                const isLocked = (CURRENT_USER && u.id === CURRENT_USER.username) || u.id === 'admin';
                const deleteBtn = isLocked 
                    ? `<span class="text-gray-600 text-xs italic px-2">Locked</span>`
                    : `<button onclick="deleteUser('${u.id}')" class="text-red-400 hover:text-white border border-red-900 px-2 py-1 rounded text-xs">Delete</button>`;

                return `
                    <tr class="hover:bg-[#1f2937] border-b border-gray-800 transition">
                        <td class="p-4 font-mono text-yellow-500">${u.id}</td>
                        <td class="p-4 text-white font-bold">${u.name}</td>
                        <td class="p-4">${roleBadge}</td>
                        <td class="p-4 text-right flex justify-end gap-2 items-center">
                            <button onclick="openEditUserModal('${u.id}')" class="text-blue-400 hover:text-white border border-blue-800 px-2 py-1 rounded text-xs">‚úèÔ∏è Edit</button>
                            ${deleteBtn}
                        </td>
                    </tr>`;
            }).join('');
        }

        // --- 2. ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏û‡∏¥‡πà‡∏° User ---
        function openAddUserModal() {
            document.getElementById('user-modal-title').innerText = "Add New User";
            document.getElementById('form-user-mode').value = 'add';
            
            // Clear Form
            document.getElementById('form-user-id').value = '';
            document.getElementById('form-user-id').disabled = false;
            document.getElementById('form-user-name').value = '';
            document.getElementById('form-user-pass').value = '';
            
            // Generate Checkbox (‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Default)
            renderPermissionCheckboxes([]); 
            
            document.getElementById('userModal').style.display = 'flex';
        }

        // --- 3. ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç User ---
        function openEditUserModal(userId) {
            const user = systemUsersDB.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('user-modal-title').innerText = "Edit User: " + user.id;
            document.getElementById('form-user-mode').value = 'edit';
            
            // Fill Form
            document.getElementById('form-user-id').value = user.id;
            document.getElementById('form-user-id').disabled = true; // ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ ID
            document.getElementById('form-user-name').value = user.name;
            document.getElementById('form-user-pass').value = user.pass;
            
            // Generate Checkbox (‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á User)
            // ‡∏ñ‡πâ‡∏≤ User ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Permissions ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ Role ‡πÄ‡∏Å‡πà‡∏≤
            let perms = user.permissions;
            if (!perms) {
                if (user.role === 'admin') perms = ALL_MENUS.map(m => m.id); // ‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
                else perms = ALL_MENUS.filter(m => m.default).map(m => m.id); // ‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô User ‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡πà Default
            }
            renderPermissionCheckboxes(perms);

            document.getElementById('userModal').style.display = 'flex';
        }

        // --- 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (SAVE) ---
        async function saveUserData() {
            const id = document.getElementById('form-user-id').value.trim();
            const name = document.getElementById('form-user-name').value.trim();
            const pass = document.getElementById('form-user-pass').value.trim();
            const mode = document.getElementById('form-user-mode').value;

            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° Checkbox
            let selectedPerms = [];
            document.querySelectorAll('.perm-check:checked').forEach(cb => selectedPerms.push(cb.value));

            if (!id || !pass || !name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");

            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Object User
            // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö role ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ user-manager = admin)
            const derivedRole = selectedPerms.includes('nav-user-manager') ? 'admin' : 'user';
            
            const userData = {
                id: id,
                name: name,
                pass: pass,
                role: derivedRole, 
                permissions: selectedPerms // <--- ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Array ‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ
            };

            try {
                if (mode === 'add') {
                    if (systemUsersDB.some(u => u.id === id)) throw new Error("Username ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
                    systemUsersDB.push(userData);
                    logAudit('ADD_USER', id, `Role: ${derivedRole}, Perms: ${selectedPerms.length}`);
                } else {
                    const idx = systemUsersDB.findIndex(u => u.id === id);
                    if (idx > -1) {
                        systemUsersDB[idx] = userData;
                        logAudit('EDIT_USER', id, `Updated Perms: ${selectedPerms.length}`);
                    }
                }

                document.getElementById('userModal').style.display = 'none';

                // *** Sync ‡∏Ç‡∏∂‡πâ‡∏ô Google Sheets ***
                await pushData();
                
                renderUserManager();
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                hideLoading();
            }
        }

        // --- 6. ‡∏•‡∏ö (DELETE) ---
        async function deleteUser(id) {
            if (!confirm(`‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${id}" ?`)) return;
            
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...");
            systemUsersDB = systemUsersDB.filter(u => u.id !== id);
            logAudit('DEL_USER', id, 'Deleted');
            
            await pushData(); // Sync ‡∏Ç‡∏∂‡πâ‡∏ô Cloud
            
            renderUserManager();
         
            hideLoading();
        }

        // --- 7. APPLY PERMISSION (‡∏ï‡∏≠‡∏ô Login) ---
        function applyUserRole() {
            // 1. ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡πà‡∏≠‡∏ô
            ALL_MENUS.forEach(menu => {
                const el = document.getElementById(menu.id);
                if (el) el.style.display = 'none';
            });

            // 2. ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå User ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            let myPerms = CURRENT_USER.permissions || [];

            // Fallback: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô User ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ permission array
            if (CURRENT_USER.role === 'admin') myPerms = ALL_MENUS.map(m => m.id);
            else myPerms = ALL_MENUS.filter(m => m.default).map(m => m.id);

            // 3. ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
            myPerms.forEach(menuId => {
                const el = document.getElementById(menuId);
                if (el) el.style.display = 'flex';
            });

            const canManageWar = CURRENT_USER.role === 'admin';

            const btnEnd = document.getElementById('btn-end-season');
            const btnClear = document.getElementById('btn-clear-room');

            if (canManageWar) {
                if (btnEnd) btnEnd.style.display = 'flex';
                if (btnClear) btnClear.style.display = 'block';
            } else {
                if (btnEnd) btnEnd.style.display = 'none';
                if (btnClear) btnClear.style.display = 'none';
            }

            // 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Group Admin Zone (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π admin ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)
            const adminMenuIds = ['nav-user-manager', 'nav-audit-logs'];
            const hasAdmin = adminMenuIds.some(id => myPerms.includes(id));
            const adminGroup = document.getElementById('admin-menu-group');
            if (adminGroup) adminGroup.style.display = hasAdmin ? 'block' : 'none';
        }

        // ‡πÅ‡∏ñ‡∏°: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        function generateRandomPass() {
            const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
            const len = 6;
            let pass = "";
            for(let i=0; i<len; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('form-user-pass').value = pass;
        }

        function saveCloudSettings() {
            const val = document.getElementById('setting-url-input').value.trim();
            if(!val) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL"); return; }
            SCRIPT_URL = val; localStorage.setItem('7k_script_url', SCRIPT_URL); USE_CLOUD = true; startCloudSync(true); updateSyncStatus();
        }
        function startCloudSync(isInitial = false) { fetchCloudData(isInitial); if(syncInterval) clearInterval(syncInterval); }
        function fetchCloudData(showOverlay = false) {
            if(showOverlay) showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            const badge = document.getElementById('sync-status'); const statusText = document.getElementById('status-text'); const settingStatus = document.getElementById('setting-status-display');

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ (Realtime) ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà‡∏à‡∏∏‡∏î‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
            if(!showOverlay && badge) badge.classList.add('loading');

            // ‡πÉ‡∏ä‡πâ mode: 'cors' ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ (default) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ response.json() ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {

                if (data.serverVersion) checkVersionMismatch(data.serverVersion);

                if (data.timestamp && data.timestamp <= lastServerTimestamp) {
                    console.log("Data is up to date.");
                    if(badge) badge.classList.remove('loading');
                    if(showOverlay) hideLoading();
                    return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Render ‡πÉ‡∏´‡∏°‡πà
                }

                if (data.timestamp) lastServerTimestamp = data.timestamp;
                console.log("New data detected! Updating UI...");

                if (data.users && Array.isArray(data.users)) {
                    systemUsersDB = data.users;
                    console.log("Users loaded:", systemUsersDB.length);
                } else {
                    // ‡∏ñ‡πâ‡∏≤ Server ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Default (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
                    if(systemUsersDB.length === 0) {
                        systemUsersDB = [{ id: 'admin', name: 'Super Admin', pass: '1234', role: 'admin' }];
                    }
                }

                heroesDB = data.heroes || []; petsDB = data.pets || []; ringsDB = data.rings || [];
                if(data.affiliations && Array.isArray(data.affiliations)) affiliationsDB = data.affiliations;
                // if(data.tierLists) tierListsDB = data.tierLists; else 
                loadLocalTierData();
                // if(!tierListsDB) tierListsDB = { hero: {}, pet: {} };
                ['hero', 'pet'].forEach(type => { if(!tierListsDB[type]) tierListsDB[type] = {}; TIER_MODES.forEach(m => { if(!tierListsDB[type][m]) tierListsDB[type][m] = {}; }); });
                
                if(data.teams) { if(data.teams.teams) teamsDB = data.teams.teams; else teamsDB = data.teams; if(data.teams.logs) logsDB = data.teams.logs; else if(!logsDB) logsDB = []; }

                console.log(data.guildMembers)
                
                if (data.guildMembers && data.guildMembers.length === 30) {
                    guildMembersDB = data.guildMembers;
                } else {
                    initGuildMembers(); // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà 30 ‡∏ä‡πà‡∏≠‡∏á
                }

                if (data.knownEnemies) knownEnemies = data.knownEnemies; 
                else knownEnemies = [];
                
                if(data.battleHistory) battleHistoryDB = data.battleHistory; else battleHistoryDB = [];
                if (data.seasonInfo) {
                    currentSeason = data.seasonInfo;
                } else{
                    console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SeasonInfo ‡∏ö‡∏ô Cloud, ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô");
                    currentSeason = { 
                        id: 1, 
                        name: 'Season 1', 
                        opponent: '-', 
                        status: 'waiting', 
                        startDate: new Date().toLocaleDateString('th-TH') 
                    };
                }
                if (data.archivedSeasons) archivedSeasons = data.archivedSeasons;
                else archivedSeasons = [];

                if (data.heroSets) heroSetsDB = data.heroSets;

                syncWarRoomFromHistory();

                if(currentView === 'war-room') checkWarRoomStatus();
                else if(currentView === 'my-teams') renderGuildResultMode();
                else if(currentView === 'logs') renderLogs(); 
                else if(currentView === 'gallery') renderGallery();
                else if(currentView === 'simulator') renderSimulatorTeams();
                else if(currentView === 'tier-viewer') renderTierViewer();
                // else if(currentView === 'tier-manager') initTierManager(currentTierType);
                else if(currentView.includes('manager')) renderManagerUI();
                
                if(badge) { badge.classList.remove('loading', 'offline'); statusText.innerText = 'ONLINE'; }
                if(settingStatus) settingStatus.innerHTML = `<div class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]"></div> <span class="text-green-500">Connected</span>`;
                if(showOverlay) { document.getElementById('loading-text').innerText = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!"; setTimeout(() => { hideLoading(); if(currentView === 'settings') switchView('war-room'); }, 1000); }
                updateGuildWarUI();
                updateCurrentViewUI(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
        
                if(badge) badge.classList.remove('loading');
                if(showOverlay) hideLoading();
            }).catch(err => {
                if(badge) { badge.classList.remove('loading'); badge.classList.add('offline'); statusText.innerText = 'OFFLINE'; }
                if(settingStatus) settingStatus.innerHTML = `<div class="w-3 h-3 rounded-full bg-red-500"></div> <span class="text-red-500">Connection Failed</span>`;
                if(showOverlay) { document.getElementById('loading-text').innerText = "‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"; setTimeout(hideLoading, 1500); }
                console.error("Sync Error:", err);
                if(showOverlay) hideLoading();
            });
        }
        async function pushData(showOverlay = false) {
            if(!USE_CLOUD) return;

            // ‡∏´‡∏¢‡∏∏‡∏î Real-time sync ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
            if (realTimeInterval) clearInterval(realTimeInterval);
            isSaving = true;
            
            const now = Date.now();
            lastServerTimestamp = now;

            // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI (Badge ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤)
            const badge = document.getElementById('sync-status');
            const statusText = document.getElementById('status-text');
            if(badge && statusText) { 
                badge.className = 'sync-badge loading'; 
                statusText.innerText = 'Saving...';
            }

            // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI (Loading ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠) -> ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Save ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏ö Battle
            if (showOverlay) {
                showLoading("‚òÅÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Cloud...");
            }

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payload
            const payload = { 
                timestamp: now,
                teams: teamsDB, 
                heroes: heroesDB, 
                pets: petsDB, 
                rings: ringsDB,
                guildMembers: guildMembersDB, 
                heroSets: heroSetsDB, 
                items: itemsDB,
                auditLogs: auditLogsDB, 
                users: systemUsersDB, 
                knownEnemies: knownEnemies,
                affiliations: affiliationsDB, 
                battleHistory: battleHistoryDB, 
                seasonInfo: currentSeason, 
                archivedSeasons: archivedSeasons
            };
            
            try {
                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(payload) 
                });

                console.log("‚úÖ Save Sent.");
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                if(badge && statusText) { 
                    badge.className = 'sync-badge sync-cloud'; 
                    statusText.innerText = 'SAVED';
                }

            } catch (err) {
                console.error("Save Error:", err);
                if(statusText) {
                    badge.className = 'sync-badge offline';
                    statusText.innerText = 'Error';
                }
                if (showOverlay) alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + err.message);
            } finally {
                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
                isPendingSave = false; 
                isSaving = false;
                
                // ‡∏õ‡∏¥‡∏î Loading ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ)
                if (showOverlay) {
                    hideLoading();
                }

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á Auto-Sync ‡πÉ‡∏´‡∏°‡πà
                setTimeout(() => {
                    if(statusText && statusText.innerText === 'SAVED') {
                        statusText.innerText = 'ONLINE';
                    }
                    startRealTimeSync(); 
                }, 5000); 
            }
        }
        function updateSyncStatus() { const b = document.getElementById('sync-status'); const t = document.getElementById('status-text'); const s = document.getElementById('setting-status-display'); if(!USE_CLOUD) { b.className = 'sync-badge offline'; t.innerText = 'NO SETUP'; if(s) s.innerHTML = `<div class="w-3 h-3 rounded-full bg-gray-500"></div> Not Configured`; } }

        function switchView(v) {
            currentView = v;

            // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Sidebar (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            document.querySelectorAll('.sidebar .menu-item').forEach(e => e.classList.remove('active'));
            const nav = document.getElementById('nav-' + v);
            if (nav) nav.classList.add('active');

            // 2. ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            document.querySelectorAll('main > div').forEach(el => {
                if (el.id !== 'sidebar-floating-btn') {
                    el.classList.add('hidden');
                    el.classList.remove('tab-active');
                }
            });

            // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î ID ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            const targetViewMap = {
                'home': 'view-home',
                'war-room': 'view-war-room',
                'preparation': 'view-preparation',
                'battle-war': 'view-battle-war',
                'battle-history': 'view-battle-history',
                'simulator': 'view-simulator',
                'gallery': 'view-gallery',
                'tier-viewer': 'view-tier-viewer',
                'analytics': 'view-analytics',
                'settings': 'view-settings',
                
                // Database & Admin
                'hero-manager': 'view-manager',
                'pet-manager': 'view-manager',
                'item-manager': 'view-manager',
                'ring-manager': 'view-manager',
                'set-manager': 'view-set-manager',
                'user-manager': 'view-user-manager',
                'audit-logs': 'view-audit-logs',

                // ‚úÖ [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°]
                'hero-lists': 'view-hero-lists' // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
            };

            const targetId = targetViewMap[v];
            const el = document.getElementById(targetId);
            
            if (el) {
                el.classList.remove('hidden');
                el.classList.add('tab-active');

                // Init Functions (‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤)
                if (v === 'war-room') checkWarRoomStatus();
                else if (v === 'preparation') renderPreparation();
                else if (v === 'battle-war') renderBattleWar();
                else if (v === 'battle-history') renderFullHistory();
                else if (v === 'simulator') initSimulator();
                else if (v === 'tier-viewer') renderTierViewer();
                else if (v === 'gallery') renderGallery();
                else if (v === 'analytics') renderAnalytics();
                else if (v === 'settings') updateSyncStatus();
                else if (v === 'audit-logs') renderAuditLogs();
                else if (v === 'user-manager') renderUserManager();
                else if (v === 'set-manager') renderSetManager();
                else if (v.includes('manager')) renderManagerUI();

                // ‚úÖ [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°]
                else if (v === 'hero-lists') renderHeroListsView(); // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
            }
        }

        // --- CASTLE MENU ---
        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó ---
        function renderCastleMenu() {
            const container = document.getElementById('castle-selector-bar');
            if(!container) return;
            
            const castles = [
                { grp: '‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡∏ô‡∏≠‡∏Å', items: ['‡∏ô‡∏≠‡∏Å 1', '‡∏ô‡∏≠‡∏Å 2', '‡∏ô‡∏≠‡∏Å 3', '‡∏ô‡∏≠‡∏Å 4', '‡∏ô‡∏≠‡∏Å 5', '‡∏ô‡∏≠‡∏Å 6', '‡∏ô‡∏≠‡∏Å 7', '‡∏ô‡∏≠‡∏Å 8'] },
                { grp: '‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡πÉ‡∏ô', items: ['‡πÉ‡∏ô 1', '‡πÉ‡∏ô 2', '‡πÉ‡∏ô 3', '‡πÉ‡∏ô 4', '‡πÉ‡∏ô 5', '‡πÉ‡∏ô 6', '‡πÉ‡∏ô 7', '‡πÉ‡∏ô 8'] },
                { grp: '‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°‡πÅ‡∏´‡πà‡∏á‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå', items: ['‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå'] }
            ];

            let h = '';
            castles.forEach(g => {
                h += `<div class="flex items-center mb-1"><span class="castle-group-label">${g.grp}</span><div class="flex flex-wrap gap-2">`;
                
                g.items.forEach(c => {
                    // 1. Logic ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                    let hasData = false;
                    const limit = (c === '‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå') ? 30 : 10; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡πâ‡∏≤‡∏ô

                    for(let i=0; i<limit; i++) {
                        const key = `${c}-${i}`;
                        const team = teamsDB[key];
                        
                        // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô Slot ‡∏ô‡∏±‡πâ‡∏ô ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô (player) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà Hero ‡πÑ‡∏ß‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß
                        if (team && (team.player || (team.slots && Object.values(team.slots).some(s => s !== null)))) {
                            hasData = true;
                            break; // ‡πÄ‡∏à‡∏≠‡πÅ‡∏Ñ‡πà 1 ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡πá‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ
                        }
                    }

                    // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Class ‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°
                    let btnClass = 'castle-btn transition-all duration-200 '; // ‡πÄ‡∏û‡∏¥‡πà‡∏° transition ‡∏ô‡∏∏‡πà‡∏°‡πÜ
                    
                    if (currentCastle === c) {
                        // ‡∏Å‡∏£‡∏ì‡∏µ: ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà (Active) -> ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏ß‡πà‡∏≤‡∏á (CSS .active ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£)
                        btnClass += ' active border-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]';
                    } 
                    else if (hasData) {
                        // ‡∏Å‡∏£‡∏ì‡∏µ: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏ï‡πà "‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" -> ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏ä‡∏±‡∏î, ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö, ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏°
                        btnClass += ' bg-[#1f2937] text-gray-200 border-gray-500 hover:border-gray-300 hover:text-white opacity-100';
                    } 
                    else {
                        // ‡∏Å‡∏£‡∏ì‡∏µ: "‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤" -> ‡∏™‡∏µ‡∏à‡∏≤‡∏á‡∏°‡∏≤‡∏Å, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö, ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á
                        btnClass += ' bg-transparent text-gray-600 border-transparent opacity-40 hover:opacity-100 hover:bg-[#1f2937]';
                    }

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°
                    h += `<button onclick="changeCastle('${c}', ${g.grp==='‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°‡πÅ‡∏´‡πà‡∏á‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå'?30:10})" class="${btnClass}" id="nav-castle-${c.replace(' ', '-')}">${c}</button>`;
                });
                h += `</div></div>`;
            });
            container.innerHTML = h;
        }

        function changeCastle(name, cap) {
            currentCastle = name; currentCap = cap;
            document.querySelectorAll('.castle-btn').forEach(e => e.classList.remove('active'));
            const activeBtn = document.getElementById(`nav-castle-${name.replace(' ', '-')}`);
            if(activeBtn) activeBtn.classList.add('active');
            document.getElementById('castle-title').innerText = `‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó${name}`;
            renderDashboard();
        }

        // --- 1. openBattleModal: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Header ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ---
        // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] openBattleModal: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏î‡∏≤‡∏ß‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô AI Analysis ---
        function openBattleModal(enemySlotIdx) {
            activeBattleSlot = enemySlotIdx;
            battleActiveMemberIdx = null; 
            battleTempTeam = null; 

            const enemyTeam = getTeam(enemySlotIdx);
            
            // 1. Header
            const headerInfo = document.getElementById('battle-header-info');
            if(headerInfo) {
                headerInfo.innerHTML = `
                    <div class="text-gray-400 font-bold uppercase">Target: ${currentCastle} (Slot ${enemySlotIdx+1})</div>
                    <div class="text-red-400 font-bold">Enemy: ${enemyTeam.player || 'Unknown'}</div>
                `;
            }

            // 2. Clear Old Panel
            const enemyPanel = document.getElementById('battle-enemy-panel');
            if (enemyPanel) enemyPanel.innerHTML = ''; 

            // 3. --- üß† AI ANALYSIS ---
            let enemyHeroIds = [];
            if (enemyTeam.slots) {
                for(let i=0; i<5; i++) if(enemyTeam.slots[i]) enemyHeroIds.push(enemyTeam.slots[i].id);
            }
            const enemySig = enemyHeroIds.sort().join(','); 
            
            // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            const history = battleHistoryDB.filter(x => x && x.enemySignature === enemySig);
            
            let aiContent = '';
            
            if (history.length > 0) {
                let heroStats = {}; 
                let turnStats = [{}, {}, {}]; 
                let totalWins = 0;

                history.forEach(log => {
                    const isWin = log.status === 'Win' || log.result === 'Win';
                    
                    // üü¢ [Logic ‡πÉ‡∏´‡∏°‡πà] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Hero + ‡∏î‡∏≤‡∏ß ‡∏à‡∏≤‡∏Å Log
                    // ‡∏ñ‡πâ‡∏≤ Log ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ playerData ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ playerIds ‡πÅ‡∏ó‡∏ô (‡∏î‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô 0)
                    const pList = log.playerData || (log.playerIds || []).map(id => ({ id, star: 0 }));

                    pList.forEach(p => {
                        if (!p.id) return;
                        if (!heroStats[p.id]) heroStats[p.id] = { wins: 0, total: 0, starSum: 0 };
                        
                        heroStats[p.id].total++;
                        heroStats[p.id].starSum += (p.star || 0); // ‡∏™‡∏∞‡∏™‡∏°‡∏î‡∏≤‡∏ß
                        
                        if (isWin) heroStats[p.id].wins++;
                    });

                    // Sequence Stats (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏≤‡∏ß)
                    if (isWin) {
                        totalWins++;
                        const queue = Array.isArray(log.skillQueue) ? log.skillQueue : [];
                        queue.forEach((move, idx) => {
                            if (idx > 2) return; 
                            const parts = move.split('-');
                            if (parts.length < 2) return;
                            const sIdx = parseInt(parts[0]); 
                            const sNum = parts[1]; 
                            
                            // ‡∏´‡∏≤ Hero ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏Å‡∏¥‡∏•
                            let hid = null;
                            if (log.playerData && log.playerData[sIdx]) hid = log.playerData[sIdx].id;
                            else if (log.playerIds) hid = log.playerIds[sIdx];

                            if (hid) {
                                const key = `${hid}-${sNum}`;
                                if (!turnStats[idx][key]) turnStats[idx][key] = 0;
                                turnStats[idx][key]++;
                            }
                        });
                    }
                });

                // --- Render Visuals ---

                // 1. Top Counters (Best Heroes)
                const topCounters = Object.keys(heroStats)
                    .map(hid => ({ 
                        id: hid, 
                        ...heroStats[hid], 
                        wr: (heroStats[hid].wins / heroStats[hid].total) * 100,
                        avgStar: Math.round(heroStats[hid].starSum / heroStats[hid].total) // üü¢ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≤‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
                    }))
                    .sort((a,b) => b.wr - a.wr || b.wins - a.wins)
                    .slice(0, 5);

                const countersHTML = topCounters.map(c => {
                    const h = heroesDB.find(x => x.id === c.id);
                    const imgSrc = (h && h.img) ? h.img : 'https://placehold.co/64x64/black/white?text=?';
                    
                    const isGodTier = c.wr >= 80;
                    const isGoodTier = c.wr >= 50;
                    const borderColor = isGodTier ? 'border-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.3)]' : (isGoodTier ? 'border-green-600' : 'border-gray-600');
                    const textColor = isGodTier ? 'text-yellow-400' : (isGoodTier ? 'text-green-400' : 'text-gray-400');

                    // üü¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏î‡∏≤‡∏ß (‡∏¢‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏î‡πâ‡∏ß‡∏¢ scale ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡πá‡∏Å)
                    // ‡πÉ‡∏ä‡πâ getStarsHTML ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ false ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ style ‡∏Ç‡∏≠‡∏á slot)
                    const starHtml = c.avgStar > 0 
                        ? `<div class="absolute bottom-0 left-0 right-0 flex justify-center z-20" style="transform: scale(0.65); transform-origin: bottom center; margin-bottom: -2px;">${getStarsHTML(c.avgStar, false)}</div>`
                        : '';

                    return h ? `
                        <div class="flex flex-col items-center gap-1 group relative">
                            <div class="w-12 h-12 rounded-xl border-2 ${borderColor} bg-black relative shadow-md transition transform hover:scale-105">
                                <img src="${imgSrc}" class="w-full h-full object-cover rounded-lg">
                                ${starHtml} </div>
                            <span class="text-[9px] ${textColor} font-bold bg-black/60 px-2 py-0.5 rounded-full border border-white/10 shadow-sm">${c.wr.toFixed(0)}%</span>
                            <div class="absolute bottom-full mb-1 hidden group-hover:block bg-gray-900 text-white text-[10px] p-1.5 rounded border border-gray-600 whitespace-nowrap z-50 shadow-xl">
                                ${h.name} (${c.wins}/${c.total})<br>Avg: ${c.avgStar}‚òÖ
                            </div>
                        </div>` : '';
                }).join('');

                // 2. Sequence Visuals (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞ ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ï‡πâ‡∏≠‡∏á)
                let sequenceHTML = '';
                const turnLabels = ['Turn 1', 'Turn 2', 'Turn 3'];
                const turnColors = ['text-yellow-400', 'text-blue-400', 'text-purple-400'];

                turnStats.forEach((stats, turnIdx) => {
                    const topMoves = Object.keys(stats)
                        .map(key => {
                            const [hid, sNum] = key.split('-');
                            return { id: hid, sNum: sNum, count: stats[key] };
                        })
                        .sort((a, b) => b.count - a.count)
                        .slice(0, 3); 

                    if (topMoves.length > 0) {
                        const movesHTML = topMoves.map((m, rank) => {
                            const h = heroesDB.find(x => x.id === m.id);
                            const imgSrc = (h && h.img) ? h.img : 'https://placehold.co/64x64/black/white?text=?';
                            const colorClass = m.sNum === '1' ? 'bg-blue-600' : 'bg-yellow-600 text-black';
                            const label = m.sNum === '1' ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô';
                            const pickRate = ((m.count / totalWins) * 100).toFixed(0);
                            
                            const isRank1 = rank === 0;
                            const sizeClass = isRank1 ? 'w-11 h-11 border-white/40' : 'w-9 h-9 border-gray-600 opacity-80';
                            const rankBadge = isRank1 ? `<div class="absolute -top-2 -left-2 bg-red-600 text-white text-[8px] w-4 h-4 flex items-center justify-center rounded-full border border-black shadow z-10 font-bold">1</div>` : '';

                            return `
                                <div class="flex flex-col items-center relative group">
                                    ${rankBadge}
                                    <div class="relative ${sizeClass} rounded-lg bg-black border-2 flex-shrink-0 shadow-lg mb-1">
                                        <img src="${imgSrc}" class="w-full h-full object-cover rounded-md" onerror="this.src='https://placehold.co/64x64/black/white?text=?'">
                                        <div class="absolute bottom-0 right-0 ${colorClass} text-white text-[7px] font-bold px-1 leading-none shadow rounded-tl">${label}</div>
                                    </div>
                                    <span class="text-[8px] ${isRank1 ? 'text-green-300 font-bold' : 'text-gray-500'} bg-black/40 px-1 rounded">${pickRate}%</span>
                                    
                                    <div class="absolute bottom-full mb-1 hidden group-hover:block bg-gray-900 text-white text-[10px] p-1.5 rounded border border-gray-600 whitespace-nowrap z-50 shadow-xl">
                                        ${h?.name} (${m.count} picks)
                                    </div>
                                </div>
                            `;
                        }).join('');

                        sequenceHTML += `
                            <div class="bg-black/20 rounded-lg p-2 mb-2 border border-white/5 flex items-center gap-3">
                                <div class="text-[10px] ${turnColors[turnIdx]} font-bold uppercase w-10 text-right flex-shrink-0 border-r border-white/10 pr-2 leading-tight">
                                    ${turnLabels[turnIdx]}
                                </div>
                                <div class="flex items-end gap-3">
                                    ${movesHTML}
                                </div>
                            </div>
                        `;
                    }
                });

                aiContent = `
                    <div class="space-y-5">
                        <div>
                            <div class="text-[10px] text-green-400 font-bold uppercase mb-2 flex justify-between items-center px-1">
                                <span>üèÜ Best Heroes (Win Rate)</span>
                            </div>
                            <div class="flex gap-3 flex-wrap justify-center bg-[#0d1117] p-3 rounded-xl border border-gray-800 shadow-inner">
                                ${countersHTML || '<span class="text-xs text-gray-500">No data</span>'}
                            </div>
                        </div>

                        <div class="relative">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="w-full border-t border-gray-700"></div>
                            </div>
                            <div class="relative flex justify-center">
                                <span class="bg-[#161b22] px-2 text-[10px] text-gray-500 uppercase">Strategy</span>
                            </div>
                        </div>

                        <div>
                            <div class="text-[10px] text-yellow-500 font-bold uppercase mb-2 flex justify-between items-center px-1">
                                <span>‚ö° Skill Priority</span>
                                <span class="text-[8px] text-gray-500 bg-gray-800 px-1.5 rounded-full">${totalWins} wins sample</span>
                            </div>
                            <div class="flex flex-col gap-1">
                                ${sequenceHTML || '<div class="text-center py-4 text-xs text-gray-600 bg-black/20 rounded border border-gray-800 border-dashed">No skill data available</div>'}
                            </div>
                        </div>
                    </div>
                `;

            } else {
                aiContent = `
                    <div class="flex flex-col items-center justify-center py-12 gap-3 opacity-60">
                        <div class="w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center text-3xl">ü§ñ</div>
                        <div class="text-xs text-gray-500 font-bold">No Battle History</div>
                        <div class="text-[10px] text-gray-600 text-center max-w-[200px]">Fight this team to generate AI analysis data.</div>
                    </div>
                `;
            }

            // 3. Render AI Panel
            const aiPanel = document.getElementById('battle-ai-panel');
            if (aiPanel) {
                aiPanel.innerHTML = `
                    <div class="bg-[#161b22] border border-green-500/20 rounded-2xl p-4 shadow-xl w-full min-h-[400px]">
                        <div class="flex items-center justify-between gap-2 mb-5 pb-3 border-b border-gray-700/50">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl filter drop-shadow">ü§ñ</span>
                                <div class="flex flex-col">
                                    <span class="text-xs font-black text-green-400 uppercase tracking-widest">AI Advisor</span>
                                    <span class="text-[8px] text-gray-500">Tactical Analysis</span>
                                </div>
                            </div>
                        </div>
                        ${aiContent}
                    </div>
                `;
            }

            // Reset State & Show Modal
            document.getElementById('battle-builder-area').innerHTML = `...`; 
            document.getElementById('battle-actions').classList.add('hidden');

            const sidebarInput = document.querySelector('#battleModal input[placeholder="Filter..."]');
            if(sidebarInput) sidebarInput.id = "battle-guild-search";

            renderBattleGuildList(); 
            renderBattleBuilder(); 
            document.getElementById('battleModal').style.display = 'flex';
        }
        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Render List ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
        function renderBattleGuildList() {
            const list = document.getElementById('battle-guild-list');
            if(!list) return;
            list.innerHTML = '';

            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ
            const memberUsage = guildMembersDB.map((mem, mIdx) => {
                const used = battleHistoryDB.filter(log => log.myTeamId && log.myTeamId.startsWith(`G-${mIdx}-`)).length;
                return { ...mem, originalIdx: mIdx, usedCount: used };
            });

            // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
            memberUsage.sort((a, b) => {
                const aFull = a.usedCount >= 5;
                const bFull = b.usedCount >= 5;
                if (!aFull && bFull) return -1;
                if (aFull && !bFull) return 1;
                return a.usedCount - b.usedCount; 
            });

            // 3. Render List
            memberUsage.forEach((mem) => {
                const mIdx = mem.originalIdx;
                const used = mem.usedCount;
                const isFull = used >= 5;
                const isActive = (battleActiveMemberIdx === mIdx);
                
                let bgClass = isActive ? 'bg-blue-600 text-white border-blue-500' : 'bg-[#1f2937] text-gray-300 border-gray-600 hover:bg-gray-700';
                let textClass = isFull ? 'text-red-500' : 'text-green-400';
                if (isActive && !isFull) textClass = 'text-green-200';
                
                const clickAction = isFull ? '' : `onclick="selectMemberForBattle(${mIdx})"`;
                const cursorClass = isFull ? 'cursor-not-allowed opacity-50 grayscale' : 'cursor-pointer';

                list.innerHTML += `
                    <div ${clickAction} 
                        class="p-3 mb-1 rounded border flex justify-between items-center ${bgClass} ${cursorClass} guild-mem-group" 
                        data-name="${mem.name.toLowerCase()}">
                        
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-black/30 flex items-center justify-center text-xs font-bold border border-white/10">
                                ${mIdx + 1}
                            </div>
                            <div>
                                <div class="font-bold text-sm ${isActive ? 'text-white' : ''}">${mem.name}</div>
                            </div>
                        </div>

                        <div class="flex flex-col items-end">
                            <span class="text-xs font-black ${textClass}">${used}/5</span>
                            <span class="text-[8px] uppercase tracking-wide opacity-60">Attacked</span>
                        </div>
                    </div>
                `;
            });

            // --- üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ---
            const searchInput = document.getElementById('battle-guild-search');
            if (searchInput && searchInput.value) {
                filterBattleGuildList(searchInput.value);
            }
        }
        // --- [5] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà selectMemberForBattle ---
        function selectMemberForBattle(mIdx) {
            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏à‡∏≤‡∏Å Logs (Double Check)
            const usedCount = battleHistoryDB.filter(log => log.myTeamId && log.myTeamId.startsWith(`G-${mIdx}-`)).length;

            if (usedCount >= 5) {
                alert("‚ùå ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Battle Logs)");
                return;
            }

            battleActiveMemberIdx = mIdx;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            battleTempTeam = { 
                id: 'BATTLE-TEMP', 
                name: `Attack by ${guildMembersDB[mIdx].name}`, 
                formation: 'basic', 
                slots: {0:null,1:null,2:null,3:null,4:null}, 
                pet: null, 
                skillQueue: [] 
            };

            renderBattleGuildList(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Highlight

            document.getElementById('battle-actions').classList.remove('hidden');
            document.getElementById('battle-footer-info').innerHTML = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏ó‡∏±‡∏û‡πÉ‡∏´‡πâ: <span class="text-blue-400">${guildMembersDB[mIdx].name}</span>`;

            renderBattleBuilder();
        }

        // --- 2. renderBattleBuilder: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ Compact (‡∏Ç‡πâ‡∏≠ 3) ---
        function renderBattleBuilder() {
            const container = document.getElementById('battle-builder-area');
            if (!container) return;

            if (!battleTempTeam) {
                battleTempTeam = { id: 'BATTLE-TEMP', name: 'New Team', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] };
            }

            let enemyTeamHTML = '';
            if (activeBattleSlot !== null && activeBattleSlot !== undefined) {
                const enemyTeam = getTeam(activeBattleSlot);
                if (enemyTeam) {
                    enemyTeamHTML = generateSimCardHTML(enemyTeam, 'ENEMY-VIEW', false, true);
                }
            }

            const myTeamHTML = generateSimCardHTML(battleTempTeam, 'BATTLE-TEMP', true, false);

            // AI Summary (‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏û‡πâ‡∏ó‡∏≤‡∏á)
            let warnings = [];
            // ... (‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î AI Warning ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ... ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)

            container.className = "w-full max-w-[750px] mx-auto flex-col items-center border-none p-0 transition-all bg-transparent min-h-fit gap-4";

            container.innerHTML = `
                <div class="w-full h-full flex flex-col gap-4 pb-4 mt-4"> 
                    
                    ${enemyTeamHTML ? `
                    <div class="relative w-full opacity-100 transition duration-300">
                        <div class="absolute -top-3 left-4 z-20 bg-red-900 text-red-100 text-[10px] font-bold px-2 py-0.5 rounded border border-red-500 shadow-md">OPPONENT</div>
                        ${enemyTeamHTML}
                    </div>
                    
                    <div class="flex items-center justify-center relative -my-2 z-20">
                        <div class="bg-gradient-to-r from-transparent via-gray-700 to-transparent h-px w-full absolute"></div>
                        <div class="bg-black border-2 border-yellow-500 rounded-full w-10 h-10 flex items-center justify-center text-yellow-500 font-black text-sm shadow-[0_0_15px_rgba(234,179,8,0.6)] relative z-10">VS</div>
                    </div>
                    ` : ''}
                    
                    <div class="relative w-full">
                        <div class="absolute -top-3 left-4 z-20 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded border border-blue-400 shadow-md">COMMANDER</div>
                        <div id="sim-team-BATTLE-TEMP" class="w-full">
                            ${myTeamHTML}
                        </div>
                    </div>

                </div>
            `;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡πÅ‡∏ñ‡∏°‡πÉ‡∏´‡πâ)
        function filterBattleGuildList(txt) {
            const term = txt.toLowerCase();
            const items = document.querySelectorAll('.guild-mem-group'); 

            items.forEach(el => {
                const name = el.getAttribute('data-name');
                if (name) {
                    // ‡πÉ‡∏ä‡πâ display: flex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏á layout ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤ none ‡∏Ñ‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô)
                    el.style.display = name.includes(term) ? 'flex' : 'none';
                }
            });
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏° (‡πÅ‡∏™‡∏î‡∏á Preview)
        function selectBattleTeam(mIdx, tIdx) {
            selectedAttacker = { memIdx: mIdx, teamIdx: tIdx };
            const team = guildMembersDB[mIdx].teams[tIdx];

            // Re-render List ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            renderBattleGuildList();

            // Show Actions
            document.getElementById('battle-actions').classList.remove('hidden');

            // Generate Preview HTML (‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Simulator ‡πÅ‡∏ï‡πà‡∏õ‡∏¥‡∏î Interaction)
            const cardHTML = generateSimCardHTML(team, `PREVIEW-${mIdx}-${tIdx}`, true);
            
            const previewArea = document.getElementById('battle-preview-area');
            previewArea.innerHTML = `
                <div class="w-full max-w-2xl animate-fade-in-up">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-white flex justify-center items-center gap-2">
                            <span class="text-blue-400">üõ°Ô∏è</span> ${team.name}
                        </h2>
                        <div class="text-gray-400 text-sm bg-[#111827] inline-block px-3 py-1 rounded-full border border-gray-700 mt-1">
                            Owner: <span class="text-white font-bold">${guildMembersDB[mIdx].name}</span>
                        </div>
                    </div>
                    
                    <div class="pointer-events-none select-none transform origin-top scale-100">
                        ${cardHTML}
                    </div>
                </div>
            `;

            // ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î Preview
            const container = previewArea.firstElementChild;
            const buttons = container.querySelectorAll('button');
            buttons.forEach(b => b.remove()); 
        }

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Å (Logic ‡πÅ‡∏û‡πâ/‡∏ä‡∏ô‡∏∞)
        // --- [8] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç confirmBattleResult (‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        // --- [8] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç confirmBattleResult (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡∏≤‡∏ß) ---
        async function confirmBattleResult(result) {
            // 1. Validation Checks (‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)
            if (battleActiveMemberIdx === null || !battleTempTeam) return;

            const hasHero = Object.values(battleTempTeam.slots).some(s => s !== null);
            if (!hasHero) { alert("‚ö†Ô∏è ‡∏ó‡∏µ‡∏°‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà"); return; }

            // ============================================================
            // üü¢ LOGIC ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏î‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
            // ============================================================
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (s && s.id) ‡πÅ‡∏ï‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ (!s.star)
            const missingStars = Object.values(battleTempTeam.slots).some(s => s && s.id && (!s.star || s.star === 0));

            if (missingStars) {
                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                if (!confirm("‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!\n\n‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡∏≤‡∏ß\n\n‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏π‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏î‡∏≤‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
                    return; // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î Cancel ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
                }
            }
            // ============================================================

            // Confirm ‡∏õ‡∏Å‡∏ï‡∏¥
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ: "${result.toUpperCase()}"`)) return;

            // 2. Prepare Data
            const myTeam = battleTempTeam;
            const enemyTeam = getTeam(activeBattleSlot); 
            const member = guildMembersDB[battleActiveMemberIdx];

            // --- ‡∏ï‡∏±‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ó‡∏µ‡∏° ---
            let targetTeamIdx = member.teams.findIndex(t => t && !t.isDead);
            if (targetTeamIdx === -1) targetTeamIdx = member.teams.length;
            
            const finalizedTeam = JSON.parse(JSON.stringify(myTeam));
            finalizedTeam.name = `Battle Team (R${targetTeamIdx+1})`;
            finalizedTeam.isDead = true;
            member.teams[targetTeamIdx] = finalizedTeam;

            // --- Update Enemy Stats ---
            if (result === 'Lose') enemyTeam.defensiveWins = (enemyTeam.defensiveWins || 0) + 1;
            else if (result === 'Win') enemyTeam.isCleared = true;

            // --- üü¢ Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Log (‡πÄ‡∏û‡∏¥‡πà‡∏° Ring) ---
            const createLogData = (teamSource) => {
                let data = [], ids = [];
                for(let i=0; i<5; i++) {
                    const s = teamSource.slots[i];
                    if(s) {
                        const h = heroesDB.find(x => x.id === s.id);
                        data.push({ 
                            id: s.id, 
                            star: s.star || 0, 
                            type: h ? h.type : 'Unknown',
                            ring: s.ring || null 
                        });
                        ids.push(s.id);
                    }
                }
                return { data, ids };
            };

            const myLog = createLogData(myTeam);
            const enemyLog = createLogData(enemyTeam);

            // --- üü¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á Record ‡∏´‡∏•‡∏±‡∏Å ---
            const record = {
                id: Date.now().toString(),
                timestamp: new Date().getTime(),
                date: new Date().toLocaleString('th-TH'),
                
                castle: getFullCastleName(currentCastle),
                castleSlot: activeBattleSlot + 1,
                castleKey: `${currentCastle}-${activeBattleSlot}`, // Key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sync ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                
                myTeamId: `G-${battleActiveMemberIdx}-${targetTeamIdx}`,
                myTeamName: finalizedTeam.name + ` (${member.name})`,
                
                playerData: myLog.data,
                enemyData: enemyLog.data,
                playerIds: myLog.ids,
                enemyIds: enemyLog.ids,
                enemySignature: enemyLog.ids.sort().join(','),
                
                myTeamStars: calculateTotalTeamStars(myTeam),
                enemyTeamStars: calculateTotalTeamStars(enemyTeam),
                
                skillQueue: myTeam.skillQueue || [],
                enemySkillQueue: enemyTeam.skillQueue || [], 

                myPet: myTeam.pet ? { id: myTeam.pet.id, star: myTeam.pet.star || 0 } : null,
                enemyPet: enemyTeam.pet ? { id: enemyTeam.pet.id, star: enemyTeam.pet.star || 0 } : null,

                enemyName: enemyTeam.player || 'Enemy',
                status: result,
                result: result
            };
            
            // Save to Local & Cloud
            battleHistoryDB.unshift(record);
            if (battleHistoryDB.length > 500) battleHistoryDB.pop();

            if(result === 'Win') addLog(currentCastle, activeBattleSlot, enemyTeam.player, 'Defeated');
            else addLog(currentCastle, activeBattleSlot, enemyTeam.player, 'Lost');

            // üü¢ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡πâ‡∏á)
            syncWarRoomFromHistory();

            renderDashboard(); 
            closeBattleModal();
            triggerAutoSave(true);
        }

        function syncWarRoomFromHistory() {
            console.log("üîÑ Re-syncing War Room status from History...");

            // 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å" ‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á)
            // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏ô Locked (‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ/‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ) ‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
            Object.keys(teamsDB).forEach(key => {
                if (teamsDB[key]) {
                    teamsDB[key].isCleared = false; 
                    teamsDB[key].defensiveWins = 0;
                }
            });

            // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ
            battleHistoryDB.forEach(log => {
                // ‡∏´‡∏≤ Key ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Log ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ castleKey ‡πÅ‡∏•‡∏∞ Log ‡πÄ‡∏Å‡πà‡∏≤)
                let key = log.castleKey;
                
                // Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Log ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ Code (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Key ‡πÄ‡∏≠‡∏á)
                if (!key && log.castle && log.castleSlot) {
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠ (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏°‡πà‡∏ô 100% ‡πÅ‡∏ï‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ)
                    // ‡πÄ‡∏ä‡πà‡∏ô "‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡∏ô‡∏≠‡∏Å 1" -> "‡∏ô‡∏≠‡∏Å 1"
                    let shortName = log.castle.replace('‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó', '').trim();
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡∏´‡∏•‡∏±‡∏Å (‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå)" -> "‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå"
                    if (shortName.includes('‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå')) shortName = '‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå';
                    
                    key = `${shortName}-${log.castleSlot - 1}`;
                }

                // 3. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô DB ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                if (key && teamsDB[key]) {
                    if (log.result === 'Win' || log.status === 'Win') {
                        teamsDB[key].isCleared = true; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏Å
                    } else if (log.result === 'Lose' || log.status === 'Lose') {
                        teamsDB[key].defensiveWins = (teamsDB[key].defensiveWins || 0) + 1;
                    }
                }
            });

            // 4. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            renderDashboard();
        }

        function closeBattleModal() { document.getElementById('battleModal').style.display = 'none'; activeBattleSlot = null; }

        async function recordBattle(result) {

            console.log("*** recordBattle", result);
            const memIdx = document.getElementById('battle-member-select').value;
            const teamIdx = document.getElementById('battle-team-select').value;
            
            if (teamIdx === "") { alert("‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏Ñ‡∏£‡∏±‡∏ö"); return; }

            const myTeam = guildMembersDB[memIdx].teams[teamIdx]; // ‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏°‡∏à‡∏≤‡∏Å Guild DB
            const enemyTeam = getTeam(activeBattleSlot);
            
            // 1. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• My Team (ID + Star)
            let playerData = [];
            let playerIds = []; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡∏ó‡∏≥ Signature ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            for(let i=0; i<5; i++) {
                const s = myTeam.slots[i];
                if(s) {
                    const h = heroesDB.find(x => x.id === s.id);
                    playerData.push({ 
                        id: s.id, 
                        star: s.star || 0,
                        type: h ? h.type : 'Unknown' // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö Type ‡∏•‡∏á‡πÉ‡∏ô Log ‡πÄ‡∏•‡∏¢
                    }); // ‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß
                    playerIds.push(s.id);
                }
            }

            // 2. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Enemy (ID + Star)
            let enemyData = [];
            let enemyIds = [];
            for(let i=0; i<5; i++) {
                const s = enemyTeam.slots[i];
                if(s) {
                    const h = heroesDB.find(x => x.id === s.id);
                    enemyData.push({ 
                        id: s.id, 
                        star: s.star || 0,
                        type: h ? h.type : 'Unknown' // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö Type ‡∏•‡∏á‡πÉ‡∏ô Log ‡πÄ‡∏•‡∏¢
                    }); // ‡πÄ‡∏Å‡πá‡∏ö‡∏î‡∏≤‡∏ß
                    enemyIds.push(s.id);
                }
            }
            
            const enemySignature = [...enemyIds].sort().join(',');

            // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            const record = {
                id: Date.now().toString(),
                timestamp: new Date().getTime(),
                date: new Date().toLocaleString('th-TH'),
                
                castle: getFullCastleName(currentCastle),
                castleSlot: activeBattleSlot + 1,
                
                myTeamId: myTeam.id,
                myTeamName: myTeam.name,
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ö‡∏ö Object ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏°‡∏µ‡∏î‡∏≤‡∏ß)
                playerData: playerData, 
                enemyData: enemyData,
                
                // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏•‡πâ‡∏ß‡∏ô‡πÑ‡∏ß‡πâ backward compatibility (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤)
                playerIds: playerIds,
                enemyIds: enemyIds,
                enemySignature: enemySignature, 

                // üî¥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß‡∏£‡∏ß‡∏°‡∏•‡∏á‡πÉ‡∏ô Log
                myTeamStars: calculateTotalTeamStars(myTeam),
                enemyTeamStars: calculateTotalTeamStars(enemyTeam),
                status: result,
                skillQueue: myTeam.skillQueue || [],
            };

            battleHistoryDB.unshift(record);
            if (battleHistoryDB.length > 500) battleHistoryDB.pop();

            // Logic ‡πÄ‡∏î‡∏¥‡∏°: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            if(result === 'Win') {
                enemyTeam.isCleared = true;
                addLog(currentCastle, activeBattleSlot, enemyTeam.player, 'Defeated');
            } else {
                addLog(currentCastle, activeBattleSlot, enemyTeam.player, 'Lost');
            }

            renderDashboard(); 
            closeBattleModal();

            // showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ...");
            // try {
            //     await triggerAutoSave();
            //     // alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            // } catch(e) {
            //     alert("Error: " + e.message);
            // } finally {
            //     hideLoading();
            // }
        }

        function checkHistory(enemySlotIdx) {
            const enemyTeam = getTeam(enemySlotIdx);
            
            // 1. ‡∏î‡∏∂‡∏á ID ‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Signature
            let enemyHeroIds = [];
            for(let i=0; i<5; i++) if(enemyTeam.slots[i]) enemyHeroIds.push(enemyTeam.slots[i].id);
            if(enemyHeroIds.length === 0) { alert("‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏®‡∏±‡∏ï‡∏£‡∏π (‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)"); return; }

            // Display Current Enemy Comp (‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£)
            document.getElementById('history-enemy-comp').innerHTML = enemyHeroIds.map(hid => {
                const h = heroesDB.find(x => x.id === hid);
                return h ? `<div class="flex items-center gap-2 bg-black rounded p-1 pr-3 border border-red-900"><img src="${h.img}" class="w-8 h-8 rounded bg-gray-900 object-cover"><span class="text-xs text-red-200 font-bold">${h.name}</span></div>` : '';
            }).join('');

            // 2. Filter History (‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ)
            const currentSignature = enemyHeroIds.sort().join(',');
            const matches = battleHistoryDB.filter(log => log.enemySignature === currentSignature);

            const resultContainer = document.getElementById('history-results');
            
            if(matches.length === 0) {
                resultContainer.innerHTML = '<div class="text-gray-500 text-center py-10 flex flex-col items-center gap-2"><span class="text-4xl">üìú</span><span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ</span></div>';
            } else {
                // 3. Render ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏°‡∏ï‡∏ä‡πå
                resultContainer.innerHTML = matches.map(log => {
                    const isWin = log.result === 'Win' || log.status === 'Win';
                    const statusClass = isWin ? 'bg-green-900/10 border-green-600/50' : 'bg-red-900/10 border-red-600/50';
                    const statusTextClass = isWin ? 'text-green-400' : 'text-red-400';
                    const resultBadge = isWin ? 'üèÜ WIN' : 'üíÄ LOSE';

                    // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≤‡∏ß (My Team)
                    const myTeamIcons = (log.playerData || []).map(p => {
                        const h = heroesDB.find(x => x.id === p.id);
                        // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getStarBadge ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏î‡∏≤‡∏ß‡πÄ‡∏•‡πá‡∏Å‡πÜ
                        const starBadge = p.star > 0 ? `<span class="absolute -bottom-1 -right-1 text-[8px] bg-black text-yellow-500 border border-gray-600 px-1 rounded font-bold shadow-sm z-10">${p.star}‚òÖ</span>` : '';
                        return h ? `<div class="relative w-8 h-8 rounded border border-gray-600 bg-black shrink-0"><img src="${h.img}" class="w-full h-full object-cover opacity-90">${starBadge}</div>` : '';
                    }).join('');

                    // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≤‡∏ß (Enemy Team)
                    const enemyTeamIcons = (log.enemyData || []).map(p => {
                        const h = heroesDB.find(x => x.id === p.id);
                        const starBadge = p.star > 0 ? `<span class="absolute -bottom-1 -right-1 text-[8px] bg-black text-red-400 border border-gray-600 px-1 rounded font-bold shadow-sm z-10">${p.star}‚òÖ</span>` : '';
                        return h ? `<div class="relative w-8 h-8 rounded border border-red-900/50 bg-black shrink-0"><img src="${h.img}" class="w-full h-full object-cover opacity-90 grayscale-[0.3]">${starBadge}</div>` : '';
                    }).join('');

                    // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á Skill Queue
                    let queueHTML = '<div class="text-xs text-gray-500 italic">No Queue</div>';
                    if (log.skillQueue && log.skillQueue.length > 0) {
                        queueHTML = `<div class="flex gap-2 items-center">`;
                        log.skillQueue.forEach((q, idx) => {
                            const [sIdx, sNum] = q.split('-');
                            // ‡∏´‡∏≤ Hero ‡∏à‡∏≤‡∏Å Slot Index ‡∏Ç‡∏≠‡∏á My Team
                            const heroData = log.playerData ? log.playerData[sIdx] : null; 
                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ playerData (log ‡πÄ‡∏Å‡πà‡∏≤) ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å playerIds
                            const heroId = heroData ? heroData.id : (log.playerIds ? log.playerIds[sIdx] : null);
                            
                            const h = heroesDB.find(x => x.id === heroId);
                            const label = sNum === '1' ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô';
                            
                            if(h) {
                                queueHTML += `
                                    <div class="relative w-8 h-8 rounded border border-yellow-600/50 bg-black group">
                                        <img src="${h.img}" class="w-full h-full object-cover opacity-80">
                                        <div class="absolute bottom-0 right-0 bg-blue-600 text-white text-[8px] font-bold px-1 leading-none shadow">${label}</div>
                                        <div class="absolute top-0 left-0 bg-yellow-600 text-black text-[8px] font-bold px-1 leading-none rounded-br">${idx+1}</div>
                                    </div>
                                `;
                            }
                        });
                        queueHTML += `</div>`;
                    }

                    return `
                        <div class="mb-3 rounded-lg border ${statusClass} overflow-hidden bg-[#0d1117] shadow-lg">
                            <div class="flex justify-between items-center p-2 bg-black/20 border-b border-white/5">
                                <div class="text-[10px] text-gray-500">${log.date}</div>
                                <div class="font-black text-sm ${statusTextClass}">${resultBadge}</div>
                            </div>

                            <div class="flex items-center p-3 gap-2">
                                <div class="flex-1">
                                    <div class="text-[10px] text-blue-400 font-bold mb-1 uppercase tracking-wider flex justify-between">
                                        <span>${log.myTeamName || 'My Team'}</span>
                                        <span class="text-yellow-600">‚òÖ${log.myTeamStars||'?'}</span>
                                    </div>
                                    <div class="flex gap-1 flex-wrap">${myTeamIcons}</div>
                                </div>

                                <div class="text-gray-600 font-black italic text-lg px-2">VS</div>

                                <div class="flex-1 text-right">
                                    <div class="text-[10px] text-red-400 font-bold mb-1 uppercase tracking-wider flex justify-between flex-row-reverse">
                                        <span>Enemy</span>
                                        <span class="text-red-700">‚òÖ${log.enemyTeamStars||'?'}</span>
                                    </div>
                                    <div class="flex gap-1 justify-end flex-wrap">${enemyTeamIcons}</div>
                                </div>
                            </div>

                            <div class="px-3 py-2 bg-black/20 border-t border-white/5 flex items-center gap-3">
                                <span class="text-[9px] text-yellow-500 font-bold uppercase tracking-wider">Skill Queue:</span>
                                ${queueHTML}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('historyModal').style.display = 'flex';
        }

        function closeHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }

        // --- LOGS ---
        function addLog(castle, slot, player, action) {
            const time = new Date().toLocaleString('th-TH');
            logsDB.unshift({ time, castle, slot: slot+1, player: player||'-', action });
            if(logsDB.length > 50) logsDB.pop();
            if(currentView === 'logs') renderLogs();
        }
        function renderLogs() {
            const container = document.querySelector('#view-logs .p-8');
            if (!container) return;

            if (battleHistoryDB.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-500">
                        <div class="text-4xl mb-4 opacity-30">üìú</div>
                        <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ (No Battle History)</div>
                    </div>`;
                return;
            }

            let html = `
                <div class="max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-gray-400 text-xs">Showing recent ${battleHistoryDB.length} matches</div>
                    </div>
                    <div class="space-y-4">
            `;

            html += battleHistoryDB.map(log => {
                const isWin = log.result === 'Win' || log.status === 'Win';
                const borderClass = isWin ? 'border-l-4 border-l-green-500 border-gray-700' : 'border-l-4 border-l-red-500 border-gray-700';
                const resultText = isWin ? '<span class="text-green-400 font-black text-lg">VICTORY</span>' : '<span class="text-red-500 font-black text-lg">DEFEAT</span>';

                // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (My Team) + ‡πÅ‡∏´‡∏ß‡∏ô üíç
                const myHeroes = (log.playerData || log.playerIds || []).map((p, idx) => {
                    const id = typeof p === 'object' ? p.id : (log.playerIds ? log.playerIds[idx] : null);
                    const star = typeof p === 'object' ? p.star : 0;
                    // üü¢ ‡∏î‡∏∂‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
                    const ringId = typeof p === 'object' ? p.ring : null;
                    const ring = ringId ? ringsDB.find(r => r.id === ringId) : null;
                    const ringHtml = ring ? `<div class="absolute -top-1 -left-1 w-4 h-4 rounded-full border border-yellow-500 bg-black z-20" title="${ring.name}"><img src="${ring.img}" class="w-full h-full object-cover rounded-full"></div>` : '';

                    const h = heroesDB.find(x => x.id === id);
                    const starBadge = star > 0 ? `<span class="absolute -bottom-1 -right-1 text-[8px] bg-black text-yellow-500 border border-gray-600 px-1 rounded font-bold shadow-sm z-10">${star}‚òÖ</span>` : '';
                    
                    return h ? `
                        <div class="relative w-10 h-10 rounded border border-gray-600 bg-black shrink-0" title="${h.name}">
                            ${ringHtml}
                            <img src="${h.img}" class="w-full h-full object-cover opacity-90">
                            ${starBadge}
                        </div>` : '';
                }).join('');

                // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (Enemy Team) + ‡πÅ‡∏´‡∏ß‡∏ô üíç
                const enemyHeroes = (log.enemyData || log.enemyIds || []).map((p, idx) => {
                    const id = typeof p === 'object' ? p.id : (log.enemyIds ? log.enemyIds[idx] : null);
                    const star = typeof p === 'object' ? p.star : 0;
                    const ringId = typeof p === 'object' ? p.ring : null;
                    const ring = ringId ? ringsDB.find(r => r.id === ringId) : null;
                    const ringHtml = ring ? `<div class="absolute -top-1 -left-1 w-4 h-4 rounded-full border border-red-500 bg-black z-20" title="${ring.name}"><img src="${ring.img}" class="w-full h-full object-cover rounded-full"></div>` : '';

                    const h = heroesDB.find(x => x.id === id);
                    const starBadge = star > 0 ? `<span class="absolute -bottom-1 -right-1 text-[8px] bg-black text-red-400 border border-gray-600 px-1 rounded font-bold shadow-sm z-10">${star}‚òÖ</span>` : '';

                    return h ? `
                        <div class="relative w-10 h-10 rounded border border-red-900/50 bg-black shrink-0" title="${h.name}">
                            ${ringHtml}
                            <img src="${h.img}" class="w-full h-full object-cover opacity-80 grayscale-[0.3]">
                            ${starBadge}
                        </div>` : '';
                }).join('');

                // üü¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á (My Pet / Enemy Pet)
                const myPetData = log.myPet && log.myPet.id ? petsDB.find(p => p.id === log.myPet.id) : null;
                const enemyPetData = log.enemyPet && log.enemyPet.id ? petsDB.find(p => p.id === log.enemyPet.id) : null;

                const myPetHtml = myPetData ? `<div class="flex flex-col items-center ml-2 border-l border-gray-700 pl-2"><span class="text-[8px] text-purple-400 uppercase">Pet</span><img src="${myPetData.img}" class="w-8 h-8 rounded-full border border-purple-500 bg-black" title="${myPetData.name}"></div>` : '';
                const enemyPetHtml = enemyPetData ? `<div class="flex flex-col items-center mr-2 border-r border-gray-700 pr-2"><span class="text-[8px] text-red-400 uppercase">Pet</span><img src="${enemyPetData.img}" class="w-8 h-8 rounded-full border border-red-500 bg-black" title="${enemyPetData.name}"></div>` : '';

                // (Queue Logic ... ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ... ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏•‡∏∞‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
                // ... (Skill Queue rendering logic same as before) ...
                
                return `
                    <div class="mb-3 rounded-lg border ${borderClass} bg-[#161b22] shadow-lg overflow-hidden">
                        <div class="flex justify-between items-center p-2 bg-black/20 border-b border-white/5">
                            <div class="text-[10px] text-gray-500">${log.date}</div>
                            <div class="font-black text-sm">${resultText}</div>
                        </div>

                        <div class="flex items-center p-3 gap-2">
                            <div class="flex-1">
                                <div class="text-[10px] text-blue-400 font-bold mb-1 uppercase tracking-wider flex justify-between">
                                    <span>${log.myTeamName || 'My Team'}</span>
                                    <span class="text-yellow-600">‚òÖ${log.myTeamStars||'?'}</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="flex gap-1 flex-wrap">${myHeroes}</div>
                                    ${myPetHtml} </div>
                            </div>

                            <div class="text-gray-600 font-black italic text-lg px-2">VS</div>

                            <div class="flex-1 text-right">
                                <div class="text-[10px] text-red-400 font-bold mb-1 uppercase tracking-wider flex justify-between flex-row-reverse">
                                    <span>${log.enemyName || 'Enemy'}</span>
                                    <span class="text-red-700">‚òÖ${log.enemyTeamStars||'?'}</span>
                                </div>
                                <div class="flex items-center justify-end">
                                    ${enemyPetHtml} <div class="flex gap-1 flex-wrap justify-end">${enemyHeroes}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            html += `</div></div>`;
            container.innerHTML = html;
        }
        async function clearLogs() { if(confirm("Clear logs?")) { logsDB = []; renderLogs(); await pushData(); } }

        // --- SHARED ---
        // --- TIER LIST MODERN LOGIC ---

        // ‡πÇ‡∏´‡∏•‡∏î Background ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ã‡∏ü‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏ï‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        let savedBg = localStorage.getItem('7k_tier_bg');
        if(savedBg) {
             const bgContainer = document.getElementById('tier-bg-container');
             if(bgContainer) bgContainer.style.backgroundImage = `url('${savedBg}')`;
        }

        function changeTierBackground(url) {
            const bgContainer = document.getElementById('tier-bg-container');
            const overlay = document.getElementById('tier-bg-overlay');
            
            if (!url) {
                // ‡∏Å‡∏£‡∏ì‡∏µ Reset (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û) ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏∂‡∏ö
                bgContainer.style.backgroundImage = "none";
                overlay.style.background = "#0b0e14"; 
                localStorage.removeItem('7k_tier_bg');
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏†‡∏≤‡∏û
                bgContainer.style.backgroundImage = `url('${url}')`;
                
                // [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏≠‡∏á Overlay ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (0.3 - 0.4 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏¢)
                overlay.style.background = "rgba(11, 14, 20, 0.3)"; 
                
                localStorage.setItem('7k_tier_bg', url);
            }
        }

        function switchTierTab(t) { 
            tierViewTab = t;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Pool Footer
            const btnHero = document.getElementById('pool-tab-hero');
            const btnPet = document.getElementById('pool-tab-pet');

            if (t === 'hero') {
                // Hero Active
                btnHero.className = "px-6 py-1 rounded text-xs font-bold transition border border-transparent bg-blue-600 text-white shadow-lg transform scale-105";
                btnPet.className = "px-6 py-1 rounded text-xs font-bold transition border border-gray-600 text-gray-400 hover:text-white hover:bg-gray-700";
            } else {
                // Pet Active
                btnHero.className = "px-6 py-1 rounded text-xs font-bold transition border border-gray-600 text-gray-400 hover:text-white hover:bg-gray-700";
                btnPet.className = "px-6 py-1 rounded text-xs font-bold transition border border-transparent bg-purple-600 text-white shadow-lg transform scale-105";
            }

            renderTierViewer();
        }
        function switchTierViewMode(m) { currentTierMode = m; renderTierViewer(); }
        function renderTierModeSelectors(containerId, callbackName) {
            const container = document.getElementById(containerId);
            container.innerHTML = TIER_MODES.map(m => `<button onclick="${callbackName}('${m}')" class="mode-btn ${currentTierMode===m?'active':''}">${TIER_MODE_LABELS[m]}</button>`).join('');
        }
        // --- RENDER FUNCTION ---
        function renderTierViewer() {
            renderTierModeSelectors('tv-mode-selector', 'switchTierViewMode');
            const container = document.getElementById('tier-canvas');
            const poolContainer = document.getElementById('tier-pool-content');
            const db = tierViewTab === 'hero' ? heroesDB : petsDB;
            const currentTiers = tierListsDB[tierViewTab][currentTierMode];

            // Clear ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô tier-row)
            // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà innerHTML='' ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ snap-guide ‡∏´‡∏≤‡∏¢
            container.querySelectorAll('.tier-row-modern').forEach(e => e.remove());

            activeTiers.forEach((rank, index) => {
                sanitizeRankConfig(rank); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î
                const conf = tierRankConfigs[rank];
                const ids = currentTiers[rank] || [];

                // Style ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏µ
                let headerStyle = conf.headerBg ? `background: ${conf.headerBg};` : `background: linear-gradient(135deg, #333, #000);`;
                // ‡∏™‡∏µ Default ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ Rank ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                if (!conf.headerBg) {
                    if(rank==='S') headerStyle = 'background: linear-gradient(135deg, #ef4444, #7f1d1d);';
                    else if(rank==='A') headerStyle = 'background: linear-gradient(135deg, #f97316, #c2410c);';
                    else if(rank==='B') headerStyle = 'background: linear-gradient(135deg, #eab308, #a16207);';
                    else if(rank==='C') headerStyle = 'background: linear-gradient(135deg, #22c55e, #14532d);';
                    else if(rank==='D') headerStyle = 'background: linear-gradient(135deg, #64748b, #334155);';
                }

                const overlayColor = `rgba(17, 24, 39, ${conf.opacity / 100})`;
                const rowBgImg = conf.bg ? `background-image: url('${conf.bg}'); background-size: cover;` : '';

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Element
                const row = document.createElement('div');
                row.className = 'tier-row-modern group';
                row.id = `tier-row-${rank}`;
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô
                row.style.left = conf.x + 'px';
                row.style.top = conf.y + 'px';
                row.style.width = (conf.width || 800) + 'px'; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á
                row.style.transform = `scale(${conf.scale}) rotate(${conf.rot}deg)`;
                row.style.cssText += rowBgImg; // ‡πÄ‡∏û‡∏¥‡πà‡∏° BG Image

                // Events ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
                row.ondragover = tierAllowDrop;
                row.ondrop = (e) => tierDrop(e, rank);

                // HTML ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
                row.innerHTML = `
                    <div class="absolute inset-0 z-0 pointer-events-none" style="background-color: ${overlayColor};"></div>
                    
                    <div class="tier-header-modern relative z-10" style="${headerStyle}" 
                        onmousedown="rowDragStart(event, '${rank}')"
                        onwheel="rowWheel(event, '${rank}')"
                        oncontextmenu="openRankContextMenu(event, '${rank}')">
                        
                        <input type="text" value="${conf.name}" 
                            class="rank-name-input pointer-events-auto" 
                            style="color: ${conf.color} !important;" 
                            oninput="updateRankNameLocal('${rank}', this.value)"
                            onclick="event.stopPropagation()"> </div>
                    
                    <div class="tier-content relative z-10">
                        ${ids.map(id => {
                            const item = db.find(x => x.id === id);
                            if(!item) return '';
                            return `
                                <div class="w-16 h-16 rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 relative cursor-grab active:cursor-grabbing hover:scale-110 transition shadow-lg bg-[#0d1117] group/item"
                                    draggable="true" 
                                    ondragstart="tierDragStart(event, '${item.id}', '${rank}')"
                                    oncontextmenu="openItemContextMenu(event, '${item.id}', '${rank}')">
                                    <img src="${item.img}" class="w-full h-full object-cover pointer-events-none">
                                </div>`;
                        }).join('')}
                    </div>

                    <div class="absolute bottom-0 right-0 w-4 h-4 cursor-se-resize z-20 hover:bg-white/20 rounded-tl"
                        onmousedown="rowResizeStart(event, '${rank}')"></div>
                `;

                container.appendChild(row);
            });

            // Render Pool (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            renderTierPoolContent(poolContainer, db, currentTiers);
        }

        // Helper ‡πÅ‡∏¢‡∏Å Pool Render (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)
        function renderTierPoolContent(container, db, currentTiers) {
            let rankedIds = [];
            Object.values(currentTiers).forEach(arr => rankedIds.push(...arr));
            let unranked = db.filter(item => !rankedIds.includes(item.id));
            if(tierViewTab==='hero') unranked.sort((a,b) => RARITY_OPTS.indexOf(a.rarity) - RARITY_OPTS.indexOf(b.rarity)); 
            else unranked.sort((a,b) => a.name.localeCompare(b.name, 'th'));

            const icon = document.getElementById('pool-toggle-icon');
            if(icon) icon.innerText = isPoolOpen ? '‚ñº' : '‚ñ≤';
            const footer = document.getElementById('tier-pool-footer');
            if(footer) footer.style.transform = isPoolOpen ? "translateY(0%)" : "translateY(100%)";

            container.innerHTML = unranked.map(item => `
                <div class="w-20 h-20 rounded-lg overflow-hidden border border-gray-600 relative cursor-grab active:cursor-grabbing hover:scale-110 transition bg-[#0d1117] group"
                     draggable="true" 
                     ondragstart="tierDragStart(event, '${item.id}', 'pool')"
                     oncontextmenu="openItemContextMenu(event, '${item.id}', 'pool')"
                     title="${item.name}">
                    <img src="${item.img}" class="w-full h-full object-cover pointer-events-none">
                </div>
            `).join('');
        }

        // --- RIGHT CLICK MENUS ---
        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π (‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏µ Header ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á)
        function openRankContextMenu(e, rankId) {
            e.preventDefault();
            e.stopPropagation();
            contextRankTarget = rankId;
            
            const menu = document.getElementById('rank-context-menu');
            
            // Load Config
            const conf = tierRankConfigs[rankId] || { color: '#ffffff', headerBg: '', opacity: 60, bg: '' };
            
            // Fix Color Format
            let textColor = conf.color.length === 4 ? '#' + conf.color[1].repeat(2) + conf.color[2].repeat(2) + conf.color[3].repeat(2) : conf.color;
            let headerColor = (conf.headerBg && conf.headerBg.length === 4) ? '#' + conf.headerBg[1].repeat(2) + conf.headerBg[2].repeat(2) + conf.headerBg[3].repeat(2) : (conf.headerBg || '#000000');

            document.getElementById('ctx-rank-color').value = textColor;
            document.getElementById('ctx-header-bg').value = headerColor; // [NEW] Load Header Color
            
            document.getElementById('ctx-rank-opacity').value = conf.opacity;
            document.getElementById('ctx-opacity-val').innerText = conf.opacity + '%';
            document.getElementById('ctx-rank-bg').value = conf.bg || '';

            menu.style.display = 'block';
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
            
            document.getElementById('item-context-menu').style.display = 'none';
            document.getElementById('sticker-context-menu').style.display = 'none';
            document.getElementById('bg-context-menu')?.classList.add('hidden');
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™ headerBg)
        function updateRankStyle(key, value) {
            if(!contextRankTarget) return;
            if(!tierRankConfigs[contextRankTarget]) {
                tierRankConfigs[contextRankTarget] = { name: contextRankTarget, color: '#ffffff', headerBg: '', opacity: 60, bg: '' };
            }
            const conf = tierRankConfigs[contextRankTarget];
            
            if(key === 'color') conf.color = value;
            if(key === 'headerBg') conf.headerBg = value;
            if(key === 'opacity') {
                conf.opacity = value;
                document.getElementById('ctx-opacity-val').innerText = value + '%';
            }
            if(key === 'bg') conf.bg = value;

            saveLocalTierData();
            renderTierViewer();
        }

        function resetRankStyle() {
            if(!contextRankTarget) return;
            if(tierRankConfigs[contextRankTarget]) {
                tierRankConfigs[contextRankTarget].color = '#ffffff';
                tierRankConfigs[contextRankTarget].opacity = 60;
                tierRankConfigs[contextRankTarget].bg = '';
                saveTierConfig();
                renderTierViewer();
            }
            closeCtxMenus();
        }

        // 2. Item Context Menu
        function openItemContextMenu(e, itemId, fromRank) {
            e.preventDefault();
            e.stopPropagation(); // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ trigger background menu
            contextItemTarget = { id: itemId, rank: fromRank };
            
            const menu = document.getElementById('item-context-menu');
            menu.style.display = 'block';
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
            
            document.getElementById('rank-context-menu').style.display = 'none';
        }

        // Action: Convert to Sticker (Float)
        function convertItemToSticker() {
            if(!contextItemTarget) return;
            const { id, rank } = contextItemTarget;
            
            // 1. ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å Rank ‡∏õ‡∏Å‡∏ï‡∏¥ (S, A, B...) ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢
            if (rank !== 'pool') {
                const db = tierListsDB[tierViewTab][currentTierMode];
                if(db[rank]) {
                    db[rank] = db[rank].filter(x => x !== id);
                }
            }
            // (‡∏ñ‡πâ‡∏≤ rank === 'pool' ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ö DB ‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏Å‡∏£‡∏π‡∏õ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤)
            
            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Sticker
            const itemDB = tierViewTab === 'hero' ? heroesDB : petsDB;
            const item = itemDB.find(x => x.id === id);
            if(item) addSticker(item.img); 

            saveLocalTierData();
            renderTierViewer();
            closeCtxMenus();
        }

        function removeItemFromTier() {
             if(!contextItemTarget) return;
             const { id, rank } = contextItemTarget;
             // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Rank (‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏•‡∏á Pool ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ Render ‡πÉ‡∏´‡∏°‡πà)
             const db = tierListsDB[tierViewTab][currentTierMode];
             if(db[rank]) db[rank] = db[rank].filter(x => x !== id);
            
             saveLocalTierData();
             renderTierViewer();
             autoSaveTierList();
             closeCtxMenus();
        }

        // Close menus on click
        document.addEventListener('click', function(e) {
            const target = e.target;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î Settings (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏∂‡∏á)
            const settingsBtn = document.querySelector('button[onclick="toggleTierSettings()"]');
            if (settingsBtn && settingsBtn.contains(target)) return;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏†‡∏≤‡∏¢‡πÉ‡∏ô" ‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
            const isClickInside = 
                target.closest('#tier-context-menu') ||
                target.closest('#tier-text-menu') ||
                target.closest('#rank-context-menu') ||
                target.closest('#item-context-menu') ||
                target.closest('#sticker-context-menu') ||
                target.closest('#tier-settings-menu');

            // ‡∏ñ‡πâ‡∏≤ "‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏•‡∏¢" -> ‡∏õ‡∏¥‡∏î‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î
            if (!isClickInside) {
                closeCtxMenus();
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡∏ô‡∏¥‡∏î (‡∏£‡∏ß‡∏°‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤)
        function closeCtxMenus() {
            const menuIds = [
                'tier-context-menu',    // ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
                'tier-text-menu',       // ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                'rank-context-menu',    // ‡πÄ‡∏°‡∏ô‡∏π Rank
                'item-context-menu',    // ‡πÄ‡∏°‡∏ô‡∏π Hero
                'sticker-context-menu', // ‡πÄ‡∏°‡∏ô‡∏π Sticker
                'tier-settings-menu'    // ‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô
            ];

            menuIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.display = 'none';   // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö Inline
                    el.classList.add('hidden');  // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö Class
                }
            });
        }

        // Action: Add Rank (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å Context Menu)
        function addNewRank() {
            const id = 'RANK_' + Date.now();
            activeTiers.push(id);
            tierRankConfigs[id] = { name: 'NEW', color: '#ffffff', opacity: 60, bg: '' };
            saveLocalTierData();
            renderTierViewer();
            closeCtxMenus();
        }

        function deleteRank() {
            if(!contextRankTarget) return;
            if(confirm("Delete this rank? Items will move to pool.")) {
                // ‡∏•‡∏ö Rank ID ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å List
                activeTiers = activeTiers.filter(r => r !== contextRankTarget);
                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• item ‡πÉ‡∏ô db[rank] ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å render (‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏•‡∏á Pool) ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏•‡∏ö key ‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ
                saveTierConfig();
                autoSaveTierList();
                renderTierViewer();
            }
            closeCtxMenus();
        }

        function moveRank(direction) {
            if(!contextRankTarget) return;
            const idx = activeTiers.indexOf(contextRankTarget);
            if (idx === -1) return;
            
            const newIdx = idx + direction;
            if (newIdx >= 0 && newIdx < activeTiers.length) {
                // Swap
                const temp = activeTiers[newIdx];
                activeTiers[newIdx] = activeTiers[idx];
                activeTiers[idx] = temp;
                saveTierConfig();
                renderTierViewer();
            }
            closeCtxMenus();
        }

        function updateRankName(rankKey, newName) {
            if(!tierRankConfigs[rankKey]) tierRankConfigs[rankKey] = { name: rankKey, color: '#ffffff', opacity: 60, bg: '' };
            tierRankConfigs[rankKey].name = newName;
            saveTierConfig();
        }

        function resetTierNames() {
            if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡πÇ‡∏•‡πà‡∏á (Clear All)?\n(‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏á Pool)")) {
                // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
                activeTiers = [];
                tierRankConfigs = {};
                
                autoSaveTierList();
                renderTierViewer();
            }
        }

        function saveTierConfig() {
            localStorage.setItem('7k_active_tiers', JSON.stringify(activeTiers));
            localStorage.setItem('7k_tier_ranks_config', JSON.stringify(tierRankConfigs));
            pushData();
        }

        // Helper ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î
        function generateTierCard(item, fromRank) {
            return `
                <div class="w-16 h-16 rounded-lg overflow-hidden border-2 border-transparent hover:border-blue-500 relative cursor-grab active:cursor-grabbing hover:scale-110 transition shadow-lg bg-[#0d1117] group"
                     draggable="true" 
                     ondragstart="tierDragStart(event, '${item.id}', '${fromRank}')"
                     title="${item.name}">
                    <img src="${item.img}" class="w-full h-full object-cover pointer-events-none">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10"></div>
                </div>
            `;
        }

        function initTierManager(type) {
            currentTierType = type;
            document.getElementById('tm-tab-hero').className = `px-4 py-1 rounded text-xs font-bold transition ${type==='hero'?'bg-blue-600 text-white':'text-gray-400 hover:text-white'}`;
            document.getElementById('tm-tab-pet').className = `px-4 py-1 rounded text-xs font-bold transition ${type==='pet'?'bg-blue-600 text-white':'text-gray-400 hover:text-white'}`;
            renderTierManagerUI();
        }
        function switchTierManagerMode(m) { currentTierMode = m; renderTierManagerUI(); }
        function renderTierManagerUI() {
            renderTierModeSelectors('tm-mode-selector', 'switchTierManagerMode');
            const zones = document.getElementById('tier-drop-zones');
            const pool = document.getElementById('tier-pool');
            const db = currentTierType === 'hero' ? heroesDB : petsDB;
            const tiers = tierListsDB[currentTierType]?.[currentTierMode] || {};
            let zonesHtml = '';
            TIERS.forEach(rank => {
                const ids = tiers[rank] || [];
                zonesHtml += `<div class="tier-row"><div class="tier-header tier-${rank.toLowerCase()}">${rank}</div><div class="tier-content" ondragover="tierAllowDrop(event)" ondrop="tierDrop(event, '${rank}')" ondragleave="tierDragLeave(event)">`;
                ids.forEach(id => { const item = db.find(x => x.id === id); if(item) zonesHtml += `<div class="tier-item" draggable="true" ondragstart="tierDragStart(event, '${id}', '${rank}')"><img src="${item.img}"></div>`; });
                zonesHtml += `</div></div>`;
            });
            zones.innerHTML = zonesHtml;
            let rankedIds = []; Object.values(tiers).forEach(arr => rankedIds.push(...arr));
            const unranked = db.filter(item => !rankedIds.includes(item.id));
            if(currentTierType==='hero') unranked.sort((a,b) => RARITY_OPTS.indexOf(a.rarity) - RARITY_OPTS.indexOf(b.rarity)); else unranked.sort((a,b) => a.name.localeCompare(b.name, 'th'));
            document.getElementById('pool-count').innerText = `${unranked.length} items`;
            let poolHtml = '';
            unranked.forEach(item => { poolHtml += `<div class="tier-item" draggable="true" ondragstart="tierDragStart(event, '${item.id}', 'pool')"><img src="${item.img}"></div>`; });
            pool.innerHTML = poolHtml;
            pool.ondragover = tierAllowDrop; pool.ondrop = (e) => tierDrop(e, 'pool');
        }
        // --- INTERACTION LOGIC ---

        function tierDragStart(e, id, from) {
            tierDragSrc = { id, from };
            e.dataTransfer.effectAllowed = 'move';
        }
        function tierAllowDrop(e) { e.preventDefault(); }

        function tierDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function tierDrop(e, toRank) {
            e.preventDefault();
            if (!tierDragSrc) return;
            const { id, from } = tierDragSrc;

            if (from === toRank) return; // ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°

            // Logic ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const currentModeDB = tierListsDB[tierViewTab][currentTierMode];

            // 1. ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤
            if (from !== 'pool') {
                if (currentModeDB[from]) {
                    currentModeDB[from] = currentModeDB[from].filter(x => x !== id);
                }
            }

            // 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
            if (toRank !== 'pool') {
                if (!currentModeDB[toRank]) currentModeDB[toRank] = [];
                // ‡πÉ‡∏™‡πà‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
                currentModeDB[toRank].push(id);
            }

            tierDragSrc = null;
            saveLocalTierData();
            renderTierViewer();
            autoSaveTierList();
            // pushData(); // Auto Save
        }
        function updateRankName(rankKey, newName) {
            tierRankNames[rankKey] = newName;
            localStorage.setItem('7k_tier_ranks', JSON.stringify(tierRankNames));
            pushData(); // (Optional: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏ã‡∏ü‡∏•‡∏á Cloud ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô payload)
        }

        function resetTierNames() {
            if(confirm("Reset Rank Names?")) {
                tierRankNames = { S:'S', A:'A', B:'B', C:'C', D:'D' };
                localStorage.removeItem('7k_tier_ranks');
                renderTierViewer();
            }
        }

        // --- UI TOGGLES ---

        // --- POOL TOGGLE LOGIC (FIXED) ---
        function toggleTierPool() {
            isPoolOpen = !isPoolOpen;
            const footer = document.getElementById('tier-pool-footer');
            const icon = document.getElementById('pool-toggle-icon');
            
            if(!footer) return;

            if (isPoolOpen) {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ (Show)
                footer.style.transform = "translateY(0%)";
                if(icon) icon.innerText = "‚ñº";
            } else {
                // ‡∏õ‡∏¥‡∏î‡∏•‡∏á‡πÑ‡∏õ (Hide)
                // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å CSS ‡πÄ‡∏£‡∏≤‡∏ï‡∏±‡πâ‡∏á h-64 ‡πÄ‡∏£‡∏≤‡∏à‡∏∂‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á 100% ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏ï‡∏¥‡πà‡∏á‡∏õ‡∏∏‡πà‡∏°
                footer.style.transform = "translateY(100%)";
                if(icon) icon.innerText = "‚ñ≤";
            }
        }

        // --- TIER LIST: STICKER & PREVIEW LOGIC ---
        let previewIdleTimer = null;
        function togglePreviewMode() {
            const body = document.body;
            body.classList.toggle('preview-mode');

            if (body.classList.contains('preview-mode')) {
                // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î Full Screen: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå
                document.addEventListener('mousemove', resetPreviewIdleTimer);
                resetPreviewIdleTimer(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ä‡∏ß‡πå
            } else {
                // ‡∏≠‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î: ‡∏•‡πâ‡∏≤‡∏á Event ‡∏ó‡∏¥‡πâ‡∏á
                document.removeEventListener('mousemove', resetPreviewIdleTimer);
                clearTimeout(previewIdleTimer);
                body.classList.remove('ui-idle'); // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
            }
        }

        function resetPreviewIdleTimer() {
            const body = document.body;
            
            // 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Ç‡∏¢‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏° (‡∏•‡∏ö class ui-idle)
            body.classList.remove('ui-idle');
            
            // 2. ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πà‡∏≤
            clearTimeout(previewIdleTimer);

            // 3. ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏±‡∏ö 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° (‡πÄ‡∏ï‡∏¥‡∏° class ui-idle)
            previewIdleTimer = setTimeout(() => {
                if (body.classList.contains('preview-mode')) {
                    body.classList.add('ui-idle');
                }
            }, 1000); // 3000ms = 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        }

        function addStickerFromInput() {
            const url = document.getElementById('sticker-url-input').value;
            if(url) addSticker(url);
        }

       // --- STICKER LOGIC (RESIZABLE) ---

        // --- STICKER LOGIC (RESIZE & ROTATE) ---
        function addSticker(url) {
            const layer = document.getElementById('tier-sticker-layer');
            const img = document.createElement('img');
            img.src = url;
            img.title = "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π / ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢ / Scroll ‡∏¢‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢ / Shift+Scroll ‡∏´‡∏°‡∏∏‡∏ô";
            
            // Default Classes & Style
            img.className = "sticker-item pointer-events-auto";
            img.style.width = "128px"; // Default size (w-32)
            img.style.height = "auto";
            img.style.left = "50%";
            img.style.top = "50%";
            img.style.transform = "translate(-50%, -50%) rotate(0deg)";
            
            // Init Data
            img.dataset.rotation = 0;

            // [NEW] Right Click Event
            img.oncontextmenu = function(e) {
                e.preventDefault();
                e.stopPropagation(); // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡πÇ‡∏î‡∏ô Background
                openStickerContextMenu(e, this);
            };
            
            // Mouse Wheel (Resize & Rotate) - ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            img.onwheel = function(e) {
                e.preventDefault();
                if (e.shiftKey) {
                    let currentRot = parseFloat(this.dataset.rotation) || 0;
                    const rotateStep = 15;
                    if (e.deltaY < 0) currentRot += rotateStep; else currentRot -= rotateStep;
                    this.dataset.rotation = currentRot;
                    this.style.transform = `translate(-50%, -50%) rotate(${currentRot}deg)`;
                } else {
                    const scaleFactor = e.deltaY < 0 ? 1.1 : 0.9;
                    let newWidth = this.clientWidth * scaleFactor;
                    if (newWidth > 20 && newWidth < 1000) {
                        this.style.width = newWidth + "px";
                        this.style.height = "auto";
                    }
                }
            };
            
            makeDraggable(img);
            layer.appendChild(img);
        }

        // --- STICKER CONTEXT MENU ACTIONS ---

        function openStickerContextMenu(e, imgElement) {
            contextStickerTarget = imgElement; // ‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô
            
            const menu = document.getElementById('sticker-context-menu');
            menu.style.display = 'block';
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;

            // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô
            document.getElementById('rank-context-menu').style.display = 'none';
            document.getElementById('item-context-menu').style.display = 'none';
            document.getElementById('bg-context-menu')?.classList.add('hidden');
        }

        function resetSticker() {
            if (!contextStickerTarget) return;
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Default
            contextStickerTarget.style.width = "128px";
            contextStickerTarget.style.height = "auto";
            contextStickerTarget.dataset.rotation = 0;
            contextStickerTarget.style.transform = "translate(-50%, -50%) rotate(0deg)";
            
            closeCtxMenus();
        }

        function deleteSticker() {
            if (contextStickerTarget) {
                contextStickerTarget.remove();
                autoSaveTierList(); // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö
            }
            closeCtxMenus();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Drag Logic ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Transform
        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // Get initial cursor position
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // Calculate new position
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // Set element's new position
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                autoSaveTierList();
            }
        }

        // --- 2. BACKGROUND LOGIC (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î 100%) ---
        function setTierBg(url, shouldSave = true) {
            const container = document.getElementById('tier-bg-container');
            const overlay = document.getElementById('tier-bg-overlay');
            
            if (!url) {
                // Reset (‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥‡∏ó‡∏∂‡∏ö)
                container.style.backgroundImage = 'none';
                container.style.backgroundColor = '#0b0e14';
                overlay.style.backgroundColor = 'transparent';
                localStorage.removeItem('7k_tier_bg');
            } else {
                container.style.backgroundImage = `url('${url}')`;
                
                // [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'transparent' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ä‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏∑‡∏î‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'rgba(0,0,0,0.2)'
                overlay.style.backgroundColor = 'transparent'; 
                
                localStorage.setItem('7k_tier_bg', url);
            }

            if(shouldSave) autoSaveTierList();
        }

        // Toggle Menu
        function toggleTierSettings() {
            const menu = document.getElementById('tier-settings-menu');
            if (menu.classList.contains('hidden')) menu.classList.remove('hidden');
            else menu.classList.add('hidden');
        }

        // --- STICKER LOGIC ---
        function updateSticker(text) {
            const sticker = document.getElementById('tier-sticker');
            const input = document.getElementById('sticker-input');
            if(sticker) {
                sticker.innerText = text;
                sticker.classList.remove('hidden');
            }
            if(input) input.value = text; // Update input value if called via preset button
        }

        function toggleStickerVisibility() {
            const sticker = document.getElementById('tier-sticker');
            if(sticker) sticker.classList.toggle('hidden');
        }

        function toggleWatermark() {
            const wm = document.getElementById('tier-watermark');
            wm.classList.toggle('hidden');
        }

        async function saveTierList() { showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö..."); await pushData(); hideLoading(); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); }

        // --- DASHBOARD (WAR ROOM) ---
        function getTeam(idx) {
            if (idx === 'BW-ENEMY') return battleWarData.enemy;
            if (idx === 'BW-MY') return battleWarData.my;
            if (idx === 'PREP-ENEMY') return prepData.enemy;
            if (idx === 'PREP-MY') return prepData.my;
            
            // Sim logic
            if (typeof idx === 'string' && idx.startsWith('SIM-')) {
                if (idx === 'SIM-ENEMY') return simData.enemy;
                if (idx.startsWith('SIM-ATK-')) return simData.attack[parseInt(idx.split('-')[2])];
            }
            // Guild & Set logic
            if (typeof idx === 'string' && idx.startsWith('G-')) return guildMembersDB[parseInt(idx.split('-')[1])].teams[parseInt(idx.split('-')[2])];
            if (typeof idx === 'string' && idx.startsWith('S-')) return heroSetsDB[parseInt(idx.split('-')[1])];
            if (idx === 'BATTLE-TEMP') {
                if (!battleTempTeam) battleTempTeam = { id: 'BATTLE-TEMP', name: 'Battle Squad', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] };
                return battleTempTeam;
            }
            // War Room fallback
            const k = `${currentCastle}-${idx}`;
            if (!teamsDB[k]) teamsDB[k] = { player: '', speed: '', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skills: [], isCleared: false };
            return teamsDB[k];
        }
        function handleSlotClick(i, p) { const t=getTeam(i); if(t.locked||t.isCleared)return; if(t.slots[p]) openDetail(i,p); else openSelector(i,p,'hero'); }
        async function saveWarRoomChanges() { 
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°..."); // ‡πÄ‡∏õ‡∏¥‡∏î Loading
            try { 
                await pushData(); 
                // alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); // (Option) ‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ
            } catch (err) { 
                console.error(err); 
                alert("Save Error"); 
            } finally { 
                hideLoading(); // ‡∏õ‡∏¥‡∏î Loading
            } 
        }
        // ‚úÖ [‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà] selectItem ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Battle War
        function selectItem(id) {
            if (editContext && editContext.i === 'HERO-LIST') {
                if (id) {
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° Hero (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô)
                    // editContext.p ‡∏Ñ‡∏∑‡∏≠ listId ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ù‡∏≤‡∏Å‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô openSelector
                    addHeroByIdToHelper(editContext.p, id);
                }
                closeSelector();
                return;
            }
            
            let t = getTeam(editContext.i);
            const p = editContext.p;

            if (t) {
                if (editContext.type === 'hero') {
                    if (id === null) t.slots[p] = null;
                    else t.slots[p] = { id: id, star: 0, ring: null };
                } else if (editContext.type === 'pet') {
                    if (id === null) t.pet = null;
                    else t.pet = { id: id, star: 0 };
                } else { // Ring
                    if (t.slots[p]) t.slots[p].ring = id;
                }

                // *** REFRESH LOGIC ***
                if (editContext.i === 'BW-ENEMY' || editContext.i === 'BW-MY') renderBattleWar();
                else if (editContext.i === 'PREP-ENEMY' || editContext.i === 'PREP-MY') renderPreparation();
                else if (editContext.i === 'BATTLE-TEMP') renderBattleBuilder();
                else if (typeof editContext.i === 'string' && editContext.i.startsWith('SIM-')) renderSimulatorTeams();
                else { updateCurrentViewUI(); triggerAutoSave(); }
            }
            closeSelector();
        }
        function updateCurrentViewUI() {
            console.log('updateCurrentViewUI: ' + currentView);

            if (currentView === 'my-teams') {
                renderGuildResultMode(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤ Guild Team
            } else if (currentView === 'simulator') {
                console.log('updateCurrentViewUI: simulator');
                renderSimulatorTeams(); // 
            } else if (currentView === 'set-manager') {
                renderSetManager();    // 
            } else if(currentView === 'hero-lists') {
                renderHeroListsView();
            } else {
                renderDashboard();     // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤ War Room
            }
        }
        function updateTeam(i, f, v) { 
            const t = getTeam(i); 
            if (!t.isCleared) { 
                t[f] = v; 
                if (f === 'formation') renderDashboard(); 
                
                // ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ]
                triggerAutoSave();
            } 
        }
        function toggleSkill(i, p, n) { const t = getTeam(i); if (t.isCleared) return; const id = `${p}-${n}`; const idx = t.skills.indexOf(id); if (idx > -1) t.skills.splice(idx, 1); else if (t.skills.length < 3) t.skills.push(id); renderDashboard(); triggerAutoSave(); }
        function removePet(e, i) { e.stopPropagation(); const t = getTeam(i); if (!t.isCleared) { t.pet = null; renderDashboard(); } }
        function setStar(l) {
            const t = getTeam(contextTarget.i);
            if (t) {
                if (contextTarget.p === 'pet') {
                    if(t.pet) t.pet.star = l;
                } else {
                    if(t.slots[contextTarget.p]) t.slots[contextTarget.p].star = l;
                }

                if (contextTarget.i === 'PREP-ENEMY' || contextTarget.i === 'PREP-MY') {
                    renderPreparation();
                }
                else if (contextTarget.i === 'BATTLE-TEMP') {
                    renderBattleBuilder();
                } 
                else if (typeof contextTarget.i === 'string' && contextTarget.i.startsWith('SIM-')) {
                    renderSimulatorTeams();
                }
                else if (contextTarget.i === 'BW-ENEMY' || contextTarget.i === 'BW-MY') {
                    renderBattleWar(); 
                }
                else {
                    updateCurrentViewUI();
                    triggerAutoSave();
                }
            }
            closeContextMenu();
        }

        function setRing(id) { 
            if (!contextTarget) return;
            
            const team = getTeam(contextTarget.i);
            
            if (contextTarget.p !== 'pet' && team && team.slots[contextTarget.p]) { 
                team.slots[contextTarget.p].ring = id; 
                
                if (contextTarget.i === 'PREP-ENEMY' || contextTarget.i === 'PREP-MY') {
                    renderPreparation();
                }
                else if (contextTarget.i === 'BATTLE-TEMP') {
                    renderBattleBuilder();
                }
                else if (typeof contextTarget.i === 'string' && contextTarget.i.startsWith('SIM-')) {
                    renderSimulatorTeams();
                }
                else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ Guild Team ‡∏´‡∏£‡∏∑‡∏≠ War Room
                    if(currentView === 'my-teams') renderMyTeams();
                    else renderDashboard();
                    
                    triggerAutoSave();
                }
            }
            closeContextMenu(); 
        }
        function removeHeroFromDetail() { 
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?')) { 
                const t = getTeam(detailTarget.i);
                
                if (t) {
                    // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
                    t.slots[detailTarget.p] = null; 
                    
                    // ‡∏•‡∏ö‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏ô Queue
                    if(t.skillQueue) {
                        t.skillQueue = t.skillQueue.filter(s => !s.startsWith(`${detailTarget.p}-`));
                    }
                    if(t.skills) {
                        t.skills = t.skills.filter(s => !s.startsWith(`${detailTarget.p}-`));
                    }

                    closeDetail(); 

                    // --- üü¢ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
                    if (detailTarget.i === 'BATTLE-TEMP') {
                        renderBattleBuilder(); // <--- ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏ö‡∏∏‡∏Å
                    } 
                    else if (typeof detailTarget.i === 'string' && detailTarget.i.startsWith('SIM-')) {
                        renderSimulatorTeams();
                    }
                    else if (detailTarget.i === 'BW-ENEMY' || detailTarget.i === 'BW-MY') {
                        renderBattleWar();
                    }
                    else {
                        updateCurrentViewUI();
                        triggerAutoSave();
                    }
                }
            } 
        }
        function removeItemFromContext() {
            const t = getTeam(contextTarget.i);
            
            if (t) {
                // 1. ‡∏•‡∏ö Pet
                if(contextTarget.p === 'pet') { 
                    t.pet = null; 
                } 
                // 2. ‡∏•‡∏ö Hero ‡πÉ‡∏ô Slot
                else { 
                    t.slots[contextTarget.p] = null; 
                    
                    if (t.skillQueue) {
                        t.skillQueue = t.skillQueue.filter(s => !s.startsWith(`${contextTarget.p}-`));
                    }
                    if (t.skills) {
                        t.skills = t.skills.filter(s => !s.startsWith(`${contextTarget.p}-`));
                    }
                }

                if (contextTarget.i === 'PREP-ENEMY' || contextTarget.i === 'PREP-MY') {
                    renderPreparation(); 
                } 
                else if (contextTarget.i === 'BATTLE-TEMP') {
                    renderBattleBuilder(); 
                } 
                else if (typeof contextTarget.i === 'string' && contextTarget.i.startsWith('SIM-')) {
                    renderSimulatorTeams(); 
                }
                else {
                    updateCurrentViewUI(); 
                    triggerAutoSave(); 
                }
            }

            closeContextMenu();
        }
        function resetSlot(i) { if (confirm('Reset Slot?')) { addLog(currentCastle, i, getTeam(i).player, 'Reset'); teamsDB[`${currentCastle}-${i}`] = undefined; renderDashboard(); } }
        function clearCastle() { 
            const canManage = CURRENT_USER.role === 'admin';
            if (!canManage) return alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó");
            if (confirm('Clear All?')) { Object.keys(teamsDB).forEach(k => { if (k.startsWith(currentCastle)) delete teamsDB[k] }); renderDashboard(); } }
        function toggleStatus(i) { const t = getTeam(i); t.isCleared = !t.isCleared; if (t.isCleared) addLog(currentCastle, i, t.player, 'Defeated'); renderDashboard(); }

        function renderDashboard() {
            const container = document.getElementById('dashboard-container'); container.innerHTML = '';

            // [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1] ‡∏™‡∏£‡πâ‡∏≤‡∏á Datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Autocomplete (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà)
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Option ‡∏à‡∏≤‡∏Å knownEnemies
            const datalistHTML = `
                <datalist id="enemy-names-list">
                    ${knownEnemies.map(n => `<option value="${n}">`).join('')}
                </datalist>
            `;
            
            // ‡πÉ‡∏™‡πà Datalist ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Container
            container.insertAdjacentHTML('beforeend', datalistHTML);
            
            for(let i=0; i<currentCap; i++) {
                const team = getTeam(i);
                const layout = { 'basic': {b:3,f:2}, 'balanced':{b:2,f:3}, 'attack':{b:4,f:1}, 'defense':{b:1,f:4} }[team.formation];
                const fmts = ['basic','balanced','attack','defense'].map(f => `<button onclick="updateTeam(${i},'formation','${f}')" class="form-btn ${team.formation===f?'active':''}">${f.toUpperCase()}</button>`).join('');
                let sc = 0;
                const genRow = (c, l) => {
                    let h = `<div class="flex gap-4 items-center justify-center relative min-h-[70px]"><div class="absolute -left-12 text-[10px] text-gray-500 font-bold w-10 text-right">${l}</div>`;
                    for(let k=0; k<c; k++) {
                        const p = sc++; const s = team.slots[p]; const hData = s ? heroesDB.find(x=>x.id==s.id) : null;
                        let inner = '';
                        if(hData) {
                            let ring = '', rCls = ''; if(s.ring) { const r = ringsDB.find(x=>x.id==s.ring); if(r) { ring=`<img src="${r.img}">`; rCls=`equipped grade-${r.grade}`; } }
                            const s1 = team.skills.includes(`${p}-1`)?'active':'', s2 = team.skills.includes(`${p}-2`)?'active':'';
                            inner = `
                                <img src="${hData.img}">
                                ${getStarsHTML(s.star, false)}
                                <div class="ring-trigger ${rCls}" onclick="openSelector(${i},${p},'ring',event)">${ring||'üíç'}</div>
                                <div class="skill-bar" onclick="event.stopPropagation()">
                                    <div onclick="toggleSkill(${i},${p},2)" class="skill-btn ${s2}">‡∏ö‡∏ô</div>
                                    <div onclick="toggleSkill(${i},${p},1)" class="skill-btn ${s1}">‡∏•‡πà‡∏≤‡∏á</div>
                                </div>  
                            `;
                        }
                        h += `<div class="slot ${hData?'filled':''} interactive-area" onclick="handleSlotClick(${i},${p})" oncontextmenu="openContextMenu(event,${i},${p})" ondragover="allowDrop(event)" ondrop="drop(event,${i},${p})" draggable="true" ondragstart="dragStart(event,${i},${p})">${inner}</div>`;
                    } return h + `</div>`;
                }
                const petD = team.pet ? petsDB.find(p=>p.id==team.pet.id) : null;
                const queueHtml = team.skills.map((s, index) => {
                    const [pos, skillNum] = s.split('-'); const slot = team.slots[pos]; if (!slot) return ''; const hero = heroesDB.find(h => h.id == slot.id); if (!hero) return '';
                    return `<div class="relative w-14 h-14 border border-gray-600 rounded bg-black flex-shrink-0"><img src="${hero.img}" class="w-full h-full object-cover rounded opacity-70"><div class="absolute bottom-0 right-0 bg-blue-600 text-white text-[10px] font-bold px-1.5 rounded-tl">${skillNum == '1' ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô'}</div><div class="absolute top-0 left-0 bg-yellow-500 text-black text-[10px] font-bold px-1.5 rounded-br leading-none">${index+1}</div></div>`;
                }).join('');
                const emptyHtml = Array(3 - team.skills.length).fill('<div class="w-14 h-14 border border-dashed border-gray-700 rounded bg-[#0d1117] flex items-center justify-center text-gray-700 text-xs flex-shrink-0">?</div>').join('');
                container.insertAdjacentHTML('beforeend', `<div class="team-row ${team.isCleared?'cleared':''}">
                    <div class="w-48 flex flex-col gap-3 justify-center flex-shrink-0"><div class="flex justify-between items-center"><span class="text-xs font-bold text-gray-500">SLOT #${i+1}</span><div class="flex gap-1"><button onclick="checkHistory(${i})" class="text-gray-500 hover:text-white" title="History">üìú</button><button onclick="openBattleModal(${i})" class="bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] px-2 py-0.5 rounded font-bold">‚öîÔ∏è BATTLE</button></div></div>
                <input type="number" value="${team.speed}" onchange="updateTeam(${i},'speed',this.value)" class="w-full bg-[#0d1117] border border-gray-600 text-blue-400 font-bold text-sm rounded px-2 outline-none" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤">
                <input type="text" 
                value="${team.player}" 
                list="enemy-names-list" 
                onchange="handleEnemyNameChange(${i}, this.value)" 
                class="w-full bg-[#0d1117] border border-gray-600 text-white px-3 py-2 rounded outline-none placeholder-gray-600 focus:border-yellow-500 transition" 
                placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏±‡∏ï‡∏£‡∏π (Name)..."
                autocomplete="off">
                <div class="grid grid-cols-2 gap-2 mt-1">${fmts}</div>
                <button onclick="openLoadSetModal('warRoom', ${i}, null)" class="w-full mt-2 bg-purple-900/50 hover:bg-purple-800 text-purple-200 border border-purple-700 text-[10px] py-1 rounded font-bold">üìÇ LOAD SET</button></div><div class="flex-1 flex items-center border-x border-gray-700 px-2 bg-[#0d1117]/30 rounded-lg mx-2"><div class="flex flex-col gap-2 items-center justify-center w-20 mr-2 border-r border-dashed border-gray-700 pr-2 py-2 flex-shrink-0"><span class="text-[10px] text-yellow-500 font-bold uppercase tracking-wider">Queue</span><div class="flex flex-col gap-1 items-center">${queueHtml}${emptyHtml}</div></div><div class="flex-1 flex flex-col gap-3 justify-center items-center">${genRow(layout.b,'BACK')}<div class="w-full h-px bg-gray-700/50"></div>${genRow(layout.f,'FRONT')}</div><div class="w-px h-32 bg-gray-700 mx-4 border-l border-dashed border-gray-600"></div><div class="flex flex-col gap-2 items-center justify-center w-20 flex-shrink-0"><span class="text-[10px] text-purple-400 font-bold uppercase">Pet</span><div class="pet-slot ${petD?'filled':''}" onclick="openSelector(${i},'pet','pet')" oncontextmenu="openContextMenu(event,${i},'pet')">${petD?`<img src="${petD.img}">`:'<span class="text-xl">+</span>'}</div></div></div>
                <div class="w-24 flex flex-col items-center justify-center gap-3 flex-shrink-0">
                
                    <div class="w-full mb-2 transform hover:scale-110 transition duration-300 cursor-help" title="‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${team.defensiveWins || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß!">
                        <div class="bg-gradient-to-br from-red-600 via-red-700 to-red-900 border-2 border-red-400 rounded-xl py-2 shadow-[0_0_15px_rgba(239,68,68,0.6)] flex flex-col items-center justify-center relative overflow-hidden">
                            
                            <div class="absolute inset-0 bg-white/10 animate-pulse"></div>
                            
                            <span class="text-[9px] font-bold text-red-200 uppercase tracking-widest z-10 relative" style="text-shadow: 0 1px 2px black;">DEFENDED</span>
                            
                            <div class="flex items-end gap-1 z-10 relative mt-[-2px]">
                                <span class="text-sm mb-1 filter drop-shadow-lg">üõ°Ô∏è</span>
                                <span class="text-3xl font-black text-yellow-400 leading-none filter drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">${team.defensiveWins || 0}</span>
                            </div>
                            
                        </div>
                    </div>

                <button onclick="toggleStatus(${i})" class="w-full py-2 border rounded font-bold text-[10px] transition ${team.isCleared?"bg-red-900/20 text-red-500 border-red-900":"bg-green-900/20 text-green-500 border-green-900 hover:bg-green-800"}">${team.isCleared?"üíÄ DEFEATED":"üü¢ ACTIVE"}</button><button onclick="resetSlot(${i})" class="text-xs text-gray-500 hover:text-white interactive-area border border-transparent hover:border-gray-600 px-3 py-1 rounded">Reset</button></div></div>`);

                renderCastleMenu();
            }
            
        }
        function getStarsHTML(l, pet, detail = false) {
            let stars = [];
            let redCount = 0;
            let blueCount = 0;
            let yellowCount = 6;

            if (!pet) {
                if (l > 6) {
                    redCount = l - 6;
                    blueCount = 6 - redCount;
                    yellowCount = 0;
                } else if (l > 0) {
                    blueCount = l;
                    yellowCount = 6 - blueCount;
                }
            }

            for (let i = 0; i < redCount; i++) stars.push('<span class="star-icon star-red">‚òÖ</span>');
            for (let i = 0; i < blueCount; i++) stars.push('<span class="star-icon star-blue">‚òÖ</span>');
            for (let i = 0; i < yellowCount; i++) stars.push('<span class="star-icon star-yellow">‚òÖ</span>');

            const containerClass = detail ? 'star-row-detail' : 'star-row-slot';
            
            // ‡∏õ‡∏£‡∏±‡∏ö style ‡∏´‡∏ô‡πâ‡∏≤ Detail ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
            const detailStyle = detail ? 'style="font-size: 28px; gap: 2px; margin-top: 10px;"' : '';

            return `<div class="${containerClass}" ${detailStyle}>${stars.join('')}</div>`;
        }
        function dragStart(e, i, p){
            // ‡∏ñ‡πâ‡∏≤ i ‡πÄ‡∏õ‡πá‡∏ô 'POOL' ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏•‡∏≤‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á Simulator (p ‡∏Ñ‡∏∑‡∏≠ heroId)
            if (i === 'POOL') {
                dragSrc = { i: 'POOL', heroId: p }; // p ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ ID ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
            } else {
                dragSrc = { i, p }; // ‡∏•‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏° (i=teamId, p=slotIndex)
            }
            e.dataTransfer.effectAllowed = 'move';
        }
        function allowDrop(e){e.preventDefault();}
        function drop(e, i, p) {
            e.preventDefault();
            const t = getTeam(i);
            if (!t) return;

            let droppedHeroId = null;
            if (dragSrc.i === 'POOL') droppedHeroId = dragSrc.heroId;
            else {
                const srcTeam = getTeam(dragSrc.i);
                if (srcTeam && srcTeam.slots[dragSrc.p]) droppedHeroId = srcTeam.slots[dragSrc.p].id;
            }

            // Drop Logic
            if (dragSrc.i === 'POOL') {
                t.slots[p] = { id: dragSrc.heroId, star: 0, ring: null };
            } else if (dragSrc && dragSrc.p !== p) {
                const srcTeam = getTeam(dragSrc.i);
                const temp = srcTeam.slots[dragSrc.p];
                srcTeam.slots[dragSrc.p] = t.slots[p];
                t.slots[p] = temp;
                if (t.skillQueue) t.skillQueue = [];
                if (srcTeam.skillQueue) srcTeam.skillQueue = [];
            }

            // *** REFRESH LOGIC ***
            if (i === 'BW-ENEMY' || i === 'BW-MY' || (dragSrc && (dragSrc.i === 'BW-ENEMY' || dragSrc.i === 'BW-MY'))) renderBattleWar();
            else if (i === 'PREP-ENEMY' || i === 'PREP-MY' || (dragSrc && (dragSrc.i === 'PREP-ENEMY' || dragSrc.i === 'PREP-MY'))) renderPreparation();
            else if (i === 'BATTLE-TEMP' || (dragSrc && dragSrc.i === 'BATTLE-TEMP')) renderBattleBuilder();
            else if (typeof i === 'string' && i.startsWith('SIM-')) renderSimulatorTeams();
            else { updateCurrentViewUI(); triggerAutoSave(); }

            dragSrc = null;
        }
        
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openSelector ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
        // --- üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤ Filter + ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≥) ---
        function openSelector(i, p, type, e) { 
            if(e) e.stopPropagation(); 

            if (i === 'HERO-LIST') {
                editContext = { i, p, type }; // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ p ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ listId ‡πÅ‡∏ó‡∏ô
                selectorActiveCategory = 'All';
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å (Optional)
                selectorExcludedIds = []; 
                // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ uncomment ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ tempHeroLists)
                // const list = tempHeroLists.find(l => l.id === p);
                // if (list) selectorExcludedIds = list.heroIds;

                document.getElementById('selector-title').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏° Hero ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                document.getElementById('selector-search').value = '';
                renderSelectorTabs();
                
                selectorCurrentData = [...heroesDB]; // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Hero
                document.getElementById('selectorModal').style.display = 'flex';
                filterSelector('');
                return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏≥ Logic ‡∏Ç‡∏≠‡∏á War Room ‡∏ï‡πà‡∏≠
            }

            let t = null;
            if (i === 'PREP-ENEMY') t = prepData.enemy;
            else if (i === 'PREP-MY') t = prepData.my;
            else if (i === 'BATTLE-TEMP') t = battleTempTeam; // (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
            else t = getTeam(i);

            if (typeof i === 'string' && i.startsWith('G-')) {
                const parts = i.split('-');
                const team = guildMembersDB[parseInt(parts[1])].teams[parseInt(parts[2])];
                if (team && team.isDead) return alert("‚õî ‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
            }
            if (typeof i !== 'string' && t.isCleared) return;
            if(type==='ring'&&!t.slots[p])return; 

            const prevType = editContext ? editContext.type : null;

            // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Context ‡πÉ‡∏´‡∏°‡πà
            editContext={i,p,type}; 

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡πÄ‡∏ä‡πà‡∏ô Hero -> Pet) ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô 'All'
            // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏¥‡∏° (Hero -> Hero) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
            if (prevType !== type) {
                selectorActiveCategory = 'All';
            }
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î
            if (!prevType) selectorActiveCategory = 'All';

            // 5. Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Hero ‡∏ó‡∏µ‡πà "‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß" (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô)
            selectorExcludedIds = []; 

            if (type === 'hero') {
                // Case A: Guild Teams
                if (typeof i === 'string' && i.startsWith('G-')) {
                    const parts = i.split('-');
                    const memIdx = parseInt(parts[1]);         
                    const currentTeamIdx = parseInt(parts[2]); 
                    const currentSlotIdx = parseInt(p);        

                    const member = guildMembersDB[memIdx];
                    if (member && member.teams) {
                        member.teams.forEach((team, tIdx) => {
                            if (!team || !team.slots) return;
                            for (let k = 0; k < 5; k++) {
                                const slot = team.slots[k];
                                if (slot && slot.id) {
                                    if (tIdx === currentTeamIdx && k === currentSlotIdx) continue;
                                    // selectorExcludedIds.push(slot.id);
                                }
                            }
                        });
                    }
                }
                // Case B: Preparation (Battle Temp)
                else if (i === 'BATTLE-TEMP') {
                    if (battleActiveMemberIdx !== null && battleActiveMemberIdx !== undefined) {
                        const member = guildMembersDB[battleActiveMemberIdx];
                        if (member && member.teams) {
                            member.teams.forEach(team => {
                                if (!team || !team.slots) return;
                                for (let k = 0; k < 5; k++) {
                                    const slot = team.slots[k];
                                    // if (slot && slot.id) selectorExcludedIds.push(slot.id);
                                }
                            });
                        }
                        if (battleTempTeam && battleTempTeam.slots) {
                            for (let k = 0; k < 5; k++) {
                                if (parseInt(k) === parseInt(p)) continue;
                                const slot = battleTempTeam.slots[k];
                                // if (slot && slot.id) selectorExcludedIds.push(slot.id);
                            }
                        }
                    }
                }
            }

            // 6. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• UI
            document.getElementById('selector-title').innerText = 'Select ' + type; 
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search Text) ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
            // (‡πÅ‡∏ï‡πà Tab Filter ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏° Logic ‡∏Ç‡πâ‡∏≠ 4)
            document.getElementById('selector-search').value = ''; 

            // Render Tabs (‡∏à‡∏∞‡πÉ‡∏ä‡πâ selectorActiveCategory ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Highlight)
            renderSelectorTabs();
            
            if(type==='hero') selectorCurrentData = [...heroesDB]; 
            else if(type==='pet') selectorCurrentData = [...petsDB]; 
            else selectorCurrentData = [...ringsDB];
            
            document.getElementById('selectorModal').style.display = 'flex'; 
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Filter (‡πÉ‡∏ä‡πâ Search ‡∏ß‡πà‡∏≤‡∏á + Tab ‡πÄ‡∏î‡∏¥‡∏°)
            filterSelector('');
        }

        function renderSelectorTabs() {
            const container = document.getElementById('selector-tabs'); let tabs = ['All'];
            if (editContext.type === 'hero') tabs = ['All', ...TYPE_OPTS]; else if (editContext.type === 'pet') tabs = ['All', ...PET_TYPE_OPTS]; else if (editContext.type === 'ring') tabs = ['All', '6 ‡∏î‡∏≤‡∏ß', '5 ‡∏î‡∏≤‡∏ß', '4 ‡∏î‡∏≤‡∏ß'];
            container.innerHTML = tabs.map(t => `<button onclick="switchSelectorTab('${t}')" class="tab-btn px-3 py-1 text-xs border rounded-full ${selectorActiveCategory===t?'bg-blue-600 text-white border-blue-600':'border-gray-600 text-gray-400 hover:text-white'}">${t}</button>`).join('');
        }
        function switchSelectorTab(cat) { selectorActiveCategory = cat; renderSelectorTabs(); filterSelector(document.getElementById('selector-search').value); }
        function filterSelector(text) {
            const lower = text.toLowerCase(); 
            const grid = document.getElementById('selector-grid'); 
            grid.innerHTML = '';

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            let filteredItems = selectorCurrentData.filter(item => {
                // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠
                if (!item.name.toLowerCase().includes(lower)) return false;

                // üü¢ 2. LOGIC ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (Excluded IDs)
                if (editContext.type === 'hero' && selectorExcludedIds.length > 0) {
                    if (selectorExcludedIds.includes(item.id)) {
                        return false; // ‚ùå ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    }
                }

                // 3. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Category
                if (selectorActiveCategory !== 'All') {
                    if (editContext.type === 'hero') return item.type === selectorActiveCategory;
                    else if (editContext.type === 'pet') { 
                        const types = Array.isArray(item.type) ? item.type : [item.type]; 
                        return types.includes(selectorActiveCategory); 
                    }
                    else if (editContext.type === 'ring') { 
                        const grade = parseInt(selectorActiveCategory.split(' ')[0]); 
                        return item.grade === grade; 
                    }
                } 
                return true;
            });

            // Sorting
            const sortFunc = (a, b) => {
                if (editContext.type === 'ring') return (b.grade||0) - (a.grade||0);
                let rA = -1, rB = -1;
                if(editContext.type === 'hero') { rA = RARITY_OPTS.indexOf(a.rarity); rB = RARITY_OPTS.indexOf(b.rarity); } 
                else if(editContext.type === 'pet') { rA = PET_RARITY_OPTS.indexOf(a.rarity); rB = PET_RARITY_OPTS.indexOf(b.rarity); }
                if (rA === -1) rA = 999; if (rB === -1) rB = 999; if (rA !== rB) return rA - rB; return a.name.localeCompare(b.name, 'th');
            };
            filteredItems.sort(sortFunc);

            // ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏≠‡∏î‡∏≠‡∏≠‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏´‡∏ß‡∏ô)
            if (editContext.type === 'ring' && selectorActiveCategory === 'All' && !text) { 
                grid.innerHTML = `<div onclick="selectItem(null)" class="selector-card border-red-500/50 flex items-center justify-center"><span class="text-red-500 font-bold text-xl">‚úï</span></div>`; 
            }

            // Render HTML
            const html = filteredItems.map(d => {
                if (editContext.type === 'ring') { 
                    return `<div onclick="selectItem('${d.id}')" class="selector-card grade-${d.grade} flex flex-col items-center justify-center p-2 gap-2"><img src="${d.img}" class="rounded-full w-14 h-14 border-2 border-gray-700"><span class="selector-text text-[10px]">${d.name}</span></div>`; 
                }
                else { 
                    return `<div onclick="selectItem('${d.id}')" class="selector-card group"><img src="${d.img}"><div class="selector-overlay"><span class="selector-text">${d.name}</span></div><div class="selector-badge">${getRarityBadgeHTML(d.rarity)}</div></div>`; 
                }
            }).join('');
            
            grid.insertAdjacentHTML('beforeend', html);
        }
        function closeSelector() { document.getElementById('selectorModal').style.display = 'none'; }
        
        function openContextMenu(e, i, p) { 
            e.preventDefault(); 
            
            // [‡πÅ‡∏Å‡πâ] ‡πÉ‡∏ä‡πâ getTeam ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö (‡∏°‡∏±‡∏ô‡∏â‡∏•‡∏≤‡∏î‡∏û‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô War Room ‡∏´‡∏£‡∏∑‡∏≠ Guild Team ‡∏à‡∏≤‡∏Å ID 'i')
            const t = getTeam(i);
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ó‡∏µ‡∏° ‡∏´‡∏£‡∏∑‡∏≠ (‡πÄ‡∏õ‡πá‡∏ô War Room ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏µ‡∏°‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß) ‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            if(!t || (typeof i !== 'string' && t.isCleared)) return;
            
            if(p === 'pet') { if(!t.pet) return; } else { if(!t.slots[p]) return; }
            
            contextTarget={i,p}; 
            const m=document.getElementById('contextMenu'); m.style.top=e.pageY+'px'; m.style.left=e.pageX+'px'; m.style.display='block'; 
            
            const r=document.getElementById('star-grid-red'), b=document.getElementById('star-grid-blue'); r.innerHTML=''; b.innerHTML=''; 
            for(let x=1;x<=6;x++)r.innerHTML+=`<div class="ctx-btn red" onclick="setStar(${x+6})">${x}</div>`; 
            for(let x=1;x<=6;x++)b.innerHTML+=`<div class="ctx-btn blue" onclick="setStar(${x})">${x}</div>`; 
            
            const ringSec = document.getElementById('ctx-rings-section'); const starSec = document.getElementById('ctx-stars-section');
            if(p === 'pet') { ringSec.style.display = 'none'; starSec.style.display = 'none'; } 
            else { ringSec.style.display = 'block'; starSec.style.display = 'block'; const rl=document.getElementById('ring-options'); rl.innerHTML=`<div class="ring-option" onclick="setRing(null)"><span>No Ring</span></div>`; ringsDB.forEach(r=>{rl.innerHTML+=`<div class="ring-option" onclick="setRing('${r.id}')"><img src="${r.img}" class="grade-${r.grade}" style="border:2px solid"><div><div class="text-xs text-gray-200">${r.name}</div></div></div>`}); }
        }
        
        // --- FIXED: OPEN DETAIL FUNCTION ---
        function openDetailFromContext() { 
            closeContextMenu(); 
            
            // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ getTeam(id) ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á War Room ‡πÅ‡∏•‡∏∞ Guild Team)
            const t = getTeam(contextTarget.i);
            
            if (!t) return; // ‡∏Å‡∏±‡∏ô Error

            if(contextTarget.p === 'pet') {
                if(t.pet) {
                    const pet = petsDB.find(p => p.id == t.pet.id);
                    if(pet) showDetailModal(pet, 'pet', 0, null, true);
                }
            } else {
                const s = t.slots[contextTarget.p];
                if(s) {
                    const h = heroesDB.find(x => x.id == s.id);
                    // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏î‡∏≤‡∏ß (s.star) ‡πÅ‡∏•‡∏∞‡πÅ‡∏´‡∏ß‡∏ô (s.ring) ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                    if(h) showDetailModal(h, 'hero', s.star, s.ring, true);
                }
            }
        }
        
        function closeContextMenu() { document.getElementById('contextMenu').style.display='none'; }
        function openTextContextMenu(e, elem) { e.preventDefault(); activeTextarea = elem; const m = document.getElementById('textEditorMenu'); m.style.top = e.pageY + 'px'; m.style.left = e.pageX + 'px'; m.style.display = 'block'; }
        function closeTextContextMenu() { document.getElementById('textEditorMenu').style.display = 'none'; }
        function applyTextColor(cls) { if(!activeTextarea) return; const start = activeTextarea.selectionStart, end = activeTextarea.selectionEnd, text = activeTextarea.value, selection = text.substring(start, end), replacement = `<span class="${cls}">${selection || 'TEXT'}</span>`; activeTextarea.value = text.substring(0, start) + replacement + text.substring(end); closeTextContextMenu(); }

        function switchGalleryTab(tab) { galleryTab = tab; document.getElementById('tab-gallery-hero').className = `tab-btn ${tab==='hero'?'active':''}`; document.getElementById('tab-gallery-pet').className = `tab-btn ${tab==='pet'?'active':''}`; document.getElementById('gallery-filters').style.display = 'flex'; galleryFilter = { rarity: null, type: null, aff: null }; renderGallery(); }
        function toggleGalleryFilter(key, val) { if (galleryFilter[key] === val) galleryFilter[key] = null; else galleryFilter[key] = val; renderGallery(); }
        function renderGallery() {
            const container = document.getElementById('gallery-container'); const search = document.getElementById('gallery-search').value.toLowerCase(); const filterContainer = document.getElementById('gallery-filters');
            let filterHTML = '';
            if(galleryTab === 'hero') {
                const renderBtns = (key, opts) => `<div class="flex gap-2 items-center flex-wrap"><span class="text-[10px] text-gray-500 font-bold w-12 uppercase">${key}</span><div class="flex gap-2 flex-wrap">${opts.map(o => `<button onclick="toggleGalleryFilter('${key}','${o}')" class="filter-btn ${galleryFilter[key]===o?'active':''}">${o}</button>`).join('')}</div></div>`;
                filterHTML += renderBtns('rarity', RARITY_OPTS); filterHTML += renderBtns('type', TYPE_OPTS); let affs = [...affiliationsDB].sort(); filterHTML += `<div class="flex gap-2 items-center flex-wrap"><span class="text-[10px] text-gray-500 font-bold w-12 uppercase">Group</span><div class="flex gap-2 flex-wrap">${affs.map(o => `<button onclick="toggleGalleryFilter('aff','${o}')" class="filter-btn ${galleryFilter.aff===o?'active':''}">${o}</button>`).join('')}</div></div>`;
            } else {
                const renderBtns = (key, opts, label) => `<div class="flex gap-2 items-center flex-wrap"><span class="text-[10px] text-gray-500 font-bold w-12 uppercase">${label}</span><div class="flex gap-2 flex-wrap">${opts.map(o => `<button onclick="toggleGalleryFilter('${key}','${o}')" class="filter-btn ${galleryFilter[key]===o?'active':''}">${o}</button>`).join('')}</div></div>`;
                filterHTML += renderBtns('rarity', PET_RARITY_OPTS, 'Rarity'); filterHTML += renderBtns('type', PET_TYPE_OPTS, 'Type');
            }
            filterContainer.innerHTML = filterHTML;
            let data = [];
            if (galleryTab === 'hero') { data = heroesDB.filter(h => { let match = h.name.toLowerCase().includes(search); if (galleryFilter.rarity && h.rarity !== galleryFilter.rarity) match = false; if (galleryFilter.type && h.type !== galleryFilter.type) match = false; if (galleryFilter.aff && h.affiliation !== galleryFilter.aff) match = false; return match; }); data.sort((a, b) => { let rA = RARITY_OPTS.indexOf(a.rarity); let rB = RARITY_OPTS.indexOf(b.rarity); if (rA === -1) rA = 999; if (rB === -1) rB = 999; if (rA !== rB) return rA - rB; return a.name.localeCompare(b.name, 'th'); }); } 
            else { data = petsDB.filter(p => { let match = p.name.toLowerCase().includes(search); if (galleryFilter.rarity && p.rarity !== galleryFilter.rarity) match = false; if (galleryFilter.type) { let pTypes = Array.isArray(p.type) ? p.type : [p.type]; if (!pTypes.includes(galleryFilter.type)) match = false; } return match; }); data.sort((a,b) => { let rA = PET_RARITY_OPTS.indexOf(a.rarity); let rB = PET_RARITY_OPTS.indexOf(b.rarity); if (rA === -1) rA = 999; if (rB === -1) rB = 999; if (rA !== rB) return rA - rB; return a.name.localeCompare(b.name, 'th'); }); }
            container.innerHTML = data.map(item => `<div class="hero-card group" onclick="viewGalleryDetail('${item.id}', '${galleryTab}')"><img src="${item.img || 'https://via.placeholder.com/100'}" class="hc-img"><div class="absolute top-1 right-1 opacity-90">${getRarityBadgeHTML(item.rarity)}</div><div class="hc-name-overlay"><div class="hc-name-text">${item.name}</div></div></div>`).join('');
        }

        function openDetail(i, p) { 
            detailTarget = {i,p}; 
            
            // [‡πÅ‡∏Å‡πâ] ‡πÉ‡∏ä‡πâ getTeam ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö (‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏£‡∏π‡πâ‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô War Room ‡∏´‡∏£‡∏∑‡∏≠ Guild Team)
            const team = getTeam(i);
            
            if (!team) return;

            if (p === 'pet') { 
                if (team.pet) { 
                    const h = petsDB.find(x => x.id == team.pet.id); 
                    if(h) showDetailModal(h, 'pet', 0, null, true); 
                } 
            } else { 
                const s = team.slots[p]; 
                if (s) { 
                    const h = heroesDB.find(x => x.id == s.id); 
                    if(h) showDetailModal(h, 'hero', s.star, s.ring, true); 
                } 
            }
        }
        function viewGalleryDetail(id, type) { detailTarget = null; const db = type === 'hero' ? heroesDB : petsDB; const item = db.find(x => x.id == id); showDetailModal(item, type, 0, null, false); }

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Logic ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏î‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á C2/C6) ---
        function showDetailModal(item, type, stars, ringId, allowRemove) {
            if(!item) return;
            currentDetailHero = item; 

            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á (Blue Stars)
            if (stars > 6) { currentDetailBlueStars = 6; currentDetailRedStars = stars - 6; } 
            else { currentDetailBlueStars = stars; currentDetailRedStars = 0; }

            const modal = document.getElementById('detailModal');
            document.getElementById('dt-img').src = item.img; 
            document.getElementById('dt-name').innerText = item.name; 
            const tabHeader = document.getElementById('dt-tabs');

            // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢ Effect (‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏î‡∏≤‡∏ß)
            const renderEffectTags = (skillKey) => {
                const conf = item.skillData?.[skillKey];
                if (!conf || !conf.effects || conf.effects.length === 0) return '';

                let html = '<div class="mt-2 flex flex-col gap-1">';
                conf.effects.forEach(eff => {
                    // --- [NEW LOGIC] ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á (Active Values) ---
                    let actRate = eff.rate || 0;
                    let actVal = eff.val || 0;
                    let actTurn = eff.turn || 0;
                    let tierLabel = ""; // ‡∏õ‡πâ‡∏≤‡∏¢‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡πÑ‡∏´‡∏ô (Option)

                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏á (C6 -> C2 -> Green -> Base)
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô
                    if (currentDetailBlueStars >= 6 && (eff.c6_rate || eff.c6_val || eff.c6_turn)) {
                        actRate = eff.c6_rate || actRate;
                        actVal = eff.c6_val || actVal;
                        actTurn = eff.c6_turn || actTurn;
                        tierLabel = "LB6";
                    } else if (currentDetailBlueStars >= 2 && (eff.c2_rate || eff.c2_val || eff.c2_turn)) {
                        actRate = eff.c2_rate || actRate;
                        actVal = eff.c2_val || actVal;
                        actTurn = eff.c2_turn || actTurn;
                        tierLabel = "LB2";
                    } else if (currentDetailBlueStars >= 1 && (eff.green_rate || eff.green_val || eff.green_turn)) {
                        // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏î‡∏≤‡∏ß‡∏ü‡πâ‡∏≤ 1 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏Å‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß (Green)
                        actRate = eff.green_rate || actRate;
                        actVal = eff.green_val || actVal;
                        actTurn = eff.green_turn || actTurn;
                    }

                    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ Effect ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡∏µ‡πâ -> ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå
                    if (actRate === 0 && actVal === 0 && actTurn === 0) return;

                    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
                    let rawNote = eff.note || "";
                    let rawCond = eff.cond || "";
                    const shouldHideStats = rawNote.includes('#hide') || rawCond.includes('#hide');
                    const cleanNote = rawNote.replace('#hide', '').trim();
                    const cleanCond = rawCond.replace('#hide', '').trim();

                    let colorClass = "bg-gray-700 text-gray-300 border-gray-600";
                    let icon = "üîπ";
                    if (eff.type === 'dot') { colorClass = "bg-orange-900/40 text-orange-300 border-orange-700"; icon = "üî•"; }
                    else if (eff.type === 'cc') { colorClass = "bg-blue-900/40 text-blue-300 border-blue-700"; icon = "‚ùÑÔ∏è"; }
                    else if (eff.type === 'stat') { colorClass = "bg-green-900/40 text-green-300 border-green-700"; icon = "üìä"; }
                    else if (eff.type === 'dmg') { colorClass = "bg-red-900/40 text-red-300 border-red-700"; icon = "‚öîÔ∏è"; }
                    else if (eff.type === 'special') { colorClass = "bg-yellow-900/40 text-yellow-300 border-yellow-700"; icon = "‚ú®"; }

                    let valText = "";
                    if (!shouldHideStats) {
                        if (actVal > 0) valText += `Val:${actVal} `;
                        if (actRate > 0 && actRate < 100) valText += `${actRate}% `;
                        if (actTurn > 0) valText += `${actTurn}T `;
                    }

                    let extra = "";
                    if (cleanCond) extra += ` <span class="text-white opacity-90">(${cleanCond})</span>`;
                    if (valText) extra += ` <span class="bg-black/30 px-1 rounded text-[10px] font-mono text-gray-300 ml-1">${valText}</span>`;
                    if (cleanNote) extra += ` <span class="text-[9px] opacity-70 ml-1">- ${cleanNote}</span>`;
                    if (eff.cap) extra += ` <span class="text-[9px] text-red-400 ml-1">[Cap: ${eff.cap}]</span>`;
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πâ‡∏≤‡∏¢ LB ‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å LB
                    // if (tierLabel) extra += ` <span class="text-[8px] bg-purple-900 text-purple-200 px-1 rounded ml-1">${tierLabel}</span>`;

                    html += `
                    <div class="px-2 py-1 rounded border text-xs flex flex-wrap items-center ${colorClass}">
                        <span class="font-bold mr-1">${icon} ${eff.name}</span>
                        ${extra}
                    </div>`;
                });
                html += '</div>';
                return html;
            };

            if (type === 'hero') {
                tabHeader.classList.remove('hidden');
                switchDetailTab('skills'); 
                document.getElementById('dt-content-hero').classList.remove('hidden');
                document.getElementById('dt-content-pet').classList.add('hidden');
                document.getElementById('dt-stars').innerHTML = getStarsHTML(stars, false, true);
                
                const tags = `<div class="flex flex-wrap gap-2 mt-2 items-center">${getRarityBadgeHTML(item.rarity)}${item.type ? `<span class="${BASE_BADGE_STYLE} bg-gray-700 text-blue-300 border-blue-600">${item.type}</span>` : ''}${item.affiliation ? `<span class="${BASE_BADGE_STYLE} bg-gray-700 text-purple-300 border-purple-600">${item.affiliation}</span>` : ''}</div>`;
                document.getElementById('dt-stars').insertAdjacentHTML('beforeend', tags);
                
                document.getElementById('dt-n').innerHTML = (item.skills?.n || '-') + renderEffectTags('n');
                document.getElementById('dt-p').innerHTML = (item.skills?.p || '-') + renderEffectTags('p');
                document.getElementById('dt-s1').innerHTML = (item.skills?.s1 || '-') + renderEffectTags('s1');
                document.getElementById('dt-s2').innerHTML = (item.skills?.s2 || '-') + renderEffectTags('s2');
                
                const rDiv = document.getElementById('dt-ring-section'); 
                if(ringId) { const r = ringsDB.find(x=>x.id==ringId); if(r) rDiv.innerHTML = `<img src="${r.img}" class="w-12 h-12 rounded border-2 grade-${r.grade}"><div><div class="font-bold text-white text-sm">${r.name}</div><div class="text-xs text-gray-400">${r.desc}</div></div>`; else rDiv.innerHTML = `<div class="text-gray-500 text-sm">No Ring Equipped</div>`; } 
                else { rDiv.innerHTML = `<div class="text-gray-500 text-sm">No Ring Equipped</div>`; }
            } else {
                // (Pet Logic ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                tabHeader.classList.add('hidden');
                document.getElementById('dt-view-skills').classList.add('hidden');
                document.getElementById('dt-view-stats').classList.add('hidden');
                document.getElementById('dt-content-hero').classList.add('hidden');
                document.getElementById('dt-content-pet').classList.remove('hidden');
                let typesHtml = ''; const PET_TYPE_STYLE = `${BASE_BADGE_STYLE} bg-purple-900/60 text-purple-300 border-purple-500`;
                if(Array.isArray(item.type)) typesHtml = item.type.map(t => `<span class="${PET_TYPE_STYLE}">${t}</span>`).join(''); else if(item.type) typesHtml = `<span class="${PET_TYPE_STYLE}">${item.type}</span>`;
                document.getElementById('dt-stars').innerHTML = `<div class="flex flex-wrap gap-2 mt-2 items-center">${getRarityBadgeHTML(item.rarity)}${typesHtml}</div>`;
                document.getElementById('dt-content-pet').innerHTML = `<div class="bg-[#111827] p-4 rounded-lg border border-gray-700 mt-4"><h4 class="text-purple-400 font-bold text-sm uppercase mb-2 border-b border-gray-700 pb-1">Pet Skill</h4><div class="skill-display">${item.skill || '<span class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏Å‡∏¥‡∏•</span>'}</div></div>`;
            }
            const btn = document.getElementById('btn-remove-hero'); 
            btn.style.display = allowRemove ? 'flex' : 'none';
            modal.style.display = 'flex';
        }
        // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö Tab (Skills / Stats) ---
        function switchDetailTab(tab) {
            const btnSkills = document.getElementById('dt-tab-skills');
            const btnStats = document.getElementById('dt-tab-stats');
            const viewSkills = document.getElementById('dt-view-skills');
            const viewStats = document.getElementById('dt-view-stats');

            if(tab === 'skills') {
                btnSkills.className = "flex-1 py-2 text-sm font-bold text-blue-400 border-b-2 border-blue-500 transition";
                btnStats.className = "flex-1 py-2 text-sm font-bold text-gray-500 hover:text-white transition";
                viewSkills.classList.remove('hidden');
                viewStats.classList.add('hidden');
            } else {
                btnSkills.className = "flex-1 py-2 text-sm font-bold text-gray-500 hover:text-white transition";
                btnStats.className = "flex-1 py-2 text-sm font-bold text-blue-400 border-b-2 border-blue-500 transition";
                viewSkills.classList.add('hidden');
                viewStats.classList.remove('hidden');
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Stat ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î Tab ‡∏ô‡∏µ‡πâ
                calculateAndRenderStats(); 
            }
        }
        
        function closeDetail() { document.getElementById('detailModal').style.display = 'none'; }
        
        async function addNewMyTeam() {
            myTeamsDB.push({ id: Date.now().toString(), name: 'New Team', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, note: '' });
            renderGuildResultMode();
            await pushData();
        }
        async function deleteMyTeam(id) { if(confirm("Delete this team?")) { myTeamsDB = myTeamsDB.filter(t => t.id !== id); renderGuildResultMode(); await pushData(); } }
        async function updateMyTeam(id, field, val) { const t = myTeamsDB.find(x => x.id === id); if(t) { t[field] = val; if(field==='formation') renderGuildResultMode(); await pushData(); } }

        // --- MANAGER UI ---
        function renderManagerUI() {
            const list=document.getElementById('manager-list'), form=document.getElementById('manager-form'), empty=document.getElementById('manager-empty'); list.innerHTML='';
            let db=[], title=''; if(currentView==='hero-manager'){title='Heroes';db=heroesDB;} else if(currentView==='pet-manager'){title='Pets';db=petsDB;} else if(currentView==='item-manager'){ title='Items'; db=itemsDB; } else{title='Rings';db=ringsDB;}
            document.getElementById('manager-title').innerText='Manage '+title;

            if(currentView === 'item-manager') {
                db.sort((a,b) => a.type.localeCompare(b.type) || b.level - a.level);
            }else{
                if (currentView === 'hero-manager') db.sort((a, b) => { let rA = RARITY_OPTS.indexOf(a.rarity); let rB = RARITY_OPTS.indexOf(b.rarity); if (rA === -1) rA = 999; if (rB === -1) rB = 999; if (rA !== rB) return rA - rB; return a.name.localeCompare(b.name, 'th'); });
                else if (currentView === 'pet-manager') db.sort((a, b) => { let rA = PET_RARITY_OPTS.indexOf(a.rarity); let rB = PET_RARITY_OPTS.indexOf(b.rarity); if (rA === -1) rA = 999; if (rB === -1) rB = 999; if (rA !== rB) return rA - rB; return a.name.localeCompare(b.name, 'th'); });
                else db.sort((a, b) => (b.grade||0) - (a.grade||0) || a.name.localeCompare(b.name, 'th'));
            }

            db.forEach(i => {
                let badgeHtml = '';
                const PET_TYPE_STYLE_LIST = `${BASE_BADGE_STYLE} bg-purple-900/60 text-purple-300 border-purple-500`;
                if (currentView === 'hero-manager' && i.rarity) badgeHtml = getRarityBadgeHTML(i.rarity); 
                else if (currentView === 'pet-manager') {
                    let rarityBadge = getRarityBadgeHTML(i.rarity);
                    let typeBadge = '';
                    if(Array.isArray(i.type)) typeBadge = i.type.map(t => `<span class="${PET_TYPE_STYLE_LIST}">${t}</span>`).join('');
                    else if(i.type) typeBadge = `<span class="${PET_TYPE_STYLE_LIST}">${i.type}</span>`;
                    badgeHtml = rarityBadge + typeBadge;
                } 
                else if (currentView === 'ring-manager') badgeHtml = `<span class="${BASE_BADGE_STYLE} bg-gray-800 text-yellow-400 border-yellow-500">${i.grade}‚òÖ</span>`;
                else if (currentView === 'item-manager') { // <--- Badge ‡∏Ç‡∏≠‡∏á Item
                    const color = i.type === 'front' ? 'text-blue-300 border-blue-500' : 'text-purple-300 border-purple-500';
                    const label = i.type === 'front' ? 'FRONT' : 'BACK';
                    badgeHtml = `<span class="${BASE_BADGE_STYLE} bg-[#0d1117] ${color}">+${i.level} ${label}</span>`;
                }
                list.innerHTML+=`<div onclick="editManagerItem('${i.id}')" class="manager-list-item ${editingItemId==i.id?'active':''}"><img src="${i.img||'https://via.placeholder.com/50'}" class="w-10 h-10 rounded bg-black object-cover border border-gray-700 shrink-0"><div class="overflow-hidden w-full"><div class="flex flex-wrap items-center">${badgeHtml}</div><div class="font-bold text-gray-200 text-sm truncate leading-tight">${i.name}</div></div></div>`
            });
            if(!editingItemId){form.classList.add('hidden');empty.classList.remove('hidden');} else{form.classList.remove('hidden');empty.classList.add('hidden');}
        }
        
        function editManagerItem(id) {
            editingItemId = id; 
            let db = currentView === 'hero-manager' ? heroesDB : currentView === 'pet-manager' ? petsDB : currentView === 'item-manager' ? itemsDB : ringsDB;
            let item = db.find(x => x.id == id);
            if (!item) { editingItemId = null; renderManagerUI(); return; }

            // ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß Common
            let h = `<div class="bg-[#0d1117] p-4 rounded-xl border border-gray-700 mb-6 flex gap-6 items-start shadow-md">
                <div class="relative group">
                    <img id="m-prev" src="${item.img}" class="w-32 h-32 rounded-lg border-2 border-gray-600 object-cover bg-black shadow-lg" onerror="this.src='https://via.placeholder.com/128/333/fff?text=No+Image'">
                    <div class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition rounded-lg pointer-events-none">
                        <span class="text-xs text-white font-bold">Preview</span>
                    </div>
                </div>
                <div class="flex-1 space-y-4 pt-1">
                    <div class="input-group">
                        <label class="text-blue-400">‡∏ä‡∏∑‡πà‡∏≠ (Name)</label>
                        <input type="text" id="m-name" value="${item.name}" class="text-lg font-bold">
                    </div>
                    <div class="input-group">
                        <label class="text-gray-500">‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image URL)</label>
                        <input type="text" id="m-img" value="${item.img}" onchange="document.getElementById('m-prev').src=this.value" class="font-mono text-xs text-yellow-500">
                    </div>
                </div>
            </div>`;

            if (currentView === 'item-manager') {
                // --- ITEM EDITOR START ---
                
                // 1. Level Slider (+0 to +15)
                h += `
                <div class="bg-[#0d1117] p-4 rounded border border-gray-700 mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-400 uppercase">Upgrade Level</label>
                        <span id="lvl-display" class="text-xl font-bold text-green-400">+${item.level}</span>
                    </div>
                    <input type="range" id="m-level" min="0" max="15" value="${item.level}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-500" oninput="document.getElementById('lvl-display').innerText = '+' + this.value">
                    <div class="flex justify-between text-[10px] text-gray-500 mt-1"><span>0</span><span>3</span><span>6</span><span>9</span><span>12</span><span>15 (Max)</span></div>
                </div>`;

                // 2. Type & Set
                h += `
                <div class="grid grid-cols-2 gap-4 mt-2">
                    <div class="input-group">
                        <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Position)</label>
                        <select id="m-type" onchange="renderMainStatOptions(this.value)" class="bg-[#0d1117] border border-gray-600 rounded px-2 py-2 text-white w-full outline-none">
                            <option value="front" ${item.type==='front'?'selected':''}>‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (Front)</option>
                            <option value="back" ${item.type==='back'?'selected':''}>‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á (Back)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏ï (Set Name)</label>
                        <input type="text" id="m-set" value="${item.set}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏Å‡∏£‡∏ö‡∏Ñ‡∏•‡∏±‡πà‡∏á">
                    </div>
                </div>`;

                // 3. Main Stat (Dynamic based on Type)
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Stat ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Front/Back)
                const currentMainStats = MAIN_STAT_RULES[item.type] || MAIN_STAT_RULES['front'];
                let mainOptHtml = currentMainStats.map(s => `<option value="${s}" ${item.mainStat?.stat===s?'selected':''}>${STAT_DISPLAY[s] || s}</option>`).join('');

                h += `
                <div class="bg-[#0d1117] p-4 rounded border border-yellow-600/50 mt-4 relative">
                    <span class="absolute -top-2 left-3 bg-[#161b22] px-1 text-[10px] text-yellow-500 font-bold uppercase">Main Option (‡∏≠‡∏≠‡∏ü‡∏´‡∏•‡∏±‡∏Å 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á)</span>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="m-main-stat" class="bg-[#161b22] border border-gray-600 rounded px-2 py-1 text-white w-full outline-none">${mainOptHtml}</select>
                        <input type="number" id="m-main-val" value="${item.mainStat?.val || 0}" class="bg-[#161b22] border border-gray-600 rounded px-2 text-white placeholder-gray-500" placeholder="Value">
                    </div>
                </div>`;

                // 4. Sub Stats (4 Slots)
                h += `<div class="bg-[#0d1117] p-4 rounded border border-blue-600/50 mt-4 relative">
                        <span class="absolute -top-2 left-3 bg-[#161b22] px-1 text-[10px] text-blue-400 font-bold uppercase">Sub Options (‡∏≠‡∏≠‡∏ü‡∏£‡∏≠‡∏á 4 ‡∏≠‡∏¢‡πà‡∏≤‡∏á)</span>
                        <div class="space-y-2">`;
                
                // Loop ‡∏™‡∏£‡πâ‡∏≤‡∏á 4 ‡∏ä‡πà‡∏≠‡∏á
                for(let i=0; i<4; i++) {
                    const sub = item.subStats?.[i] || { stat: '', val: 0 };
                    
                    // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡πÑ‡∏´‡∏ô?
                    const unlockLvl = (i+1) * 3; // +3, +6, +9, +12 ? (‡∏ï‡∏≤‡∏° User: 3-6-9-12-15)
                    // ‡∏à‡∏£‡∏¥‡∏á‡πÜ User ‡∏ö‡∏≠‡∏Å "‡∏≠‡∏≠‡∏ü‡∏£‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ + ‡πÑ‡∏î‡πâ ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ + ‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà 3-6-9-12-15" 
                    // ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏°‡∏µ 4 ‡πÅ‡∏ñ‡∏ß‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏•
                    // ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡πÅ‡∏Ñ‡πà‡πÅ‡∏™‡∏î‡∏á Input 4 ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡πÅ‡∏õ‡∏∞‡∏õ‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö

                    let subOptHtml = `<option value="">- ‡∏ß‡πà‡∏≤‡∏á -</option>` + ALL_STATS.map(s => `<option value="${s}" ${sub.stat===s?'selected':''}>${STAT_DISPLAY[s] || s}</option>`).join('');
                    
                    h += `
                    <div class="grid grid-cols-12 gap-2 items-center">
                        <div class="col-span-1 text-[10px] text-gray-500 font-bold">#${i+1}</div>
                        <div class="col-span-7">
                            <select id="m-sub-stat-${i}" class="bg-[#161b22] border border-gray-600 rounded px-2 py-1 text-white w-full outline-none text-xs h-8">
                                ${subOptHtml}
                            </select>
                        </div>
                        <div class="col-span-4">
                            <input type="number" id="m-sub-val-${i}" value="${sub.val}" class="w-full bg-[#161b22] border border-gray-600 rounded px-2 py-1 text-white text-xs h-8" placeholder="Val">
                        </div>
                    </div>`;
                }
                h += `</div><div class="text-[9px] text-gray-500 mt-2 text-center">* ‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å‡∏ñ‡∏∂‡∏á +3, +6, +9, +12, +15</div></div>`;

                // Helper Function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Dropdown Main Stat ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Type
                // (‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö script ‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö html string ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô global)
                // ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢: ‡πÉ‡∏™‡πà onchange="renderMainStatOptions(this.value)" ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å

                // --- ITEM EDITOR END ---
            }else if(currentView==='hero-manager') {
                // TAB BUTTONS
                h += `<div class="flex border-b border-gray-700 mt-4 mb-4">
                        <button onclick="switchManagerTab('info')" id="mgr-tab-info" class="px-4 py-2 text-sm font-bold text-blue-400 border-b-2 border-blue-500">Info</button>
                        <button onclick="switchManagerTab('stats')" id="mgr-tab-stats" class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-white">Stats</button>
                        <button onclick="switchManagerTab('skills')" id="mgr-tab-skills" class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-white">Skills</button>
                    </div>`;

                // TAB 1: INFO
                let rOpts = RARITY_OPTS.map(o => `<option value="${o}" ${item.rarity===o?'selected':''}>${o}</option>`).join('');
                let tOpts = TYPE_OPTS.map(o => `<option value="${o}" ${item.type===o?'selected':''}>${o}</option>`).join('');
                let sortedAffs = [...affiliationsDB].sort().map(o => `<option value="${o}" ${item.affiliation===o?'selected':''}>${o}</option>`).join('');
                
                h += `<div id="mgr-view-info">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group"><label>‡∏£‡∏∞‡∏î‡∏±‡∏ö</label><select id="m-rarity">${rOpts}</select></div>
                            <div class="input-group"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="m-type">${tOpts}</select></div>
                            <div class="input-group col-span-2"><label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label><select id="m-aff" class="w-full bg-[#0d1117] border border-gray-700 p-2 rounded text-white"><option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>${sortedAffs}</select></div>
                        </div>
                    </div>`;

                // TAB 2: STATS (‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà)
                h += `<div id="mgr-view-stats" class="hidden space-y-4">
                        <div class="bg-[#111827] p-4 rounded border border-gray-700">
                            <div class="text-xs font-bold text-blue-400 mb-2 uppercase">Base Stats (‡∏ó‡∏µ‡πà 6 ‡∏î‡∏≤‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</div>
                            <div class="grid grid-cols-3 gap-3">
                                ${STAT_KEYS.map(k => `<div class="input-group"><label>${STAT_LABELS[k]}</label><input type="number" id="stat-${k}" value="${item.baseStats?.[k] || 0}" class="text-right bg-[#0d1117]"></div>`).join('')}
                            </div>
                        </div>
                        <div class="bg-[#111827] p-4 rounded border border-gray-700">
                            <div class="text-xs font-bold text-red-400 mb-2 uppercase">Growth Config</div>
                            <div class="flex items-center gap-2 mb-4 text-sm">
                                <span class="text-gray-400">‡∏î‡∏≤‡∏ß‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Stat (‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤):</span>
                                <input type="number" id="grow-red" value="${item.growthConfig?.redStarPerLevel || 2}" class="w-16 text-center bg-[#0d1117] border border-gray-600 rounded">
                                <span>% ‡∏ï‡πà‡∏≠ 1 ‡∏î‡∏≤‡∏ß</span>
                            </div>
                            <div class="space-y-2">
                                <span class="text-xs font-bold text-blue-300 block">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏î‡∏≤‡∏ß‡∏ü‡πâ‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏•‡πÄ‡∏ß‡∏• 1,3,4,5):</span>
                                ${[1, 3, 4, 5].map(lvl => {
                                    const conf = item.growthConfig?.[`blue${lvl}`] || {stat: 'atk', percent: 10};
                                    return `<div class="flex items-center gap-2 text-xs">
                                            <span class="w-12 text-gray-400">Lv.${lvl}:</span>
                                            <select id="grow-blue-${lvl}-stat" class="bg-[#0d1117] border border-gray-600 rounded px-2 py-1 text-white flex-1">
                                                ${STAT_KEYS.map(k => `<option value="${k}" ${conf.stat===k?'selected':''}>${STAT_LABELS[k]}</option>`).join('')}
                                            </select>
                                            <span>+</span>
                                            <input type="number" id="grow-blue-${lvl}-val" value="${conf.percent}" class="w-12 bg-[#0d1117] border border-gray-600 rounded text-center">
                                            <span>%</span>
                                        </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>`;

                // TAB 3: SKILLS
                h += `<div id="mgr-view-skills" class="hidden">
                    ${renderSkillInputs(item)}
                </div>`;
            } else if (currentView === 'pet-manager') {
                // Pet Manager Form
                let rOpts = PET_RARITY_OPTS.map(o => `<option value="${o}" ${item.rarity===o?'selected':''}>${o}</option>`).join('');
                let itemTypes = Array.isArray(item.type) ? item.type : [item.type];
                let typeChecks = PET_TYPE_OPTS.map(t => `<label class="flex items-center gap-2 text-xs text-gray-300"><input type="checkbox" class="pet-type-check" value="${t}" ${itemTypes.includes(t)?'checked':''}> ${t}</label>`).join('');
                
                h += `<div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="input-group"><label>‡∏£‡∏∞‡∏î‡∏±‡∏ö</label><select id="m-rarity">${rOpts}</select></div>
                    <div class="input-group"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><div class="flex flex-col gap-1 mt-1">${typeChecks}</div></div>
                    <div class="col-span-2 input-group"><label>‡∏™‡∏Å‡∏¥‡∏•</label><textarea id="m-skill" class="h-24">${item.skill || ''}</textarea></div>
                </div>`;
            } else if (currentView === 'ring-manager') {
                // Ring Manager Form
                h += `<div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="input-group"><label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏≤‡∏ß (4-6)</label><input type="number" id="m-grade" value="${item.grade || 4}" min="4" max="6"></div>
                    <div class="col-span-2 input-group"><label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label><textarea id="m-desc" class="h-24">${item.desc || ''}</textarea></div>
                </div>`;
            }
            
            h += `<div class="sticky bottom-0 z-10 bg-[#161b22] flex gap-2 mt-6 py-4 border-t border-gray-700">
                    <button onclick="saveItem()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)</button>
                    <button onclick="deleteItem()" class="px-6 bg-red-900/50 hover:bg-red-800 text-red-400 border border-red-800 rounded-lg font-bold">‡∏•‡∏ö</button>
                </div></div>`;

            document.getElementById('manager-form').innerHTML = h;
            document.getElementById('manager-form').parentElement.scrollTop = 0;
            renderManagerUI(); // Refresh list active state
        }

        function switchManagerTab(tab) {
            ['info', 'stats', 'skills'].forEach(t => {
                const btn = document.getElementById(`mgr-tab-${t}`);
                const view = document.getElementById(`mgr-view-${t}`);
                if(t === tab) {
                    btn.className = "px-4 py-2 text-sm font-bold text-blue-400 border-b-2 border-blue-500 transition";
                    view.classList.remove('hidden');
                } else {
                    btn.className = "px-4 py-2 text-sm font-bold text-gray-500 hover:text-white transition";
                    view.classList.add('hidden');
                }
            });
        }

        async function addAffiliation() {
            let name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà:");
            if (!name || name.trim() === "") return;
            name = name.trim();
            if (affiliationsDB.includes(name)) { alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ: ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î "${name}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`); return; }
            affiliationsDB.push(name); showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î..."); await pushData(); hideLoading(); editManagerItem(editingItemId); 
        }
        async function deleteAffiliation() {
            const val = document.getElementById('m-aff').value;
            if(val && confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î "${val}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) { affiliationsDB = affiliationsDB.filter(a => a !== val); showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î..."); await pushData(); hideLoading(); editManagerItem(editingItemId); }
        }
        async function saveItem() {
            let db = currentView === 'hero-manager' ? heroesDB : currentView === 'pet-manager' ? petsDB : currentView === 'item-manager' ? itemsDB : ringsDB;
            let item = db.find(x => x.id == editingItemId);
            if (!item) return;

            item.name=document.getElementById('m-name').value; 
            item.img=document.getElementById('m-img').value;
            
            if (currentView === 'item-manager') {
                // Save Item
                item.level = parseInt(document.getElementById('m-level').value);
                item.type = document.getElementById('m-type').value;
                item.set = document.getElementById('m-set').value;
                
                // Save Main Stat
                item.mainStat = {
                    stat: document.getElementById('m-main-stat').value,
                    val: parseFloat(document.getElementById('m-main-val').value) || 0
                };

                // Save Sub Stats (4 Slots)
                item.subStats = [];
                for(let i=0; i<4; i++) {
                    const s = document.getElementById(`m-sub-stat-${i}`).value;
                    const v = parseFloat(document.getElementById(`m-sub-val-${i}`).value) || 0;
                    if(s) item.subStats.push({ stat: s, val: v });
                    else item.subStats.push({ stat: '', val: 0 }); // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
                }

            } else if(currentView==='hero-manager') { 
                item.rarity = document.getElementById('m-rarity').value; 
                item.type = document.getElementById('m-type').value; 
                item.affiliation = document.getElementById('m-aff').value;
                
                // --- SAVE STATS LOGIC ---
                item.baseStats = {};
                STAT_KEYS.forEach(k => {
                    item.baseStats[k] = parseFloat(document.getElementById(`stat-${k}`).value) || 0;
                });

                // --- SAVE GROWTH CONFIG ---
                item.growthConfig = {
                    redStarPerLevel: parseFloat(document.getElementById('grow-red').value) || 0
                };
                [1, 3, 4, 5].forEach(lvl => {
                    item.growthConfig[`blue${lvl}`] = {
                        stat: document.getElementById(`grow-blue-${lvl}-stat`).value,
                        percent: parseFloat(document.getElementById(`grow-blue-${lvl}-val`).value) || 0
                    };
                });

                // SAVE SKILL DATA
                let newSkillData = {};
                ['n', 'p', 's1', 's2'].forEach(k => {
                    let baseConf = {
                        scale: document.getElementById(`conf-${k}-scale`)?.value || 'atk',
                        percent: parseFloat(document.getElementById(`conf-${k}-per`)?.value) || 0,
                        greenPercent: parseFloat(document.getElementById(`conf-${k}-green-per`)?.value) || 0,
                        // c2Percent: parseFloat(document.getElementById(`conf-${k}-c2-per`)?.value) || 0,
                        // c6Percent: parseFloat(document.getElementById(`conf-${k}-c6-per`)?.value) || 0,
                        targets: parseInt(document.getElementById(`conf-${k}-tar`)?.value) || 1,
                        hits: parseInt(document.getElementById(`conf-${k}-hit`)?.value) || 1,
                        effects: []
                    };

                    const effContainer = document.getElementById(`eff-list-${k}`);
                    if(effContainer) {
                        const effDivs = effContainer.querySelectorAll('.effect-item');
                        effDivs.forEach(div => {
                            baseConf.effects.push({
                                type: div.querySelector('.eff-type').value,
                                name: div.querySelector('.eff-name').value,
                                stack: div.querySelector('.eff-stack').checked,
                                note: div.querySelector('.eff-note').value,
                                cond: div.querySelector('.eff-cond').value, 
                                cap: div.querySelector('.eff-cap').value,
                                rate: parseFloat(div.querySelector('.eff-rate').value) || 0,
                                turn: parseInt(div.querySelector('.eff-turn').value) || 0,
                                val: parseFloat(div.querySelector('.eff-val').value) || 0,
                                green_rate: parseFloat(div.querySelector('.eff-green_rate').value) || 0,
                                green_turn: parseInt(div.querySelector('.eff-green_turn').value) || 0,
                                green_val: parseFloat(div.querySelector('.eff-green_val').value) || 0,
                                c2_rate: parseFloat(div.querySelector('.eff-c2_rate').value) || 0,
                                c2_turn: parseInt(div.querySelector('.eff-c2_turn').value) || 0,
                                c2_val: parseFloat(div.querySelector('.eff-c2_val').value) || 0,
                                c6_rate: parseFloat(div.querySelector('.eff-c6_rate').value) || 0,
                                c6_turn: parseInt(div.querySelector('.eff-c6_turn').value) || 0,
                                c6_val: parseFloat(div.querySelector('.eff-c6_val').value) || 0,
                            });
                        });
                    }
                    newSkillData[k] = baseConf;
                });
                item.skillData = newSkillData;

                // --- SAVE SKILLS LOGIC ---
                const buildSkill = (id) => {
                    let base = document.getElementById(id+'-base').value;
                    let green = document.getElementById(id+'-green').value;
                    let c2 = document.getElementById(id+'-c2').value;
                    let c6 = document.getElementById(id+'-c6').value;
                    let html = base;
                    if(green) html += `<div class="sb-green"><div class="sb-head">‚¨ÜÔ∏è ‡∏ú‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏Å‡∏¥‡∏•</div><div class="sb-content">${green}</div></div>`;
                    if(c2) html += `<div class="sb-purple"><div class="sb-head">‚≠ê ‡∏ú‡∏•‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 2</div><div class="sb-content">${c2}</div></div>`;
                    if(c6) html += `<div class="sb-purple"><div class="sb-head">‚≠ê ‡∏ú‡∏•‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 6</div><div class="sb-content">${c6}</div></div>`;
                    return html;
                };
                item.skills={ n: buildSkill('m-n'), p: buildSkill('m-p'), s1: buildSkill('m-s1'), s2: buildSkill('m-s2') }; 
            } else if (currentView === 'pet-manager') {
                item.rarity = document.getElementById('m-rarity').value;
                let types = [];
                document.querySelectorAll('.pet-type-check:checked').forEach(c => types.push(c.value));
                item.type = types;
                item.skill = document.getElementById('m-skill').value;
            } else if (currentView === 'ring-manager') {
                item.grade = parseInt(document.getElementById('m-grade').value);
                item.desc = document.getElementById('m-desc').value;
            }

            logAudit('EDIT_DB', `Item: ${item.name}`, `In category: ${currentView}`);
            
            // [‡∏ä‡πà‡∏ß‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô]
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."); // Start
            await pushData(); 
            hideLoading(); // Stop
            
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); 
            renderManagerUI();
        }
        async function deleteItem() { 
            if(confirm('Delete?')){ 
                if(currentView==='hero-manager') heroesDB=heroesDB.filter(x=>x.id!=editingItemId); 
                else if(currentView==='pet-manager') petsDB=petsDB.filter(x=>x.id!=editingItemId); 
                else ringsDB=ringsDB.filter(x=>x.id!=editingItemId); 
                editingItemId=null; 
                showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."); // Start
                logAudit('DEL_DB', `Item ID: ${editingItemId}`, `From category: ${currentView}`);
                await pushData(); 
                hideLoading(); // Stop
                
                renderManagerUI();
            } 
        }
        async function addNewItemInit() { 
            let id = Date.now().toString(); 
            
            if(currentView === 'hero-manager') {
                heroesDB.push({id, name:'New Hero', img:'', rarity:'‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', type:'‡∏™‡∏°‡∏î‡∏∏‡∏•', affiliation: affiliationsDB[0]||'', skills:{n:'',p:'',s1:'',s2:''}}); 
            } 
            else if(currentView === 'pet-manager') {
                petsDB.push({id, name:'New Pet', img:'', rarity:'‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', type:['‡∏ö‡∏±‡∏û‡πÇ‡∏à‡∏°‡∏ï‡∏µ'], skill:''}); 
            } 
            else if(currentView === 'ring-manager') {
                ringsDB.push({id, name:'New Ring', img:'', grade:4, desc:'', options:[]}); 
            }else if(currentView === 'item-manager') { // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ
                itemsDB.push({
                    id, 
                    name: 'New Item', 
                    type: 'front', // default ‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    set: 'Set Name', 
                    img: '', 
                    level: 0, // +0 ‡∏ñ‡∏∂‡∏á +15
                    mainStat: { stat: 'atk', val: 0 },
                    subStats: [ // 4 ‡∏ä‡πà‡∏≠‡∏á ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                        { stat: '', val: 0 }, { stat: '', val: 0 }, { stat: '', val: 0 }, { stat: '', val: 0 }
                    ]
                });
            }
            
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà..."); 
            await pushData(); 
            hideLoading(); 
            editManagerItem(id);
        }
        
        function renderSkillInputs(item) {
            const skills = item.skills || { n:'', p:'', s1:'', s2:'' };
            const defConf = { percent: 100, scale: 'atk', targets: 1, hits: 1, effects: [] };
            const config = item.skillData || { n: { ...defConf }, p: { ...defConf, targets: 0 }, s1: { ...defConf }, s2: { ...defConf } };

            const parseSkill = (html) => {
                let base = html || "", green = "", c2 = "", c6 = "";
                const greenMatch = html?.match(/<div class="sb-green">.*?<div class="sb-content">(.*?)<\/div><\/div>/s);
                const purpleMatches = [...(html?.matchAll(/<div class="sb-purple"><div class="sb-head">(.*?)<\/div><div class="sb-content">(.*?)<\/div><\/div>/gs) || [])];
                if(greenMatch) { green = greenMatch[1].trim(); base = base.replace(greenMatch[0], ""); }
                purpleMatches.forEach(m => { if(m[1].includes("2")) c2 = m[2].trim(); else if(m[1].includes("6")) c6 = m[2].trim(); else if(!c2) c2 = m[2].trim(); base = base.replace(m[0], ""); });
                return { base: base.replace(/<br>$/, "").trim(), green, c2, c6 };
            };

            const n = parseSkill(skills.n); const p = parseSkill(skills.p);
            const s1 = parseSkill(skills.s1); const s2 = parseSkill(skills.s2);

            // --- Helper: Row ---
            window.renderEffectRow = (label, color, pfx, eff) => `
                <div class="grid grid-cols-4 gap-2 items-center mb-1 text-xs">
                    <div class="${color} font-bold text-right pr-2">${label}</div>
                    <input type="number" class="eff-${pfx}rate bg-[#111827] border border-gray-600 text-center text-white rounded py-1 focus:border-blue-500 outline-none" value="${eff?.[pfx+'rate'] ?? (eff?.rate||100)}" placeholder="%">
                    <input type="number" class="eff-${pfx}turn bg-[#111827] border border-gray-600 text-center text-white rounded py-1 focus:border-blue-500 outline-none" value="${eff?.[pfx+'turn'] ?? (eff?.turn||2)}" placeholder="Turn">
                    <input type="number" class="eff-${pfx}val bg-[#111827] border border-gray-600 text-center text-white rounded py-1 focus:border-blue-500 outline-none" value="${eff?.[pfx+'val'] ?? (eff?.val||0)}" placeholder="Val">
                </div>
            `;

            // --- Effect List (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á Condition & Cap) ---
            const renderEffectsList = (key, effects) => {
                if (!effects) effects = [];
                let html = `<div id="eff-list-${key}" class="space-y-4 mt-4">`;
                
                effects.forEach((eff) => {
                    html += `
                    <div class="bg-[#2d3748] p-3 rounded-lg border border-gray-600 relative group text-sm animate-fade-in effect-item shadow-lg">
                        <div class="absolute -top-2 -right-2 cursor-pointer text-white bg-red-600 hover:bg-red-500 font-bold rounded-full w-6 h-6 flex items-center justify-center shadow-md border border-red-400 z-10" onclick="this.parentElement.remove()">√ó</div>
                        
                        <div class="flex gap-2 mb-2">
                            <select class="eff-type bg-[#1a202c] border border-gray-500 rounded text-blue-300 w-32 py-1 px-2 font-bold outline-none">
                                <option value="special" ${eff.type==='special'?'selected':''}>‚ú® Special</option>
                                <option value="dot" ${eff.type==='dot'?'selected':''}>üî• DoT</option>
                                <option value="cc" ${eff.type==='cc'?'selected':''}>‚ùÑÔ∏è CC</option>
                                <option value="stat" ${eff.type==='stat'?'selected':''}>üìä Stat</option>
                                <option value="dmg" ${eff.type==='dmg'?'selected':''}>‚öîÔ∏è Extra Dmg</option>
                            </select>
                            <input type="text" class="eff-name bg-transparent border-b border-gray-500 w-full text-white font-bold px-2 outline-none" value="${eff.name || ''}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏µ‡∏Ç‡∏ô‡∏≤‡∏ö)">
                        </div>

                        <div class="bg-[#1a202c] p-2 rounded border border-gray-700 mb-2">
                            <div class="grid grid-cols-4 gap-2 text-[10px] text-gray-400 text-center mb-1 uppercase font-bold">
                                <div>Level</div><div>Chance %</div><div>Turn/Hit</div><div>Value</div>
                            </div>
                            ${renderEffectRow('Base', 'text-gray-300', '', eff)}
                            ${renderEffectRow('Up', 'text-green-400', 'green_', eff)}
                            ${renderEffectRow('LB 2', 'text-purple-400', 'c2_', eff)}
                            ${renderEffectRow('LB 6', 'text-purple-400', 'c6_', eff)}
                        </div>

                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div class="bg-[#1a202c] px-2 py-1 rounded border border-gray-700">
                                <span class="text-[9px] text-yellow-500 font-bold uppercase block">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (Condition)</span>
                                <input type="text" class="eff-cond bg-transparent w-full text-xs text-white outline-none" value="${eff.cond||''}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏¢, ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏µ‡∏Ç‡∏ô‡∏≤‡∏ö">
                            </div>
                            <div class="bg-[#1a202c] px-2 py-1 rounded border border-gray-700">
                                <span class="text-[9px] text-red-400 font-bold uppercase block">‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î (Cap/Limit)</span>
                                <input type="text" class="eff-cap bg-transparent w-full text-xs text-white outline-none" value="${eff.cap||''}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 300% ATK">
                            </div>
                        </div>

                        <div class="flex gap-2 items-center">
                            <label class="flex items-center gap-1 text-[10px] text-gray-300 bg-[#1a202c] px-2 py-1 rounded border border-gray-600"><input type="checkbox" class="eff-stack" ${eff.stack?'checked':''}> Stack</label>
                            <input type="text" class="eff-note bg-[#1a202c] border border-gray-600 rounded px-2 py-1 w-full text-[10px] text-gray-300 outline-none" value="${eff.note||''}" placeholder="Note...">
                        </div>
                    </div>`;
                });
                
                html += `</div><button onclick="addEffect('${key}')" class="mt-3 w-full py-2 border-2 border-dashed border-gray-600 text-gray-400 text-xs font-bold hover:text-white hover:border-blue-500 rounded transition">+ Add Effect / Status</button>`;
                return html;
            };

            // Config Box (Direct Damage)
            const renderConfigBox = (key, conf) => `
                <div class="flex flex-wrap gap-2 mb-3 mt-2 items-center bg-[#1f2937] p-3 rounded-lg border border-gray-600 shadow-sm">
                    <span class="text-xs text-yellow-500 font-bold uppercase mr-2">‚ö° Base Hit:</span>
                    <div class="flex gap-1">
                        <div class="bg-[#111827] rounded border border-gray-600 flex items-center px-1"><span class="text-[9px] text-gray-400 mr-1">Base</span><input type="number" id="conf-${key}-per" value="${conf?.percent || 0}" class="w-10 bg-transparent text-center text-sm text-white font-mono py-1 outline-none"></div>
                        <div class="bg-[#111827] rounded border border-green-800 flex items-center px-1"><span class="text-[9px] text-green-400 mr-1">Up</span><input type="number" id="conf-${key}-green-per" value="${conf?.greenPercent || 0}" class="w-10 bg-transparent text-center text-sm text-green-300 font-mono font-bold py-1 outline-none"></div>
                    </div>
                    <div class="w-px h-6 bg-gray-600 mx-1"></div>
                    <select id="conf-${key}-scale" class="bg-[#111827] border border-gray-600 text-xs text-white rounded py-1 px-1 outline-none"><option value="atk" ${conf?.scale==='atk'?'selected':''}>ATK</option><option value="def" ${conf?.scale==='def'?'selected':''}>DEF</option><option value="hp" ${conf?.scale==='hp'?'selected':''}>HP</option></select>
                    <div class="bg-[#111827] rounded border border-gray-600 px-1 flex items-center"><input type="number" id="conf-${key}-tar" value="${conf?.targets || 1}" class="w-6 bg-transparent text-center text-sm text-white font-bold outline-none"><span class="text-[9px] text-gray-400 ml-1">Targets</span></div>
                    <div class="bg-[#111827] rounded border border-gray-600 px-1 flex items-center"><input type="number" id="conf-${key}-hit" value="${conf?.hits || 1}" class="w-6 bg-transparent text-center text-sm text-white font-bold outline-none"><span class="text-[9px] text-gray-400 ml-1">Hits</span></div>
                </div>
            `;

            const renderTextBox = (label, id, val) => {
                const key = id.replace('m-', '');
                return `
                <div class="skill-input-container mb-8 border border-gray-700 rounded-xl overflow-hidden shadow-md">
                    <div class="si-header bg-gray-800 p-3 text-sm font-bold text-gray-200 border-b border-gray-700 flex justify-between items-center">
                        <span class="flex items-center gap-2"><span class="w-2 h-4 bg-blue-500 rounded-sm"></span>${label}</span>
                        <span class="text-[10px] text-gray-500 bg-black/30 px-2 py-1 rounded">Right Click for Color</span>
                    </div>
                    <div class="p-4 bg-[#111827]">
                        <textarea id="${id}-base" oncontextmenu="openTextContextMenu(event, this)" class="builder-textarea w-full h-20 bg-[#0d1117] border border-gray-600 rounded-md p-3 text-sm text-white mb-3 focus:border-blue-500 transition" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢...">${val.base}</textarea>
                        ${renderConfigBox(key, config[key])}
                        ${renderEffectsList(key, config[key]?.effects)}
                        <div class="mt-6 pt-4 border-t border-gray-700"><div class="text-xs text-green-400 font-bold mb-1 uppercase">‚¨ÜÔ∏è ‡∏ú‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î</div><textarea id="${id}-green" oncontextmenu="openTextContextMenu(event, this)" class="builder-textarea w-full h-16 bg-green-900/10 border border-green-800/50 rounded-md p-2 text-sm text-green-100 placeholder-green-800/50">${val.green}</textarea></div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div><div class="text-xs text-purple-400 font-bold mb-1 uppercase">‚≠ê LB 2</div><textarea id="${id}-c2" oncontextmenu="openTextContextMenu(event, this)" class="builder-textarea w-full h-16 bg-purple-900/10 border border-purple-800/50 rounded-md p-2 text-sm text-purple-100 placeholder-purple-800/50">${val.c2}</textarea></div>
                            <div><div class="text-xs text-purple-400 font-bold mb-1 uppercase">‚≠ê LB 6</div><textarea id="${id}-c6" oncontextmenu="openTextContextMenu(event, this)" class="builder-textarea w-full h-16 bg-purple-900/10 border border-purple-800/50 rounded-md p-2 text-sm text-purple-100 placeholder-purple-800/50">${val.c6}</textarea></div>
                        </div>
                    </div>
                </div>`;
            };

            return `<div class="grid gap-6">${renderTextBox("Normal", "m-n", n)}${renderTextBox("Passive", "m-p", p)}${renderTextBox("Skill 1", "m-s1", s1)}${renderTextBox("Skill 2", "m-s2", s2)}</div>`;
        }

        window.addEffect = function(key) {
            const container = document.getElementById(`eff-list-${key}`);
            const newHtml = `
                <div class="bg-[#2d3748] p-3 rounded-lg border border-gray-600 relative group text-sm animate-fade-in effect-item shadow-lg">
                    <div class="absolute -top-2 -right-2 cursor-pointer text-white bg-red-600 hover:bg-red-500 font-bold rounded-full w-6 h-6 flex items-center justify-center shadow-md border border-red-400 z-10" onclick="this.parentElement.remove()">√ó</div>
                    
                    <div class="flex gap-2 mb-2">
                        <select class="eff-type bg-[#1a202c] border border-gray-500 rounded text-blue-300 w-32 py-1 px-2 font-bold outline-none">
                            <option value="special">‚ú® Special</option>
                            <option value="dot">üî• DoT</option>
                            <option value="cc">‚ùÑÔ∏è CC</option>
                            <option value="stat">üìä Stat</option>
                            <option value="dmg">‚öîÔ∏è Extra Dmg</option>
                        </select>
                        <input type="text" class="eff-name bg-transparent border-b border-gray-500 w-full text-white font-bold px-2 outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞">
                    </div>

                    <div class="bg-[#1a202c] p-2 rounded border border-gray-700 mb-2">
                        <div class="grid grid-cols-4 gap-2 text-[10px] text-gray-400 text-center mb-1 uppercase font-bold">
                            <div>Level</div><div>Chance %</div><div>Turn/Hit</div><div>Value</div>
                        </div>
                        ${renderEffectRow('Base', 'text-gray-300', '', null)}
                        ${renderEffectRow('Up', 'text-green-400', 'green_', null)}
                        ${renderEffectRow('LB 2', 'text-purple-400', 'c2_', null)}
                        ${renderEffectRow('LB 6', 'text-purple-400', 'c6_', null)}
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="bg-[#1a202c] px-2 py-1 rounded border border-gray-700">
                            <span class="text-[9px] text-yellow-500 font-bold uppercase block">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (Condition)</span>
                            <input type="text" class="eff-cond bg-transparent w-full text-xs text-white outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏¢, ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏µ‡∏Ç‡∏ô‡∏≤‡∏ö">
                        </div>
                        <div class="bg-[#1a202c] px-2 py-1 rounded border border-gray-700">
                            <span class="text-[9px] text-red-400 font-bold uppercase block">‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î (Cap/Limit)</span>
                            <input type="text" class="eff-cap bg-transparent w-full text-xs text-white outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 300% ATK">
                        </div>
                    </div>

                    <div class="flex gap-2 items-center">
                        <label class="flex items-center gap-1 text-[10px] text-gray-300 bg-[#1a202c] px-2 py-1 rounded border border-gray-600"><input type="checkbox" class="eff-stack"> Stack</label>
                        <input type="text" class="eff-note bg-[#1a202c] border border-gray-600 rounded px-2 py-1 w-full text-[10px] text-gray-300 outline-none" placeholder="Note...">
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newHtml);
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Stat (Auto-include Passive Stats) ---
        function calculateAndRenderStats() {
            if(!currentDetailHero || !currentDetailHero.baseStats) {
                document.getElementById('dt-stat-grid').innerHTML = '<div class="text-gray-500 text-sm col-span-2 text-center py-4">No base stats configured.</div>';
                document.getElementById('dt-stat-cp').innerText = '0';
                return;
            }

            const blueLvl = currentDetailBlueStars;
            const activeRedStars = currentDetailRedStars;

            // 1. ‡πÅ‡∏™‡∏î‡∏á Status ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
            let statusText = `${blueLvl} Blue Stars`;
            if(activeRedStars > 0) statusText = `${activeRedStars} Red Stars (Max Blue)`;
            document.getElementById('dt-stat-desc').innerText = statusText;

            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Base + Red Stars
            const redGrowthRate = (currentDetailHero.growthConfig?.redStarPerLevel || 2) / 100; 
            const redMultiplier = 1 + (activeRedStars * redGrowthRate);
            let finalStats = {};

            STAT_KEYS.forEach(k => {
                let base = currentDetailHero.baseStats[k] || 0;
                if(['hp', 'atk', 'def'].includes(k)) { finalStats[k] = base * redMultiplier; } 
                else { finalStats[k] = base; }
            });

            const percentStats = ['critRate', 'critDmg', 'block', 'dmgRed', 'acc', 'resist', 'weakness'];

            // 3. ‡∏ö‡∏ß‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ "Growth" (Blue Star Milestones) - Logic ‡πÄ‡∏î‡∏¥‡∏°
            [1, 3, 4, 5].forEach(lvl => {
                if(blueLvl >= lvl) {
                    const conf = currentDetailHero.growthConfig?.[`blue${lvl}`];
                    if(conf && conf.stat && STAT_KEYS.includes(conf.stat)) {
                        const val = parseFloat(conf.percent) || 0;
                        if (percentStats.includes(conf.stat)) { 
                            finalStats[conf.stat] = (finalStats[conf.stat] || 0) + val; 
                        } else {
                            // Stat ‡∏´‡∏•‡∏±‡∏Å (HP/ATK/DEF) ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô % ‡∏à‡∏≤‡∏Å Base
                            const boostAmount = (currentDetailHero.baseStats[conf.stat] || 0) * (val / 100);
                            finalStats[conf.stat] = (finalStats[conf.stat] || 0) + boostAmount;
                        }
                    }
                }
            });

            // 4. [NEW] ‡∏ö‡∏ß‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å "Passive Skill" (Auto-Detect)
            if (currentDetailHero.skillData && currentDetailHero.skillData.p && currentDetailHero.skillData.p.effects) {
                currentDetailHero.skillData.p.effects.forEach(eff => {
                    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Type = Stat
                    if (eff.type === 'stat') {
                        // 4.1 ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏≤‡∏ß (Base/Green/C2/C6)
                        let actVal = eff.val || 0;
                        if (blueLvl >= 6 && eff.c6_val) actVal = eff.c6_val;
                        else if (blueLvl >= 2 && eff.c2_val) actVal = eff.c2_val;
                        else if (blueLvl >= 1 && eff.green_val) actVal = eff.green_val;

                        if (actVal > 0) {
                            // 4.2 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ (Name) ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Map ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö Stat Key
                            const name = eff.name.toLowerCase();
                            let targetKey = null;

                            // Keyword Mapping (‡πÑ‡∏ó‡∏¢/Eng)
                            if (name.includes('hp') || name.includes('‡πÄ‡∏•‡∏∑‡∏≠‡∏î')) targetKey = 'hp';
                            else if (name.includes('atk') || name.includes('‡πÇ‡∏à‡∏°‡∏ï‡∏µ')) targetKey = 'atk';
                            else if (name.includes('def') || name.includes('‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô')) targetKey = 'def';
                            else if (name.includes('spd') || name.includes('speed') || name.includes('‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß')) targetKey = 'spd';
                            else if (name.includes('block') || name.includes('‡∏ö‡∏•‡πá‡∏≠‡∏Å')) targetKey = 'block';
                            else if (name.includes('crit') || name.includes('‡∏Ñ‡∏£‡∏¥')) targetKey = 'critRate'; // Crit Rate
                            else if (name.includes('dmg') && (name.includes('crit') || name.includes('‡∏Ñ‡∏£‡∏¥'))) targetKey = 'critDmg'; // Crit Dmg (‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á Dmg ‡πÅ‡∏•‡∏∞ Crit)
                            else if (name.includes('weak') || name.includes('‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô')) targetKey = 'weakness';
                            else if (name.includes('acc') || name.includes('‡πÅ‡∏°‡πà‡∏ô')) targetKey = 'acc';
                            else if (name.includes('resist') || name.includes('‡∏ï‡πâ‡∏≤‡∏ô')) targetKey = 'resist';

                            // 4.3 ‡∏ö‡∏ß‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                            if (targetKey) {
                                if (percentStats.includes(targetKey)) {
                                    // ‡∏û‡∏ß‡∏Å Rate ‡∏ö‡∏ß‡∏Å‡∏ï‡∏£‡∏á‡πÜ (‡πÄ‡∏ä‡πà‡∏ô Block +20)
                                    finalStats[targetKey] = (finalStats[targetKey] || 0) + actVal;
                                } else {
                                    // ‡∏û‡∏ß‡∏Å Base Stat ‡∏ö‡∏ß‡∏Å‡πÄ‡∏õ‡πá‡∏ô % (‡πÄ‡∏ä‡πà‡∏ô HP +10%)
                                    const boostAmount = (currentDetailHero.baseStats[targetKey] || 0) * (actVal / 100);
                                    finalStats[targetKey] = (finalStats[targetKey] || 0) + boostAmount;
                                }
                            }
                        }
                    }
                });
            }

            // 5. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Grid
            const grid = document.getElementById('dt-stat-grid');
            grid.innerHTML = STAT_KEYS.map(k => {
                let val = Math.floor(finalStats[k]);
                let suffix = '';
                if(percentStats.includes(k)) { suffix = '%'; } else { val = val.toLocaleString(); }

                let isBoosted = false;
                // ‡πÄ‡∏ä‡πá‡∏Ñ Growth
                [1, 3, 4, 5].forEach(lvl => { if(blueLvl >= lvl && currentDetailHero.growthConfig?.[`blue${lvl}`]?.stat === k) isBoosted = true; });
                
                let isRedBoosted = (activeRedStars > 0 && ['hp', 'atk', 'def'].includes(k));

                let labelClass = "text-gray-500"; let valClass = "text-white";
                if (isBoosted) { labelClass = "text-green-400 font-bold"; valClass = "text-green-300 font-bold"; }
                if (isRedBoosted) { valClass = "text-red-300 font-bold"; }
                
                return `<div class="flex justify-between border-b border-gray-800 pb-1 items-center"><span class="${labelClass} text-xs uppercase tracking-wide">${STAT_LABELS[k]} ${isBoosted ? '‚¨ÜÔ∏è' : ''}</span><span class="${valClass} font-mono text-sm">${val}${suffix}</span></div>`;
            }).join('');

            if (activeRedStars > 0) {
                grid.insertAdjacentHTML('beforeend', `<div class="col-span-2 text-center text-[10px] text-red-400 mt-2 bg-red-900/20 p-1 rounded border border-red-900/50">üî• Red Bonus (Lv.${activeRedStars}) : HP/ATK/DEF +${(activeRedStars * (currentDetailHero.growthConfig?.redStarPerLevel||2))}%</div>`);
            }

            const cp = (finalStats.atk) + (finalStats.def * 0.8) + (finalStats.hp * 0.2) + (finalStats.spd * 10);
            document.getElementById('dt-stat-cp').innerText = Math.floor(cp).toLocaleString();
        }
    
        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ó‡∏£‡∏Å Keyword/Icon (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏™‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢) ---
        function insertKeyword(type) {
            if(!activeTextarea) return;

            let html = "";
            if (type === 'ally') { html = `üõ°Ô∏è`; } 
            else if (type === 'enemy') { html = `‚öîÔ∏è`; } 
            else if (type === 'self') { html = `üë§`; }

            const start = activeTextarea.selectionStart;
            const end = activeTextarea.selectionEnd;
            const text = activeTextarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end, text.length);

            activeTextarea.value = before + html + after;
            activeTextarea.selectionStart = activeTextarea.selectionEnd = start + html.length;
            closeTextContextMenu();
            activeTextarea.dispatchEvent(new Event('change'));
        }
        
        function setTextBackground() {
            if(!activeFloatingText) return;
            
            const url = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image URL):\n(‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô / Banner)");
            if(url) {
                activeFloatingText.style.backgroundImage = `url('${url}')`;
                // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏£‡∏π‡∏õ
                activeFloatingText.style.backgroundColor = 'transparent';
                activeFloatingText.style.border = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
                activeFloatingText.style.color = '#ffffff'; 
                
                // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÑ‡∏õ
                if(activeFloatingText.offsetWidth < 120) {
                    activeFloatingText.style.minWidth = '150px';
                    activeFloatingText.style.minHeight = '60px';
                    activeFloatingText.style.display = 'flex';
                    activeFloatingText.style.alignItems = 'center';
                    activeFloatingText.style.justifyContent = 'center';
                }
            }
            closeTierTextMenu();
        }

        function clearTextBackground() {
            if(!activeFloatingText) return;
            activeFloatingText.style.backgroundImage = '';
            activeFloatingText.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            activeFloatingText.style.border = '1px dashed #fbbf24';
            activeFloatingText.style.color = '#fbbf24';
            activeFloatingText.style.minWidth = '50px';
            activeFloatingText.style.minHeight = 'auto';
            closeTierTextMenu();
        }

        function deleteFloatingText() {
            if(activeFloatingText) {
                activeFloatingText.remove(); // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                autoSaveTierList();          // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö
            }
            closeCtxMenus();
        }

        function closeTierTextMenu() {
            document.getElementById('tier-text-menu').classList.add('hidden');
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°
        function getFullCastleName(shortName) {
            if (!shortName) return '-';
            const parts = shortName.split(' ');
            const type = parts[0];
            const num = parts[1] || '';
            
            if (type === '‡∏ô‡∏≠‡∏Å') return `‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å ${num}`;
            if (type === '‡πÉ‡∏ô') return `‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡πÉ‡∏ô ${num}`;
            if (type === '‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå') return `‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡∏´‡∏•‡∏±‡∏Å (‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå)`;
            return shortName;
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Badge ‡∏î‡∏≤‡∏ß‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Log)
        function getStarBadge(star) {
            if (!star) return '';
            let color = 'bg-yellow-500 text-black'; // 1-6 ‡∏î‡∏≤‡∏ß
            let text = star;
            
            if (star > 6) {
                const redStar = star - 6;
                color = 'bg-red-600 text-white'; // ‡∏î‡∏≤‡∏ß‡πÅ‡∏î‡∏á
                text = `R${redStar}`; // R1, R2...
            }
            // ‡∏î‡∏≤‡∏ß‡∏ü‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
            // if (star ‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≤‡∏ß‡∏ü‡πâ‡∏≤) ... 

            return `<span class="absolute -bottom-1 -right-1 ${color} text-[8px] font-bold px-1 rounded-sm leading-tight z-10 border border-black/50">${text}</span>`;
        }

        // --- GUILD WAR MANAGEMENT ---
        function updateGuildWarUI() {
            const badge = document.getElementById('gw-season-badge');
            const oppName = document.getElementById('gw-opponent-name');
            if(badge) badge.innerText = `Season ${currentSeason.id}`;
            if(oppName) oppName.innerText = currentSeason.opponent;
        }

        async function endGuildWarRound() {

            const canManage = CURRENT_USER.role === 'admin';
            if (!canManage) return alert("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏ö Season");

            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ '‡∏à‡∏ö Season' ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n\n- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Archive\n- ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß (Lobby)")) return;

            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏£‡∏≠‡∏ö...");

            // 1. ‡πÄ‡∏Å‡πá‡∏ö Log ‡πÄ‡∏Ç‡πâ‡∏≤ Archive
            const archiveData = {
                seasonId: currentSeason.id,
                opponent: currentSeason.opponent,
                date: (currentSeason.startDate || 'Unknown') + " - " + new Date().toLocaleDateString('th-TH'),
                logs: [...battleHistoryDB]
            };
            archivedSeasons.unshift(archiveData);

            // 2. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            currentSeason.id++;          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏Ç Season ‡∏£‡∏≠‡πÑ‡∏ß‡πâ
            currentSeason.opponent = '-';
            currentSeason.status = 'waiting'; // *** ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Waiting ***
            
            battleHistoryDB = []; // ‡∏•‡πâ‡∏≤‡∏á Log
            logsDB = [];
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô
            Object.keys(teamsDB).forEach(key => {
                teamsDB[key] = { player: '', speed: '', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skills: [], isCleared: false };
            });

            // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            checkWarRoomStatus(); // ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
            if(currentView === 'logs') renderLogs();

            await pushData();
            hideLoading();
        }
        function viewArchives() {
            const list = document.getElementById('arc-season-list');
            list.innerHTML = '';
            
            if(archivedSeasons.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-center text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤</div>';
            }

            archivedSeasons.forEach((season, idx) => {
                list.innerHTML += `
                    <div onclick="renderArchiveDetail(${idx})" class="p-3 bg-[#161b22] border border-gray-700 rounded cursor-pointer hover:bg-[#1f2937] transition">
                        <div class="font-bold text-purple-400 text-sm">Season ${season.seasonId}</div>
                        <div class="text-white text-xs mt-1">VS <span class="text-red-400 font-bold">${season.opponent}</span></div>
                        <div class="text-[10px] text-gray-500 mt-1">${season.date}</div>
                        <div class="text-[10px] text-gray-400 text-right mt-2">${season.logs.length} matches</div>
                    </div>
                `;
            });
            
            document.getElementById('archiveModal').style.display = 'flex';
        }

        function renderArchiveDetail(idx) {
            const season = archivedSeasons[idx];
            const container = document.getElementById('arc-log-detail');
            
            // ‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö renderLogs ‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô data source
            // (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Copy Code ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≤‡∏Å renderLogs ‡∏°‡∏≤‡πÅ‡∏õ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠ Refactor ‡∏Å‡πá‡πÑ‡∏î‡πâ)
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡∏ú‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
            
            const rows = season.logs.map(log => {
                const isWin = log.result === 'Win';
                return `
                    <div class="bg-[#161b22] p-2 mb-2 rounded border-l-4 ${isWin?'border-green-500':'border-red-500'} flex justify-between items-center">
                        <div>
                            <div class="text-xs text-blue-300 font-bold">${log.castle || log.castleShort}</div>
                            <div class="text-xs text-gray-300">${log.myTeamName} <span class="text-gray-500">vs</span> ${log.enemyName}</div>
                        </div>
                        <div class="${isWin?'text-green-400':'text-red-400'} font-bold text-xs uppercase">${log.result}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <h4 class="text-white font-bold mb-4 border-b border-gray-700 pb-2">VS ${season.opponent} (Season ${season.seasonId})</h4>
                <div class="space-y-1">${rows}</div>
            `;
        }
        async function clearHistoryDB() {
            if(confirm("‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")) {
                battleHistoryDB = [];
                await pushData();
            }
        }
        // --- GUILD MEMBER SYSTEM ---

        // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 30 ‡∏Ñ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
        function initGuildMembers() {
            guildMembersDB = [];
            for(let i=0; i<30; i++) {
                guildMembersDB.push({
                    id: i,
                    name: `Member ${i+1}`,
                    teams: [] // ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏°‡∏µ Array ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                });
            }
        }

        function selectGuildMember(idx) {
            currentMemberIdx = idx;
            renderGuildResultMode(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°
        }

        function updateMemberName(newName) {
            guildMembersDB[currentMemberIdx].name = newName || `Member ${currentMemberIdx+1}`;
            renderGuildResultMode(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ã‡πâ‡∏≤‡∏¢
        }

        // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Render Right Side)
        function renderMemberTeamsUI() {
            const mem = guildMembersDB[currentMemberIdx];
            
            // Update Header
            document.getElementById('current-mem-icon').innerText = currentMemberIdx + 1;
            document.getElementById('current-mem-name').value = mem.name;
            document.getElementById('current-mem-team-count').innerText = mem.teams.length;

            // --- RENDER STATS (‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô) ---
            const statsContainer = document.getElementById('member-stats-content');
            const stats = getMemberStats(currentMemberIdx);
            
            // Bar Chart HTML
            let teamPerformanceHTML = '';
            for (let tId in stats.teamUsage) {
                const tStat = stats.teamUsage[tId];
                const tWr = (tStat.wins / tStat.total) * 100;
                teamPerformanceHTML += `
                    <div class="mb-1">
                        <div class="flex justify-between text-[10px] text-gray-400 mb-0.5">
                            <span>${tStat.name}</span>
                            <span>${tWr.toFixed(0)}% (${tStat.wins}/${tStat.total})</span>
                        </div>
                        <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden">
                            <div class="${tWr>=50?'bg-green-500':'bg-yellow-500'}" style="width: ${tWr}%"></div>
                        </div>
                    </div>`;
            }

            statsContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-[#161b22] p-3 rounded-lg border border-gray-600 flex items-center justify-between">
                        <div>
                            <div class="text-gray-500 text-xs uppercase">Win Rate</div>
                            <div class="text-3xl font-bold ${stats.wr>=50?'text-green-400':'text-red-400'}">${stats.wr.toFixed(0)}%</div>
                        </div>
                        <div class="text-right text-xs">
                            <div class="text-green-400 font-bold">W: ${stats.wins}</div>
                            <div class="text-red-400 font-bold">L: ${stats.losses}</div>
                            <div class="text-gray-500 mt-1">Total: ${stats.total}</div>
                        </div>
                    </div>
                    <div class="bg-[#161b22] p-3 rounded-lg border border-gray-600 col-span-2">
                        <div class="text-gray-500 text-xs uppercase mb-2">Team Efficiency</div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 max-h-16 overflow-y-auto custom-scroll">
                            ${teamPerformanceHTML || '<div class="text-xs text-gray-600">No Data</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            // ‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
            const panel = document.getElementById('member-stats-panel');
            const icon = document.getElementById('stats-toggle-icon');
            if(isStatsOpen) { panel.classList.remove('hidden'); icon.innerText = '‚ñ≤'; } 
            else { panel.classList.add('hidden'); icon.innerText = '‚ñº'; }


            // --- RENDER TEAMS (‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á) ---
            const container = document.getElementById('member-team-container');
            container.innerHTML = '';

            for(let i=0; i<5; i++) {
                const team = mem.teams[i];
                if(team) {
                    renderGuildTeamCard(container, team, i);
                } else {
                    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (w-full)
                    container.innerHTML += `
                        <div onclick="createNewTeamForMember(${i})" class="w-full border-2 border-dashed border-gray-700 rounded-xl p-6 flex flex-col items-center justify-center text-gray-600 hover:border-gray-500 hover:text-gray-400 hover:bg-[#161b22] cursor-pointer transition min-h-[150px]">
                            <div class="text-4xl mb-2">+</div>
                            <div class="text-xs font-bold uppercase">Create Team ${i+1}</div>
                        </div>
                    `;
                }
            }

            statsContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-[#161b22] p-3 rounded-lg border border-gray-600 flex items-center justify-between">
                        <div>
                            <div class="text-gray-500 text-xs uppercase">Win Rate</div>
                            <div class="text-3xl font-bold ${stats.wr>=50?'text-green-400':'text-red-400'}">${stats.wr.toFixed(0)}%</div>
                        </div>
                        <div class="text-right text-xs">
                            <div class="text-green-400 font-bold">W: ${stats.wins}</div>
                            <div class="text-red-400 font-bold">L: ${stats.losses}</div>
                            <div class="text-gray-500 mt-1">Total: ${stats.total}</div>
                        </div>
                    </div>
                    <div class="bg-[#161b22] p-3 rounded-lg border border-gray-600 col-span-2">
                        <div class="text-gray-500 text-xs uppercase mb-2">Team Efficiency</div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 max-h-16 overflow-y-auto custom-scroll">
                            ${teamPerformanceHTML || '<div class="text-xs text-gray-600">No Data</div>'}
                        </div>
                    </div>
                </div>
            `;

            const recentHistoryHTML = stats.history.slice(0, 5).map(log => {
                const isWin = log.result === 'Win';
                // Helper ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Code genHeroIconsWithStar ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏±‡πâ‡∏ô‡πÜ)
                const heroIcons = (log.playerIds || []).map(hid => {
                    const h = heroesDB.find(x => x.id === hid);
                    return h ? `<img src="${h.img}" class="w-6 h-6 rounded border border-gray-600 bg-black">` : '';
                }).join('');

                return `
                    <div class="flex justify-between items-center bg-[#1f2937] p-2 rounded border border-gray-700 text-xs">
                        <div class="flex items-center gap-2">
                            <span class="${isWin?'text-green-400':'text-red-400'} font-bold w-8">${isWin?'WIN':'LOSE'}</span>
                            <span class="text-gray-500">vs ${log.enemyName}</span>
                        </div>
                        <div class="flex gap-1">${heroIcons}</div>
                    </div>
                `;
            }).join('') || '<div class="text-center text-gray-600 py-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</div>';

            // HTML ‡∏Å‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Stats Board
            const statsBoard = `
                <div class="col-span-1 xl:col-span-2 mt-4 border-t border-gray-800 pt-4">
                    <h3 class="text-white font-bold text-lg mb-3 flex items-center gap-2">
                        <span>üìä Performance Stats</span>
                        <span class="text-xs font-normal text-gray-500">(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å Log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-[#161b22] p-4 rounded-xl border border-gray-700 shadow-lg flex flex-col justify-center items-center">
                            <div class="text-gray-400 text-xs uppercase mb-1">Total Win Rate</div>
                            <div class="text-4xl font-bold ${stats.wr>=50?'text-green-400':'text-red-400'}">${stats.wr.toFixed(1)}%</div>
                            <div class="flex gap-4 mt-2 text-xs font-bold">
                                <span class="text-green-500">‡∏ä‡∏ô‡∏∞: ${stats.wins}</span>
                                <span class="text-red-500">‡πÅ‡∏û‡πâ: ${stats.losses}</span>
                            </div>
                        </div>

                        <div class="bg-[#161b22] p-4 rounded-xl border border-gray-700 shadow-lg">
                            <div class="text-gray-400 text-xs uppercase mb-2">Team Efficiency</div>
                            <div class="overflow-y-auto max-h-24 custom-scroll pr-1">
                                ${teamPerformanceHTML || '<div class="text-xs text-gray-600 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡∏°‡∏™‡∏π‡πâ</div>'}
                            </div>
                        </div>

                        <div class="bg-[#161b22] p-4 rounded-xl border border-gray-700 shadow-lg">
                            <div class="text-gray-400 text-xs uppercase mb-2">Recent Battles</div>
                            <div class="space-y-1 overflow-y-auto max-h-24 custom-scroll">
                                ${recentHistoryHTML}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', statsBoard);
        }

        function renderGuildTeamCard(container, team, slotIdx) {
            const layout = { 'basic': {b:3,f:2}, 'balanced':{b:2,f:3}, 'attack':{b:4,f:1}, 'defense':{b:1,f:4} }[team.formation] || {b:3,f:2};
            let sc = 0;
            if (!team.skillQueue) team.skillQueue = [];
            const cardId = `guild-team-card-${currentMemberIdx}-${slotIdx}`;
            
            // --- [NEW] LOCK LOGIC ---
            const isLocked = team.isDead === true; // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏î (Pointer Events) ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö (Opacity)
            const lockClass = isLocked ? 'opacity-60 pointer-events-none grayscale-[0.8]' : '';
            const lockOverlay = isLocked ? `<div class="absolute top-2 right-2 z-50 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg border border-red-400">üîí BATTLE ENDED</div>` : '';
            // ------------------------

            // 1. Queue Display
            const renderQueueDisplay = () => {
                let html = '<div class="flex flex-col gap-2 items-center justify-center w-20 border-r border-dashed border-gray-700 pr-2 mr-2 flex-shrink-0 pt-4">';
                html += '<span class="text-[10px] text-yellow-500 font-bold uppercase tracking-wider">QUEUE</span>';
                html += '<div class="flex flex-col gap-2 items-center">';
                for(let i=0; i<3; i++) {
                    const skillKey = team.skillQueue[i];
                    if(skillKey) {
                        const [sIdx, sNum] = skillKey.split('-');
                        const hero = heroesDB.find(h => h.id == team.slots[sIdx]?.id);
                        const img = hero ? hero.img : '';
                        const skillLabel = sNum === '1' ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô';
                        html += `<div class="relative w-12 h-12 border border-yellow-600 rounded bg-black flex-shrink-0 shadow-md"><img src="${img}" class="w-full h-full object-cover opacity-80"><div class="absolute bottom-0 right-0 bg-blue-600 text-white text-[10px] font-bold px-1.5 leading-none shadow">${skillLabel}</div><div class="absolute top-0 left-0 bg-black/50 text-yellow-500 text-[8px] font-bold px-1 rounded-br">${i+1}</div></div>`;
                    } else {
                        html += `<div class="w-12 h-12 border border-dashed border-gray-700 rounded flex items-center justify-center text-xs text-gray-600 flex-shrink-0 font-bold">${i+1}</div>`;
                    }
                }
                html += '</div></div>';
                return html;
            };

            // 2. Row Generator
            const genRow = (c, l) => {
                let h = `<div class="flex gap-4 items-center justify-center relative py-6 w-full"><div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0"><span class="text-5xl font-black text-gray-800/40 uppercase tracking-[0.3em] select-none">${l}</span></div>`;
                for(let k=0; k<c; k++) {
                    const p = sc++; const s = team.slots[p]; const hData = s ? heroesDB.find(x=>x.id==s.id) : null;
                    let inner = '', skillControls = '';

                    if(hData) {
                        let ring = '', rCls = ''; if(s.ring) { const r = ringsDB.find(x=>x.id==s.ring); if(r) { ring=`<img src="${r.img}">`; rCls=`equipped grade-${r.grade}`; } }
                        const isS1 = team.skillQueue.includes(`${p}-1`) ? 'bg-yellow-500 text-black border-yellow-600 shadow-[0_0_5px_rgba(234,179,8,0.5)]' : 'bg-[#1f2937] text-gray-500 border-gray-600 hover:text-white hover:border-gray-400';
                        const isS2 = team.skillQueue.includes(`${p}-2`) ? 'bg-yellow-500 text-black border-yellow-600 shadow-[0_0_5px_rgba(234,179,8,0.5)]' : 'bg-[#1f2937] text-gray-500 border-gray-600 hover:text-white hover:border-gray-400';
                        
                        skillControls = `
                            <div class="absolute -bottom-[26px] inset-x-0 mx-auto w-full flex justify-center gap-0.5 z-20">
                                <button onclick="toggleGuildSkillQueue(${slotIdx}, ${p}, 2)" class="w-10 h-5 text-[9px] font-bold border rounded-sm ${isS2} transition flex items-center justify-center" ${isLocked ? 'disabled' : ''}>‡∏ö‡∏ô</button>
                                <button onclick="toggleGuildSkillQueue(${slotIdx}, ${p}, 1)" class="w-10 h-5 text-[9px] font-bold border rounded-sm ${isS1} transition flex items-center justify-center" ${isLocked ? 'disabled' : ''}>‡∏•‡πà‡∏≤‡∏á</button>
                            </div>
                        `;
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏° pointer-events-auto ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
                        // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏≤ lockClass ‡∏Ñ‡∏£‡∏≠‡∏ö parent ‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ 
                        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤ lockClass ‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô input/drag ‡πÅ‡∏ó‡∏ô
                        // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏ú‡∏°‡∏Ç‡∏≠ Lock ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô Slot ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
                        inner = `<img src="${hData.img}">${getStarsHTML(s.star, false)}<div class="ring-trigger ${rCls} w-8 h-8 text-sm" onclick="!${isLocked} && openSelector('G-${currentMemberIdx}-${slotIdx}',${p},'ring',event)">${ring||'üíç'}</div>`;
                    }
                    
                    // ‡πÉ‡∏™‡πà onclick check isLocked
                    const clickAction = isLocked ? '' : `onclick="openSelector('G-${currentMemberIdx}-${slotIdx}',${p},'hero', event)"`;
                    const contextAction = isLocked ? '' : `oncontextmenu="openContextMenu(event,'G-${currentMemberIdx}-${slotIdx}',${p})"`;
                    const dragAttrs = isLocked ? '' : `draggable="true" ondragstart="dragStart(event,'G-${currentMemberIdx}-${slotIdx}',${p})" ondragover="allowDrop(event)" ondrop="drop(event,'G-${currentMemberIdx}-${slotIdx}',${p})"`;

                    h += `<div class="relative group z-10 ${lockClass}">
                            ${skillControls}
                            <div class="slot ${hData?'filled':''} w-20 h-20 relative shadow-md z-10" ${clickAction} ${contextAction} ${dragAttrs}>
                                ${inner}
                            </div>
                        </div>`;
                } return h + `</div>`;
            }
            
            const petD = team.pet ? petsDB.find(p=>p.id==team.pet.id) : null;
            const petClick = isLocked ? '' : `onclick="openSelector('G-${currentMemberIdx}-${slotIdx}','pet','pet')"`;
            const petContext = isLocked ? '' : `oncontextmenu="openContextMenu(event,'G-${currentMemberIdx}-${slotIdx}','pet')"`;

            container.insertAdjacentHTML('beforeend', `
                <div id="${cardId}" class="bg-[#161b22] border ${isLocked ? 'border-red-900/50 bg-red-900/5' : 'border-gray-700'} rounded-2xl p-5 shadow-xl relative group hover:border-blue-500/50 transition">
                    ${lockOverlay}
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-700">
                        <div class="flex items-center gap-3">
                            <span class="bg-blue-900 text-blue-200 text-xs px-2 py-1 rounded font-bold uppercase tracking-wider">Team ${slotIdx+1}</span>
                            <input type="text" value="${team.name}" ${isLocked ? 'disabled' : ''} onchange="updateGuildTeam(${slotIdx},'name',this.value)" class="bg-transparent text-lg font-bold ${isLocked?'text-gray-500':'text-white'} w-32 md:w-48 outline-none focus:text-blue-400 border-b border-transparent focus:border-blue-500 transition placeholder-gray-600">
                        </div>
                        <div class="flex items-center ${isLocked ? 'opacity-0 pointer-events-none' : ''}">
                            <button onclick="openLoadSetModal('guild', ${currentMemberIdx}, ${slotIdx})" class="text-purple-400 hover:bg-purple-900/30 hover:text-white text-xs border border-purple-900 px-3 py-1 rounded transition mr-2">üìÇ Load Set</button>
                            <button onclick="deleteGuildTeam(${slotIdx})" class="text-red-500 hover:bg-red-900/30 hover:text-red-300 text-xs border border-red-900 px-3 py-1 rounded transition">Delete</button>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <div class="flex flex-col gap-2 w-20 flex-shrink-0 pt-4 ${lockClass}">
                            <span class="text-[10px] text-gray-500 font-bold uppercase text-center">Formation</span>
                            <div class="flex flex-col gap-1">
                                ${['basic','balanced','attack','defense'].map(f => `<button onclick="updateGuildTeam(${slotIdx},'formation','${f}')" class="px-2 py-2 text-[9px] rounded border transition ${team.formation===f?'bg-blue-600 border-blue-500 text-white font-bold shadow-lg ring-1 ring-blue-400':'bg-[#0d1117] border-gray-600 text-gray-400 hover:text-white hover:border-gray-400'}">${f.substring(0,3).toUpperCase()}</button>`).join('')}
                            </div>
                        </div>

                        <div class="flex-1 flex items-stretch bg-[#0d1117] rounded-xl border border-gray-800 shadow-inner">
                            <div class="${lockClass} flex items-stretch">${renderQueueDisplay()}</div>

                            <div class="flex-1 flex flex-col items-center justify-center py-2">
                                ${genRow(layout.b,'BACK')}
                                <div class="w-full h-px bg-gray-800/50 my-1 border-t border-dashed border-gray-700"></div>
                                ${genRow(layout.f,'FRONT')}
                            </div>

                            <div class="flex flex-col gap-2 items-center justify-center w-24 border-l border-dashed border-gray-700 pl-2 ml-2 bg-[#111827]/30 rounded-r-xl ${lockClass}">
                                <span class="text-[10px] text-purple-400 font-bold tracking-widest">PET</span>
                                <div class="pet-slot w-16 h-16 ${petD?'filled':''} shadow-lg" ${petClick} ${petContext}>
                                    ${petD?`<img src="${petD.img}">`:'<span class="text-2xl opacity-50">+</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        // Actions
        function createNewTeamForMember(slotIdx) {
            const newTeam = { 
                name: `Team ${slotIdx+1}`, 
                formation: 'basic', 
                slots: {0:null,1:null,2:null,3:null,4:null}, 
                pet: null,
                skillQueue: [] // ‡πÄ‡∏û‡∏¥‡πà‡∏° array ‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢ ‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡πä‡∏Å
            };  
            guildMembersDB[currentMemberIdx].teams[slotIdx] = newTeam;
            renderGuildResultMode(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 3/5 ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢

            triggerAutoSave();
        }

        function deleteGuildTeam(slotIdx) {

            const team = guildMembersDB[currentMemberIdx].teams[slotIdx];
            if (team && team.isDead) {
                return alert("‚õî ‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)");
            }

            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ?\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)")) return;

            guildMembersDB[currentMemberIdx].teams[slotIdx] = null;

            // renderMemberTeamsUI();
            renderGuildResultMode(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 3/5 -> 2/5)

            // 6. [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å] ‡∏™‡∏±‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Cloud
            triggerAutoSave();
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateGuildTeam
        function updateGuildTeam(slotIdx, field, val) {
            const team = guildMembersDB[currentMemberIdx].teams[slotIdx];

            if (!team) return;

            if (team.isDead) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠ input ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° Formation ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                if (field === 'formation') {
                    alert("‚õî ‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡∏û‡πÑ‡∏î‡πâ");
                }
                return; 
            }

            team[field] = val;

            // // 4. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Formation ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
            // if (field === 'formation') {
            //     renderMemberTeamsUI();
            // }

            // 5. [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î] ‡∏™‡∏±‡πà‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Cloud ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            triggerAutoSave();
        }

        window.updateBattleTeamSelect = function() {
            // 1. ‡∏î‡∏∂‡∏á Element ‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
            const memSelect = document.getElementById('battle-member-select');
            const teamSelect = document.getElementById('battle-team-select');

            // 2. [‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏à‡∏≠ Element ‡πÑ‡∏´‡∏°? ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error)
            if (!memSelect || !teamSelect) return;

            // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ Element ‡πÅ‡∏•‡πâ‡∏ß
            const memIdx = memSelect.value;
            const member = guildMembersDB[memIdx];
            
            teamSelect.innerHTML = '';
            
            if (!member || !member.teams) {
                teamSelect.innerHTML = '<option value="">No Data</option>';
                return;
            }

            let hasTeam = false;
            member.teams.forEach((t, i) => {
                if(t) {
                    teamSelect.innerHTML += `<option value="${i}">${t.name} (${t.formation})</option>`;
                    hasTeam = true;
                }
            });
            
            if(!hasTeam) teamSelect.innerHTML = '<option value="">No Teams Created</option>';
        };
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ init
        setTimeout(updateBattleTeamSelect, 100);

        async function saveGuildData() {
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏•‡∏î‡πå..."); // 1. ‡πÅ‡∏™‡∏î‡∏á Loading
            try {
                await pushData(); // 2. ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            } finally {
                hideLoading(); // 3. ‡∏ã‡πà‡∏≠‡∏ô Loading ‡πÄ‡∏™‡∏°‡∏≠ (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
            }
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function checkWarRoomStatus() {
            const emptyScreen = document.getElementById('war-room-empty');
            const interfaceScreen = document.getElementById('war-room-interface');

            console.log(currentSeason);
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ status ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô active (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)
            const status = currentSeason.status || 'active';

            console.log(status);

            if (status === 'waiting') {
                emptyScreen.classList.remove('hidden');
                interfaceScreen.classList.add('hidden');
            } else {
                emptyScreen.classList.add('hidden');
                interfaceScreen.classList.remove('hidden');
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• UI
                const badge = document.getElementById('gw-season-badge');
                const oppName = document.getElementById('gw-opponent-name');
                if(badge) badge.innerText = `Season ${currentSeason.id}`;
                if(oppName) oppName.innerText = currentSeason.opponent;
                
                renderDashboard(); // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô
            }
        }
        async function startNewSeasonInput() {
            const newOpponent = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ '‡∏Å‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á' (Opponent Guild):", "");
            if (!newOpponent || newOpponent.trim() === "") return;

            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Season ‡πÉ‡∏´‡∏°‡πà...");

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô Active
            currentSeason.opponent = newOpponent;
            currentSeason.startDate = new Date().toLocaleDateString('th-TH');
            currentSeason.status = 'active'; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠

            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            checkWarRoomStatus();
            
            await pushData();
            hideLoading();
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
        function getMemberStats(memIdx) {
            // ID ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏¥‡∏•‡∏î‡πå‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "G-{memIdx}-{teamIdx}"
            // ‡πÄ‡∏ä‡πà‡∏ô "G-0-1" ‡∏Ñ‡∏∑‡∏≠ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1, ‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà 2
            const prefix = `G-${memIdx}-`;
            
            // ‡∏Å‡∏£‡∏≠‡∏á Log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏´‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
            const logs = battleHistoryDB.filter(log => log.myTeamId && log.myTeamId.startsWith(prefix));
            
            let stats = {
                total: logs.length,
                wins: 0,
                losses: 0,
                wr: 0,
                teamUsage: {}, // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ó‡∏µ‡∏° (Team 1, Team 2...)
                history: logs  // ‡∏™‡πà‡∏á Log ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡∏î‡πâ‡∏ß‡∏¢
            };

            logs.forEach(log => {
                // ‡∏ô‡∏±‡∏ö Win/Lose
                if(log.result === 'Win') stats.wins++;
                else stats.losses++;

                // ‡∏ô‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏ó‡∏µ‡∏°
                if(!stats.teamUsage[log.myTeamId]) {
                    stats.teamUsage[log.myTeamId] = { wins:0, total:0, name: log.myTeamName };
                }
                stats.teamUsage[log.myTeamId].total++;
                if(log.result === 'Win') stats.teamUsage[log.myTeamId].wins++;
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % Win Rate
            stats.wr = stats.total > 0 ? (stats.wins / stats.total) * 100 : 0;
            
            return stats;
        }

        // --- GUILD SKILL LOGIC ---

        function toggleGuildSkillQueue(teamIdx, slotIdx, skillNum) {
            const team = guildMembersDB[currentMemberIdx].teams[teamIdx];

            if(team.isDead) return alert("‚õî ‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ");

            const skillKey = `${slotIdx}-${skillNum}`; // "0-1"
            
            if (!team.skillQueue) team.skillQueue = [];

            const existIdx = team.skillQueue.indexOf(skillKey);
            if (existIdx > -1) {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
                team.skillQueue.splice(existIdx, 1);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° 3 ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°
                if (team.skillQueue.length < 3) {
                    team.skillQueue.push(skillKey);
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£)
                    // alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏™‡∏Å‡∏¥‡∏•");
                }
            }
            // renderMemberTeamsUI(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            renderGuildResultMode();

            triggerAutoSave();
        }

        function removeGuildSkillQueue(teamIdx, queueIdx) {
            const team = guildMembersDB[currentMemberIdx].teams[teamIdx];
            if (team && team.skillQueue) {
                team.skillQueue.splice(queueIdx, 1); // ‡∏•‡∏ö‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß
                // renderMemberTeamsUI();
                renderGuildResultMode();
            }
        }
        function toggleMemberStats() {
            isStatsOpen = !isStatsOpen;
            const panel = document.getElementById('member-stats-panel');
            const icon = document.getElementById('stats-toggle-icon');
            
            if(isStatsOpen) {
                panel.classList.remove('hidden');
                icon.innerText = '‚ñ≤';
            } else {
                panel.classList.add('hidden');
                icon.innerText = '‚ñº';
            }
        }
        // --- HERO SET MANAGER LOGIC ---

        function addNewHeroSet() {
            heroSetsDB.push({
                id: Date.now().toString(),
                name: 'New Meta Team',
                formation: 'basic',
                slots: {0:null,1:null,2:null,3:null,4:null},
                pet: null
            });
            currentSetIdx = heroSetsDB.length - 1;
            renderSetManager();
        }

        function renderSetManager() {
            const list = document.getElementById('set-manager-list');
            const editor = document.getElementById('set-manager-editor');
            const empty = document.getElementById('set-manager-empty');
            const btnSave = document.getElementById('btn-save-set');
            
            list.innerHTML = '';
            
            if (heroSetsDB.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 mt-4 text-xs">No sets created yet.</div>';
            }

            heroSetsDB.forEach((set, i) => {
                const active = i === currentSetIdx ? 'active bg-blue-900/40 border-blue-500' : 'hover:bg-[#1f2937] border-transparent';
                
                // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏£‡∏π‡∏õ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ 5 ‡∏ï‡∏±‡∏ß
                let iconsHtml = '';
                for(let k=0; k<5; k++) {
                    const s = set.slots[k];
                    if(s && s.id) {
                        const h = heroesDB.find(x => x.id == s.id);
                        if(h) {
                            iconsHtml += `<img src="${h.img}" class="w-6 h-6 rounded border border-gray-600 bg-black object-cover" title="${h.name}">`;
                        } else {
                            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏£‡∏π‡∏õ (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)
                            iconsHtml += `<div class="w-6 h-6 rounded border border-gray-700 bg-[#111] flex items-center justify-center text-[8px] text-gray-500">?</div>`;
                        }
                    } else {
                        // ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
                        iconsHtml += `<div class="w-6 h-6 rounded border border-gray-800 bg-[#0d1117]"></div>`;
                    }
                }

                // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                let petHtml = '';
                if(set.pet && set.pet.id) {
                    const p = petsDB.find(x => x.id == set.pet.id);
                    if(p) {
                        petHtml = `<div class="w-6 h-6 rounded-full border border-purple-500/50 ml-2 shadow-sm relative" title="${p.name}"><img src="${p.img}" class="w-full h-full rounded-full object-cover"></div>`;
                    }
                }

                // 3. ‡∏™‡∏µ‡∏õ‡πâ‡∏≤‡∏¢ Formation
                const fmtColor = set.formation === 'basic' ? 'text-gray-400 border-gray-600' :
                                set.formation === 'attack' ? 'text-red-400 border-red-600' :
                                set.formation === 'defense' ? 'text-blue-400 border-blue-600' : 'text-yellow-400 border-yellow-600';

                // 4. Render Item
                list.innerHTML += `
                    <div onclick="selectHeroSet(${i})" class="cursor-pointer p-3 rounded-lg border mb-1 transition flex flex-col gap-2 ${active}">
                        
                        <div class="flex justify-between items-center w-full">
                            <div class="font-bold text-gray-200 text-sm truncate flex-1 mr-2">${set.name || 'Unnamed Set'}</div>
                            <span class="text-[9px] uppercase px-1.5 py-0.5 rounded border bg-black/20 ${fmtColor}">${set.formation.substring(0,3)}</span>
                        </div>

                        <div class="flex items-center">
                            <div class="flex gap-1 bg-black/20 p-1 rounded border border-gray-700/50">
                                ${iconsHtml}
                            </div>
                            ${petHtml}
                        </div>
                    </div>
                `;
            });

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏ß‡∏≤ (Editor)
            if (currentSetIdx > -1 && heroSetsDB[currentSetIdx]) {
                editor.classList.remove('hidden');
                empty.classList.add('hidden');
                btnSave.classList.remove('hidden');
                renderSetEditor(heroSetsDB[currentSetIdx], currentSetIdx);
            } else {
                editor.classList.add('hidden');
                empty.classList.remove('hidden');
                btnSave.classList.add('hidden');
            }
        }

        function selectHeroSet(i) { currentSetIdx = i; renderSetManager(); }

        function renderSetEditor(set, idx) {
            const container = document.getElementById('set-manager-editor');
            
            // Layout Logic
            const layout = { 'basic': {b:3,f:2}, 'balanced':{b:2,f:3}, 'attack':{b:4,f:1}, 'defense':{b:1,f:4} }[set.formation] || {b:3,f:2};
            let sc = 0;
            const petD = set.pet ? petsDB.find(p=>p.id==set.pet.id) : null;
            
            if (!set.skillQueue) set.skillQueue = []; // Init queue if missing

            // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏Å‡∏¥‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
            const renderQueueDisplay = () => {
                let html = '<div class="flex flex-col gap-2 items-center justify-center w-20 border-r border-dashed border-gray-700 pr-2 mr-2 flex-shrink-0 pt-4">';
                html += '<span class="text-[10px] text-yellow-500 font-bold uppercase tracking-wider">QUEUE</span>';
                html += '<div class="flex flex-col gap-2 items-center">';
                
                for(let i=0; i<3; i++) {
                    const skillKey = set.skillQueue[i];
                    if(skillKey) {
                        const [sIdx, sNum] = skillKey.split('-');
                        const hero = heroesDB.find(h => h.id == set.slots[sIdx]?.id);
                        const img = hero ? hero.img : '';
                        const skillLabel = sNum === '1' ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô';

                        html += `
                            <div class="relative w-12 h-12 border border-yellow-600 rounded bg-black flex-shrink-0 shadow-md">
                                <img src="${img}" class="w-full h-full object-cover opacity-80">
                                <div class="absolute bottom-0 right-0 bg-blue-600 text-white text-[10px] font-bold px-1.5 leading-none shadow">${skillLabel}</div>
                                <div class="absolute top-0 left-0 bg-black/50 text-yellow-500 text-[8px] font-bold px-1 rounded-br">${i+1}</div>
                            </div>
                        `;
                    } else {
                        html += `<div class="w-12 h-12 border border-dashed border-gray-700 rounded flex items-center justify-center text-xs text-gray-600 flex-shrink-0 font-bold">${i+1}</div>`;
                    }
                }
                html += '</div></div>';
                return html;
            };

            // Main HTML Structure
            let html = `
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <input type="text" value="${set.name}" onchange="updateHeroSet(${idx}, 'name', this.value)" class="bg-transparent text-2xl font-bold text-white w-full outline-none border-b border-transparent focus:border-blue-500 placeholder-gray-600 mr-4">
                    <button onclick="deleteHeroSet(${idx})" class="text-red-500 hover:bg-red-900/30 px-3 py-1 rounded border border-red-900 text-xs whitespace-nowrap">Delete Set</button>
                </div>
                
                <div class="flex gap-4 items-stretch">
                     <div class="flex flex-col gap-2 w-20 flex-shrink-0 pt-4 border-r border-gray-800 pr-2">
                        <span class="text-[10px] text-gray-500 font-bold uppercase text-center">Formation</span>
                        <div class="flex flex-col gap-1">
                            ${['basic','balanced','attack','defense'].map(f => `<button onclick="updateHeroSet(${idx},'formation','${f}')" class="px-2 py-2 text-[9px] rounded border transition ${set.formation===f?'bg-blue-600 border-blue-500 text-white font-bold shadow-lg ring-1 ring-blue-400':'bg-[#0d1117] border-gray-600 text-gray-400 hover:text-white hover:border-gray-400'}">${f.substring(0,3).toUpperCase()}</button>`).join('')}
                        </div>
                    </div>

                    <div class="flex-1 flex items-stretch bg-[#0d1117] rounded-xl p-2 border border-gray-800 justify-center shadow-inner relative">
                        
                        ${renderQueueDisplay()}

                        <div class="flex-1 flex flex-col items-center justify-center gap-4 py-4">
                            <div class="flex gap-4 justify-center relative w-full min-h-[90px]">
                                <span class="absolute inset-0 flex items-center justify-center text-5xl font-black text-gray-800/30 uppercase tracking-widest select-none pointer-events-none">BACK</span>
                                ${Array(layout.b).fill(0).map(() => renderSetSlot(set, idx, sc++)).join('')}
                            </div>
                            
                            <div class="w-full h-px bg-gray-800 border-t border-dashed border-gray-700 my-2"></div>
                            
                            <div class="flex gap-4 justify-center relative w-full min-h-[90px]">
                                <span class="absolute inset-0 flex items-center justify-center text-5xl font-black text-gray-800/30 uppercase tracking-widest select-none pointer-events-none">FRONT</span>
                                ${Array(layout.f).fill(0).map(() => renderSetSlot(set, idx, sc++)).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2 items-center justify-center w-24 border-l border-gray-800 pl-4">
                        <span class="text-[10px] text-purple-400 font-bold tracking-widest">PET</span>
                        <div class="pet-slot w-16 h-16 ${petD?'filled':''} shadow-lg" onclick="openSelector('S-${idx}','pet','pet')" oncontextmenu="openContextMenu(event,'S-${idx}','pet')">
                            ${petD?`<img src="${petD.img}">`:'<span class="text-2xl opacity-50">+</span>'}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function renderSetSlot(set, setIdx, p) {
            const s = set.slots[p];
            const hData = s ? heroesDB.find(x => x.id == s.id) : null;
            let inner = '';
            let skillControls = '';

            if (hData) {
                // Render ‡πÅ‡∏´‡∏ß‡∏ô
                let ring = '', rCls = '';
                if (s.ring) { const r = ringsDB.find(x => x.id == s.ring); if (r) { ring = `<img src="${r.img}">`; rCls = `equipped grade-${r.grade}`; } }
                
                // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏Å‡∏¥‡∏• (‡∏•‡πà‡∏≤‡∏á/‡∏ö‡∏ô)
                const isS1 = set.skillQueue?.includes(`${p}-1`) ? 'bg-yellow-500 text-black border-yellow-600 shadow-[0_0_5px_rgba(234,179,8,0.5)]' : 'bg-[#1f2937] text-gray-500 border-gray-600 hover:text-white hover:border-gray-400';
                const isS2 = set.skillQueue?.includes(`${p}-2`) ? 'bg-yellow-500 text-black border-yellow-600 shadow-[0_0_5px_rgba(234,179,8,0.5)]' : 'bg-[#1f2937] text-gray-500 border-gray-600 hover:text-white hover:border-gray-400';

                skillControls = `
                    <div class="absolute -bottom-[26px] inset-x-0 mx-auto w-full flex justify-center gap-0.5 z-20">
                        <button onclick="toggleSetSkillQueue(${setIdx}, ${p}, 2)" class="w-8 h-5 text-[9px] font-bold border rounded-sm ${isS2} transition flex items-center justify-center">‡∏ö‡∏ô</button>
                        <button onclick="toggleSetSkillQueue(${setIdx}, ${p}, 1)" class="w-8 h-5 text-[9px] font-bold border rounded-sm ${isS1} transition flex items-center justify-center">‡∏•‡πà‡∏≤‡∏á</button>
                    </div>
                `;

                inner = `<img src="${hData.img}">${getStarsHTML(s.star, false)}<div class="ring-trigger ${rCls} w-8 h-8 text-sm" onclick="openSelector('S-${setIdx}',${p},'ring', event)">${ring || 'üíç'}</div>`;
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Draggable Attributes ‡πÅ‡∏•‡∏∞ ID ‡πÅ‡∏ö‡∏ö "S-{setIdx}"
            return `
                <div class="relative group z-10">
                    ${skillControls}
                    <div class="slot ${hData ? 'filled' : ''} w-20 h-20 relative shadow-md z-10" 
                         onclick="openSelector('S-${setIdx}',${p},'hero', event)" 
                         oncontextmenu="openContextMenu(event,'S-${setIdx}',${p})"
                         draggable="true" 
                         ondragstart="dragStart(event,'S-${setIdx}',${p})"
                         ondragover="allowDrop(event)" 
                         ondrop="drop(event,'S-${setIdx}',${p})">
                        ${inner}
                    </div>
                </div>
            `;
        }

        function updateHeroSet(idx, field, val) {
            heroSetsDB[idx][field] = val;
            if (field === 'formation') renderSetManager();
        }
        
        async function deleteHeroSet(idx) {
            if(confirm('‡∏•‡∏ö Set ‡∏ô‡∏µ‡πâ?')) {
                heroSetsDB.splice(idx, 1);
                currentSetIdx = -1;
                renderSetManager();
                await saveHeroSets();
            }
        }
        
        async function saveHeroSets() {
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Team Sets...");
            await pushData();
            hideLoading();
        }
        
        function openLoadSetModal(type, id, teamIdx) {
            // ‡πÄ‡∏Å‡πá‡∏ö Context ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Set
            targetLoadContext = { type, id, teamIdx };

            // --- 1. Validation Checks (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ö) ---
            if (type === 'guild') {
                const team = guildMembersDB[id].teams[teamIdx];
                if (team && team.isDead) return alert("‚õî ‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ö‡πÑ‡∏î‡πâ");
            } 
            else if (type === 'BW-ENEMY' || type === 'BW-MY' || type === 'BATTLE-TEMP' || type.startsWith('PREP-')) {
                // ‚úÖ Case: Battle War / Preparation / Temp
                // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó‡πÅ‡∏ï‡∏Å
            }
            else {
                // Case: War Room (Check isCleared)
                const k = `${currentCastle}-${id}`;
                const team = teamsDB[k];
                if (team && team.isCleared) return alert("‚õî ‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ");
            }

            // --- 2. Render List ---
            const list = document.getElementById('load-set-list');
            list.innerHTML = '';
            
            if(heroSetsDB.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Set<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π Database Manager > Team Sets</div>';
            } else {
                heroSetsDB.forEach((set, i) => {
                    let icons = '';
                    for(let k=0; k<5; k++) {
                        const s = set.slots[k];
                        if(s) {
                            const h = heroesDB.find(x => x.id == s.id);
                            if(h) icons += `<img src="${h.img}" class="w-6 h-6 rounded bg-black border border-gray-700">`;
                        }
                    }
                    
                    list.innerHTML += `
                        <div onclick="applyHeroSet(${i})" class="bg-[#161b22] border border-gray-700 hover:border-blue-500 p-3 rounded flex justify-between items-center cursor-pointer transition group mb-2">
                            <div>
                                <div class="font-bold text-white group-hover:text-blue-400">${set.name}</div>
                                <div class="text-xs text-gray-500 capitalize">${set.formation} Formation</div>
                            </div>
                            <div class="flex gap-1">${icons}</div>
                        </div>
                    `;
                });
            }
            document.getElementById('loadSetModal').style.display = 'flex';
        }

        function closeLoadSetModal() { document.getElementById('loadSetModal').style.display = 'none'; }

        function applyHeroSet(setIdx) {
            const set = heroSetsDB[setIdx];
            if (!set || !targetLoadContext) return;

            const { type, id, teamIdx } = targetLoadContext;
            let targetTeam = null;

            // --- 1. ‡∏´‡∏≤ Target Team (‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏™‡πà) ---
            if (type === 'guild') {
                targetTeam = guildMembersDB[id].teams[teamIdx];
            } 
            else if (type === 'BW-ENEMY' || type === 'BW-MY' || type === 'BATTLE-TEMP' || type.startsWith('PREP-')) {
                // ‚úÖ Case: Battle War ‡πÉ‡∏ä‡πâ getTeam ‡∏î‡∏∂‡∏á Object ‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                targetTeam = getTeam(type);
            }
            else {
                // Case: War Room
                const k = `${currentCastle}-${id}`;
                if (!teamsDB[k]) teamsDB[k] = { player: '', speed: '', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skills: [], isCleared: false };
                targetTeam = teamsDB[k];
            }

            if (targetTeam) {
                // --- 2. Copy Data ---
                targetTeam.formation = set.formation;
                targetTeam.pet = set.pet ? JSON.parse(JSON.stringify(set.pet)) : null;
                targetTeam.slots = JSON.parse(JSON.stringify(set.slots));
                
                if (set.skillQueue && Array.isArray(set.skillQueue)) {
                    targetTeam.skillQueue = JSON.parse(JSON.stringify(set.skillQueue));
                    // War Room Compatibility
                    targetTeam.skills = JSON.parse(JSON.stringify(set.skillQueue));
                } else {
                    targetTeam.skillQueue = [];
                    targetTeam.skills = [];
                }
                
                // --- 3. Refresh UI ---
                if (type === 'BW-ENEMY' || type === 'BW-MY') {
                    renderBattleWar(); // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ Battle War
                }
                else if (type.startsWith('PREP-')) {
                    renderPreparation();
                }
                else if (type === 'BATTLE-TEMP') {
                    renderBattleBuilder(); 
                } 
                else if (type === 'guild') {
                    renderGuildResultMode(); // ‡∏´‡∏£‡∏∑‡∏≠ renderMemberTeamsUI ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏´‡∏ô‡πâ‡∏≤
                }
                else {
                    renderDashboard(); // War Room
                }

                triggerAutoSave();
            }

            closeLoadSetModal();
        }
        // --- NEW FEATURES: EXPORT IMAGE & BACKUP ---

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Download Backup (Settings)
        function downloadBackup() {
            const backupData = {
                timestamp: new Date().toLocaleString(),
                heroes: heroesDB,
                pets: petsDB,
                rings: ringsDB,
                affiliations: affiliationsDB,
                teams: teamsDB,
                logs: logsDB,
                tierLists: tierListsDB,
                myTeams: myTeamsDB, // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
                guildMembers: guildMembersDB, // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
                battleHistory: battleHistoryDB,
                seasonInfo: currentSeason,
                archivedSeasons: archivedSeasons,
                heroSets: heroSetsDB
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "7K_Commander_Backup_" + Date.now() + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Restore Backup
        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;

            if(!confirm("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Backup\n‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                input.value = ''; // Reset input
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Restore Data
                    if(data.heroes) heroesDB = data.heroes;
                    if(data.pets) petsDB = data.pets;
                    if(data.rings) ringsDB = data.rings;
                    if(data.affiliations) affiliationsDB = data.affiliations;
                    if(data.teams) teamsDB = data.teams;
                    if(data.logs) logsDB = data.logs;
                    if(data.tierLists) tierListsDB = data.tierLists;
                    if(data.guildMembers) guildMembersDB = data.guildMembers;
                    if(data.battleHistory) battleHistoryDB = data.battleHistory;
                    if(data.seasonInfo) currentSeason = data.seasonInfo;
                    if(data.archivedSeasons) archivedSeasons = data.archivedSeasons;
                    if(data.heroSets) heroSetsDB = data.heroSets;

                    alert("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô Cloud ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠");
                    
                    // Save to Cloud & Refresh UI
                    if(USE_CLOUD) await pushData();
                    initApp();
                    
                } catch (err) {
                    alert("‡πÑ‡∏ü‡∏•‡πå Backup ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢: " + err);
                }
            };
            reader.readAsText(file);
        }

        // --- SET MANAGER SKILL LOGIC ---
        function toggleSetSkillQueue(setIdx, slotIdx, skillNum) {
            const set = heroSetsDB[setIdx];
            const skillKey = `${slotIdx}-${skillNum}`; // "0-1"
            
            if (!set.skillQueue) set.skillQueue = [];

            const existIdx = set.skillQueue.indexOf(skillKey);
            if (existIdx > -1) {
                set.skillQueue.splice(existIdx, 1); // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß
            } else {
                if (set.skillQueue.length < 3) {
                    set.skillQueue.push(skillKey); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° 3
                }
            }
            renderSetManager(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        }
        // --- GUILD ANALYTICS ENGINE ---

        function getGlobalAnalytics() {
            let heroStats = {}; // { heroId: { wins: 0, total: 0, teams: { teamId: wins } } }
            let skillStats = {}; // { skillQueueStr: { wins: 0, total: 0 } }

            battleHistoryDB.forEach(log => {
                const isWin = log.result === 'Win';
                
                // 1. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (Hero Performance)
                if (log.playerData) {
                    log.playerData.forEach(p => {
                        if (!heroStats[p.id]) heroStats[p.id] = { wins: 0, total: 0, bestTeam: log.myTeamName };
                        heroStats[p.id].total++;
                        if (isWin) heroStats[p.id].wins++;
                    });
                }

                // 2. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏• (Skill Queue Performance)
                if (log.skillQueue && log.skillQueue.length > 0) {
                    const queueStr = log.skillQueue.join(' > '); // ‡πÄ‡∏ä‡πà‡∏ô "0-2 > 1-1 > 4-2"
                    if (!skillStats[queueStr]) skillStats[queueStr] = { wins: 0, total: 0 };
                    skillStats[queueStr].total++;
                    if (isWin) skillStats[queueStr].wins++;
                }
            });

            // ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Win Rate)
            const topHeroes = Object.keys(heroStats).map(id => ({
                id,
                ...heroStats[id],
                wr: (heroStats[id].wins / heroStats[id].total) * 100
            })).sort((a, b) => b.wr - a.wr || b.wins - a.wins);

            // ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏™‡∏Å‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            const topSkills = Object.keys(skillStats).map(q => ({
                queue: q,
                ...skillStats[q],
                wr: (skillStats[q].wins / skillStats[q].total) * 100
            })).sort((a, b) => b.wr - a.wr);

            return { topHeroes, topSkills };
        }

        function showGlobalStatsModal() {
            const data = getGlobalAnalytics();
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÉ‡∏™‡πà‡πÉ‡∏ô Modal ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ)
            let heroListHTML = data.topHeroes.slice(0, 5).map(h => {
                const hero = heroesDB.find(x => x.id === h.id);
                return `
                    <div class="flex justify-between items-center bg-gray-800/40 p-2 rounded border border-gray-700">
                        <div class="flex items-center gap-2">
                            <img src="${hero?.img}" class="w-8 h-8 rounded-full border border-gray-600">
                            <span class="text-xs font-bold text-white">${hero?.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-green-400 font-bold">${h.wr.toFixed(0)}% WR</div>
                            <div class="text-[8px] text-gray-500">${h.wins}/${h.total} Battles</div>
                        </div>
                    </div>
                `;
            }).join('');

            let skillListHTML = data.topSkills.slice(0, 3).map(s => `
                <div class="bg-black/30 p-2 rounded border border-blue-900/30 mb-2">
                    <div class="text-[9px] text-blue-300 font-mono mb-1">${s.queue}</div>
                    <div class="text-[10px] text-gray-400">‡∏ä‡∏ô‡∏∞ ${s.wins} ‡∏à‡∏≤‡∏Å ${s.total} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${s.wr.toFixed(0)}%)</div>
                </div>
            `).join('');

            // ‡πÉ‡∏ä‡πâ Alert ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ñ‡∏∏‡∏ì
            // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏ú‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á <div> Modal ‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô HTML ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î
            alert(`MVP Heroes:\n${data.topHeroes.slice(0,3).map(h => h.id + ": " + h.wr.toFixed(0) + "%").join('\n')}`);
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏î‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏° (0-60 ‡∏î‡∏≤‡∏ß)
        // ‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å 5 ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 12 ‡∏î‡∏≤‡∏ß (6 ‡∏ü‡πâ‡∏≤ + 6 ‡πÅ‡∏î‡∏á)
        function calculateTotalTeamStars(team) {
            if (!team || !team.slots) return 0;
            let total = 0;
            for (let i = 0; i < 5; i++) {
                const slot = team.slots[i];
                if (slot && slot.star) {
                    total += parseInt(slot.star);
                }
            }
            return total;
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô switchView ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ analytics
        // (‡πÄ‡∏û‡∏¥‡πà‡∏° 'view-analytics' ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ID ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô)
        function renderAnalytics() {
            let internalTotal = 0;
            let externalTotal = 0;
            
            let heroUsage = {};    // ‡∏Æ‡∏µ‡πÇ‡∏£‡πà‡∏Å‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏£‡∏≤
            let petUsage = {};     // ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏Å‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏£‡∏≤
            let enemyHeroUsage = {}; // ‡∏Æ‡∏µ‡πÇ‡∏£‡πà‡∏®‡∏±‡∏ï‡∏£‡∏π
            let enemyPetUsage = {};  // ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π
            let synergyPairs = {}; 
            
            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤ (Guild Members)
            guildMembersDB.forEach(member => {
                member.teams.forEach(team => {
                    if (!team) return;
                    internalTotal++;
                    
                    // ‡∏ô‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤
                    if (team.pet && team.pet.id) {
                        petUsage[team.pet.id] = (petUsage[team.pet.id] || 0) + 1;
                    }

                    let heroesInTeam = [];
                    for (let i = 0; i < 5; i++) {
                        if (team.slots[i]) {
                            const hId = team.slots[i].id;
                            heroesInTeam.push(hId);
                            heroUsage[hId] = (heroUsage[hId] || 0) + 1;
                        }
                    }
                    // Synergy... (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                });
            });

            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ù‡∏±‡πà‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π (War Room Data)
            Object.keys(teamsDB).forEach(key => {
                const team = teamsDB[key];
                if (!team) return;
                
                let teamHasData = false;
                // ‡∏ô‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π
                if (team.pet && team.pet.id) {
                    enemyPetUsage[team.pet.id] = (enemyPetUsage[team.pet.id] || 0) + 1;
                    teamHasData = true;
                }

                for (let i = 0; i < 5; i++) {
                    if (team.slots[i]) {
                        const hId = team.slots[i].id;
                        enemyHeroUsage[hId] = (enemyHeroUsage[hId] || 0) + 1;
                        teamHasData = true;
                    }
                }
                if (teamHasData) externalTotal++;
            });

            // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ---
            const getStatListHTML = (usageObj, db, total, colorClass) => {
                return Object.entries(usageObj)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([id, count]) => {
                        const item = db.find(x => x.id === id);
                        const percent = ((count / (total || 1)) * 100).toFixed(1);
                        return `
                            <div class="flex items-center justify-between p-2 rounded-lg bg-gray-800/40 mb-1 border border-gray-700/50">
                                <div class="flex items-center gap-2">
                                    <img src="${item?.img}" class="w-8 h-8 rounded border border-gray-600 bg-black">
                                    <span class="text-xs text-gray-200 truncate w-24">${item?.name || 'Unknown'}</span>
                                </div>
                                <div class="text-right">
                                    <div class="${colorClass} font-bold text-xs">${percent}%</div>
                                    <div class="text-[8px] text-gray-500">${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                                </div>
                            </div>`;
                    }).join('') || '<div class="text-gray-600 text-center py-4 text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            };

            // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HTML ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
            const internalHeroHTML = getStatListHTML(heroUsage, heroesDB, internalTotal, 'text-green-400');
            const internalPetHTML = getStatListHTML(petUsage, petsDB, internalTotal, 'text-blue-400');
            const externalHeroHTML = getStatListHTML(enemyHeroUsage, heroesDB, externalTotal, 'text-red-400');
            const externalPetHTML = getStatListHTML(enemyPetUsage, petsDB, externalTotal, 'text-orange-400');

            // ‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô Container (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏° ID ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HTML)
            document.getElementById('analytics-content').innerHTML = `
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold text-blue-500 border-l-4 border-blue-500 pl-3">üè† Our Guild Meta</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-[#161b22] p-4 rounded-2xl border border-gray-700 shadow-lg">
                                <h4 class="text-xs font-bold text-gray-400 mb-3 uppercase">Top Heroes</h4>
                                ${internalHeroHTML}
                            </div>
                            <div class="bg-[#161b22] p-4 rounded-2xl border border-gray-700 shadow-lg">
                                <h4 class="text-xs font-bold text-gray-400 mb-3 uppercase">Top Pets</h4>
                                ${internalPetHTML}
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <h3 class="text-xl font-bold text-red-500 border-l-4 border-red-500 pl-3">‚öîÔ∏è Opponent Meta (War Room)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-[#161b22] p-4 rounded-2xl border border-gray-700 shadow-lg">
                                <h4 class="text-xs font-bold text-gray-400 mb-3 uppercase">Top Heroes</h4>
                                ${externalHeroHTML}
                            </div>
                            <div class="bg-[#161b22] p-4 rounded-2xl border border-gray-700 shadow-lg">
                                <h4 class="text-xs font-bold text-gray-400 mb-3 uppercase">Top Pets</h4>
                                ${externalPetHTML}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Init (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤)
        function initSimulator() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ Data ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            if (!window.simData) {
                window.simData = {
                    enemy: { id: 'SIM-ENEMY', name: 'Enemy Team', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
                    attack: [
                        { id: 'SIM-ATK-0', name: 'Attack Team 1', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
                        { id: 'SIM-ATK-1', name: 'Attack Team 2', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
                        { id: 'SIM-ATK-2', name: 'Attack Team 3', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] }
                    ]
                };
            }

            console.log("initSimulator")
            renderSimulatorPool();
            renderSimulatorTeams();
        }

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Drop Logic ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏à‡∏≤‡∏Å Pool ‡∏°‡∏≤‡∏•‡∏á Sim (‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô Object)
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô dragStart ‡πÉ‡∏ô Sim Pool ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á fromType='pool'
        function renderSimulatorPool() {
            console.log("xxx")
            const pool = document.getElementById('sim-hero-pool');
            const search = document.getElementById('sim-hero-search').value.toLowerCase();
            const filtered = heroesDB.filter(h => h.name.toLowerCase().includes(search));
            
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡∏£‡∏á ondragstart ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ dragStart ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡πÉ‡∏™‡πà ID ‡πÄ‡∏õ‡πá‡∏ô 'POOL'
            pool.innerHTML = filtered.map(h => `
                <div class="w-14 h-14 rounded-lg border border-gray-700 overflow-hidden cursor-grab active:cursor-grabbing hover:border-blue-500 hover:scale-110 transition bg-black"
                    draggable="true" ondragstart="dragStart(event, 'POOL', '${h.id}')">
                    <img src="${h.img}" class="w-full h-full object-cover pointer-events-none">
                </div>`).join('');
        }

        function addToSim(heroId) {
            // ‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô 3 ‡∏ó‡∏µ‡∏°
            for (let t = 0; t < 3; t++) {
                for (let p = 0; p < 3; p++) {
                    if (simulatorTeams[t][p] === null) {
                        simulatorTeams[t][p] = heroId;
                        renderSimulatorTeams();
                        renderSimulatorPool();
                        return;
                    }
                }
            }
            alert("‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡∏°‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà");
        }

        function removeFromSim(tIdx, pIdx) {
            simulatorTeams[tIdx][pIdx] = null;
            renderSimulatorTeams();
            renderSimulatorPool();
        }

        // --- 1. RENDER ENEMY (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô 28x28) ---
        function renderSimulatorEnemy() {
            const container = document.getElementById('sim-enemy-slots');
            if(!container) return;
            container.innerHTML = simEnemyTeam.map((hId, pIdx) => {
                const h = hId ? heroesDB.find(x => x.id === hId) : null;
                return `
                    <div class="w-28 h-28 rounded-2xl border-4 ${h ? 'border-red-600 bg-black shadow-[0_0_20px_rgba(220,38,38,0.4)]' : 'border-dashed border-red-900/30 bg-gray-900/30'} flex items-center justify-center cursor-pointer transition relative overflow-hidden group"
                        draggable="true" ondragstart="simDragStart(event, 'enemy', '${hId}', 0, ${pIdx})"
                        ondragover="event.preventDefault()" ondrop="simDrop(event, 'enemy', 0, ${pIdx})" onclick="simClearSlot('enemy', 0, ${pIdx})">
                        ${h ? `<img src="${h.img}" class="w-full h-full object-cover grayscale-[0.2]">` : '<span class="text-red-900/30 text-4xl">?</span>'}
                        ${h ? `<div class="absolute inset-0 bg-red-600/60 opacity-0 group-hover:opacity-100 flex items-center justify-center text-[10px] font-bold text-white transition">REMOVE</div>` : ''}
                    </div>`;
            }).join('');
        }

        // State ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        let ctxTarget = { type: null, tIdx: null, pIdx: null };

        // --- RENDER TEAMS (‡∏õ‡∏£‡∏±‡∏ö Layout: Vertical Center ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á) ---
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Render ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Simulator (FIXED: ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ID ‡∏´‡∏≤‡∏¢)
        function renderSimulatorTeams() {
            // 1. Render Attack Teams (3 ‡∏ó‡∏µ‡∏°)
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Attack Team ‡πÑ‡∏´‡∏°
            if (simData && simData.attack) {
                simData.attack.forEach((team, idx) => {
                    const container = document.getElementById(`sim-team-${idx}`);
                    if (container) {
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô container ‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏•‡∏ö container ‡∏ó‡∏¥‡πâ‡∏á)
                        container.innerHTML = generateSimCardHTML(team, `SIM-ATK-${idx}`, true);
                    }
                });
            }

            // 2. Render Enemy Team (1 ‡∏ó‡∏µ‡∏°)
            const enemyContainer = document.getElementById('sim-enemy-slots');
            if (enemyContainer && simData && simData.enemy) {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Å‡∏≤‡∏£‡πå‡∏î Enemy
                // ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï: ‡πÄ‡∏£‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏á‡πÉ‡∏ô innerHTML ‡∏Ç‡∏≠‡∏á sim-enemy-slots ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö parent
                enemyContainer.innerHTML = generateSimCardHTML(simData.enemy, 'SIM-ENEMY', false);
                
                // ‡∏õ‡∏£‡∏±‡∏ö CSS ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π)
                const card = enemyContainer.firstElementChild;
                if (card) {
                    card.classList.remove('border-gray-800');
                    card.classList.add('border-red-900', 'shadow-[0_0_15px_rgba(127,29,29,0.4)]');
                    
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á
                    const headerBadge = card.querySelector('.bg-blue-900');
                    if (headerBadge) {
                        headerBadge.classList.replace('bg-blue-900', 'bg-red-900');
                        headerBadge.classList.replace('text-blue-200', 'text-red-200');
                    }
                }
            }
        }

        // Helper ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î (Updated: Increased Spacing)
        function generateSimCardHTML(team, teamId, isAttack, readOnly = false) {
            if (!team) {
                team = { name: 'Empty Team', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] };
            }
            if (!team.skillQueue) team.skillQueue = [];
            if (!team.slots) team.slots = {0:null,1:null,2:null,3:null,4:null};

            const fmt = team.formation || 'basic';
            const layout = { 'basic': {b:3,f:2}, 'balanced':{b:2,f:3}, 'attack':{b:4,f:1}, 'defense':{b:1,f:4} }[fmt] || {b:3,f:2};
            let sc = 0;
            const petD = team.pet ? petsDB.find(p=>p.id==team.pet.id) : null;

            const theme = readOnly ? 
                { border: 'border-red-900/50', bg: 'bg-red-900/10', text: 'text-red-200', hl: 'text-red-500', slotBorder: 'border-red-800', slotBg: 'bg-black' } : 
                { border: 'border-gray-700', bg: 'bg-[#161b22]/90', text: 'text-blue-100', hl: 'text-blue-400', slotBorder: 'border-blue-600', slotBg: 'bg-[#0d1117]' };

            // 1. Formation Buttons Logic
            let formationHtml = '';
            
            if (readOnly) {
                formationHtml = `
                    <div class="flex flex-col justify-center items-center w-24 border-r border-dashed border-red-800/30 pr-2 mr-2">
                        <span class="text-[8px] text-red-400 uppercase font-bold mb-1">Formation</span>
                        <span class="text-xs font-black text-red-200 uppercase tracking-widest bg-red-900/40 px-2 py-1 rounded">${fmt.substring(0,3)}</span>
                    </div>`;
            } else {
                // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô (Grid 2x2)
                const formationBtns = ['basic','balanced','attack','defense'].map(f => {
                    const isActive = fmt === f;
                    const activeClass = isActive 
                        ? 'bg-blue-600 border-blue-400 text-white shadow-sm z-10 font-bold ring-1 ring-blue-300' 
                        : 'bg-[#0d1117] border-gray-600 text-gray-500 hover:text-gray-300 hover:border-gray-400';
                    return `<button onclick="updateSimFormation('${teamId}','${f}')" class="w-full py-1 text-[8px] uppercase tracking-wider rounded border transition ${activeClass}">${f.substring(0,3)}</button>`;
                }).join('');

                // ‡∏õ‡∏∏‡πà‡∏° WINNER (‡πÉ‡∏ä‡πâ Style ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ù‡∏±‡πà‡∏á)
                let winnerBtn = '';
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° h-8 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
                const winStyle = "w-full h-8 bg-[#1f2937] hover:bg-yellow-900/20 text-yellow-600 hover:text-yellow-400 border border-gray-700 hover:border-yellow-500 rounded py-1 text-[9px] font-bold uppercase tracking-widest transition flex items-center justify-center gap-2 group shadow-inner";

                if (teamId === 'BW-MY') {
                    winnerBtn = `
                        <button onclick="recordBattleWarResult('Win')" class="${winStyle}">
                            <span class="text-xs group-hover:scale-125 transition">üèÜ</span> WINNER
                        </button>`;
                } else if (teamId === 'BW-ENEMY') {
                    winnerBtn = `
                        <button onclick="recordBattleWarResult('Lose')" class="${winStyle}">
                            <span class="text-xs group-hover:scale-125 transition">üèÜ</span> WINNER
                        </button>`;
                }

                // ‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á (‡πÄ‡∏û‡∏¥‡πà‡∏° mt-4 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏´‡πà‡∏≤‡∏á)
                formationHtml = `
                    <div class="flex flex-col w-28 border-r border-dashed border-gray-700/50 pr-3 mr-2 flex-shrink-0 justify-center items-center py-1">
                        
                        <span class="text-[8px] text-gray-500 font-bold uppercase text-center mb-1.5">Formation</span>
                        
                        <div class="grid grid-cols-2 gap-1 w-full">
                            ${formationBtns}
                        </div>

                        ${winnerBtn ? `
                            <div class="w-full h-px bg-gray-700/50 mt-4 mb-3 border-t border-dashed border-gray-800"></div>
                            
                            ${winnerBtn}
                        ` : ''}

                    </div>`;
            }

            // 2. Queue (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            let queueHtml = `<div class="flex flex-col gap-2 items-center justify-center w-14 border-r border-dashed ${readOnly?'border-red-800/30':'border-gray-700/50'} pr-2 mr-2 flex-shrink-0 py-1"><span class="text-[9px] ${theme.hl} font-bold uppercase tracking-wider transform -rotate-90 md:rotate-0">QUEUE</span><div class="flex flex-col gap-1 items-center">`;
            for(let i=0; i<3; i++) {
                const skillKey = team.skillQueue[i];
                if(skillKey) {
                    const [sIdx, sNum] = skillKey.split('-');
                    const slot = team.slots[sIdx];
                    const hero = slot ? heroesDB.find(h => h.id == slot.id) : null;
                    const imgSrc = (hero && hero.img) ? hero.img : 'https://placehold.co/64x64/black/white?text=?';
                    const skillLabel = sNum === '1' ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô';
                    const funcName = readOnly ? `toggleEnemySkillQueue(${sIdx}, ${sNum})` : `toggleSimSkillQueue('${teamId}', ${sIdx}, ${sNum})`;
                    queueHtml += `<div class="relative w-10 h-10 border ${readOnly?'border-red-500':'border-yellow-600'} rounded bg-black flex-shrink-0 shadow-md cursor-pointer hover:scale-110 transition" onclick="${funcName}"><img src="${imgSrc}" class="w-full h-full object-cover opacity-80" onerror="this.src='https://placehold.co/64x64/black/white?text=ERR'"><div class="absolute bottom-0 right-0 ${readOnly?'bg-red-700':'bg-blue-600'} text-white text-[8px] font-bold px-1 leading-none shadow">${skillLabel}</div><div class="absolute top-0 left-0 bg-red-600 text-white text-[8px] font-bold px-1 rounded-br hover:bg-red-500">√ó</div></div>`;
                } else {
                    queueHtml += `<div class="w-10 h-10 border border-dashed ${readOnly?'border-red-900/50 text-red-800':'border-gray-700 text-gray-600'} rounded flex items-center justify-center text-[10px] flex-shrink-0 font-bold bg-black/20">${i+1}</div>`;
                }
            }
            queueHtml += '</div></div>';

            // 3. Slots (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            const genSimSlot = (p) => {
                const s = team.slots[p];
                const hData = s ? heroesDB.find(x=>x.id==s.id) : null;
                const imgSrc = (hData && hData.img) ? hData.img : 'https://placehold.co/128x128/black/white?text=+'; 
                let inner = '', skillControls = '';

                if(hData) {
                    let ring = '', rCls = ''; if(s.ring) { const r = ringsDB.find(x=>x.id==s.ring); if(r) { ring=`<img src="${r.img}">`; rCls=`equipped grade-${r.grade}`; } }
                    
                    const isS1 = team.skillQueue.includes(`${p}-1`) ? (readOnly?'bg-red-600 text-white border-red-400':'bg-yellow-500 text-black border-yellow-600') : (readOnly?'bg-red-900/20 text-red-800 border-red-900':'bg-[#1f2937] text-gray-500 border-gray-600');
                    const isS2 = team.skillQueue.includes(`${p}-2`) ? (readOnly?'bg-red-600 text-white border-red-400':'bg-yellow-500 text-black border-yellow-600') : (readOnly?'bg-red-900/20 text-red-800 border-red-900':'bg-[#1f2937] text-gray-500 border-gray-600');
                    const funcName = readOnly ? 'toggleEnemySkillQueue' : 'toggleSimSkillQueue';
                    const extraArg = readOnly ? '' : `'${teamId}',`; 

                    skillControls = `<div class="absolute -bottom-5 inset-x-0 mx-auto w-full flex justify-center gap-0.5 z-30 pointer-events-auto"><button onclick="event.stopPropagation(); ${funcName}(${extraArg} ${p}, 2)" class="w-8 h-4 text-[8px] font-bold border rounded-sm ${isS2} flex items-center justify-center shadow-md hover:scale-110 transition">‡∏ö‡∏ô</button><button onclick="event.stopPropagation(); ${funcName}(${extraArg} ${p}, 1)" class="w-8 h-4 text-[8px] font-bold border rounded-sm ${isS1} flex items-center justify-center shadow-md hover:scale-110 transition">‡∏•‡πà‡∏≤‡∏á</button></div>`;

                    if(readOnly) {
                        inner = `<img src="${imgSrc}" class="w-full h-full object-cover rounded-lg select-none grayscale-[0.2]" onerror="this.src='https://placehold.co/128'">${getStarsHTML(s.star, false)}<div class="ring-trigger ${rCls} w-5 h-5 text-[8px] z-20 absolute -top-1 -left-1 shadow-md cursor-default pointer-events-none">${ring||''}</div>`;
                    } else {
                        inner = `<img src="${imgSrc}" class="w-full h-full object-cover rounded-lg pointer-events-none select-none" onerror="this.src='https://placehold.co/128'">${getStarsHTML(s.star, false)}<div class="ring-trigger ${rCls} w-6 h-6 text-[9px] z-20 absolute -top-2 -left-2 shadow-md hover:scale-110 transition" onclick="event.stopPropagation(); openSelector('${teamId}',${p},'ring',event)">${ring||'üíç'}</div>`;
                    }
                } else {
                    inner = `<span class="${readOnly?'text-red-900/30':'text-gray-700/50'} text-3xl select-none font-thin">${readOnly?'?':'+'}</span>`;
                }

                const events = readOnly ? '' : `onclick="openSelector('${teamId}',${p},'hero',event)" oncontextmenu="openContextMenu(event,'${teamId}',${p})" ondragover="allowDrop(event)" ondrop="drop(event,'${teamId}',${p})" draggable="true" ondragstart="dragStart(event,'${teamId}',${p})"`;
                const slotStyle = readOnly ? `border-2 border-red-900/40 bg-black` : `cursor-pointer hover:border-blue-400 hover:shadow-[0_0_15px_rgba(59,130,246,0.3)] bg-[#0d1117] rounded-xl border-2 ${hData?'border-blue-600':'border-dashed border-gray-700'}`;

                return `<div class="relative group flex flex-col items-center mb-6 mx-1" ${readOnly ? `title="${hData?.name||'Empty'}"` : ''}><div class="slot ${hData?'filled':''} w-20 h-20 relative shadow-xl z-10 flex items-center justify-center transition ${slotStyle}" ${events}>${inner}</div>${skillControls}</div>`;
            };

            let slotsBack = '', slotsFront = '';
            for(let i=0; i<layout.b; i++) slotsBack += genSimSlot(sc++);
            for(let i=0; i<layout.f; i++) slotsFront += genSimSlot(sc++);

            // 4. Pet
            const petHtml = `<div class="flex flex-col gap-1 items-center justify-center w-20 border-l border-dashed ${readOnly?'border-red-800/30':'border-gray-700/50'} pl-2 ml-2 flex-shrink-0 pt-1"><span class="text-[9px] ${readOnly?'text-red-400':'text-purple-400'} font-bold tracking-widest">PET</span><div class="pet-slot w-16 h-16 ${petD?'filled':''} shadow-lg border-2 ${petD?(readOnly?'border-red-500':'border-purple-500'):'border-dashed border-gray-600'} rounded-full hover:scale-105 transition bg-[#0d1117] ${readOnly?'cursor-default':'cursor-pointer'}" ${readOnly?'':`onclick="openSelector('${teamId}','pet','pet',event)" oncontextmenu="openContextMenu(event,'${teamId}','pet')"`}>${petD ? `<img src="${petD.img}" class="rounded-full w-full h-full object-cover" onerror="this.src='https://placehold.co/64'">` : `<span class="text-2xl opacity-30 ${readOnly?'text-red-800':'text-purple-300'}">+</span>`}</div></div>`;

            return `
                <div class="${theme.bg} border ${theme.border} rounded-2xl p-3 shadow-2xl relative group w-full h-full flex flex-col">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b ${readOnly?'border-red-900/30':'border-gray-700'} shrink-0">
                        <div class="flex items-center gap-3">
                            <span class="${readOnly?'bg-red-900 text-red-200':'bg-gradient-to-r from-blue-900 to-blue-800 text-blue-100'} text-[10px] px-3 py-0.5 rounded font-bold uppercase tracking-wider shadow-inner">${team.name || (readOnly?'Enemy Team':'My Team')}</span>
                        </div>
                        ${!readOnly ? `<div class="flex items-center gap-2"><button onclick="openLoadSetModal('${teamId}', 0, 0)" class="text-[10px] bg-purple-600 hover:bg-purple-500 text-white border border-purple-400 px-3 py-0.5 rounded transition font-bold uppercase shadow-lg flex items-center gap-1">üìÇ Preset</button><button onclick="clearSimTeam('${teamId}')" class="text-[10px] text-red-400 hover:text-white border border-red-900 px-2 py-0.5 rounded hover:bg-red-900/50 transition">Clear</button></div>` : ''}
                    </div>
                    
                    <div class="flex flex-1 items-stretch justify-center">
                        ${formationHtml} ${queueHtml}
                        <div class="flex-1 flex items-stretch ${readOnly?'bg-black/40 border-red-900/20':'bg-[#0b0e14]/50 border-gray-800'} rounded-xl border shadow-inner overflow-hidden mx-1">
                            <div class="flex-1 flex flex-col items-center justify-center py-2 relative">
                                <div class="flex gap-2 justify-center relative w-full items-center min-h-[90px]"><span class="absolute inset-0 flex items-center justify-center text-5xl font-black ${readOnly?'text-red-900/20':'text-gray-800/20'} uppercase tracking-[0.5em] select-none pointer-events-none transform -rotate-2">BACK</span>${slotsBack}</div>
                                <div class="w-full h-px ${readOnly?'bg-red-900/30 border-red-900/50':'bg-gray-800/50 border-gray-700'} border-t border-dashed my-2 relative"></div>
                                <div class="flex gap-2 justify-center relative w-full items-center min-h-[90px]"><span class="absolute inset-0 flex items-center justify-center text-5xl font-black ${readOnly?'text-red-900/20':'text-gray-800/20'} uppercase tracking-[0.5em] select-none pointer-events-none transform -rotate-2">FRONT</span>${slotsFront}</div>
                            </div>
                        </div>
                        ${petHtml}
                    </div>
                </div>
            `;
        }

        // Action ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Formation
        function updateSimFormation(teamId, fmt) {
            const team = getTeam(teamId);
            if(team) {
                team.formation = fmt;
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏´‡∏ô
                if (teamId === 'PREP-ENEMY' || teamId === 'PREP-MY') renderPreparation();
                else if (teamId === 'BATTLE-TEMP') renderBattleBuilder();
                else if (teamId === 'BW-ENEMY' || teamId === 'BW-MY') renderBattleWar();
                else renderSimulatorTeams();
            }
        }

        function toggleEnemySkillQueue(slotIdx, skillNum) {
            if (activeBattleSlot === null) return;

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏à‡∏≤‡∏Å teamsDB ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const enemyTeam = getTeam(activeBattleSlot); 
            if (!enemyTeam) return;

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Æ‡∏µ‡πÇ‡∏£‡πà‡πÑ‡∏´‡∏°
            if (!enemyTeam.slots[slotIdx] || !enemyTeam.slots[slotIdx].id) {
                // alert("‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Æ‡∏µ‡πÇ‡∏£‡πà"); return; // (Option: ‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ)
                return;
            }

            const skillKey = `${slotIdx}-${skillNum}`;
            
            if (!enemyTeam.skillQueue) enemyTeam.skillQueue = [];

            const existIdx = enemyTeam.skillQueue.indexOf(skillKey);
            if (existIdx > -1) {
                enemyTeam.skillQueue.splice(existIdx, 1); // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
            } else {
                if (enemyTeam.skillQueue.length < 3) {
                    enemyTeam.skillQueue.push(skillKey); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏° 3 ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß)
                    enemyTeam.skillQueue[2] = skillKey;
                }
            }

            // Save ‡∏•‡∏á Database ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤
            triggerAutoSave(); 
            
            // Refresh ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (renderBattleBuilder ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏á)
            renderBattleBuilder();
        }

        function toggleSimSkillQueue(teamId, slotIdx, skillNum) {
            const team = getTeam(teamId);
            const skillKey = `${slotIdx}-${skillNum}`;
            const existIdx = team.skillQueue.indexOf(skillKey);
            if(existIdx > -1) team.skillQueue.splice(existIdx, 1);
            else if(team.skillQueue.length < 3) team.skillQueue.push(skillKey);
            
           // üü¢ ‡πÄ‡∏ä‡πá‡∏Ñ ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏ô‡πâ‡∏≤
            if (teamId === 'PREP-ENEMY' || teamId === 'PREP-MY') renderPreparation();
            else if (teamId === 'BATTLE-TEMP') renderBattleBuilder();
            else if (teamId === 'BW-ENEMY' || teamId === 'BW-MY') renderBattleWar();
            else renderSimulatorTeams();
        }

        // Action ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏µ‡∏°
        function clearSimTeam(teamId) {
        // if(!confirm("Clear this team?")) return;
        const team = getTeam(teamId);
        if(team) {
            team.slots = {0:null,1:null,2:null,3:null,4:null};
            team.pet = null;
            team.skillQueue = [];
            
            if (teamId === 'PREP-ENEMY' || teamId === 'PREP-MY') renderPreparation();
            else if (teamId === 'BATTLE-TEMP') renderBattleBuilder();
            else if (teamId === 'BW-ENEMY' || teamId === 'BW-MY') renderBattleWar(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            else renderSimulatorTeams();
        }
    }

        // --- LOGIC: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏• ---
        function toggleSimSkill(tIdx, pIdx, skillNum) {
            const skillKey = `${pIdx}-${skillNum}`; // ‡∏™‡∏£‡πâ‡∏≤‡∏á Key ‡πÄ‡∏ä‡πà‡∏ô "0-1"
            const queue = simSkillQueues[tIdx];
            
            const existIdx = queue.indexOf(skillKey);
            
            if (existIdx > -1) {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≠‡∏á)
                queue.splice(existIdx, 1);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ï‡πá‡∏° 3 ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
                if (queue.length < 3) {
                    queue.push(skillKey);
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ)
                    // alert("‡∏à‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏•‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏™‡∏Å‡∏¥‡∏•‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°"); 
                }
            }
            renderSimulatorTeams(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        }

        // --- LOGIC ---
        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏° ---
        function simDragStart(e, fromType, heroId, tIdx, pIdx) {
            if (fromType !== 'pool' && (!heroId || heroId === 'null')) { e.preventDefault(); return; }
            simDragData = { fromType, heroId, tIdx, pIdx };
            e.dataTransfer.effectAllowed = 'move';
        }

        function toggleSkillOrder(tIdx, pIdx) {
            simSkillOrder[tIdx][pIdx] = (simSkillOrder[tIdx][pIdx] + 1) % 4;
            renderSimulatorTeams();
        }

       // --- UPDATE: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Queue ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà ---
        function simClearSlot(type, tIdx, pIdx) {
            if (type === 'team') {
                simAttackTeams[tIdx][pIdx] = null;
                // ‡∏•‡∏ö‡∏™‡∏Å‡∏¥‡∏•‡∏Ç‡∏≠‡∏á Slot ‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏î‡πâ‡∏ß‡∏¢
                simSkillQueues[tIdx] = simSkillQueues[tIdx].filter(s => !s.startsWith(`${pIdx}-`));
            } else simEnemyTeam[pIdx] = null;
            initSimulator();
        }

        function resetSimulator() {
            if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                // Reset Data to Default
                simData.enemy = { id: 'SIM-ENEMY', name: 'Enemy Team', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] };
                simData.attack = [
                    { id: 'SIM-ATK-0', name: 'Attack Team 1', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
                    { id: 'SIM-ATK-1', name: 'Attack Team 2', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] },
                    { id: 'SIM-ATK-2', name: 'Attack Team 3', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] }
                ];
                renderSimulatorTeams();
            }
        }

        // Update Drop Logic ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏Å‡∏±‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏°‡∏±‡πà‡∏ß)
        function simDrop(e, toType, toTIdx, toPIdx) {
            e.preventDefault();
            if (!simDragData) return;

            const { fromType, heroId, tIdx, pIdx } = simDragData;
            
            // Check Duplicate ... (‡∏Ñ‡∏á Logic ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ)
            if (toType === 'enemy') {
                if (simEnemyTeam.includes(heroId)) { alert("‡∏Æ‡∏µ‡πÇ‡∏£‡πà‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß"); return; }
            } else if (toType === 'team') {
                if (simAttackTeams[toTIdx].includes(heroId)) { alert(`‡∏Æ‡∏µ‡πÇ‡∏£‡πà‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Attack Team ${toTIdx + 1} ‡πÅ‡∏•‡πâ‡∏ß`); return; }
            }

            let targetId = (toType === 'enemy') ? simEnemyTeam[toPIdx] : simAttackTeams[toTIdx][toPIdx];

            if (fromType === 'pool') {
                if (toType === 'enemy') simEnemyTeam[toPIdx] = heroId;
                if (toType === 'team') simAttackTeams[toTIdx][toPIdx] = heroId;
            } else {
                // Swap Logic
                if (fromType === 'team') {
                    simAttackTeams[tIdx][pIdx] = targetId;
                    // *‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç* ‡∏ñ‡πâ‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏ô‡∏ó‡∏µ‡∏° ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏Å‡∏¥‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏¥‡πâ‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏Å‡∏™‡∏Å‡∏¥‡∏•‡∏Ñ‡πâ‡∏≤‡∏á
                    simSkillQueues[tIdx] = []; 
                }
                if (fromType === 'enemy') simEnemyTeam[pIdx] = targetId;

                if (toType === 'enemy') simEnemyTeam[toPIdx] = heroId;
                if (toType === 'team') {
                    simAttackTeams[toTIdx][toPIdx] = heroId;
                    simSkillQueues[toTIdx] = []; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡∏°‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢
                }
            }

            simDragData = null;
            initSimulator();
        }

        function renderSimulatorStaticUI() {
            const container = document.getElementById('sim-teams-container');
            if(!container) return;
            
            container.innerHTML = [0, 1, 2].map(t => `
                <div class="bg-[#161b22] p-4 rounded-2xl border border-gray-800 shadow-xl relative overflow-hidden group hover:border-blue-500/30 transition">
                    <div class="absolute top-0 left-0 bg-blue-900/50 text-blue-300 text-[9px] px-3 py-0.5 rounded-br font-bold uppercase">Attack Team ${t+1}</div>
                    <div class="flex justify-center gap-2 mt-4" id="sim-team-${t}"></div>
                </div>
            `).join('');
        }
        // --- DATABASE SAVE SYSTEM ---

        async function saveTierListToDB() {
            const btn = document.querySelector('button[onclick="saveTierListToDB()"]');
            showLoading("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

            try {
                // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)
                // ‡∏ï‡∏±‡∏î showLoading() ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏î‡∏≥
                await pushData(); 
                
                hideLoading();

            } catch (error) {
                console.error("Save Error:", error);
                btn.innerHTML = `<span>‚ùå</span> Error`;
                hideLoading();
            } 
        }

        // (‡πÅ‡∏ñ‡∏°) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å DB)
        function loadTierDataFromDB(savedData) {
            if(!savedData) return;

            // 1. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
            if(savedData.structure) {
                activeTiers = savedData.structure.activeTiers;
                tierRankConfigs = savedData.structure.configs;
            }

            // 2. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
            if(savedData.data) {
                tierListsDB[tierViewTab][currentTierMode] = savedData.data;
            }

            // 3. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
            if(savedData.background) setTierBg(savedData.background);

            // 4. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå
            const stickerLayer = document.getElementById('tier-sticker-layer');
            stickerLayer.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
            if(savedData.stickers) {
                savedData.stickers.forEach(s => {
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Sticker ‡πÅ‡∏ö‡∏ö Manual (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö addSticker ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö style ‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏•‡∏¢)
                    const img = document.createElement('img');
                    img.src = s.src;
                    img.className = "sticker-item pointer-events-auto";
                    img.style.top = s.style.top;
                    img.style.left = s.style.left;
                    img.style.width = s.style.width;
                    img.style.transform = s.style.transform;
                    img.dataset.rotation = s.style.rotation;
                    
                    // Attach Events ‡πÄ‡∏î‡∏¥‡∏°
                    img.oncontextmenu = function(e) { e.preventDefault(); e.stopPropagation(); openStickerContextMenu(e, this); };
                    img.onwheel = function(e) { /* ...copy logic‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà... */ }; 
                    img.ondblclick = function() { this.remove(); };
                    
                    makeDraggable(img);
                    stickerLayer.appendChild(img);
                });
            }

            // 5. Render ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà
            renderTierViewer();
        }
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô Script
        function updateRankNameLocal(rankKey, newName) {
            if(!tierRankConfigs[rankKey]) {
                tierRankConfigs[rankKey] = { name: rankKey, color: '#ffffff', opacity: 60, bg: '' };
            }
            tierRankConfigs[rankKey].name = newName;
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Cloud ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô)
            saveLocalTierData();
            renderTierViewer();
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            const floatBtn = document.getElementById('sidebar-floating-btn');
            
            // ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™ collapsed
            sidebar.classList.toggle('collapsed');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢
            if (sidebar.classList.contains('collapsed')) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏ã‡πà‡∏≠‡∏ô -> ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢
                setTimeout(() => { floatBtn.style.display = 'flex'; }, 300); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏∏‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏õ‡∏¥‡∏î -> ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                floatBtn.style.display = 'none';
            }
        }
        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô Script ---
        function handleEnemyNameChange(slotIdx, name) {
            name = name.trim();
            
            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
            updateTeam(slotIdx, 'player', name);

            // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°
            if (name && !knownEnemies.includes(name)) {
                knownEnemies.push(name);
                knownEnemies.sort(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                
                // pushData(); // (Optional) ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏ü‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏á Cloud ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                // ‡πÅ‡∏ï‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏±‡∏ô‡∏à‡∏∞ save ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Save ‡∏´‡∏£‡∏∑‡∏≠ End Round ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Datalist ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                renderDashboard(); 
            }

            triggerAutoSave();
        }
        // --- VERSION CHECK SYSTEM ---
        function checkVersionMismatch(serverVer) {
            // ‡∏ñ‡πâ‡∏≤ Server ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏°‡∏≤ (‡πÄ‡∏õ‡πá‡∏ô Script ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô -> ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
            if (!serverVer || serverVer === SYSTEM_CONFIG.VERSION) return;

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            const msg = `
                <div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm animate-fade-in">
                    <div class="bg-[#161b22] border-2 border-red-600 rounded-2xl p-8 max-w-md text-center shadow-[0_0_50px_rgba(220,38,38,0.5)]">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <h2 class="text-2xl font-bold text-white mb-2">Version Mismatch!</h2>
                        <div class="text-gray-400 text-sm mb-6">
                            ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå HTML ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Code.gs)<br>
                            ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏î‡πâ
                        </div>
                        
                        <div class="bg-black/50 p-4 rounded-lg border border-gray-700 mb-6 grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-[10px] text-gray-500 uppercase font-bold">My Version</div>
                                <div class="text-xl font-bold text-red-400">${SYSTEM_CONFIG.VERSION}</div>
                            </div>
                            <div class="border-l border-gray-700">
                                <div class="text-[10px] text-gray-500 uppercase font-bold">Server Version</div>
                                <div class="text-xl font-bold text-green-400">${serverVer}</div>
                            </div>
                        </div>

                        <button onclick="this.parentElement.parentElement.remove()" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-bold transition w-full">
                            ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö (Close)
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', msg);
        }
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô initApp() ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
        function initInteractionDetectors() {
            // 1. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå Input -> ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            document.addEventListener('input', () => {
                isUserInteracting = true;
                resetInteractionTimer();
            });

            // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á (Drag) -> ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            document.addEventListener('dragstart', () => { isUserInteracting = true; });
            document.addEventListener('dragend', () => { 
                // ‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                setTimeout(() => { isUserInteracting = false; }, 2000); 
            });

            // 3. ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏°‡∏≤‡∏™‡πå (Optional: ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏õ ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ)
            // document.addEventListener('mousemove', () => { ... });
        }

        let interactionTimer;
        function resetInteractionTimer() {
            clearTimeout(interactionTimer);
            // ‡∏ñ‡πâ‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏õ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ)
            interactionTimer = setTimeout(() => {
                isUserInteracting = false;
            }, 3000);
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        function startRealTimeSync() {
            // 1. ‡∏Ü‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ (‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô)
            if (realTimeInterval) clearInterval(realTimeInterval);

            console.log("üîÑ Auto-Sync System Started (Every 10s)");

            // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
            realTimeInterval = setInterval(() => {
                // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -> ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
                if (isUserInteracting || isSaving || isPendingSave) { 
                    console.log("Skipping sync (User busy or Saving)...");
                    return;
                }
                
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå Loading ‡∏à‡∏≠‡∏î‡∏≥)
                fetchCloudData(false);
                
            }, 10000); // 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        }
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        function triggerAutoSave(immediate = false) {
            // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Timer ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á (Debounce)
            if (autoSaveTimer) clearTimeout(autoSaveTimer);

            isPendingSave = true;

            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡πÄ‡∏õ‡πá‡∏ô "Pending..." (‡∏™‡∏µ‡∏™‡πâ‡∏°/‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö)
            const badge = document.getElementById('sync-status');
            const statusText = document.getElementById('status-text');
            
            if(badge && statusText) { 
                badge.className = 'sync-badge loading'; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å CSS animation
                statusText.innerText = 'Pending...';    // ‡∏ö‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤‡∏£‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            }

            // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏á (‡∏ñ‡πâ‡∏≤‡∏Å‡∏î Save ‡πÄ‡∏•‡∏¢ = 0ms, ‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡∏π‡πà = 3000ms)
            const delay = immediate ? 0 : 3000; 

            autoSaveTimer = setTimeout(() => {
                // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ immediate ‡πÑ‡∏õ‡∏ö‡∏≠‡∏Å pushData ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå Loading ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÑ‡∏´‡∏°
                pushData(immediate); 
            }, delay);
        }
        // --- LOCAL TIER LIST SYSTEM ---

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Tier List ‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Server)
        function saveLocalTierData() {
            localStorage.setItem('7k_local_tier_db', JSON.stringify(tierListsDB));
            localStorage.setItem('7k_local_tier_struct', JSON.stringify(activeTiers));
            localStorage.setItem('7k_local_tier_conf', JSON.stringify(tierRankConfigs));
            // ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å pushData() ‡∏´‡∏£‡∏∑‡∏≠ triggerAutoSave()
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î Tier List ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        function loadLocalTierData() {
            const localDB = localStorage.getItem('7k_local_tier_db');
            const localStruct = localStorage.getItem('7k_local_tier_struct');
            const localConf = localStorage.getItem('7k_local_tier_conf');

            if (localDB) tierListsDB = JSON.parse(localDB);
            else tierListsDB = { hero: { pvp: {}, pve: {}, farming: {} }, pet: { pvp: {}, pve: {}, farming: {} } };

            if (localStruct) {
                activeTiers = JSON.parse(localStruct);
            } else {
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å ['S', 'A'...] ‡πÄ‡∏õ‡πá‡∏ô [] (‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
                activeTiers = []; 
            }

            if (localConf) {
                tierRankConfigs = JSON.parse(localConf);
            } else {
                tierRankConfigs = {};
            }
        }
        // --- 4. Render Checkbox Logic ---
        function renderPermissionCheckboxes(userPerms = []) {
            const container = document.getElementById('permission-container');
            container.innerHTML = '';

            ALL_MENUS.forEach(menu => {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î Add (userPerms ‡∏ß‡πà‡∏≤‡∏á) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Default ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î Edit ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ userPerms ‡∏°‡∏µ id ‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°
                const isChecked = (userPerms.length > 0 || userPerms.includes('*')) 
                    ? userPerms.includes(menu.id) 
                    : menu.default;

                container.innerHTML += `
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-white/5 p-1.5 rounded transition select-none">
                        <input type="checkbox" class="perm-check accent-green-500 w-4 h-4" value="${menu.id}" ${isChecked ? 'checked' : ''}>
                        <span class="text-xs text-gray-300">${menu.label}</span>
                    </label>
                `;
            });
        }
        function toggleAllPermissions(check) {
            document.querySelectorAll('.perm-check').forEach(cb => cb.checked = check);
        }
        function analyzeTypeCounters() {
            let typeStats = {}; // { playerType_vs_enemyType: { wins: 0, total: 0 } }

            battleHistoryDB.forEach(log => {
                const isWin = log.result === 'Win';
                
                // ‡∏î‡∏∂‡∏á Type ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ï‡∏µ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
                const myTypes = (log.playerIds || []).map(id => {
                    const h = heroesDB.find(x => x.id === id);
                    return h ? h.type : 'Unknown';
                });

                // ‡∏î‡∏∂‡∏á Type ‡∏Ç‡∏≠‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
                const enemyTypes = (log.enemyIds || []).map(id => {
                    const h = heroesDB.find(x => x.id === id);
                    return h ? h.type : 'Unknown';
                });

                // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ï‡∏µ‡πÄ‡∏õ‡πá‡∏ô '‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û' ‡πÑ‡∏õ‡πÄ‡∏à‡∏≠‡∏®‡∏±‡∏ï‡∏£‡∏π '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô' ‡πÅ‡∏•‡πâ‡∏ß‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)
                myTypes.forEach(mType => {
                    enemyTypes.forEach(eType => {
                        const key = `${mType}_vs_${eType}`;
                        if (!typeStats[key]) typeStats[key] = { wins: 0, total: 0 };
                        typeStats[key].total++;
                        if (isWin) typeStats[key].wins++;
                    });
                });
            });

            return typeStats;
        }
        function calculateBestCounterTypes(enemyHeroIds) {
            // 1. ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ä‡∏∏‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÑ‡∏õ‡∏ï‡∏µ
            const currentEnemyTypes = enemyHeroIds.map(id => {
                const h = heroesDB.find(x => x.id === id);
                return h ? h.type : 'Unknown';
            }).filter(t => t !== 'Unknown');

            // 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History) ‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà "‡∏ä‡∏ô‡∏∞" ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∞‡πÑ‡∏£
            let winTypeStats = {}; // { MyType: winCount }

            battleHistoryDB.forEach(log => {
                if (log.result === 'Win' && log.enemyData && log.playerData) {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏à‡∏≠‡πÑ‡∏´‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß)
                const logEnemyTypes = log.enemyData.map(e => e.type);
                const hasSimilarEnemy = currentEnemyTypes.some(t => logEnemyTypes.includes(t));

                if (hasSimilarEnemy) {
                    // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á ‡∏Å‡πá‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏±‡πâ‡∏ô
                    log.playerData.forEach(p => {
                        if (p.type) {
                            winTypeStats[p.type] = (winTypeStats[p.type] || 0) + 1;
                        }
                    });
                }
            }
        });

        // 3. ‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ä‡∏ô‡∏∞‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
        const sortedTypes = Object.entries(winTypeStats)
            .sort((a, b) => b[1] - a[1]) // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏ô‡∏∞‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
            .map(entry => entry[0]);

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
        return sortedTypes.slice(0, 2); 
    }

    function filterGuildMemberUI(text) {
        const term = text.toLowerCase();
        const list = document.getElementById('guild-member-list');
        const items = list.querySelectorAll('div[onclick^="selectGuildMember"]'); // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Row ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å

        items.forEach(el => {
            // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÉ‡∏ô Element (‡∏°‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô div class="truncate")
            const nameEl = el.querySelector('.truncate');
            if (nameEl) {
                const name = nameEl.innerText.toLowerCase();
                // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á (flex), ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô (none)
                el.style.display = name.includes(term) ? 'flex' : 'none';
            }
        });
    }

    // --- 3. toggleBattleEnemyView: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ç‡πâ‡∏≠ 4) ---
    function toggleBattleEnemyView() {
        const panel = document.getElementById('battle-enemy-panel');
        const lbl = document.getElementById('lbl-toggle-enemy');
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Class ‡∏ß‡πà‡∏≤‡∏°‡∏µ enemy-panel-hidden ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (panel.classList.contains('enemy-panel-hidden')) {
            // ‡∏ñ‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà -> ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á
            panel.classList.remove('enemy-panel-hidden');
            if(lbl) lbl.innerText = "Hide Enemy";
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà -> ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô
            panel.classList.add('enemy-panel-hidden');
            if(lbl) lbl.innerText = "Show Enemy";
        }
    }

    function switchSeasonData(val) {
        viewingSeasonMode = val;
        
        if (val === 'current') {
            activeHistoryData = [...battleHistoryDB];
        } else {
            const idx = parseInt(val);
            if (archivedSeasons[idx]) {
                activeHistoryData = [...archivedSeasons[idx].logs];
            } else {
                activeHistoryData = [];
            }
        }
        
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        renderGuildResultMode(); 
    }

    function renderGuildResultMode() {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown Options (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ Archive ‡πÉ‡∏´‡∏°‡πà)
            const selector = document.getElementById('season-selector');
            if (selector && selector.options.length === 1 && archivedSeasons.length > 0) {
                archivedSeasons.forEach((season, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.text = `üìú Season ${season.seasonId} (${season.opponent})`;
                    selector.add(opt);
                });
            }

            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Data ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Current ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            if (viewingSeasonMode === 'current') activeHistoryData = battleHistoryDB;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏ô Season ‡∏ô‡∏±‡πâ‡∏ô
            const totalWins = activeHistoryData.filter(l => l.result === 'Win').length;
            const totalFights = activeHistoryData.length;
            const winRate = totalFights > 0 ? ((totalWins/totalFights)*100).toFixed(0) : 0;
            document.getElementById('total-gw-stat').innerText = `WR: ${winRate}% (${totalWins}/${totalFights})`;

            // Render ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
            const list = document.getElementById('guild-member-list');
            list.innerHTML = '';

            guildMembersDB.forEach((mem, idx) => {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏à‡∏≤‡∏Å activeHistoryData
                const logs = activeHistoryData.filter(l => l.myTeamId && l.myTeamId.startsWith(`G-${idx}-`));
                const wins = logs.filter(l => l.result === 'Win').length;
                const total = logs.length;
                const wr = total > 0 ? ((wins/total)*100).toFixed(0) : 0;
                
                // Color Logic
                const wrColor = wr >= 80 ? 'text-green-400' : (wr >= 50 ? 'text-blue-400' : 'text-red-400');
                const activeClass = (idx === currentMemberIdx) ? 'bg-blue-900/40 border-blue-500' : 'bg-[#161b22] border-transparent hover:bg-[#1f2937]';

                list.innerHTML += `
                    <div onclick="selectMemberResult(${idx})" class="p-3 rounded border cursor-pointer flex justify-between items-center transition ${activeClass} group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-[#0d1117] flex items-center justify-center text-xs font-bold text-gray-500 border border-gray-700 group-hover:border-gray-500">
                                ${idx+1}
                            </div>
                            <div>
                                <div class="font-bold text-sm text-gray-200 group-hover:text-white truncate w-28">${mem.name}</div>
                                <div class="text-[9px] text-gray-500">
                                    Used: <span class="${total>=5?'text-red-400':'text-green-400'} font-bold">${total}/5</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-black ${wrColor}">${wr}%</div>
                            <div class="text-[8px] text-gray-600">${wins}W - ${total-wins}L</div>
                        </div>
                    </div>
                `;
            });

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢
            if (currentMemberIdx !== null) {
                renderMemberBattleHistory(currentMemberIdx);
            }
        }

        function selectMemberResult(idx) {
            currentMemberIdx = idx;
            renderGuildResultMode(); // Refresh list to update active highlight
            renderMemberBattleHistory(idx);
        }

        // 4. Render ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Compact Version: ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á)
        function renderMemberBattleHistory(idx) {
            const mem = guildMembersDB[idx];
            const logs = activeHistoryData.filter(l => l.myTeamId && l.myTeamId.startsWith(`G-${idx}-`));
            
            // Header Info
            const header = document.getElementById('member-history-header');
            header.classList.remove('hidden');
            document.getElementById('hist-mem-icon').innerText = idx + 1;
            document.getElementById('hist-mem-name').innerText = mem.name;
            
            const wins = logs.filter(l => l.result === 'Win').length;
            document.getElementById('hist-mem-summary').innerHTML = `<span class="text-green-400 font-bold">${wins} Wins</span> / <span class="text-red-400 font-bold">${logs.length - wins} Losses</span> (Total ${logs.length} Battles)`;

            const container = document.getElementById('member-history-content');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-600">
                        <div class="text-4xl mb-2 grayscale">‚öîÔ∏è</div>
                        <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÉ‡∏ô Season ‡∏ô‡∏µ‡πâ</div>
                    </div>`;
                return;
            }

            // Generate Cards
            container.innerHTML = logs.map((log, i) => {
                const isWin = log.result === 'Win';
                const statusColor = isWin ? 'border-green-600/50 bg-green-900/10' : 'border-red-600/50 bg-red-900/10';
                
                // Badge ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á)
                const badge = isWin 
                    ? '<span class="bg-green-600 text-white px-2 py-0.5 rounded font-black text-[10px] shadow-lg transform rotate-[-2deg] tracking-wider">VICTORY</span>' 
                    : '<span class="bg-red-600 text-white px-2 py-0.5 rounded font-black text-[10px] shadow-lg transform rotate-[2deg] tracking-wider">DEFEAT</span>';

                // üü¢ HELPER: ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô w-11 h-11 = 44px)
                const genIcons = (data, isEnemy) => {
                    if (!data) return '';
                    return data.map(p => {
                        const h = heroesDB.find(x => x.id === p.id);
                        if (!h) return '';
                        const starBadge = p.star ? `<div class="absolute -bottom-1 -right-1 bg-black text-yellow-500 text-[8px] px-0.5 rounded border border-gray-700 font-bold shadow-sm leading-none">${p.star}‚òÖ</div>` : '';
                        return `
                            <div class="relative w-11 h-11 rounded-lg border ${isEnemy?'border-red-900/60':'border-blue-900/60'} bg-black shadow-md hover:scale-105 transition" title="${h.name}">
                                <img src="${h.img}" class="w-full h-full object-cover rounded-lg opacity-100 ${isEnemy?'grayscale-[0.2]':''}">
                                ${starBadge}
                            </div>
                        `;
                    }).join('');
                };

                // üü¢ HELPER: ‡∏£‡∏π‡∏õ‡∏™‡∏Å‡∏¥‡∏• (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô w-9 h-9 = 36px)
                const genSkillTimeline = (queue) => {
                    if (!queue || queue.length === 0) return '';
                    
                    return queue.map((q, idx) => {
                        const [sIdx, sNum] = q.split('-');
                        let heroImg = '';
                        if (log.playerData && log.playerData[sIdx]) {
                             const h = heroesDB.find(x => x.id === log.playerData[sIdx].id);
                             if(h) heroImg = h.img;
                        }

                        const label = sNum === '1' ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô';
                        const colorClass = sNum === '1' ? 'bg-blue-600 border-blue-400' : 'bg-yellow-500 text-black border-yellow-400';

                        return `
                            <div class="flex items-center">
                                <div class="relative w-9 h-9 rounded-md border border-gray-600 bg-black flex-shrink-0 group overflow-hidden shadow-sm">
                                    <img src="${heroImg}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" onerror="this.src='https://placehold.co/48x48/black/white?text=?'">
                                    
                                    <div class="absolute top-0 left-0 bg-black/80 text-white text-[8px] font-bold px-1 rounded-br border-r border-b border-gray-600 leading-none">
                                        ${idx+1}
                                    </div>

                                    <div class="absolute bottom-0 right-0 ${colorClass} text-[7px] font-bold px-1 leading-none shadow-sm border-t border-l">
                                        ${label}
                                    </div>
                                </div>
                                ${idx < queue.length - 1 ? '<div class="text-gray-600 mx-1 text-xs">‚ûú</div>' : ''}
                            </div>
                        `;
                    }).join('');
                };

                return `
                    <div class="mb-3 rounded-lg border ${statusColor} bg-[#161b22] relative overflow-hidden shadow-md animate-fade-in-up">
                        
                        <div class="flex justify-between items-center px-3 py-1.5 bg-black/20 border-b border-white/5">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-gray-400 bg-gray-800 px-1.5 rounded">Battle #${i+1}</span>
                                <span class="text-[10px] text-blue-300 font-bold">@ ${log.castle || 'Unknown'} (Slot ${log.castleSlot})</span>
                            </div>
                            <div class="text-[9px] text-gray-500">${log.date}</div>
                        </div>

                        <div class="p-3 flex items-center justify-between gap-2 bg-black/5">
                            
                            <div class="flex-1 flex flex-col items-center md:items-start">
                                <div class="text-[9px] text-blue-400 font-bold mb-1 uppercase tracking-wider flex items-center gap-1">
                                    <span>${log.myTeamName || 'My Team'}</span>
                                    <span class="text-yellow-500 bg-yellow-900/30 px-1 rounded border border-yellow-700/50 text-[8px]">‚òÖ${log.myTeamStars||'?'}</span>
                                </div>
                                <div class="flex gap-1 flex-wrap justify-center md:justify-start">
                                    ${genIcons(log.playerData, false)}
                                    ${log.myPet ? `<div class="w-11 h-11 rounded-full border-2 border-purple-500/50 bg-black p-0.5 shadow-sm"><img src="${(petsDB.find(p=>p.id==log.myPet.id)||{}).img}" class="w-full h-full rounded-full object-cover"></div>` : ''}
                                </div>
                            </div>

                            <div class="flex flex-col items-center justify-center px-1">
                                <div class="text-lg font-black italic text-gray-700/30 mb-1 select-none">VS</div>
                                ${badge}
                            </div>

                            <div class="flex-1 flex flex-col items-center md:items-end">
                                <div class="text-[9px] text-red-400 font-bold mb-1 uppercase tracking-wider flex items-center gap-1">
                                    <span class="text-red-400 bg-red-900/30 px-1 rounded border border-red-700/50 text-[8px]">‚òÖ${log.enemyTeamStars||'?'}</span>
                                    <span>${log.enemyName || 'Enemy'}</span>
                                </div>
                                <div class="flex gap-1 flex-wrap justify-center md:justify-end">
                                    ${log.enemyPet ? `<div class="w-11 h-11 rounded-full border-2 border-red-500/50 bg-black p-0.5 shadow-sm"><img src="${(petsDB.find(p=>p.id==log.enemyPet.id)||{}).img}" class="w-full h-full rounded-full object-cover"></div>` : ''}
                                    ${genIcons(log.enemyData, true)}
                                </div>
                            </div>
                        </div>

                        ${log.skillQueue && log.skillQueue.length > 0 ? `
                        <div class="px-3 py-2 bg-black/30 border-t border-white/5 flex items-center gap-3">
                            <div class="flex items-center gap-1">
                                <span class="text-sm">‚ö°</span>
                                <span class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Sequence:</span>
                            </div>
                            <div class="flex flex-wrap items-center">
                                ${genSkillTimeline(log.skillQueue)}
                            </div>
                        </div>` : ''}

                    </div>
                `;
            }).join('');
        }

    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderPreparation ‡πÄ‡∏î‡∏¥‡∏°
    function renderPreparation() {
        // 1. Render Enemy (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ = true)
        // param ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ false = ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ReadOnly (‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)
        const enemyHTML = generateSimCardHTML(prepData.enemy, 'PREP-ENEMY', false, false);
        document.getElementById('prep-enemy-area').innerHTML = enemyHTML;

        // 2. Render My Team (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ = true)
        const myHTML = generateSimCardHTML(prepData.my, 'PREP-MY', true, false);
        document.getElementById('prep-my-area').innerHTML = myHTML;

        // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI
        analyzePreparationBattle();
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Unified Logic: Who beat this team?)
    function analyzePreparationBattle() {
        const panel = document.getElementById('prep-ai-panel');
        
        // 1. ‡∏î‡∏∂‡∏á ID ‡∏Ç‡∏≠‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π (Target Team)
        const targetIds = [];
        for(let i=0; i<5; i++) {
            if(prepData.enemy.slots[i]) targetIds.push(prepData.enemy.slots[i].id);
        }
        
        // 2. ‡∏î‡∏∂‡∏á ID ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡πÄ‡∏£‡∏≤ (Drafting Team)
        const myDraftIds = [];
        for(let i=0; i<5; i++) if(prepData.my.slots[i]) myDraftIds.push(prepData.my.slots[i].id);

        if (targetIds.length === 0) {
            panel.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-gray-500 opacity-60">
                    <span class="text-6xl mb-4">üïµÔ∏è</span>
                    <div class="text-sm font-bold">Waiting for Enemy Data...</div>
                    <div class="text-xs">‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ù‡∏±‡πà‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
                </div>`;
            return;
        }

        // =========================================================
        // üß† AI PROCESSING (UNIFIED LOGIC)
        // =========================================================
        
        let totalRelevantLogs = 0;
        
        // Stats Containers
        let counterStats = {};          // ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞ Target ‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î
        let skillPreference = {};       // ‡∏™‡∏Å‡∏¥‡∏•‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÉ‡∏ä‡πâ
        let teamSequenceStats = {};     // ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞
        let specificCounterStats = {};  // Target ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ ‡πÅ‡∏û‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î

        // Init Specific Stats
        targetIds.forEach(eid => specificCounterStats[eid] = {});

        // --- Analyze Logs ---
        battleHistoryDB.forEach(log => {
            let winnerIds = [];
            let loserIds = [];
            let winnerSkillQueue = [];
            let winnerData = []; // ‡πÄ‡∏Å‡πá‡∏ö playerData ‡∏´‡∏£‡∏∑‡∏≠ enemyData ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞

            // 1. ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞/‡∏ú‡∏π‡πâ‡πÅ‡∏û‡πâ
            if (log.result === 'Win') {
                // ‡πÄ‡∏£‡∏≤‡∏ä‡∏ô‡∏∞
                winnerIds = log.playerIds || [];
                loserIds = log.enemyIds || [];
                winnerSkillQueue = log.skillQueue || [];
                winnerData = log.playerData || [];
            } else {
                // ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ä‡∏ô‡∏∞ (‡πÄ‡∏£‡∏≤‡πÅ‡∏û‡πâ)
                winnerIds = log.enemyIds || [];
                loserIds = log.playerIds || [];
                winnerSkillQueue = log.enemySkillQueue || []; // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ field ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô log ‡πÉ‡∏´‡∏°‡πà‡πÜ
                winnerData = log.enemyData || [];
            }

            // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ "‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡πâ" ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏ô‡πÉ‡∏à (Target) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
            // (‡∏ô‡∏±‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏à‡∏≠ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Target ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß)
            const targetInLoser = targetIds.some(tid => loserIds.includes(tid));

            if (targetInLoser) {
                totalRelevantLogs++;

                // --- üü¢ ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ "‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞" (The Counter Team) ---
                
                // A. ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Hero (Global & Specific Counter)
                winnerIds.forEach(wId => {
                    // Global Stats
                    if (!counterStats[wId]) counterStats[wId] = { wins: 0 };
                    counterStats[wId].wins++;

                    // Specific Stats: ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ä‡∏ô‡∏∞ Target ‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ô‡∏µ‡πâ
                    loserIds.forEach(lId => {
                        if (targetIds.includes(lId)) { // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÅ‡∏û‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
                            if (!specificCounterStats[lId]) specificCounterStats[lId] = {};
                            if (!specificCounterStats[lId][wId]) specificCounterStats[lId][wId] = 0;
                            specificCounterStats[lId][wId]++;
                        }
                    });
                });

                // B. ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Skill & Sequence ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞
                // ‡∏ï‡πâ‡∏≠‡∏á Map ‡∏à‡∏≤‡∏Å Slot -> HeroID ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞
                if (winnerSkillQueue && winnerSkillQueue.length > 0) {
                    let extractedMoves = [];

                    winnerSkillQueue.forEach(sq => {
                        const [sIdx, sNum] = sq.split('-');
                        
                        // ‡∏´‡∏≤ Hero ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Slot Index
                        // (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á: winnerData ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á 0-4 ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ö‡∏ö Compact)
                        // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ winnerData ‡πÄ‡∏Å‡πá‡∏ö object {id, star} ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö slot ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ id
                        
                        let hId = null;
                        // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ ID ‡∏à‡∏≤‡∏Å winnerData (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠ winnerIds
                        if (winnerData[sIdx] && winnerData[sIdx].id) hId = winnerData[sIdx].id;
                        else if (winnerIds[sIdx]) hId = winnerIds[sIdx];

                        if (hId) {
                            // 1. Skill Preference (‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á Draft ‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
                            if (myDraftIds.includes(hId)) {
                                if (!skillPreference[hId]) skillPreference[hId] = { s1: 0, s2: 0 };
                                if (sNum === '1') skillPreference[hId].s1++; else skillPreference[hId].s2++;
                            }
                            
                            // 2. ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Sequence ‡∏£‡∏ß‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤ Draft)
                            if (myDraftIds.includes(hId)) {
                                extractedMoves.push(`${hId}:${sNum}`);
                            }
                        }
                    });

                    // Smart Combo (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                    if (extractedMoves.length > 0) {
                        const finalSeqStr = extractedMoves.slice(0, 3).join('|');
                        if (!teamSequenceStats[finalSeqStr]) teamSequenceStats[finalSeqStr] = 0;
                        teamSequenceStats[finalSeqStr]++;
                    }
                }
            }
        });

        // =========================================================
        // üìä DISPLAY GENERATION
        // =========================================================

        // 1. Guild Win Rate (‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
        // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡∏î‡∏π "‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà Target ‡πÅ‡∏û‡πâ" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô Win Rate ‡∏à‡∏∂‡∏á‡πÄ‡∏õ‡πá‡∏ô 100% ‡∏Ç‡∏≠‡∏á Dataset ‡∏ô‡∏µ‡πâ
        // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡πÄ‡∏£‡∏≤‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà Target ‡πÅ‡∏û‡πâ‡πÅ‡∏ó‡∏ô
        const totalDefeats = totalRelevantLogs;
        
        // üèÜ Best Counters (Top 5 Heroes ‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞ Target ‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ù‡∏±‡πà‡∏á‡πÑ‡∏´‡∏ô)
        const bestHeroesHTML = Object.keys(counterStats)
            .map(id => ({ id, ...counterStats[id] }))
            .sort((a,b) => b.wins - a.wins)
            .slice(0, 5)
            .map(h => {
                const hero = heroesDB.find(x => x.id === h.id);
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡∏ß‡πà‡∏≤‡∏ä‡∏ô‡∏∞‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á Target
                const winRate = ((h.wins / totalDefeats) * 100).toFixed(0);
                
                return hero ? `
                    <div class="flex flex-col items-center group relative min-w-[50px]">
                        <div class="relative">
                            <img src="${hero.img}" class="w-10 h-10 rounded-lg border border-green-500/50 bg-black object-cover cursor-help">
                            <div class="absolute -top-2 -right-2 bg-green-900 text-green-100 text-[8px] px-1 rounded-full border border-green-600 font-bold">${h.wins}</div>
                        </div>
                        <span class="text-[9px] text-green-300 font-bold mt-1">${winRate}% Freq</span>
                        <div class="absolute bottom-full mb-1 hidden group-hover:block bg-gray-900 text-white text-[10px] p-2 rounded border border-gray-600 whitespace-nowrap z-50 shadow-xl">
                            ${hero.name}<br>Found in winning team ${h.wins} times
                        </div>
                    </div>` : '';
            }).join('');

        // ‚ö° Weakness Analysis (Specific Counters)
        let breakdownHTML = `<div class="space-y-1 mt-2 max-h-56 overflow-y-auto custom-scroll pr-1">`;
        targetIds.forEach(eId => {
            const enemyHero = heroesDB.find(x => x.id === eId);
            const lostToStats = specificCounterStats[eId];
            if (!lostToStats || Object.keys(lostToStats).length === 0) return;
            const topKillerId = Object.keys(lostToStats).sort((a,b) => lostToStats[b] - lostToStats[a])[0];
            const topKiller = heroesDB.find(x => x.id === topKillerId);
            const killCount = lostToStats[topKillerId];
            if (topKiller) {
                breakdownHTML += `
                    <div class="flex justify-between items-center bg-[#1f2937] p-2 rounded border border-gray-700/50 text-[10px]">
                        <div class="flex items-center gap-2">
                            <img src="${enemyHero?.img}" class="w-10 h-10 rounded border border-red-500/50 opacity-80 object-cover">
                            <span class="text-red-300 w-16 truncate">${enemyHero?.name}</span>
                        </div>
                        <div class="text-gray-600 font-bold text-xs">‡πÅ‡∏û‡πâ‡πÉ‡∏´‡πâ</div>
                        <div class="flex items-center gap-2 justify-end">
                            <span class="text-green-300 w-16 truncate text-right">${topKiller.name}</span>
                            <div class="relative">
                                <img src="${topKiller.img}" class="w-10 h-10 rounded border border-green-500/50 object-cover">
                                <div class="absolute -top-1 -right-1 bg-green-900 text-[8px] px-1.5 rounded-full text-white border border-green-700 font-bold shadow-sm">${killCount}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        breakdownHTML += `</div>`;

        // üü¢ 4. SMART COMBO (Winning Sequence from Combined Data)
        let comboHTML = '';
        if (myDraftIds.length > 0) {
            const sortedSeqs = Object.entries(teamSequenceStats).sort((a,b) => b[1] - a[1]);
            
            if (sortedSeqs.length > 0) {
                const bestSeqStr = sortedSeqs[0][0]; 
                const winCount = sortedSeqs[0][1];
                
                const stepsHTML = bestSeqStr.split('|').map((step, idx) => {
                    const [hid, sNum] = step.split(':');
                    const hero = heroesDB.find(h => h.id === hid);
                    const label = sNum === '1' ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô';
                    const colorClass = sNum === '1' ? 'bg-blue-600' : 'bg-yellow-500 text-black';
                    return `
                        <div class="flex flex-col items-center relative group mx-1">
                            <div class="absolute -top-2 -left-2 bg-gray-800 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center border border-gray-500 font-bold z-20 shadow-md">${idx+1}</div>
                            <div class="relative w-12 h-12 rounded-xl border-2 border-gray-600 bg-black shadow-lg overflow-hidden">
                                <img src="${hero?.img}" class="w-full h-full object-cover opacity-90">
                            </div>
                            <div class="${colorClass} text-[9px] font-bold px-2 py-0.5 rounded -mt-2.5 z-10 shadow-lg border uppercase tracking-wider relative">${label}</div>
                        </div>
                    `;
                }).join('<div class="text-gray-500 mx-1 text-xl font-bold">‚ûú</div>');

                comboHTML = `
                    <div class="bg-gradient-to-r from-blue-900/20 to-purple-900/20 p-4 rounded-2xl border border-blue-500/30 mt-4 shadow-inner">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üíé</span>
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-blue-300 font-bold uppercase tracking-widest leading-none">Best Winning Sequence</span>
                                    <span class="text-[8px] text-gray-400 leading-none mt-0.5">Top 3 skills form ${winCount} successful matches</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-center bg-[#0b0e14]/60 p-3 rounded-xl border border-gray-700/50">
                            ${stepsHTML}
                        </div>
                    </div>
                `;
            } else {
                comboHTML = `<div class="text-center text-[10px] text-gray-600 mt-4 py-3 border-2 border-dashed border-gray-800 rounded-xl">No combined history found for this draft</div>`;
            }
        } else {
            comboHTML = `<div class="text-center text-[10px] text-gray-500 mt-4 py-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Combo</div>`;
        }

        // 5. INDIVIDUAL SKILL (Skill Priority from Combined Data)
        let skillRecHTML = '';
        if (myDraftIds.length > 0) {
            const listItems = myDraftIds.map(mid => {
                const pref = skillPreference[mid];
                const hero = heroesDB.find(h => h.id === mid);
                
                if (!pref || (pref.s1 === 0 && pref.s2 === 0)) return null;

                const total = pref.s1 + pref.s2;
                const s1Per = (pref.s1 / total) * 100;
                const isS1Better = s1Per >= 50;
                const label = isS1Better ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô';
                const percent = isS1Better ? s1Per : (100 - s1Per);
                const color = isS1Better ? 'bg-blue-600' : 'bg-yellow-500 text-black';

                return `
                    <div class="flex items-center justify-between bg-[#1f2937] p-2 rounded border border-gray-700 mb-1">
                        <div class="flex items-center gap-2">
                            <img src="${hero.img}" class="w-10 h-10 rounded border border-gray-600 bg-black object-cover">
                            <span class="text-[10px] text-gray-300 font-bold">${hero.name}</span>
                        </div>
                        <div class="${color} text-[8px] font-bold px-2 py-1 rounded shadow min-w-[50px] text-center">
                            ${label} ${percent.toFixed(0)}%
                        </div>
                    </div>
                `;
            }).filter(x=>x).join('');

            if (listItems) {
                skillRecHTML = `
                    <div class="mt-4">
                        <div class="text-[10px] text-purple-400 font-bold uppercase mb-2">‚ö° Individual Priority (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå)</div>
                        <div class="space-y-1 max-h-48 overflow-y-auto custom-scroll pr-1">${listItems}</div>
                    </div>
                `;
            }
        }

        // --- RENDER FINAL ---
        panel.innerHTML = `
            <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-700">
                <div class="bg-indigo-900/20 p-2 rounded-full border border-indigo-500/50">
                    <span class="text-2xl">üåç</span>
                </div>
                <div>
                    <div class="text-xs font-bold text-indigo-400 uppercase tracking-widest">Unified Analysis</div>
                    <div class="text-[10px] text-gray-400">Merged data from ${totalRelevantLogs} target defeats</div>
                </div>
            </div>

            <div class="space-y-4">
                
                <div class="flex justify-between items-center bg-[#0d1117] p-3 rounded-xl border border-gray-700">
                    <span class="text-xs text-gray-400 uppercase">Target Defeats</span>
                    <div class="text-right">
                        <span class="text-2xl font-black text-white">${totalDefeats}</span>
                        <span class="text-[9px] text-gray-500 block">times recorded</span>
                    </div>
                </div>

                <div>
                    <div class="text-[10px] text-blue-400 font-bold uppercase mb-2">üèÜ Top Winners (‡πÉ‡∏Ñ‡∏£‡∏ä‡∏ô‡∏∞‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î)</div>
                    <div class="flex gap-2 bg-[#0d1117] p-2 rounded-lg border border-gray-700 overflow-x-auto min-h-[60px] items-center custom-scroll">
                        ${bestHeroesHTML || '<span class="text-[10px] text-gray-600 w-full text-center">No Data</span>'}
                    </div>
                </div>

                ${comboHTML}

                ${skillRecHTML}

                <div>
                    <div class="text-[10px] text-orange-400 font-bold uppercase border-b border-gray-700 pb-1 flex justify-between mt-4">
                        <span>‚ö° Weakness Analysis</span>
                    </div>
                    ${breakdownHTML}
                </div>
            </div>
        `;
    }

    // 4. Reset
    function resetPreparation() {
        if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
            prepData.enemy = { id: 'PREP-ENEMY', name: 'Simulated Enemy', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] };
            prepData.my = { id: 'PREP-MY', name: 'My Draft Team', formation: 'basic', slots: {0:null,1:null,2:null,3:null,4:null}, pet: null, skillQueue: [] };
            renderPreparation();
        }
    }

    // ==========================================
    // ‚öîÔ∏è BATTLE WAR (MANUAL RECORDER) LOGIC
    // ==========================================

    function renderBattleWar() {
        // 1. Render Enemy (‡πÉ‡∏ä‡πâ generateSimCardHTML ‡πÄ‡∏î‡∏¥‡∏°)
        const enemyHTML = generateSimCardHTML(battleWarData.enemy, 'BW-ENEMY', false, false); // false, false = ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Å, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
        document.getElementById('bw-enemy-area').innerHTML = enemyHTML;

        // 2. Render My Team
        const myHTML = generateSimCardHTML(battleWarData.my, 'BW-MY', true, false); // true, false = ‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Å, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
        document.getElementById('bw-my-area').innerHTML = myHTML;
    }

    async function recordBattleWarResult(result) {
        const myTeam = battleWarData.my;
        const enemyTeam = battleWarData.enemy;
        
        // 1. Validation Checks
        const hasMy = Object.values(myTeam.slots).some(s=>s!==null);
        const hasEnemy = Object.values(enemyTeam.slots).some(s=>s!==null);
        if(!hasMy || !hasEnemy) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ù‡∏±‡πà‡∏á");

        if(!confirm(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•: ${result}?`)) return;
        showLoading("Saving...");

        // 2. Create Record Data
        const createLogData = (teamSource) => {
            let data=[], ids=[];
            for(let i=0; i<5; i++) {
                const s = teamSource.slots[i];
                if(s) {
                    const h = heroesDB.find(x=>x.id===s.id);
                    data.push({ id:s.id, star:s.star||0, type: h?h.type:'Unknown', ring:s.ring||null });
                    ids.push(s.id);
                }
            }
            return {data, ids};
        };
        const myLog = createLogData(myTeam);
        const enemyLog = createLogData(enemyTeam);

        const record = {
            id: Date.now().toString(),
            timestamp: Date.now(),
            date: new Date().toLocaleString('th-TH'),
            castle: 'Manual', castleSlot: '-', castleKey: 'MANUAL',
            myTeamId: 'MANUAL-MY', myTeamName: myTeam.name,
            playerData: myLog.data, enemyData: enemyLog.data,
            playerIds: myLog.ids, enemyIds: enemyLog.ids,
            enemySignature: enemyLog.ids.sort().join(','),
            myTeamStars: calculateTotalTeamStars(myTeam),
            enemyTeamStars: calculateTotalTeamStars(enemyTeam),
            skillQueue: myTeam.skillQueue||[], enemySkillQueue: enemyTeam.skillQueue||[],
            enemyName: (enemyTeam.name && enemyTeam.name.trim()!=='') ? enemyTeam.name : "Unknown Enemy",
            status: result, result: result
        };

        // 3. Save to History
        battleHistoryDB.unshift(record);
        if(battleHistoryDB.length > 500) battleHistoryDB.pop();

        await pushData();

        // 4. Update Logs UI
        renderBattleWarLogs();

        // ‚úÖ [‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ] 5. Clear Battle War Data (Reset Forms)
        battleWarData.enemy = { 
            id: 'BW-ENEMY', 
            name: 'Enemy Team', 
            formation: 'basic', 
            slots: {0:null,1:null,2:null,3:null,4:null}, 
            pet: null, 
            skillQueue: [] 
        };
        
        battleWarData.my = { 
            id: 'BW-MY', 
            name: 'My Team', 
            formation: 'basic', 
            slots: {0:null,1:null,2:null,3:null,4:null}, 
            pet: null, 
            skillQueue: [] 
        };

        // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà (‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏•‡πà‡∏á‡πÜ)
        renderBattleWar();

        hideLoading();
    }

    function renderBattleWar() {
        const enemyHTML = generateSimCardHTML(battleWarData.enemy, 'BW-ENEMY', false, false);
        document.getElementById('bw-enemy-area').innerHTML = enemyHTML;

        const myHTML = generateSimCardHTML(battleWarData.my, 'BW-MY', true, false);
        document.getElementById('bw-my-area').innerHTML = myHTML;

        renderBattleWarLogs(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Log ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏ß‡∏¢
    }

    function renderBattleWarLogs() {
        const container = document.getElementById('bw-logs-list');
        const countLabel = document.getElementById('bw-log-count');
        if (!container) return;

        if(countLabel) countLabel.innerText = `(${battleHistoryDB.length})`;

        if (battleHistoryDB.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-600 py-8 border-2 border-dashed border-gray-800 rounded-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</div>`;
            return;
        }

        const html = battleHistoryDB.map(log => {
            const isWin = log.result === 'Win' || log.status === 'Win';
            const statusColor = isWin ? 'border-green-900/50 bg-green-900/5' : 'border-red-900/50 bg-red-900/5';
            const badge = isWin ? 'üèÜ WIN' : 'üíÄ LOSE';
            
            const genIcons = (data, gray) => {
                if(!data) return '';
                return data.map(p => {
                    const h = heroesDB.find(x => x.id === p.id);
                    return h ? `<img src="${h.img}" class="w-6 h-6 rounded border border-gray-700 bg-black ${gray?'grayscale opacity-70':''}">` : '';
                }).join('');
            };

            return `
                <div class="flex items-center justify-between p-3 rounded-lg border ${statusColor} bg-[#161b22] mb-2">
                    <div class="flex flex-col w-20 flex-shrink-0">
                        <span class="text-[10px] text-gray-500">${log.date.split(' ')[1] || log.date}</span>
                        <span class="${isWin?'text-green-400':'text-red-400'} font-bold text-xs">${badge}</span>
                    </div>
                    <div class="flex-1 flex items-center justify-center gap-4 px-2">
                        <div class="flex gap-0.5">${genIcons(log.playerData, false)}</div>
                        <span class="text-gray-700 text-xs font-bold">VS</span>
                        <div class="flex gap-0.5">${genIcons(log.enemyData, true)}</div>
                    </div>
                    <div class="w-24 text-right flex flex-col justify-center">
                        <span class="text-xs text-gray-300 font-bold truncate">${log.enemyName || 'Unknown'}</span>
                    </div>
                </div>
            `;
        }).join('');
        container.innerHTML = html;
    }

    async function recordBattleWarResult(result) {
        const myTeam = battleWarData.my;
        const enemyTeam = battleWarData.enemy;
        
        // Check Heroes
        const hasMy = Object.values(myTeam.slots).some(s=>s!==null);
        const hasEnemy = Object.values(enemyTeam.slots).some(s=>s!==null);
        if(!hasMy || !hasEnemy) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ù‡∏±‡πà‡∏á");

        if(!confirm(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•: ${result}?`)) return;
        showLoading("Saving...");

        // Create Record
        const createLogData = (teamSource) => {
            let data=[], ids=[];
            for(let i=0; i<5; i++) {
                const s = teamSource.slots[i];
                if(s) {
                    const h = heroesDB.find(x=>x.id===s.id);
                    data.push({ id:s.id, star:s.star||0, type: h?h.type:'Unknown', ring:s.ring||null });
                    ids.push(s.id);
                }
            }
            return {data, ids};
        };
        const myLog = createLogData(myTeam);
        const enemyLog = createLogData(enemyTeam);

        const record = {
            id: Date.now().toString(),
            timestamp: Date.now(),
            date: new Date().toLocaleString('th-TH'),
            castle: 'Manual', castleSlot: '-', castleKey: 'MANUAL',
            myTeamId: 'MANUAL-MY', myTeamName: myTeam.name,
            playerData: myLog.data, enemyData: enemyLog.data,
            playerIds: myLog.ids, enemyIds: enemyLog.ids,
            enemySignature: enemyLog.ids.sort().join(','),
            myTeamStars: calculateTotalTeamStars(myTeam),
            enemyTeamStars: calculateTotalTeamStars(enemyTeam),
            skillQueue: myTeam.skillQueue||[], enemySkillQueue: enemyTeam.skillQueue||[],
            enemyName: (enemyTeam.name && enemyTeam.name.trim()!=='') ? enemyTeam.name : "Unknown Enemy",
            status: result, result: result
        };

        battleHistoryDB.unshift(record);
        if(battleHistoryDB.length > 500) battleHistoryDB.pop();

        await pushData();
        renderBattleWarLogs();
        hideLoading();
    }

    function renderFullHistory() {
        const container = document.getElementById('full-history-list');
        const countLabel = document.getElementById('history-total-count');
        
        if (!container) return;
        if (countLabel) countLabel.innerText = `(${battleHistoryDB.length})`;

        if (battleHistoryDB.length === 0) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-gray-600 border-2 border-dashed border-gray-800 rounded-xl bg-[#111827]/50">
                    <span class="text-4xl mb-4 opacity-30">üì≠</span>
                    <span class="text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</span>
                    <span class="text-xs mt-2">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "Battle War" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </div>`;
            return;
        }

        // Generate HTML
        const html = battleHistoryDB.map((log, index) => {
            const isWin = log.result === 'Win' || log.status === 'Win';
            const statusColor = isWin ? 'border-l-4 border-l-green-500 border-gray-700' : 'border-l-4 border-l-red-500 border-gray-700';
            const badgeClass = isWin ? 'text-green-400 bg-green-900/20 border-green-800' : 'text-red-400 bg-red-900/20 border-red-800';
            const badgeText = isWin ? 'VICTORY' : 'DEFEAT';

            // Helper: Icon
            const genIcons = (data, isGray) => {
                if(!data) return '';
                return data.map(p => {
                    const h = heroesDB.find(x => x.id === p.id);
                    // ‡πÉ‡∏™‡πà‡∏î‡∏≤‡∏ß‡∏î‡πâ‡∏ß‡∏¢
                    const starBadge = p.star > 0 ? `<div class="absolute -bottom-1 -right-1 bg-black text-yellow-500 text-[8px] px-1 rounded border border-gray-700 font-bold leading-none z-10">${p.star}</div>` : '';
                    
                    return h ? `
                        <div class="relative w-8 h-8 rounded border border-gray-600 bg-black group/icon" title="${h.name}">
                            <img src="${h.img}" class="w-full h-full object-cover opacity-90 ${isGray?'grayscale-[0.5]':''}">
                            ${starBadge}
                        </div>` : '';
                }).join('');
            };

            return `
                <div class="bg-[#161b22] rounded-lg border ${statusColor} p-4 shadow-md hover:bg-[#1f2937] transition relative group">
                    <div class="flex flex-col md:flex-row items-center gap-4">
                        
                        <div class="flex flex-col items-center md:items-start w-24 flex-shrink-0">
                            <span class="text-[10px] text-gray-500 font-mono mb-1">${log.date}</span>
                            <span class="px-2 py-0.5 rounded border text-[10px] font-bold tracking-wider ${badgeClass}">${badgeText}</span>
                        </div>

                        <div class="flex-1 flex items-center justify-center gap-4 bg-[#0d1117]/50 p-2 rounded-lg border border-white/5 w-full md:w-auto">
                            <div class="flex items-center gap-1">
                                ${genIcons(log.playerData, false)}
                            </div>
                            
                            <div class="text-gray-600 font-black text-lg italic px-2">VS</div>
                            
                            <div class="flex items-center gap-1">
                                ${genIcons(log.enemyData, true)}
                            </div>
                        </div>

                        <div class="w-32 text-center md:text-right flex-shrink-0">
                            <div class="text-xs text-gray-400 font-bold uppercase mb-1">Opponent</div>
                            <div class="text-sm text-white font-bold truncate">${log.enemyName || 'Unknown'}</div>
                        </div>

                    </div>
                    
                    <div class="absolute top-1 right-2 text-[9px] text-gray-700 opacity-0 group-hover:opacity-100 transition">#${index+1}</div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    // New Function 25/12/2568
    // --- 1. OPEN / CLOSE / ADD ROW ---
    function openRecorder() {
        document.getElementById('recorderModal').classList.remove('hidden');
        if (pendingMatches.length === 0) addNewRow();
    }

    function closeRecorder() {
        if(pendingMatches.length > 0 && !confirm("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
        document.getElementById('recorderModal').classList.add('hidden');
    }

    function addNewRow() {
        const rowId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Data Structure ‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ
        const newMatch = {
            rowId: rowId,
            myFormation: 'basic',
            enemyFormation: 'basic',
            myHeroes: [null, null, null, null, null], // 5 slots
            enemyHeroes: [null, null, null, null, null],
            myPet: null,
            enemyPet: null,
            skillQueue: [], // ‡πÄ‡∏Å‡πá‡∏ö string ‡πÄ‡∏ä‡πà‡∏ô "my-0-1" (‡∏ó‡∏µ‡∏°-‡∏ä‡πà‡∏≠‡∏á-‡∏™‡∏Å‡∏¥‡∏•)
            result: 'Win'
        };

        pendingMatches.push(newMatch);
        renderRecorderRows();
        
        // Focus ‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà
        setTimeout(() => {
            const firstInput = document.getElementById(`input-my-0-${rowId}`);
            if(firstInput) firstInput.focus();
        }, 100);
    }

    function deleteRow(rowId) {
        pendingMatches = pendingMatches.filter(m => m.rowId !== rowId);
        renderRecorderRows();
    }

    function renderRecorderRows() {
        const container = document.getElementById('recorderRows');
        const countBadge = document.getElementById('rowCountBadge');
        const emptyState = document.getElementById('emptyState');
        
        countBadge.innerText = pendingMatches.length;
        if(pendingMatches.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }
        emptyState.classList.add('hidden');

        // ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠ Formation
        const formLabels = { "basic": "B3/F2", "balanced": "B2/F3", "attack": "B4/F1", "defense": "B1/F4" };

        container.innerHTML = pendingMatches.map((match, idx) => {
            return `
            <tr class="border-b border-gray-800 hover:bg-[#111827] transition group">
                <td class="text-center text-gray-500 font-mono align-middle text-lg border-r border-gray-800 w-10 font-bold">${idx + 1}</td>
                
                <td class="align-middle px-2 w-20">
                   <select class="bg-[#0d1117] border border-green-900 text-green-200 rounded-lg text-xs w-full text-center outline-none py-2 font-bold cursor-pointer hover:border-green-500 transition" onchange="updateRecVal('${match.rowId}', 'myFormation', this.value)">
                        ${formations.map(f => `<option value="${f.id}" ${match.myFormation===f.id?'selected':''}>${formLabels[f.id] || f.name}</option>`).join('')}
                   </select>
                </td>

                <td class="align-middle px-0">
                    <div class="flex justify-center items-end gap-2 px-2 w-full">
                        ${[0,1,2].map(i => renderRecSlot(match, 'my', i)).join('')}
                        ${renderRecPetSlot(match, 'my')}
                    </div>
                </td>

                <td class="text-center align-middle px-0 w-12">
                    <button onclick="swapRowTeams('${match.rowId}')" class="w-8 h-8 rounded-full bg-gray-800 border border-gray-600 text-gray-400 hover:text-white hover:bg-blue-600 hover:border-blue-400 transition flex items-center justify-center shadow-lg mx-auto" title="‡∏™‡∏•‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á">
                        <span class="text-sm font-bold">‚áÑ</span>
                    </button>
                </td>

                <td class="align-middle px-0">
                    <div class="flex justify-center items-end gap-2 px-2 w-full">
                         ${renderRecPetSlot(match, 'enemy')}
                        ${[0,1,2].map(i => renderRecSlot(match, 'enemy', i)).join('')}
                    </div>
                </td>

                <td class="align-middle px-2 w-20">
                   <select class="bg-[#0d1117] border border-red-900 text-red-200 rounded-lg text-xs w-full text-center outline-none py-2 font-bold cursor-pointer hover:border-red-500 transition" onchange="updateRecVal('${match.rowId}', 'enemyFormation', this.value)">
                        ${formations.map(f => `<option value="${f.id}" ${match.enemyFormation===f.id?'selected':''}>${formLabels[f.id] || f.name}</option>`).join('')}
                   </select>
                </td>

                <td class="text-center align-middle pl-1 w-10">
                    <button onclick="deleteRow('${match.rowId}')" class="text-gray-600 hover:text-red-500 font-bold text-2xl px-2">√ó</button>
                </td>
            </tr>`;
        }).join('');
    }

    function renderRecSlot(match, team, slotIdx) {
        const hero = team === 'my' ? match.myHeroes[slotIdx] : match.enemyHeroes[slotIdx];
        const val = hero ? hero.name : '';
        const inputId = `input-${team}-${slotIdx}-${match.rowId}`;
        
        const s1Key = `${team}-${slotIdx}-1`;
        const s2Key = `${team}-${slotIdx}-2`;
        
        const s1Index = match.skillQueue.indexOf(s1Key);
        const s2Index = match.skillQueue.indexOf(s2Key);
        const hasS1 = s1Index > -1;
        const hasS2 = s2Index > -1;

        const labelS1 = hasS1 ? (s1Index + 1) : '‡∏•‡πà‡∏≤‡∏á';
        const labelS2 = hasS2 ? (s2Index + 1) : '‡∏ö‡∏ô';

        const activeStyle = 'bg-blue-600 text-white font-black hover:bg-blue-500';
        const activeStyle2 = 'bg-yellow-500 text-black font-black hover:bg-yellow-400';
        const inactiveStyle = 'bg-[#1f2937] text-gray-400 hover:text-white hover:bg-gray-700';

        const borderColor = team === 'my' ? (hero ? 'border-blue-500/50' : 'border-gray-700') : (hero ? 'border-red-500/50' : 'border-gray-700');

        return `
            <div class="flex flex-col items-center">
                
                <div class="rec-slot-container ${borderColor} group/slot">
                    ${hero ? `<img src="${hero.img}" class="rec-slot-img">` : `<span class="text-3xl text-gray-800 select-none font-bold">+</span>`}
                    
                    <input type="text" id="${inputId}" value="${val}" 
                        class="rec-slot-input"
                        placeholder="Hero"
                        oninput="handleRecSearch(this, '${match.rowId}', '${team}', ${slotIdx})"
                        onkeydown="handleRecNav(event, '${match.rowId}', '${team}', ${slotIdx})"
                        onfocus="this.select()" autocomplete="off">
                        
                    <div id="list-${inputId}" class="autocomplete-list shadow-2xl"></div>
                </div>
                
                <div class="skill-btn-group">
                    <button onclick="toggleRecSkill('${match.rowId}', '${s1Key}')" 
                        class="flex-1 text-[10px] py-1 border-r border-gray-700 transition ${hasS1 ? activeStyle : inactiveStyle}">
                        ${labelS1}
                    </button>
                    <button onclick="toggleRecSkill('${match.rowId}', '${s2Key}')" 
                        class="flex-1 text-[10px] py-1 transition ${hasS2 ? activeStyle2 : inactiveStyle}">
                        ${labelS2}
                    </button>
                </div>

            </div>
        `;
    }

    function renderRecPetSlot(match, team) {
        const pet = team === 'my' ? match.myPet : match.enemyPet;
        const val = pet ? pet.name : '';
        const inputId = `input-pet-${team}-${match.rowId}`;
        const borderClass = team === 'my' ? 'border-purple-500/50' : 'border-orange-500/50';

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Pet ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 65x65 (‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ Hero ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô Pet)
        return `
             <div class="rec-slot-container ${borderClass} rounded-full !w-[65px] !h-[65px] mx-1 relative z-10 shadow-lg bg-[#0d1117] self-center" style="border-radius: 50%; margin-bottom: 24px;">
                ${pet ? `<img src="${pet.img}" class="rec-slot-img rounded-full">` : `<span class="text-xl text-gray-800">üêæ</span>`}
                <input type="text" id="${inputId}" value="${val}" 
                    class="rec-slot-input rounded-full"
                    placeholder="Pet"
                    oninput="handleRecPetSearch(this, '${match.rowId}', '${team}')"
                    onkeydown="handleRecPetNav(event, '${match.rowId}', '${team}')"
                    onfocus="this.select()" autocomplete="off">
                <div id="list-${inputId}" class="autocomplete-list shadow-2xl"></div>
            </div>
        `;
    }

    // --- 3. LOGIC & EVENTS ---

    function updateRecVal(rowId, field, val) {
        const m = pendingMatches.find(x => x.rowId === rowId);
        if(m) { 
            m[field] = val; 
            if(field==='result') renderRecorderRows(); // Refresh color
        }
    }

    function toggleRecSkill(rowId, key) {
        const m = pendingMatches.find(x => x.rowId === rowId);
        if(m) {
            if(m.skillQueue.includes(key)) {
                m.skillQueue = m.skillQueue.filter(k => k !== key);
            } else {
                // Max 3 check
                const teamPrefix = key.split('-')[0]; // 'my' or 'enemy'
                const count = m.skillQueue.filter(k => k.startsWith(teamPrefix)).length;
                if(count < 3) m.skillQueue.push(key);
            }
            renderRecorderRows();
        }
    }

    // --- 4. SEARCH & AUTOCOMPLETE ENGINE ---

    function handleRecSearch(input, rowId, team, slotIdx) {
        const query = input.value.toLowerCase();
        const listId = `list-${input.id}`;
        const listEl = document.getElementById(listId);
        
        if (query.length < 1) { listEl.style.display = 'none'; return; }

        const matches = heroesDB.filter(h => h.name.toLowerCase().includes(query)).slice(0, 5);
        
        if (matches.length > 0) {
            listEl.innerHTML = matches.map((h, i) => `
                <div class="autocomplete-item ${i===0?'selected':''}" onclick="selectRecHero('${rowId}', '${team}', ${slotIdx}, '${h.id}')">
                    <img src="${h.img}"> <span>${h.name}</span>
                </div>
            `).join('');
            listEl.style.display = 'block';
        } else {
            listEl.style.display = 'none';
        }
    }

    function selectRecHero(rowId, team, slotIdx, heroId) {
        const m = pendingMatches.find(x => x.rowId === rowId);
        const hero = heroesDB.find(h => h.id === heroId);
        if (m && hero) {
            if (team === 'my') m.myHeroes[slotIdx] = hero;
            else m.enemyHeroes[slotIdx] = hero;
            renderRecorderRows(); // Re-render to show image/color
            
            // Move Focus to Next Slot
            setTimeout(() => {
                let nextId = '';
                if(slotIdx < 4) nextId = `input-${team}-${slotIdx+1}-${rowId}`;
                else nextId = `input-pet-${team}-${rowId}`; // End of heroes -> go to Pet
                
                const nextInput = document.getElementById(nextId);
                if(nextInput) nextInput.focus();
            }, 50);
        }
    }

    function handleRecNav(e, rowId, team, slotIdx) {
        const listId = `list-${e.target.id}`;
        const listEl = document.getElementById(listId);

        if (e.key === 'Enter') {
            e.preventDefault();
            // If list visible, select top item
            if (listEl.style.display === 'block' && listEl.children.length > 0) {
                listEl.children[0].click();
            } else {
                // If typed exact name or moving manually, just move focus? 
                // For now, assume selection via list is mandatory or text must match exactly.
                // Simple version: just move next if not selecting
                 let nextId = '';
                if(slotIdx < 4) nextId = `input-${team}-${slotIdx+1}-${rowId}`;
                else nextId = `input-pet-${team}-${rowId}`;
                document.getElementById(nextId)?.focus();
            }
        }
        // Add Up/Down arrow navigation logic here if desired
    }

    // --- PET SEARCH LOGIC (Similar structure) ---
    function handleRecPetSearch(input, rowId, team) {
        const query = input.value.toLowerCase();
        const listEl = document.getElementById(`list-${input.id}`);
        if(query.length < 1) { listEl.style.display = 'none'; return; }

        const matches = petsDB.filter(p => p.name.toLowerCase().includes(query)).slice(0, 3);
        if(matches.length > 0) {
            listEl.innerHTML = matches.map((p, i) => `
                <div class="autocomplete-item ${i===0?'selected':''}" onclick="selectRecPet('${rowId}', '${team}', '${p.id}')">
                    <img src="${p.img}"> <span>${p.name}</span>
                </div>
            `).join('');
            listEl.style.display = 'block';
        } else listEl.style.display = 'none';
    }

    function selectRecPet(rowId, team, petId) {
        const m = pendingMatches.find(x => x.rowId === rowId);
        const pet = petsDB.find(p => p.id === petId);
        if(m && pet) {
            if(team === 'my') m.myPet = pet; else m.enemyPet = pet;
            renderRecorderRows();
            // Move Focus: My Pet -> Enemy Hero 0 | Enemy Pet -> New Row?
            setTimeout(() => {
                if(team === 'my') document.getElementById(`input-enemy-0-${rowId}`)?.focus();
                else {
                   // End of row? Maybe add new row automatically?
                   // For now, focus Save button or stay
                }
            }, 50);
        }
    }
    
    function handleRecPetNav(e, rowId, team) {
         if (e.key === 'Enter') {
            e.preventDefault();
            const listEl = document.getElementById(`list-${e.target.id}`);
            if (listEl.style.display === 'block' && listEl.children.length > 0) {
                listEl.children[0].click();
            } else {
                 if(team === 'my') document.getElementById(`input-enemy-0-${rowId}`)?.focus();
            }
        }
    }


    async function saveAllMatches() {
        if (pendingMatches.length === 0) return;
        
        const timestampStart = Date.now();

        const newHistoryItems = pendingMatches.map((match, idx) => {
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• myTeamClean, enemyTeamClean ‡∏Ø‡∏•‡∏Ø ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
            const myTeamClean = match.myHeroes.map(h => h ? { id: h.id, star: 10, type: h.type, ring: null } : {}); 
            const enemyTeamClean = match.enemyHeroes.map(h => h ? { id: h.id, star: 10, type: h.type, ring: null } : {});
            
            const myPetData = match.myPet ? { id: match.myPet.id, name: match.myPet.name } : null;
            const enemyPetData = match.enemyPet ? { id: match.enemyPet.id, name: match.enemyPet.name } : null;
            
            const myQ = match.skillQueue.filter(c => c.startsWith('my-')).map(c => `${c.split('-')[1]}-${c.split('-')[2]}`);
            const enemyQ = match.skillQueue.filter(c => c.startsWith('enemy-')).map(c => `${c.split('-')[1]}-${c.split('-')[2]}`);
            
            const myFormName = formations.find(f => f.id === match.myFormation)?.name || match.myFormation;
            const enemyFormName = formations.find(f => f.id === match.enemyFormation)?.name || match.enemyFormation;

            return {
                id: (timestampStart + idx).toString(),
                timestamp: timestampStart + idx,
                date: new Date().toLocaleString('th-TH'),
                castle: "Manual Record",
                castleSlot: "-",
                castleKey: "MANUAL",
                myFormation: match.myFormation,
                enemyFormation: match.enemyFormation,
                myTeamId: "REC-MY",
                myTeamName: `My Team (${myFormName})`,
                playerData: myTeamClean,
                enemyData: enemyTeamClean,
                myPet: myPetData,
                enemyPet: enemyPetData,
                playerIds: match.myHeroes.map(h => h ? h.id : null),
                enemyIds: match.enemyHeroes.map(h => h ? h.id : null),
                skillQueue: myQ,
                enemySkillQueue: enemyQ,
                enemyName: `Enemy (${enemyFormName})`,
                
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Win ‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏¢‡∏∂‡∏î‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏ä‡∏ô‡∏∞
                status: "Win", 
                result: "Win"  
            };
        });

        // ... (‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á DB ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
        if (typeof battleHistoryDB !== 'undefined') {
             battleHistoryDB.unshift(...newHistoryItems.reverse());
             if(battleHistoryDB.length > 500) battleHistoryDB.pop();

             showLoading("Saving Records...");
             try {
                 await pushData();
                 alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${newHistoryItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£!`);
                 pendingMatches = [];
                 renderRecorderRows();
                 // closeRecorder(); // ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                 if(typeof renderFullHistory === 'function') renderFullHistory();
             } catch(err) {
                 alert("Save Error: " + err.message);
             } finally {
                 hideLoading();
             }
        } else {
             alert("Error: Database not found");
        }
    }

    function swapRowTeams(rowId) {
        const m = pendingMatches.find(x => x.rowId === rowId);
        if(!m) return;

        // 1. Swap Heroes Array
        const tempHeroes = [...m.myHeroes];
        m.myHeroes = [...m.enemyHeroes];
        m.enemyHeroes = tempHeroes;

        // 2. Swap Pet
        const tempPet = m.myPet;
        m.myPet = m.enemyPet;
        m.enemyPet = tempPet;

        // 3. Swap Formation
        const tempForm = m.myFormation;
        m.myFormation = m.enemyFormation;
        m.enemyFormation = tempForm;

        // 4. Swap Skill Queue (Complex part)
        // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô string ‡∏à‡∏≤‡∏Å 'my-...' ‡πÄ‡∏õ‡πá‡∏ô 'enemy-...' ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô
        m.skillQueue = m.skillQueue.map(sq => {
            if (sq.startsWith('my-')) {
                return sq.replace('my-', 'enemy-');
            } else if (sq.startsWith('enemy-')) {
                return sq.replace('enemy-', 'my-');
            }
            return sq;
        });

        // Re-render
        renderRecorderRows();
    }
    function renderSkillListText(match, team) {
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏Å‡∏¥‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ
        const queue = match.skillQueue.filter(q => q.startsWith(team + '-'));
        
        if (queue.length === 0) return '<span class="text-[9px] text-gray-600 text-center">- No Skill -</span>';

        return queue.map((q, i) => {
            const [_, slotIdx, sNum] = q.split('-');
            const heroes = team === 'my' ? match.myHeroes : match.enemyHeroes;
            const hero = heroes[slotIdx];
            const name = hero ? hero.name : `Hero ${parseInt(slotIdx)+1}`;
            
            // ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            const numClass = "text-gray-400 font-mono mr-1";
            const nameClass = team === 'my' ? "text-green-300" : "text-red-300";
            const skillLabel = sNum === '1' ? '‡∏•‡πà‡∏≤‡∏á' : '‡∏ö‡∏ô';
            const skillClass = sNum === '1' ? 'text-blue-400' : 'text-yellow-500';

            return `
                <div class="text-[9px] truncate" title="${name} (${skillLabel})">
                    <span class="${numClass}">${i+1}.</span>
                    <span class="${nameClass} font-bold">${name.substring(0, 6)}..</span>
                    <span class="${skillClass}">[${skillLabel}]</span>
                </div>
            `;
        }).join('');
    }
    // --- NEW UPDATE SYSTEM ---

    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô (‡πÅ‡∏ó‡∏ô startRealTimeSync ‡πÄ‡∏î‡∏¥‡∏°)
    function startUpdateChecker() {
        if (updateCheckInterval) clearInterval(updateCheckInterval);
        console.log("üì° Background Update Checker Started (Every 30s)");
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        updateCheckInterval = setInterval(() => {
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á Save ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥
            if (isSaving || isPendingSave || pendingUpdateData) return;
            
            checkForUpdates();
        }, 30000); 
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
    function checkForUpdates() {
        const badge = document.getElementById('sync-status');
        // ‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ (Option)
        if(badge && !badge.classList.contains('offline')) {
            document.getElementById('status-text').innerText = 'Checking...';
        }

        fetch(SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Online ‡∏õ‡∏Å‡∏ï‡∏¥
            if(badge) document.getElementById('status-text').innerText = 'ONLINE';

            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Timestamp
            if (data.timestamp && data.timestamp > lastServerTimestamp) {
                console.log("üîî New update found!");
                
                // ‡∏û‡∏±‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                pendingUpdateData = data;
                
                // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                document.getElementById('update-notification').classList.remove('hidden');
                document.getElementById('update-notification').classList.add('flex');
            } else {
                console.log("‚úÖ System is up to date.");
            }
        })
        .catch(err => {
            console.error("Check Update Error:", err);
            if(badge) document.getElementById('status-text').innerText = 'OFFLINE';
        });
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Refresh (Apply Data)
    function applyPendingUpdate() {
        if (!pendingUpdateData) return;

        showLoading("üîÑ Refreshing Data...");

        const data = pendingUpdateData;
        lastServerTimestamp = data.timestamp;

        // --- Process Data (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô fetchCloudData ‡πÄ‡∏î‡∏¥‡∏°) ---
        // 1. Users
        if (data.users && Array.isArray(data.users)) systemUsersDB = data.users;
        
        // 2. Main DB
        heroesDB = data.heroes || []; 
        petsDB = data.pets || []; 
        ringsDB = data.rings || [];
        if(data.affiliations) affiliationsDB = data.affiliations;
        
        // 3. Tier List & Teams
        loadLocalTierData(); // (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ data.tierLists ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ sync)
        if(data.teams) { 
            if(data.teams.teams) teamsDB = data.teams.teams; else teamsDB = data.teams; 
            if(data.teams.logs) logsDB = data.teams.logs; 
        }

        // 4. Guild & Others
        if (data.guildMembers && data.guildMembers.length === 30) guildMembersDB = data.guildMembers;
        if (data.knownEnemies) knownEnemies = data.knownEnemies;
        if (data.battleHistory) battleHistoryDB = data.battleHistory;
        if (data.seasonInfo) currentSeason = data.seasonInfo;
        if (data.archivedSeasons) archivedSeasons = data.archivedSeasons;
        if (data.heroSets) heroSetsDB = data.heroSets;

        // --- Update UI ---
        syncWarRoomFromHistory();
        updateGuildWarUI();
        updateCurrentViewUI(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (SPA Style)

        // Clear Pending State
        pendingUpdateData = null;
        dismissUpdate(); // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        
        setTimeout(hideLoading, 500); // ‡∏õ‡∏¥‡∏î Loading
    }

    // 4. ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
    function dismissUpdate() {
        document.getElementById('update-notification').classList.add('hidden');
        document.getElementById('update-notification').classList.remove('flex');
    }

    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
    function createNewHeroList() {
        const newList = {
            id: Date.now().toString(),
            name: "List " + (tempHeroLists.length + 1),
            note: "",
            heroIds: []
        };
        tempHeroLists.push(newList);
        renderHeroListsView();
    }

    // 2. ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    function deleteHeroList(id) {
        tempHeroLists = tempHeroLists.filter(l => l.id !== id);
        renderHeroListsView();
    }

    // 3. ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset)
    function resetAllHeroLists() {
        if(tempHeroLists.length === 0 && Object.keys(manualUsageOffsets).length === 0) return;
        if(!confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Checklist ‡πÅ‡∏•‡∏∞ Counter ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;
        
        tempHeroLists = [];
        manualUsageOffsets = {}; // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        
        renderHeroListsView();
    }

    // 4. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠/Note
    function updateHeroListInfo(id, field, value) {
        const list = tempHeroLists.find(l => l.id === id);
        if(list) {
            list[field] = value;
            // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Save
        }
    }

    // 5. ‡∏•‡∏ö Hero ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å List
    function removeHeroFromList(listId, heroId) {
        const list = tempHeroLists.find(l => l.id === listId);
        if(list) {
            list.heroIds = list.heroIds.filter(id => id !== heroId);
            renderHeroListsView();
        }
    }

    // 6. ‡πÄ‡∏û‡∏¥‡πà‡∏° Hero (Helper ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Dropdown)
    function addHeroByIdToHelper(listId, heroId) {
        const list = tempHeroLists.find(l => l.id === listId);
        if(list && !list.heroIds.includes(heroId)) {
            list.heroIds.push(heroId);
            renderHeroListsView();
        }
    }

    // --- MAIN RENDER ---
    function renderHeroListsView() {
        const container = document.getElementById('hero-lists-container');
        container.innerHTML = '';

        if (tempHeroLists.length === 0) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-600">
                    <span class="text-4xl mb-2">üìù</span>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    <button onclick="createNewHeroList()" class="mt-4 text-purple-400 hover:text-purple-300 underline">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å</button>
                </div>`;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown Option ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
        let heroOptions = `<option value="">+ Add Hero...</option>`;
        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠
        const sortedHeroes = [...heroesDB].sort((a,b) => a.name.localeCompare(b.name));
        sortedHeroes.forEach(h => {
            heroOptions += `<option value="${h.id}">${h.name}</option>`;
        });

        tempHeroLists.forEach(list => {
            let heroesHTML = '';
            list.heroIds.forEach(hid => {
                const h = heroesDB.find(x => x.id === hid);
                if(h) {
                    // üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 1: ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô w-20 h-20 (80px)
                    heroesHTML += `
                    <div class="relative group inline-block m-1">
                        <img src="${h.img}" class="w-20 h-20 rounded-lg border border-gray-600 bg-gray-900 object-cover shadow-md transition hover:scale-105" title="${h.name}">
                        <button onclick="removeHeroFromList('${list.id}', '${hid}')" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-sm z-10 hover:bg-red-600">‚úï</button>
                    </div>`;
                }
            });

            const card = document.createElement('div');
            card.className = "bg-gray-800 rounded-lg p-4 border border-gray-700 shadow-sm relative animate-fade-in";
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <input type="text" value="${list.name}" oninput="updateHeroListInfo('${list.id}', 'name', this.value)" 
                        class="bg-transparent text-lg font-bold text-purple-300 border-b border-transparent focus:border-purple-500 outline-none w-2/3 transition" placeholder="List Name">
                    <button onclick="deleteHeroList('${list.id}')" class="text-gray-600 hover:text-red-400 p-1 rounded hover:bg-gray-700/50 transition">‚úï</button>
                </div>
                
                <input type="text" value="${list.note}" oninput="updateHeroListInfo('${list.id}', 'note', this.value)" 
                    class="w-full bg-gray-900/50 text-xs text-gray-400 p-2 rounded border border-gray-700/50 mb-3 outline-none focus:border-gray-600 focus:bg-gray-900 transition" placeholder="Note...">
                
                <div class="bg-gray-900 p-3 rounded-lg min-h-[100px] border border-dashed border-gray-700 flex flex-wrap items-center gap-2">
                    ${heroesHTML}
                    
                    <button onclick="openSelector('HERO-LIST', '${list.id}', 'hero', event)" 
                        class="w-20 h-20 rounded-lg border-2 border-gray-700 border-dashed flex items-center justify-center text-gray-500 hover:text-purple-400 hover:border-purple-500 hover:bg-gray-800/50 transition group">
                        <span class="text-4xl font-bold group-hover:scale-110 transition">+</span>
                    </button>
                </div>
            `;
            container.appendChild(card);
        });

        // Render Stats ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
        renderTempHeroUsageStats();
    }

    function renderTempHeroUsageStats() {
        const statsBody = document.getElementById('hero-usage-table-body');
        const usageMap = {};

        // 1. ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å Lists (Auto)
        tempHeroLists.forEach(list => {
            list.heroIds.forEach(hid => {
                usageMap[hid] = (usageMap[hid] || 0) + 1;
            });
        });

        // 2. ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö Manual Offsets
        // ‡∏ï‡πâ‡∏≠‡∏á Loop ‡πÄ‡∏≠‡∏≤ Hero ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà "‡∏°‡∏µ‡∏Ñ‡πà‡∏≤" (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏à‡∏≤‡∏Å List ‡∏´‡∏£‡∏∑‡∏≠ Manual)
        const allRelevantIds = new Set([...Object.keys(usageMap), ...Object.keys(manualUsageOffsets)]);
        
        const finalStats = [];
        allRelevantIds.forEach(hid => {
            const listCount = usageMap[hid] || 0;
            const manualCount = manualUsageOffsets[hid] || 0;
            const total = listCount + manualCount;

            if (total !== 0) { // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô 0
                const hero = heroesDB.find(h => h.id === hid);
                if (hero) {
                    finalStats.push({
                        id: hid,
                        name: hero.name,
                        img: hero.img,
                        total: total,
                        listCount: listCount,   // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏î‡∏π debug ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏¢‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ
                        manualCount: manualCount
                    });
                }
            }
        });

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢
        finalStats.sort((a, b) => b.total - a.total);

        // Render HTML
        statsBody.innerHTML = finalStats.map((item, index) => `
            <tr class="hover:bg-gray-700/50 transition group border-b border-gray-800/50 last:border-0">
                <td class="p-2 flex items-center gap-3">
                    <span class="text-gray-600 font-mono text-xs w-5 text-center">${index+1}</span>
                    
                    <img src="${item.img}" class="w-14 h-14 rounded-md bg-gray-900 object-cover border border-gray-700">
                    
                    <div class="flex flex-col justify-center">
                        <span class="text-gray-200 font-medium text-sm truncate w-28 leading-tight">${item.name}</span>
                        ${item.manualCount !== 0 ? `<span class="text-[10px] text-gray-500">Manual: ${item.manualCount > 0 ? '+' : ''}${item.manualCount}</span>` : ''}
                    </div>
                </td>
                <td class="p-2 text-right align-middle">
                    <div class="flex items-center justify-end gap-2">
                        <button onclick="adjustUsageCount('${item.id}', -1)" class="w-7 h-7 flex items-center justify-center bg-gray-800 text-gray-400 hover:bg-red-900/50 hover:text-red-300 rounded text-base border border-gray-600 opacity-0 group-hover:opacity-100 transition shadow-sm">-</button>
                        
                        <span class="inline-flex items-center justify-center bg-purple-900/40 text-purple-200 text-lg font-bold w-10 h-8 rounded border border-purple-500/30 shadow-inner">
                            ${item.total}
                        </span>
                        
                        <button onclick="adjustUsageCount('${item.id}', 1)" class="w-7 h-7 flex items-center justify-center bg-gray-800 text-gray-400 hover:bg-green-900/50 hover:text-green-300 rounded text-base border border-gray-600 opacity-0 group-hover:opacity-100 transition shadow-sm">+</button>
                    </div>
                </td>
            </tr>
        `).join('');
        
        if(finalStats.length === 0) {
            statsBody.innerHTML = `<tr><td colspan="2" class="p-8 text-center text-gray-600 text-xs">No active usage</td></tr>`;
        }
    }

    // --- MODAL FUNCTIONS ---

    function openHeroSelector(listId) {
        currentTargetListId = listId;
        const modal = document.getElementById('hero-selector-modal');
        const grid = document.getElementById('hero-selector-grid');
        const searchInput = document.getElementById('hero-search-input');
        
        // Reset Search
        searchInput.value = '';
        
        // Render Heroes
        grid.innerHTML = '';
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏£‡∏î (‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≠‡∏ö)
        const sortedHeroes = [...heroesDB].sort((a,b) => a.name.localeCompare(b.name));
        
        sortedHeroes.forEach(h => {
            const div = document.createElement('div');
            div.className = "hero-item flex flex-col items-center cursor-pointer hover:bg-gray-800 p-2 rounded transition border border-transparent hover:border-purple-500 group";
            div.onclick = () => selectHeroFromModal(h.id);
            div.innerHTML = `
                <div class="relative">
                    <img src="${h.img}" class="w-14 h-14 rounded-lg bg-gray-950 object-cover border border-gray-700 group-hover:scale-105 transition" loading="lazy">
                    <div class="absolute inset-0 bg-purple-500/20 hidden group-hover:block rounded-lg"></div>
                </div>
                <span class="text-[10px] text-gray-400 mt-1 text-center truncate w-full group-hover:text-white">${h.name}</span>
            `;
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Search
            div.dataset.name = h.name.toLowerCase();
            grid.appendChild(div);
        });

        modal.classList.remove('hidden');
        searchInput.focus();
    }

    function closeHeroSelector() {
        document.getElementById('hero-selector-modal').classList.add('hidden');
        currentTargetListId = null;
    }

    function selectHeroFromModal(heroId) {
        if (currentTargetListId) {
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á List
            addHeroByIdToHelper(currentTargetListId, heroId);
        }
        closeHeroSelector();
    }

    function filterHeroSelector() {
        const txt = document.getElementById('hero-search-input').value.toLowerCase();
        const items = document.querySelectorAll('#hero-selector-grid .hero-item');
        items.forEach(el => {
            if(el.dataset.name.includes(txt)) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Manual
    function adjustUsageCount(heroId, delta) {
        if (!manualUsageOffsets[heroId]) manualUsageOffsets[heroId] = 0;
        manualUsageOffsets[heroId] += delta;
        
        // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏à‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 0 (‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô list) ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‡πÅ‡∏ï‡πà‡∏ô‡∏µ‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        renderTempHeroUsageStats();
    }

    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏î Add Text)
    function openTierContextMenu(e) {
        e.preventDefault();
        closeCtxMenus(); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà

        const menu = document.getElementById('tier-context-menu');
        const canvas = document.getElementById('tier-canvas');
        
        if(!menu || !canvas) return;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö Canvas (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Text ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î)
        const rect = canvas.getBoundingClientRect();
        contextMenuPos = {
            x: e.clientX - rect.left + canvas.scrollLeft, 
            y: e.clientY - rect.top + canvas.scrollTop
        };

        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π
        menu.style.display = 'block';
        menu.classList.remove('hidden');
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    }

    // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Add Text Logic)
    function addTextAtContextLocation() {
        const canvas = document.getElementById('tier-canvas');
        if (!canvas) return;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        const el = document.createElement('div');
        el.className = 'floating-label animate-fade-in';
        el.contentEditable = true;
        el.innerText = 'Text';

        // ‡∏ß‡∏≤‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        el.style.left = contextMenuPos.x + 'px';
        el.style.top = contextMenuPos.y + 'px';

        el.oninput = function() {
            autoSaveTierList(); 
        };

        // Event: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        el.oncontextmenu = function(e) {
            e.preventDefault();
            e.stopPropagation(); // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡πÇ‡∏î‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
            openTierTextMenu(e, this);
        };

        // Event: ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏î‡πà‡∏ß‡∏ô
        el.ondblclick = function(e) {
            e.stopPropagation();
            if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ?")) {
                el.remove();
                autoSaveTierList(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            }
        };

        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        if (typeof makeDraggable === "function") makeDraggable(el);
        canvas.appendChild(el);
        
        // Auto Focus
        setTimeout(() => {
            el.focus();
            document.execCommand('selectAll', false, null);
        }, 100);
        
        closeCtxMenus(); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
        autoSaveTierList();
    }

    // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    function openTierTextMenu(e, element) {
        activeFloatingText = element; 
        closeCtxMenus(); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô

        const menu = document.getElementById('tier-text-menu');
        menu.style.display = 'block';
        menu.classList.remove('hidden');
        
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    }

    // 7. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Text/Background
    function setTextBackground() {
        if(!activeFloatingText) return;
        const url = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image URL):");
        if(url) {
            activeFloatingText.style.backgroundImage = `url('${url}')`;
            activeFloatingText.style.backgroundColor = 'transparent';
            activeFloatingText.style.border = 'none'; 
            activeFloatingText.style.color = '#ffffff'; 
            
            if(activeFloatingText.offsetWidth < 100) {
                activeFloatingText.style.minWidth = '150px';
                activeFloatingText.style.minHeight = '60px';
                activeFloatingText.style.display = 'flex';
                activeFloatingText.style.alignItems = 'center';
                activeFloatingText.style.justifyContent = 'center';
            }

            autoSaveTierList();
        }
        closeCtxMenus();
    }

    function clearTextBackground() {
        if(!activeFloatingText) return;
        activeFloatingText.style.backgroundImage = '';
        activeFloatingText.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        activeFloatingText.style.border = '1px dashed #fbbf24';
        activeFloatingText.style.color = '#fbbf24';
        activeFloatingText.style.minWidth = '50px';
        activeFloatingText.style.minHeight = 'auto';
        closeCtxMenus();
    }

    function deleteFloatingText() {
        if(activeFloatingText) activeFloatingText.remove();
        closeCtxMenus();
    }

    function closeTierTextMenu() {
        const menu = document.getElementById('tier-text-menu');
        if(menu) menu.classList.add('hidden');
    }

    // 4. ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á (Draggable Logic)
    function makeDraggable(elmnt) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        elmnt.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            if (document.activeElement === elmnt) return; // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏≤‡∏Å

            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    function autoSaveTierList() {
        // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Rank/Hero)
        localStorage.setItem('7k_local_tier_db', JSON.stringify(tierListsDB));
        localStorage.setItem('7k_local_tier_struct', JSON.stringify(activeTiers));
        localStorage.setItem('7k_local_tier_conf', JSON.stringify(tierRankConfigs));
        
        // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Background
        const bgContainer = document.getElementById('tier-bg-container');
        if(bgContainer) {
            localStorage.setItem('7k_tier_bg', bgContainer.style.backgroundImage.slice(5, -2).replace(/"/g, ""));
        }

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Stickers ‡πÅ‡∏•‡∏∞ Text (Object Layer)
        const objects = [];
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sticker
        document.querySelectorAll('.sticker-item').forEach(el => {
            objects.push({
                type: 'sticker',
                src: el.src,
                style: el.getAttribute('style'),
                rotation: el.dataset.rotation || 0
            });
        });

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Text
        document.querySelectorAll('.floating-label').forEach(el => {
            objects.push({
                type: 'text',
                text: el.innerText,
                style: el.getAttribute('style'),
                className: el.className // ‡πÄ‡∏Å‡πá‡∏ö class ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤ style
            });
        });

        localStorage.setItem('7k_tier_objects', JSON.stringify(objects));
        
        console.log("‚úÖ Auto-saved to Local Storage");
    }

    function loadTierListFull() {
        // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const localDB = localStorage.getItem('7k_local_tier_db');
        const localStruct = localStorage.getItem('7k_local_tier_struct');
        const localConf = localStorage.getItem('7k_local_tier_conf');

        if (localDB) tierListsDB = JSON.parse(localDB);
        if (localStruct) activeTiers = JSON.parse(localStruct);
        if (localConf) tierRankConfigs = JSON.parse(localConf);

        renderTierViewer(); // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á

        // 2. ‡πÇ‡∏´‡∏•‡∏î Background
        const savedBg = localStorage.getItem('7k_tier_bg');
        if(savedBg && savedBg !== 'none') {
            setTierBg(savedBg, false); // false = ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á save ‡∏ã‡πâ‡∏≥
        }

        // 3. ‡πÇ‡∏´‡∏•‡∏î Stickers ‡πÅ‡∏•‡∏∞ Text
        const savedObjs = localStorage.getItem('7k_tier_objects');
        const stickerLayer = document.getElementById('tier-sticker-layer');
        const canvas = document.getElementById('tier-canvas');
        
        if (savedObjs && stickerLayer && canvas) {
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
            stickerLayer.innerHTML = '';
            // ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ floating-label ‡πÉ‡∏ô canvas
            canvas.querySelectorAll('.floating-label').forEach(e => e.remove());

            const objects = JSON.parse(savedObjs);
            objects.forEach(obj => {
                if (obj.type === 'sticker') {
                    const img = document.createElement('img');
                    img.src = obj.src;
                    img.className = "sticker-item pointer-events-auto";
                    img.setAttribute('style', obj.style);
                    img.dataset.rotation = obj.rotation;
                    
                    // Attach Events
                    img.oncontextmenu = function(e) { e.preventDefault(); e.stopPropagation(); openStickerContextMenu(e, this); };
                    img.onwheel = function(e) { 
                        e.preventDefault();
                        if (e.shiftKey) {
                            let currentRot = parseFloat(this.dataset.rotation) || 0;
                            if (e.deltaY < 0) currentRot += 15; else currentRot -= 15;
                            this.dataset.rotation = currentRot;
                            this.style.transform = `translate(-50%, -50%) rotate(${currentRot}deg)`;
                        } else {
                            const scaleFactor = e.deltaY < 0 ? 1.1 : 0.9;
                            let newWidth = this.clientWidth * scaleFactor;
                            if (newWidth > 20) {
                                this.style.width = newWidth + "px";
                                this.style.height = "auto";
                            }
                        }
                        autoSaveTierList(); // Save on resize/rotate
                    };
                    makeDraggable(img);
                    stickerLayer.appendChild(img);

                } else if (obj.type === 'text') {
                    const el = document.createElement('div');
                    el.className = obj.className;
                    el.contentEditable = true;
                    el.innerText = obj.text;
                    el.setAttribute('style', obj.style);

                    // Attach Events
                    el.oncontextmenu = function(e) { e.preventDefault(); e.stopPropagation(); openTierTextMenu(e, this); };
                    el.ondblclick = function(e) { 
                        e.stopPropagation(); 
                        if(confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ?")) { 
                            el.remove(); 
                            autoSaveTierList(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                        } 
                    };
                    el.oninput = autoSaveTierList; // Save when typing
                    
                    makeDraggable(el);
                    canvas.appendChild(el);
                }
            });
        }
    }
    function sanitizeRankConfig(rankId) {
        if (!tierRankConfigs[rankId]) {
            tierRankConfigs[rankId] = { name: rankId, color: '#ffffff', opacity: 60, bg: '' };
        }
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        if (tierRankConfigs[rankId].x === undefined) tierRankConfigs[rankId].x = 50; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
        if (tierRankConfigs[rankId].y === undefined) tierRankConfigs[rankId].y = activeTiers.indexOf(rankId) * 120 + 50; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏á‡∏°‡∏≤
        if (tierRankConfigs[rankId].scale === undefined) tierRankConfigs[rankId].scale = 1;
        if (tierRankConfigs[rankId].rot === undefined) tierRankConfigs[rankId].rot = 0;
        if (tierRankConfigs[rankId].width === undefined) tierRankConfigs[rankId].width = 600; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß
    function rowDragStart(e, rankId) {
        if (e.target.tagName === 'INPUT') return; // ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î Input ‡πÑ‡∏î‡πâ
    
        e.preventDefault();
        e.stopPropagation();
        
        isRowDragging = true;
        activeDragGroupId = rankId;
        dragStartMouse = { x: e.clientX, y: e.clientY };
        activeDragGroup = [];

        // --- LOGIC ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° ---
        let targets = [];
        
        // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î Shift ‡∏Ñ‡πâ‡∏≤‡∏á = ‡πÅ‡∏¢‡∏Å‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (Detach Mode)
        if (e.shiftKey) {
            targets = [rankId];
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏î Shift = ‡∏´‡∏≤‡∏û‡∏ß‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            targets = findConnectedRows(rankId);
        }

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
        targets.forEach(id => {
            const el = document.getElementById(`tier-row-${id}`);
            const conf = tierRankConfigs[id];
            if (el && conf) {
                el.classList.add('dragging');
                activeDragGroup.push({
                    id: id,
                    startX: conf.x,
                    startY: conf.y,
                    elm: el
                });
            }
        });

        document.addEventListener('mousemove', rowDragMove);
        document.addEventListener('mouseup', rowDragEnd);
    }
    function rowDragMove(e) {
        if (!isRowDragging || activeDragGroup.length === 0) return;

        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Ç‡∏¢‡∏±‡∏ö (Delta)
        let dx = e.clientX - dragStartMouse.x;
        let dy = e.clientY - dragStartMouse.y;

        // 2. LOGIC ‡πÅ‡∏°‡πà‡πÄ‡∏´‡∏•‡πá‡∏Å (Snapping)
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ "‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å" (activeDragGroupId) ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏ä‡∏ô
        const mainObj = activeDragGroup.find(g => g.id === activeDragGroupId);
        if (mainObj) {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å
            let proposedX = mainObj.startX + dx;
            let proposedY = mainObj.startY + dy;
            
            const snapDist = 20; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏î‡∏π‡∏î
            let snappedY = false;

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏ó‡∏µ‡πà "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ" ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å
            const groupIds = activeDragGroup.map(g => g.id);
            
            activeTiers.forEach(otherId => {
                if (groupIds.includes(otherId)) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏û‡∏ß‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á

                const otherConf = tierRankConfigs[otherId];
                const otherEl = document.getElementById(`tier-row-${otherId}`);
                if (!otherEl) return;

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡πÅ‡∏Å‡∏ô Y (‡∏ï‡πà‡∏≠‡∏ï‡∏π‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡πà‡∏≠‡∏´‡∏±‡∏ß)
                // ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å DOM
                const mainHeight = mainObj.elm.offsetHeight; 
                const otherHeight = otherEl.offsetHeight;

                // Case A: ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ï‡∏π‡∏î‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (Top ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å ‡∏î‡∏π‡∏î Bottom ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô)
                if (Math.abs(proposedY - (otherConf.y + otherHeight)) < snapDist) {
                    // ‡∏õ‡∏£‡∏±‡∏ö dy ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πä‡∏∞
                    const targetY = otherConf.y + otherHeight - 1; // -1 ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô
                    dy = targetY - mainObj.startY; // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì dy ‡πÉ‡∏´‡∏°‡πà
                    snappedY = true;
                    
                    // ‡∏ñ‡πâ‡∏≤ Snap Y ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ Snap X ‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
                    if (Math.abs(proposedX - otherConf.x) < snapDist) {
                        dx = otherConf.x - mainObj.startX;
                    }
                }
                
                // Case B: ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å ‡πÑ‡∏õ‡πÅ‡∏õ‡∏∞‡∏´‡∏±‡∏ß‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (Bottom ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å ‡∏î‡∏π‡∏î Top ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô)
                else if (Math.abs((proposedY + mainHeight) - otherConf.y) < snapDist) {
                    const targetY = otherConf.y - mainHeight + 1;
                    dy = targetY - mainObj.startY;
                    snappedY = true;

                    if (Math.abs(proposedX - otherConf.x) < snapDist) {
                        dx = otherConf.x - mainObj.startX;
                    }
                }
            });
        }

        // 3. Apply ‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏±‡∏ö‡πÉ‡∏´‡πâ "‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°" ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤ dx, dy ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
        activeDragGroup.forEach(item => {
            const newX = item.startX + dx;
            const newY = item.startY + dy;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
            item.elm.style.left = newX + 'px';
            item.elm.style.top = newY + 'px';

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Config (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏ã‡∏ü)
            tierRankConfigs[item.id].x = newX;
            tierRankConfigs[item.id].y = newY;
        });
    }
    function rowDragEnd() {
        isRowDragging = false;
    
        // ‡∏•‡∏ö class dragging ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
        activeDragGroup.forEach(item => {
            if(item.elm) item.elm.classList.remove('dragging');
        });

        document.removeEventListener('mousemove', rowDragMove);
        document.removeEventListener('mouseup', rowDragEnd);
        
        activeDragGroupId = null;
        activeDragGroup = [];
        
        autoSaveTierList(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    }
    function rowWheel(e, rankId) {
        e.preventDefault();
        e.stopPropagation();
        
        const conf = tierRankConfigs[rankId];
        const row = document.getElementById(`tier-row-${rankId}`);

        if (e.shiftKey) {
            // Shift + Scroll = ‡∏´‡∏°‡∏∏‡∏ô
            const step = 15;
            if (e.deltaY < 0) conf.rot += step; 
            else conf.rot -= step;
        } else {
            // Scroll = ‡∏¢‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢
            const step = 0.05;
            if (e.deltaY < 0) conf.scale += step; 
            else conf.scale -= step;
            
            if (conf.scale < 0.5) conf.scale = 0.5;
            if (conf.scale > 3.0) conf.scale = 3.0;
        }
        // Apply Transform
        row.style.transform = `scale(${conf.scale}) rotate(${conf.rot}deg)`;
        autoSaveTierList();
    }
    function rowResizeStart(e, rankId) {
        e.preventDefault();
        e.stopPropagation();
        isRowResizing = true;
        currentRowId = rankId; // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ
        const row = document.getElementById(`tier-row-${rankId}`);
        startResize = { x: e.clientX, w: row.offsetWidth }; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        document.addEventListener('mousemove', rowResizeMove);
        document.addEventListener('mouseup', rowResizeEnd);
    }

    function rowResizeMove(e) {
        if (!isRowResizing) return;
        const conf = tierRankConfigs[currentRowId];
        const row = document.getElementById(`tier-row-${currentRowId}`);
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏´‡∏≤‡∏£ scale ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô)
        const delta = (e.clientX - startResize.x) / (conf.scale || 1);
        let newWidth = startResize.w + delta;
        if (newWidth < 200) newWidth = 200;
        
        row.style.width = newWidth + 'px';
        conf.width = newWidth;
    }

    function rowResizeEnd() {
        isRowResizing = false;
        document.removeEventListener('mousemove', rowResizeMove);
        document.removeEventListener('mouseup', rowResizeEnd);
        autoSaveTierList();
    }
    function findConnectedRows(startId, found = new Set()) {
    found.add(startId);
    
    const startEl = document.getElementById(`tier-row-${startId}`);
    if(!startEl) return Array.from(found);

    const startRect = startEl.getBoundingClientRect();
    const threshold = 5; // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô

    activeTiers.forEach(otherId => {
        if (found.has(otherId)) return;

        const otherEl = document.getElementById(`tier-row-${otherId}`);
        if (!otherEl) return;
        const otherRect = otherEl.getBoundingClientRect();

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ X ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (Alignment)
        const isAlignedX = Math.abs(startRect.left - otherRect.left) < 20;

        if (isAlignedX) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Y ‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô (‡∏ö‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡πà‡∏≤‡∏á)
            const touchingBottom = Math.abs(startRect.bottom - otherRect.top) < threshold;
            const touchingTop = Math.abs(startRect.top - otherRect.bottom) < threshold;

            if (touchingBottom || touchingTop) {
                // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠ (Recursive)
                findConnectedRows(otherId, found);
            }
        }
    });

    return Array.from(found);
}
    </script>
</body>
</html>